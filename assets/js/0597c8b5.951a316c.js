"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7360],{5143:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>s});const t=JSON.parse('{"id":"Java/Netty\u7f51\u7edc\u6846\u67b6","title":"Netty \u7f51\u7edc\u6846\u67b6","description":"\uff08\u4e00\uff09 \u57fa\u7840\u7bc7","source":"@site/docs/Java/Netty\u7f51\u7edc\u6846\u67b6.md","sourceDirName":"Java","slug":"/Java/Netty\u7f51\u7edc\u6846\u67b6","permalink":"/docs/Java/Netty\u7f51\u7edc\u6846\u67b6","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Java/Netty\u7f51\u7edc\u6846\u67b6.md","tags":[],"version":"current","frontMatter":{},"sidebar":"JavaSidebar","previous":{"title":"Netty_\u6a21\u62dfRedis\u7684\u5ba2\u6237\u7aef","permalink":"/docs/Java/Netty_\u6a21\u62dfRedis\u7684\u5ba2\u6237\u7aef"},"next":{"title":"Nginx","permalink":"/docs/Java/Nginx"}}');var l=r(4848),i=r(8453);const a={},c="Netty \u7f51\u7edc\u6846\u67b6",o={},s=[{value:"\uff08\u4e00\uff09 \u57fa\u7840\u7bc7",id:"\u4e00-\u57fa\u7840\u7bc7",level:2},{value:"1\u3001I/O \u57fa\u7840",id:"1io-\u57fa\u7840",level:3},{value:"2\u3001Socket",id:"2socket",level:3},{value:"3\u3001NIO",id:"3nio",level:3},{value:"1) Channel",id:"1-channel",level:4},{value:"2) Buffer",id:"2-buffer",level:4},{value:"3) Selector",id:"3-selector",level:4},{value:"4\u3001\u96f6\u62f7\u8d1d",id:"4\u96f6\u62f7\u8d1d",level:3},{value:"\u7ebf\u7a0b\u6a21\u578b",id:"\u7ebf\u7a0b\u6a21\u578b",level:3},{value:"1\uff09 \u5355\u7ebf\u7a0b Reactor \u6a21\u578b",id:"1-\u5355\u7ebf\u7a0b-reactor-\u6a21\u578b",level:5},{value:"2\uff09\u591a\u7ebf\u7a0b Reactor \u6a21\u578b",id:"2\u591a\u7ebf\u7a0b-reactor-\u6a21\u578b",level:5},{value:"3\uff09\u4e3b\u4ece Reactor \u6a21\u578b",id:"3\u4e3b\u4ece-reactor-\u6a21\u578b",level:5},{value:"\uff08\u4e8c\uff09 \u5e94\u7528\u7bc7",id:"\u4e8c-\u5e94\u7528\u7bc7",level:2},{value:"1\u3001HTTP",id:"1http",level:3},{value:"1) 0.9 \u7248\u672c",id:"1-09-\u7248\u672c",level:4},{value:"2) 1.0 \u7248\u672c",id:"2-10-\u7248\u672c",level:4},{value:"3) 1.1 \u7248\u672c",id:"3-11-\u7248\u672c",level:4},{value:"4) 2.0 \u7248\u672c",id:"4-20-\u7248\u672c",level:4},{value:"\u8bf4\u4e86\u8fd9\u4e48\u591a \u4e0a\u4ee3\u7801\u6765\u64cd\u4f5c\u4e00\u4e0b\u5427\uff01\uff01",id:"\u8bf4\u4e86\u8fd9\u4e48\u591a-\u4e0a\u4ee3\u7801\u6765\u64cd\u4f5c\u4e00\u4e0b\u5427",level:2},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:3},{value:"2\u3001WebSocket",id:"2websocket",level:3},{value:"Websocket \u5e94\u7528 demo",id:"websocket-\u5e94\u7528-demo",level:4},{value:"\u6f14\u793a\u6548\u679c",id:"\u6f14\u793a\u6548\u679c",level:4},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3-1",level:4},{value:"\uff08\u4e09\uff09\u539f\u7406\u7bc7",id:"\u4e09\u539f\u7406\u7bc7",level:2},{value:"1\u3001ByteBuf",id:"1bytebuf",level:3},{value:"1\uff09\u5206\u7c7b",id:"1\u5206\u7c7b",level:4},{value:"A heap buffer",id:"a-heap-buffer",level:5},{value:"B direct buffer",id:"b-direct-buffer",level:5},{value:"C composite buffer",id:"c-composite-buffer",level:5},{value:"D \u6c60\u5316\u7684\u6982\u5ff5",id:"d-\u6c60\u5316\u7684\u6982\u5ff5",level:5},{value:"E \u56de\u6536\u65b9\u5f0f",id:"e-\u56de\u6536\u65b9\u5f0f",level:5},{value:"2\uff09\u5de5\u4f5c\u539f\u7406",id:"2\u5de5\u4f5c\u539f\u7406",level:4},{value:"A \u8bfb\u5199\u5206\u79bb",id:"a-\u8bfb\u5199\u5206\u79bb",level:5},{value:"B \u6df1\u6d45\u62f7\u8d1d",id:"b-\u6df1\u6d45\u62f7\u8d1d",level:5},{value:"3\uff09\u6269\u5bb9\u673a\u5236",id:"3\u6269\u5bb9\u673a\u5236",level:4},{value:"A ByteBuffer \u7684\u5b58\u50a8",id:"a-bytebuffer-\u7684\u5b58\u50a8",level:5},{value:"B ByteBuf \u7684\u5b58\u50a8\u548c\u6269\u5bb9",id:"b-bytebuf-\u7684\u5b58\u50a8\u548c\u6269\u5bb9",level:5},{value:"4\uff09\u4f18\u52bf",id:"4\u4f18\u52bf",level:4},{value:"2\u3001Channel",id:"2channel",level:3},{value:"1\uff09Channel",id:"1channel",level:4},{value:"2\uff09ChannelHandler",id:"2channelhandler",level:4},{value:"3\uff09ChannelPipeline",id:"3channelpipeline",level:4},{value:"3\u3001EventLoop",id:"3eventloop",level:3},{value:"1\uff09EventLoopGroup",id:"1eventloopgroup",level:4},{value:"A \u521d\u59cb\u5316\u6d41\u7a0b",id:"a-\u521d\u59cb\u5316\u6d41\u7a0b",level:5},{value:"2\uff09EventLoop",id:"2eventloop",level:4},{value:"A \u6ce8\u518c channel",id:"a-\u6ce8\u518c-channel",level:5},{value:"B \u8f6e\u8be2\u4e8b\u4ef6\u7684\u72b6\u6001",id:"b-\u8f6e\u8be2\u4e8b\u4ef6\u7684\u72b6\u6001",level:5},{value:"4\u3001Bootstrap",id:"4bootstrap",level:3},{value:"1\uff09\u914d\u7f6e",id:"1\u914d\u7f6e",level:4},{value:"2\uff09\u8fd0\u884c",id:"2\u8fd0\u884c",level:4},{value:"3\uff09\u6e90\u7801\u89e3\u6790",id:"3\u6e90\u7801\u89e3\u6790",level:4},{value:"A \u7c7b\u58f0\u660e",id:"a-\u7c7b\u58f0\u660e",level:5},{value:"B init \u65b9\u6cd5",id:"b-init-\u65b9\u6cd5",level:5},{value:"4) Future \u548c Promise",id:"4-future-\u548c-promise",level:4},{value:"\uff08\u56db\uff09\u62d3\u5c55\u7bc7",id:"\u56db\u62d3\u5c55\u7bc7",level:2},{value:"1\u3001\u5fc3\u8df3\u68c0\u6d4b",id:"1\u5fc3\u8df3\u68c0\u6d4b",level:3},{value:"2\u3001TCP \u7c98\u5305\u62c6\u5305",id:"2tcp-\u7c98\u5305\u62c6\u5305",level:3},{value:"3\u3001\u5e8f\u5217\u5316\u6846\u67b6\u2014\u2014protobuf",id:"3\u5e8f\u5217\u5316\u6846\u67b6protobuf",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"netty-\u7f51\u7edc\u6846\u67b6",children:"Netty \u7f51\u7edc\u6846\u67b6"})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e00-\u57fa\u7840\u7bc7",children:"\uff08\u4e00\uff09 \u57fa\u7840\u7bc7"}),"\n",(0,l.jsx)(n.h3,{id:"1io-\u57fa\u7840",children:"1\u3001I/O \u57fa\u7840"}),"\n",(0,l.jsx)(n.p,{children:"\u8f93\u5165\u6d41\uff1aInputStream \u548c Reader\r\n\u8f93\u51fa\u6d41\uff1aOutputStream \u548c Writer"}),"\n",(0,l.jsx)(n.p,{children:"\u200b \u5b57\u8282\u6d41 \u5b57\u7b26\u6d41"}),"\n",(0,l.jsx)(n.p,{children:"\u8ba1\u7b97\u673a\u6700\u5c0f\u7684\u4e8c\u8fdb\u5236\u5355\u4f4d bit \u6bd4\u7279 \u4ee3\u8868 0 \u548c 1\r\n\u5b57\u8282 1 byte = 8bit \u8ba1\u7b97\u673a\u5904\u7406\u7684\u6700\u5c0f\u5355\u4f4d\r\n\u5b57\u7b26 1 char = 2byte = 16bit \u4eba\u5904\u7406\u7684\u6700\u5c0f\u5355\u4f4d"}),"\n",(0,l.jsx)(n.p,{children:"\u6240\u4ee5\uff0c\u5b57\u8282\u6d41\u5904\u7406\u6587\u4ef6\u3001\u56fe\u7247\u3001\u89c6\u9891\u7b49\u4e8c\u8fdb\u5236\u6570\u636e\uff0c\u800c\u5b57\u7b26\u6d41\u5904\u7406\u6587\u672c\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"2socket",children:"2\u3001Socket"}),"\n",(0,l.jsx)(n.p,{children:"\u539f\u610f\u662f\u201c\u63d2\u5ea7\u201d\uff0c\u5728\u8ba1\u7b97\u673a\u9886\u57df\u4e2d\uff0c\u7ffb\u8bd1\u4e3a\u201c\u5957\u63a5\u5b57\u201d\u3002\r\n\u672c\u8d28\u4e0a\uff0c\u662f\u8ba1\u7b97\u673a\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\u7684\u4e00\u79cd\u65b9\u5f0f\u3002"}),"\n",(0,l.jsx)(n.p,{children:'Linux\uff0c\u201c\u4e00\u5207\u7686\u6587\u4ef6\u201d\uff0c\u7ed9\u6bcf\u4e2a\u6587\u4ef6\u6620\u5c04\u4e00\u4e2a ID\uff0c\u53eb\u505a"\u6587\u4ef6\u63cf\u8ff0\u7b26"\u3002\r\n\u5f53\u5904\u7406\u7f51\u7edc\u8fde\u63a5\u65f6\uff0c\u4e5f\u4f1a\u770b\u6210\u4e00\u4e2a\u6587\u4ef6\uff0cread/write \u53d8\u6210\u548c\u8fdc\u7a0b\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002'}),"\n",(0,l.jsx)(n.p,{children:"OSI \u4e03\u5c42\u6a21\u578b = Open System Interconnection \u5f00\u653e\u5f0f\u7cfb\u7edf\u4e92\u8054\r\n\u4ece\u4e0b\u5230\u4e0a\u5206\u522b\u4e3a\uff1a\u7269\u7406\u5c42\u3001\u6570\u636e\u94fe\u8def\u5c42\u3001\u7f51\u7edc\u5c42\u3001\u4f20\u8f93\u5c42\u3001\u4f1a\u8bdd\u5c42\u3001\u8868\u793a\u5c42\u548c\u5e94\u7528\u5c42\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9e\u9645\u5e94\u7528\u7684\u662f\u4f18\u5316\u540e\u7684 TCP/IP \u6a21\u578b\uff08\u56db\u5c42\uff09\r\n\u7f51\u7edc\u63a5\u53e3\u5c42/\u94fe\u8def\u5c42\u3001\u7f51\u7edc\u5c42\u3001\u4f20\u8f93\u5c42\u3001\u5e94\u7528\u5c42"}),"\n",(0,l.jsx)(n.p,{children:"\u5e94\u7528\u5c42\u534f\u8bae\uff1aHTTP\u3001FTP\u3001SMTP\uff08\u90ae\u4ef6\u534f\u8bae\uff09\r\n\u4f20\u8f93\u5c42\u534f\u8bae\uff1aTCP\u3001UDP"}),"\n",(0,l.jsx)(n.p,{children:"Socket \u5176\u5b9e\u662f\u5e94\u7528\u5c42\u4e0e\u4f20\u8f93\u5c42\u4e4b\u95f4\u7684\u62bd\u8c61\u5c42\uff0c\u662f\u4e00\u7ec4\u63a5\u53e3\u3002\r\n\u5728\u8bbe\u8ba1\u6a21\u5f0f\u4e2d\uff0c\u662f\u95e8\u9762\u6a21\u5f0f\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"3nio",children:"3\u3001NIO"}),"\n",(0,l.jsx)(n.p,{children:"BIO - BlockingIO \u540c\u6b65\u963b\u585e\r\nNIO - New IO / Non-Blocking IO \u540c\u6b65\u975e\u963b\u585e\r\nAIO - Asynchronous IO \u5f02\u6b65\u975e\u963b\u585e"}),"\n",(0,l.jsx)(n.p,{children:"\u540c\u6b65\u548c\u5f02\u6b65\uff0c\u5173\u6ce8\u7684\u662f\u6d88\u606f\u901a\u77e5\u7684\u673a\u5236\r\n\u963b\u585e\u548c\u975e\u963b\u585e\uff0c\u5173\u6ce8\u7684\u662f\u7b49\u5f85\u6d88\u606f\u8fc7\u7a0b\u4e2d\u7684\u72b6\u6001"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/a9f7483239a5b5cc156b9ad28c1cbdc7.png",alt:"image-20220412192629185"})}),"\n",(0,l.jsx)(n.p,{children:"\u591a\u8def\u590d\u7528\u7684\u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/5f7d0e6f113c2501fa1c17a850a306dc.png",alt:"image-20220412192637464"})}),"\n",(0,l.jsx)(n.p,{children:"\u4e09\u5927\u5143\u7d20\uff1aChannel \u3001Buffer\u3001Selector"}),"\n",(0,l.jsx)(n.h4,{id:"1-channel",children:"1) Channel"}),"\n",(0,l.jsx)(n.p,{children:"FileChannel \u6587\u4ef6\u7ba1\u9053\u7684\u6570\u636e\r\nPipe.SinkChannel\r\nPipe.SourceChannel \u7ebf\u7a0b\u95f4\u901a\u4fe1\u7684\u7ba1\u9053\r\nServerSocketChannel\r\nSocketChannel \u7528\u4e8e TCP \u7f51\u7edc\u901a\u4fe1\u7684\u7ba1\u9053\r\nDatagramChannel \u7528\u4e8e UDP \u7f51\u7edc\u901a\u4fe1\u7684\u7ba1\u9053"}),"\n",(0,l.jsx)(n.h4,{id:"2-buffer",children:"2) Buffer"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/99d6a5a18cd285ba16eb20cba178a78a.png",alt:"image-20220412192652620"})}),"\n",(0,l.jsx)(n.p,{children:"capacity \u603b\u4f53\u5bb9\u91cf\u5927\u5c0f\r\nlimit \u5b58\u50a8\u5bb9\u91cf\u7684\u5927\u5c0f\uff0c\u662f\u53ef\u8bfb\u5199\u548c\u4e0d\u53ef\u8bfb\u5199\u7684\u754c\u7ebf\r\nposition \u5df2\u8bfb\u5bb9\u91cf\u7684\u5927\u5c0f\uff0c\u5df2\u8bfb\u548c\u672a\u8bfb\u533a\u57df\u7684\u754c\u7ebf"}),"\n",(0,l.jsx)(n.p,{children:"\u3010\u4f7f\u7528\u539f\u7406\u3011\r\na) \u521d\u59cb\u5316\uff0c\u7ed9\u5b9a\u603b\u5bb9\u91cf\uff0cposition=0, limit=capacity\r\nb) \u5f53\u4f7f\u7528 put \u65b9\u6cd5\u5b58\u5165\u6570\u636e\u662f\uff0c\u901a\u8fc7 position \u6765\u8bb0\u5f55\u5b58\u50a8\u7684\u5bb9\u91cf\u53d8\u5316\uff0cposition \u4e0d\u65ad\u540e\u79fb\uff0c\u76f4\u5230\u5b58\u50a8\u7ed3\u675f\uff08\u5199\u5b8c\u6210\uff09\r\nc\uff09\u5199\u5b8c\u6210\u9700\u8981\u8c03\u7528 flip \u65b9\u6cd5\u5237\u65b0\uff0climit=position\uff0cposition=0\r\n\u4fdd\u969c limit \u8bb0\u5f55\u7684\u662f\u53ef\u8bfb\u5199\u533a\u57df\u7684\u5927\u5c0f\uff0cposition \u5df2\u8bfb\u90e8\u5206\u91cd\u7f6e\u4e3a\u7a7a\r\nd) \u8bfb\u6570\u636e\u76f4\u5230\u8bfb\u5b8c\u6210\uff0c\u9700\u8981\u8c03\u7528 clear \u65b9\u6cd5\uff0cposition=0, limit=capacity"}),"\n",(0,l.jsx)(n.h4,{id:"3-selector",children:"3) Selector"}),"\n",(0,l.jsx)(n.p,{children:"\u4e09\u4e2a\u5143\u7d20\uff1a Selector \u9009\u62e9\u5668\u3001SelectableChannel \u53ef\u9009\u62e9\u7684\u901a\u9053\u3001SelectionKey \u9009\u62e9\u952e"}),"\n",(0,l.jsx)(n.p,{children:"\u672c\u8d28\u4e0a\uff0cSelector \u662f\u76d1\u542c\u5668\uff0c\u76d1\u542c\u7684\u662f\u901a\u9053\u662f\u5426\u6709\u6211\u4eec\u5173\u5fc3\u7684\u64cd\u4f5c\u4ea7\u751f\uff0c\u64cd\u4f5c\u5bf9\u5e94\u7684\u662f\u4e8b\u4ef6\uff08\u8fde\u63a5\u3001\u63a5\u6536\u3001\u8bfb/\u5199\uff09\uff0c\u4f7f\u7528 SelectionKey \u4ee3\u8868\u5177\u4f53\u7684\u4e8b\u4ef6\uff0c\u5728\u786e\u4fdd\u901a\u9053\u662f\u53ef\u9009\u62e9\u7684\u60c5\u51b5\u4e0b\uff0c\u5c06\u901a\u9053\u6ce8\u518c\u8fdb\u9009\u62e9\u5668\u4e2d\uff0c\u6b64\u65f6 Selector \u7ef4\u62a4\u7684\u662f\uff0c\u901a\u9053\u548c\u4e8b\u4ef6\u4e4b\u95f4\u7684\u5173\u8054\u5173\u7cfb\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/eaa6ae4668a20fc0c2daec742f7a8f41.png",alt:"image-20220412192659118"})}),"\n",(0,l.jsx)(n.p,{children:"Selector\uff0c\u7ba1\u7406\u88ab\u6ce8\u518c\u7684\u901a\u9053\u96c6\u5408\uff0c\u4ee5\u53ca\u4ed6\u4eec\u7684\u72b6\u6001\r\nSelectableChannel\uff0c\u662f\u4e00\u4e2a\u62bd\u8c61\u7c7b\uff0c\u63d0\u4f9b\u4e86\u901a\u9053\u53ef\u88ab\u9009\u62e9\u9700\u8981\u5b9e\u73b0\u7684 api\u3002\r\nFileChannel \u5c31\u4e0d\u662f\u53ef\u9009\u62e9\u7684\uff0cSocket \u76f8\u5173\u7684\u901a\u9053\u90fd\u662f\u53ef\u9009\u62e9\u7684\r\n\u4e00\u4e2a\u901a\u9053\u53ef\u4ee5\u88ab\u6ce8\u518c\u5230\u591a\u4e2a\u9009\u62e9\u5668\u4e0a\u5417\uff1f \u53ef\u4ee5\u7684\r\n\u591a\u4e2a\u901a\u9053\u53ef\u4ee5\u6ce8\u518c\u5230\u4e00\u4e2a\u9009\u62e9\u5668\u4e0a\uff0c\u4f46\u4e00\u4e2a\u901a\u9053\u53ea\u80fd\u5728\u4e00\u4e2a\u9009\u62e9\u5668\u4e2d\u6ce8\u518c\u4e00\u6b21"}),"\n",(0,l.jsx)(n.p,{children:"SelectionKey\uff0c\u5c01\u88c5\u4e86\u8981\u76d1\u542c\u7684\u4e8b\u4ef6\uff0c\u8fde\u63a5\u3001\u63a5\u6536\u3001\u8bfb\u3001\u5199\u3002\r\n\u4e00\u65b9\u9762\uff0cSelector \u5173\u5fc3\u901a\u9053\u8981\u5904\u7406\u54ea\u4e9b\u4e8b\u4ef6\r\n\u53e6\u4e00\u65b9\u9762\uff0c\u5f53\u4e8b\u4ef6\u89e6\u53d1\u65f6\uff0c\u901a\u9053\u8981\u5904\u7406\u54ea\u4e9b\u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:"\u3010\u4f7f\u7528\u65b9\u5f0f\u3011"}),"\n",(0,l.jsx)(n.p,{children:"a\u3001\u9996\u5148\u901a\u8fc7 open \u65b9\u6cd5\uff0c\u83b7\u53d6\u901a\u9053\uff0c\u5c06\u901a\u9053\u8bbe\u7f6e\u4e3a\u975e\u963b\u585e\u7684\r\nb\u3001\u901a\u8fc7 open \u65b9\u6cd5\uff0c\u83b7\u53d6\u9009\u62e9\u5668\uff0c\u5c06\u901a\u9053\u6ce8\u518c\u8fdb\u9009\u62e9\u5668\u4e2d\uff0c\u4f34\u968f\u8bbe\u7f6e\u901a\u9053\u8981\u5904\u7406\u7684\u4e8b\u4ef6(OP_ACCEPT)\r\nc\u3001\u8f6e\u8be2\u9009\u62e9\u5668\uff0c\u5f53\u524d\u662f\u5426\u6709\u8981\u5904\u7406\u7684\u64cd\u4f5c select() > 0?\r\n\u5982\u679c\u6709\uff0c\u8981\u83b7\u53d6\uff0c\u5f85\u5904\u7406\u64cd\u4f5c\u7684\u96c6\u5408 Set<SelectionKey> , \u8fdb\u884c\u904d\u5386\r\n\u904d\u5386\u5230 SelectionKey \u65f6\uff0c\u5224\u65ad\u5bf9\u5e94\u54ea\u79cd\u64cd\u4f5c\uff0c\u4e0d\u540c\u7684\u64cd\u4f5c\u8bbe\u7f6e\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\r\n\u5982 OP_ACCEPT\uff0c\u63a5\u6536\u5ba2\u6237\u7aef\u901a\u9053\u5e76\u8fdb\u884c\u6ce8\u518c\uff0c\u76d1\u542c\u540e\u7eed\u5904\u7406\u7684\u4e8b\u4ef6\uff0c\u5982 OP_WRITE\r\n\u5982 OP_WRITE\uff0c\u901a\u8fc7 key \u7684\u65b9\u6cd5\u83b7\u53d6\u901a\u9053\u672c\u8eab\uff0c\u8bfb\u53d6\u6570\u636e\u5e76\u7ee7\u7eed\u76d1\u542c\u4e8b\u4ef6\uff0c\u5982 OP_READ"}),"\n",(0,l.jsx)(n.p,{children:"\u200b"}),"\n",(0,l.jsx)(n.h3,{id:"4\u96f6\u62f7\u8d1d",children:"4\u3001\u96f6\u62f7\u8d1d"}),"\n",(0,l.jsx)(n.p,{children:"\u9700\u6c42\uff1a\u5c06\u78c1\u76d8\u4e2d\u7684\u6587\u4ef6\u8bfb\u53d6\u51fa\u6765\uff0c\u901a\u8fc7 socket \u53d1\u9001\u51fa\u53bb"}),"\n",(0,l.jsx)(n.p,{children:"\u4f20\u7edf\u7684\u62f7\u8d1d\u65b9\u5f0f\uff084 \u6b21\uff09\r\nSocket \u7f51\u7edc\u7f13\u51b2\u533a\uff0c\u4e5f\u5c5e\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u6838\u7f13\u51b2\u533a\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/c4d403fd8d9721f7ae8103ec24ab582b.png",alt:"image-20220412192706450"})}),"\n",(0,l.jsx)(n.p,{children:"\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8fdb\u884c\u7684\u62f7\u8d1d\uff08\u5982\u7b2c\u4e8c\u6b21\u548c\u7b2c\u4e09\u6b21\uff09\uff0c\u53eb\u505a CPU \u62f7\u8d1d\u3002\r\n\u8fde\u63a5\u78c1\u76d8\u6216\u7f51\u5361\u7b49\u786c\u4ef6\u7684\u62f7\u8d1d\uff08\u5982\u7b2c\u4e00\u6b21\u548c\u7b2c\u56db\u6b21\uff09\uff0c\u53eb\u505a DMA \u62f7\u8d1d\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u96f6\u62f7\u8d1d\u7684\u6982\u5ff5\uff1a\u51cf\u5c11 CPU \u62f7\u8d1d\u7684\u6b21\u6570\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u96f6\u62f7\u8d1d\u662f\u57fa\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u7684\u4f18\u5316\u65b9\u5f0f\uff08\u4ee5\u4e0b\u57fa\u4e8e Linux \u7cfb\u7edf\uff09"}),"\n",(0,l.jsx)(n.p,{children:"1\uff09 mmap = memory mapping \u5185\u5b58\u6620\u5c04"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/47ab101c5b20875673171781b57abd27.png",alt:"image-20220412192746768"})}),"\n",(0,l.jsx)(n.p,{children:"2\uff09sendfile (linux2.1 \u5185\u6838\u652f\u6301)"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/e4deb91ce6d01b26260a766d0d8f9b5e.png",alt:"image-20220412192758187"})}),"\n",(0,l.jsxs)(n.ol,{start:"3",children:["\n",(0,l.jsx)(n.li,{children:"sendfile with scatter/gather copy\uff08\u6279\u91cf sendfile\uff09\r\n\u4ece\u5355\u4e2a\u6587\u4ef6\u7684\u5904\u7406\uff0c\u4e0a\u5347\u5230\u591a\u4e2a\u7269\u7406\u5730\u5740\u7684\u5904\u7406\uff0c\u63d0\u9ad8\u5904\u7406\u901f\u5ea6"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"4\uff09splice \uff08\u62fc\u63a5\uff0c\u5728 linux2.6 \u5185\u6838\u652f\u6301\uff09"}),"\n",(0,l.jsx)(n.p,{children:"\u200b \u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7f13\u51b2\u533a\u548c Socket \u7f51\u7edc\u7f13\u51b2\u533a\u4e4b\u95f4\u5efa\u7acb\u7ba1\u9053\uff0c\u6765\u51cf\u5c11\u62f7\u8d1d\u6b21\u6570\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/d346c3850ee5f27c4adf435a5a59184d.png",alt:"image-20220412192804981"})}),"\n",(0,l.jsx)(n.h3,{id:"\u7ebf\u7a0b\u6a21\u578b",children:"\u7ebf\u7a0b\u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/6f0d5f3f4a671dae4341a3dce89b3687.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsx)(n.h5,{id:"1-\u5355\u7ebf\u7a0b-reactor-\u6a21\u578b",children:"1\uff09 \u5355\u7ebf\u7a0b Reactor \u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:"\u987e\u540d\u601d\u4e49 \u5c31\u662f\u4f7f\u7528\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\u95ee\u9898 \u7ebf\u7a0b\u4e2d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"selector"}),"\n",(0,l.jsx)(n.li,{children:"\u4e8b\u4ef6\u5904\u7406 : \u8fde\u63a5\u4e8b\u4ef6"}),"\n",(0,l.jsx)(n.li,{children:"\u5904\u7406\u4e8b\u4ef6\uff1ahandler"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u5355\u7ebf\u7a0b\u670d\u52a1\u5668"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class ReactorServer {\r\n    private Selector selector;\r\n    private ServerSocketChannel serverSocketChannel;\r\n\r\n    public ReactorServer() {\r\n        try {\r\n            // \u521d\u59cb\u5316\u76d1\u542c\u5668 \u4e0e channel \u901a\u9053\r\n            selector = Selector.open();\r\n            serverSocketChannel = ServerSocketChannel.open();\r\n            // \u914d\u7f6e\u4e3a\u975e\u963b\u585e\u7684\r\n            serverSocketChannel.configureBlocking(false);\r\n\r\n            // \u914d\u7f6e\u901a\u9053\u8fde\u63a5\u5730\u5740 \u5f00\u653e 9090 \u7aef\u53e3\r\n            SocketAddress address = new InetSocketAddress(9090);\r\n            serverSocketChannel.socket().bind(address);\r\n\r\n            //\u5c06channel \u6ce8\u518c\u5230 selector\u76d1\u542c\u901a\u9053\u4e8b\u4ef6  \u8fbe\u5230\u591a\u8def\u590d\u7528\r\n            //\u9996\u4e2a\u6ce8\u518c\u4e8b\u4ef6\u4e00\u822c\u90fd\u662f accept \u8fde\u63a5\u4e8b\u4ef6\r\n            SelectionKey key = serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\r\n\r\n            //    \u521b\u5efa\u5904\u7406\u8fde\u63a5\u4e8b\u4ef6\u7684 acceptor\r\n            // \u540c\u65f6 \u521b\u5efa\u5904\u7406\u5668 \u63a5\u53d7\u540e\u5e8f\u7684IO\u8bfb\u5199\u4e8b\u4ef6\uff0c\u4e0d\u65ad\u7684\u904d\u5386 \u662f\u5426\u6709\u4e8b\u60c5\u53d1\u751f\r\n            Acceptor acceptor = new Acceptor(selector, serverSocketChannel);\r\n            //\u9644\u52a0\u4e00\u4e2a\u5bf9\u8c61 \u7528\u6765\u5904\u7406\u4e8b\u4ef6\r\n            key.attach(acceptor);\r\n            while (true) {\r\n                //\u8fd4\u56de\u4e8b\u4ef6\u7684\u4e2a\u6570 \u5904\u7406\u4e8b\u4ef6\r\n                int num = selector.select();\r\n                if (num == 0) {\r\n                    continue;\r\n                }\r\n                //\u6ca1\u6709\u8df3\u8fc7\u5c31\u4ee3\u8868\u6709\u4e8b\u4ef6\u9700\u8981\u5904\u7406\uff0c\u62ff\u5230\u4e8b\u4ef6\u96c6\u5408\r\n                Set<SelectionKey> SKeyset = selector.selectedKeys();\r\n                Iterator<SelectionKey> iterator = SKeyset.iterator();\r\n                while (iterator.hasNext()) {\r\n                    SelectionKey selectionKey = iterator.next();\r\n                    //\u62ff\u5230\u4e8b\u4ef6\u7684\u7b2c\u4e00\u4e8b\u60c5 \u79fb\u51fa\u4e8b\u4ef6 \u907f\u514d\u91cd\u590d\u5904\u7406\r\n                    iterator.remove();\r\n                    //\u6839\u636e\u4e8b\u4ef6\u7c7b\u578b \u5206\u53d1 \u7ed9\u76d1\u542c\u5668\u5904\u7406\r\n                    //\u9700\u8981\u5904\u7406\u4e8b\u60c5\u7684\u65f6\u5019 \u53d6\u51fa\u5b58\u50a8\u7684\u5bf9\u8c61\r\n                    //\u5982\u6709\u63a5\u6536\u7684\u65f6Accpet \u4e8b\u4ef6 \u83b7\u53d6\u7684\u5c31\u662fAcceptor \u4e8b\u4ef6\r\n                    //\u5982\u679c\u63a5\u53d7\u7684\u65f6\u8bfb\u5199\u4e8b\u4ef6 \u83b7\u53d6\u7684\u5c31\u662f Handler \u4e8b\u4ef6\r\n                    Runnable runnable = (Runnable) key.attachment();\r\n                    runnable.run();\r\n                }\r\n            }\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n\r\n    public static void main(String[] args) {\r\n\r\n    }\r\n}\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"Accpetor \u8fde\u63a5\u4e8b\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class Acceptor implements Runnable {\r\n    private Selector selector;\r\n    private ServerSocketChannel serverSocketChannel;\r\n\r\n    public Acceptor(Selector selector, ServerSocketChannel serverSocketChannel) {\r\n        this.selector = selector;\r\n        this.serverSocketChannel = serverSocketChannel;\r\n    }\r\n\r\n    @Override\r\n    public void run() {\r\n        try {\r\n            //\u63a5\u53d7\u5ba2\u6237\u7aef\u4f20\u5165\u7684\u8fde\u63a5\u65f6 Socket Channel\r\n            SocketChannel socketChannel = serverSocketChannel.accept();\r\n            //\u8bbe\u7f6e\u5f02\u6b65\r\n            socketChannel.configureBlocking(false);\r\n            SelectionKey key = socketChannel.register(selector, SelectionKey.OP_READ);\r\n            // \u521b\u9020\u5904\u7406\u5668 \u5904\u7406\u8fde\u63a5\r\n            //\u5355\u7ebf\u7a0b\r\n            //Handler handler = new Handler(key);\r\n            //\u591a\u7ebf\u7a0b\r\n            MultHandler handler = new MultHandler(key);\r\n            handler.run();\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n\r\n    }\r\n}\r\n\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"Handler \u5355\u7ebf\u7a0b\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class Handler implements Runnable {\r\n    private SelectionKey key;\r\n    private State state;\r\n\r\n    public Handler(SelectionKey key) {\r\n        this.key = key;\r\n        this.state = State.READ;\r\n    }\r\n\r\n    @Override\r\n\r\n    public void run() {\r\n        //\u5904\u7406 \u8bfb\u5199\u64cd\u4f5c\uff0c\u5224\u65ad\u8bfb\u5199\r\n        switch (state) {\r\n            case READ:\r\n                read();\r\n                break;\r\n            case WRITE:\r\n                write();\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n\r\n\r\n    /*\u8f6e\u6d41\u5904\u7406\u672b\u5c3e\u6dfb\u52a0\u4e8b\u4ef6\u8fbe\u5230\u5faa\u73af\u5904\u7406*/\r\n    //\u5904\u7406 \u8bfb\u65b9\u6cd5\r\n    private void read() {\r\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\r\n        //    \u901a\u8fc7\u901a\u9053\u83b7\u53d6KEY\r\n        SocketChannel channel = (SocketChannel) key.channel();\r\n        try {\r\n            //\u5c06\u4f20\u5165\u7684\u6570\u636e\u5199\u5165\u5230buffer\u4e2d\r\n            int num = channel.read(buffer);\r\n            //    \u8f6c\u5316\u6210String\r\n            String msg = new String(buffer.array());\r\n            //    \u589e\u52a0\u4e1a\u52a1\u5904\u7406\r\n            //    \u7ee7\u7eed\u5904\u7406\u6ce8\u518c\u5199\u4e8b\u4ef6\r\n            key.interestOps(SelectionKey.OP_WRITE);\r\n            this.state = State.WRITE;\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n\r\n    //\u5904\u7406 \u5199\u65b9\u6cd5\r\n    private void write() {\r\n        ByteBuffer buffer = ByteBuffer.wrap("hello".getBytes());\r\n        try {\r\n            //    \u901a\u8fc7\u901a\u9053\u83b7\u53d6KEY\r\n            SocketChannel channel = (SocketChannel) key.channel();\r\n            channel.write(buffer);\r\n            //    \u7ee7\u7eed\u5904\u7406\u6ce8\u518c\u5199\u4e8b\u4ef6\r\n            key.interestOps(SelectionKey.OP_READ);\r\n            this.state = State.READ;\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n\r\n    }\r\n\r\n    //\u8bb0\u5f55\u72b6\u6001 \u975e\u8bfb\u5373\u5199\r\n    private enum State {\r\n        //\u8bfb\u5199\u4e8b\u4ef6\r\n        READ, WRITE\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(n.h5,{id:"2\u591a\u7ebf\u7a0b-reactor-\u6a21\u578b",children:"2\uff09\u591a\u7ebf\u7a0b Reactor \u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:"\u63d0\u9ad8 handler \u7684\u5904\u7406\u6548\u7387\uff0c\u9996\u5148 handler \u4e0d\u518d\u8d1f\u8d23\u5177\u4f53\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u5f53\u8bfb\u53d6\u51fa\u6570\u636e\u540e\uff0c\u5206\u53d1\u7ed9\u5b50\u7ebf\u7a0b\u5904\u7406\uff0c\u5b50\u7ebf\u7a0b\u5904\u7406\u5b8c\u6210\u540e\u518d\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 handler\uff0chandler \u518d\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16-1680866877502990.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u591a\u7ebf\u7a0b\u5904\u7406 \uff08handler \u4f7f\u7528\u7ebf\u7a0b\u6c60\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class MultHandler implements Runnable {\r\n    private SelectionKey key;\r\n    private State state;\r\n\r\n    private ExecutorService pool;\r\n\r\n    public MultHandler(SelectionKey key) {\r\n        this.key = key;\r\n        this.state = State.READ;\r\n    }\r\n\r\n    @Override\r\n\r\n    public void run() {\r\n        //\u5904\u7406 \u8bfb\u5199\u64cd\u4f5c\uff0c\u5224\u65ad\u8bfb\u5199\r\n        switch (state) {\r\n            case READ:\r\n                //\u5c06\u6700\u8017\u65f6\u7684\u64cd\u4f5c \u653e\u5165\u7ebf\u7a0b\u6c60\u6267\u884c\r\n                pool.execute(new Runnable() {\r\n                    @Override\r\n                    public void run() {\r\n                        read();\r\n                    }\r\n                });\r\n                break;\r\n            case WRITE:\r\n                write();\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n\r\n\r\n    /*\u8f6e\u6d41\u5904\u7406\u672b\u5c3e\u6dfb\u52a0\u4e8b\u4ef6\u8fbe\u5230\u5faa\u73af\u5904\u7406*/\r\n    //\u5904\u7406 \u8bfb\u65b9\u6cd5\r\n    private void read() {\r\n        ByteBuffer buffer = ByteBuffer.allocate(1024);\r\n        //    \u901a\u8fc7\u901a\u9053\u83b7\u53d6KEY\r\n        SocketChannel channel = (SocketChannel) key.channel();\r\n        try {\r\n            //\u5c06\u4f20\u5165\u7684\u6570\u636e\u5199\u5165\u5230buffer\u4e2d\r\n            int num = channel.read(buffer);\r\n            //    \u8f6c\u5316\u6210String\r\n            String msg = new String(buffer.array());\r\n            //    \u589e\u52a0\u4e1a\u52a1\u5904\u7406\r\n            //    \u7ee7\u7eed\u5904\u7406\u6ce8\u518c\u5199\u4e8b\u4ef6\r\n            key.interestOps(SelectionKey.OP_WRITE);\r\n            this.state = State.WRITE;\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n\r\n    //\u5904\u7406 \u5199\u65b9\u6cd5\r\n    private void write() {\r\n        ByteBuffer buffer = ByteBuffer.wrap("hello".getBytes());\r\n        try {\r\n            //    \u901a\u8fc7\u901a\u9053\u83b7\u53d6KEY\r\n            SocketChannel channel = (SocketChannel) key.channel();\r\n            channel.write(buffer);\r\n            //    \u7ee7\u7eed\u5904\u7406\u6ce8\u518c\u5199\u4e8b\u4ef6\r\n            key.interestOps(SelectionKey.OP_READ);\r\n            this.state = State.READ;\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n\r\n    }\r\n\r\n    //\u8bb0\u5f55\u72b6\u6001 \u975e\u8bfb\u5373\u5199\r\n    private enum State {\r\n        //\u8bfb\u5199\u4e8b\u4ef6\r\n        READ, WRITE\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(n.h5,{id:"3\u4e3b\u4ece-reactor-\u6a21\u578b",children:"3\uff09\u4e3b\u4ece Reactor \u6a21\u578b"}),"\n",(0,l.jsx)(n.p,{children:"mainReactor \u7528\u6765\u63a5\u6536\u8fde\u63a5\u4e8b\u4ef6\uff0c\u7136\u540e\u5206\u53d1\u7ed9 acceptor\uff0cacceptor \u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\uff0c\u76f4\u63a5\u5c06\u540e\u7eed\u7684\u8bfb\u5199\u4e8b\u4ef6\uff0c\u6ce8\u518c\u5230 slaveReactor \u4e4b\u4e2d\uff0c\u4ee5\u6b64\u6765\u8fbe\u5230\u5206\u6d41\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/49645d17e759824fa2862d2c7b0778c2.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u4ece\u76d1\u542c\u5668"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"//\u4e3b\u4ece\u6a21\u578b\r\npublic class MultReactorServer {\r\n    private Selector mainselector;\r\n    private Selector slaveselector;\r\n    private ServerSocketChannel serverSocketChannel;\r\n\r\n    public MultReactorServer() {\r\n        try {\r\n            // \u4e3b reactor \u5904\u7406\u8fde\u63a5\u4e8b\u4ef6\r\n            mainselector = Selector.open();\r\n            //\u4ecereactor \u5904\u7406\u8bfb\u5199\u4e8b\u4ef6\r\n            slaveselector = Selector.open();\r\n            // \u914d\u7f6e\u4e3a\u975e\u963b\u585e\u7684\r\n            serverSocketChannel.configureBlocking(false);\r\n\r\n            // \u914d\u7f6e\u901a\u9053\u8fde\u63a5\u5730\u5740 \u5f00\u653e 9090 \u7aef\u53e3\r\n            SocketAddress address = new InetSocketAddress(9090);\r\n            serverSocketChannel.socket().bind(address);\r\n\r\n            //\u5c06channel \u6ce8\u518c\u5230 selector\u76d1\u542c\u901a\u9053\u4e8b\u4ef6  \u8fbe\u5230\u591a\u8def\u590d\u7528\r\n            //\u9996\u4e2a\u6ce8\u518c\u4e8b\u4ef6\u4e00\u822c\u90fd\u662f accept \u8fde\u63a5\u4e8b\u4ef6 \uff08\u53c2\u6570\u53d8\u5316\uff09\r\n            SelectionKey key = serverSocketChannel.register(mainselector, SelectionKey.OP_ACCEPT);\r\n            //    \u521b\u5efa\u5904\u7406\u8fde\u63a5\u4e8b\u4ef6\u7684 acceptor\r\n            // \u540c\u65f6 \u521b\u5efa\u5904\u7406\u5668 \u63a5\u53d7\u540e\u5e8f\u7684IO\u8bfb\u5199\u4e8b\u4ef6\uff0c\u4e0d\u65ad\u7684\u904d\u5386 \u662f\u5426\u6709\u4e8b\u60c5\u53d1\u751f \uff08\u53c2\u6570\u53d8\u5316\uff09\r\n            Acceptor acceptor = new Acceptor(slaveselector, serverSocketChannel);\r\n            //\u9644\u52a0\u4e00\u4e2a\u5bf9\u8c61 \u7528\u6765\u5904\u7406\u4e8b\u4ef6\r\n            key.attach(acceptor);\r\n            //\u4e3b\u4ece\u76d1\u542c\u903b\u8f91\u5206\u79bb\r\n            new HandlerLoop(slaveselector).run();\r\n            while (true) {\r\n                //\u8fd4\u56de\u4e8b\u4ef6\u7684\u4e2a\u6570 \u5904\u7406\u4e8b\u4ef6\r\n                int num = mainselector.select();\r\n                if (num == 0) {\r\n                    continue;\r\n                }\r\n                //\u6ca1\u6709\u8df3\u8fc7\u5c31\u4ee3\u8868\u6709\u4e8b\u4ef6\u9700\u8981\u5904\u7406\uff0c\u62ff\u5230\u4e8b\u4ef6\u96c6\u5408\r\n                Set<SelectionKey> SKeyset = mainselector.selectedKeys();\r\n                Iterator<SelectionKey> iterator = SKeyset.iterator();\r\n                while (iterator.hasNext()) {\r\n                    SelectionKey selectionKey = iterator.next();\r\n                    //\u62ff\u5230\u4e8b\u4ef6\u7684\u7b2c\u4e00\u4e8b\u60c5 \u79fb\u51fa\u4e8b\u4ef6 \u907f\u514d\u91cd\u590d\u5904\u7406\r\n                    iterator.remove();\r\n                    //\u6839\u636e\u4e8b\u4ef6\u7c7b\u578b \u5206\u53d1 \u7ed9\u76d1\u542c\u5668\u5904\u7406\r\n                    //\u9700\u8981\u5904\u7406\u4e8b\u60c5\u7684\u65f6\u5019 \u53d6\u51fa\u5b58\u50a8\u7684\u5bf9\u8c61\r\n                    //\u53ea\u5904\u7406\u4e3bReactor \u53ea\u5904\u7406\u8fde\u63a5\u4e8b\u4ef6\r\n                    Runnable runnable = (Runnable) key.attachment();\r\n                    runnable.run();\r\n                }\r\n            }\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n\r\n    }\r\n}\r\n\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u4e3b\u4ece\u4e8b\u4ef6\u5904\u7406\u8bfb\u5199\u5206\u79bb"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"//\u7528\u4e8e\u5904\u7406\u4ecereactor\u4e8b\u4ef6\u76d1\u542c\r\npublic class HandlerLoop implements Runnable {\r\n\r\n    private Selector selector;\r\n\r\n    public HandlerLoop(Selector selector) {\r\n        this.selector = selector;\r\n    }\r\n\r\n\r\n    @Override\r\n    public void run() {\r\n        try {\r\n            while (true) {\r\n                //\u8fd4\u56de\u4e8b\u4ef6\u7684\u4e2a\u6570 \u5904\u7406\u4e8b\u4ef6\r\n                int num = selector.select();\r\n                if (num == 0) {\r\n                    continue;\r\n                }\r\n                //\u6ca1\u6709\u8df3\u8fc7\u5c31\u4ee3\u8868\u6709\u4e8b\u4ef6\u9700\u8981\u5904\u7406\uff0c\u62ff\u5230\u4e8b\u4ef6\u96c6\u5408\r\n                Set<SelectionKey> SKeyset = selector.selectedKeys();\r\n                Iterator<SelectionKey> iterator = SKeyset.iterator();\r\n                while (iterator.hasNext()) {\r\n                    SelectionKey selectionKey = iterator.next();\r\n                    //\u62ff\u5230\u4e8b\u4ef6\u7684\u7b2c\u4e00\u4e8b\u60c5 \u79fb\u51fa\u4e8b\u4ef6 \u907f\u514d\u91cd\u590d\u5904\u7406\r\n                    iterator.remove();\r\n                    //\u6839\u636e\u4e8b\u4ef6\u7c7b\u578b \u5206\u53d1 \u7ed9\u76d1\u542c\u5668\u5904\u7406\r\n                    //\u9700\u8981\u5904\u7406\u4e8b\u60c5\u7684\u65f6\u5019 \u53d6\u51fa\u5b58\u50a8\u7684\u5bf9\u8c61\r\n                    //\u53ea\u5904\u7406\u4ecereactor \u6240\u4ee5 \u63a5\u53d7\u7684\u4e00\u5b9a\u662f\u8bfb\u5199\u4e8b\u4ef6\r\n                    Runnable runnable = (Runnable) selectionKey.attachment();\r\n                    runnable.run();\r\n                }\r\n            }\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n}\r\n\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e8c-\u5e94\u7528\u7bc7",children:"\uff08\u4e8c\uff09 \u5e94\u7528\u7bc7"}),"\n",(0,l.jsx)(n.h3,{id:"1http",children:"1\u3001HTTP"}),"\n",(0,l.jsx)(n.h4,{id:"1-09-\u7248\u672c",children:"1) 0.9 \u7248\u672c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"GET /index.html\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u53ea\u80fd\u8fd4\u56de html \u683c\u5f0f\uff0c\u4f20\u8f93\u8fc7\u7a0b\u53ea\u80fd\u5904\u7406\u6587\u5b57\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"2-10-\u7248\u672c",children:"2) 1.0 \u7248\u672c"}),"\n",(0,l.jsx)(n.p,{children:"\u652f\u6301\u4efb\u4f55\u683c\u5f0f\u7684\u5185\u5bb9\uff0c\u5305\u62ec\u56fe\u50cf\u3001\u89c6\u9891\u3001\u4e8c\u8fdb\u5236\u7b49\u7b49"}),"\n",(0,l.jsx)(n.p,{children:"\u5f15\u5165\u4e86 POST \u547d\u4ee4\u3001HEAD \u547d\u4ee4"}),"\n",(0,l.jsx)(n.p,{children:"\u589e\u52a0\u4e86\u8bf7\u6c42\u5934\u3001\u72b6\u6001\u7801\uff0c\u4ee5\u53ca\u6743\u9650\u3001\u7f13\u5b58\u7b49"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"GET / HTTP/1.0\r\nUser-Agent:Mozilla/1.0\r\nAccept: */*\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"HTTP/1.0 200 OK\r\nContent-Type: text/plain\r\nContent-Encoding: gzip\r\n\r\n<html>\r\n  <body> hello world </body>\r\n</html>\n"})}),"\n",(0,l.jsx)(n.p,{children:"a\u3001 Content-Type"}),"\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u901a\u77e5\u5ba2\u6237\u7aef\uff0c\u5f53\u524d\u6570\u636e\u7684\u683c\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u793a\u4f8b\uff1a text/html \u3001 image/png \u3001 application/pdf \u3001 video/mp4"}),"\n",(0,l.jsx)(n.p,{children:"\u524d\u9762\u662f\u4e00\u7ea7\u7c7b\u578b\uff0c\u540e\u9762\u662f\u4e8c\u7ea7\u7c7b\u578b\uff0c\u7528\u659c\u6760\u5206\u9694\uff1b \u8fd8\u53ef\u4ee5\u589e\u52a0\u5176\u4ed6\u53c2\u6570\uff0c\u5982\u7f16\u7801\u683c\u5f0f\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"Content-Type: text/plain; charset=utf-8\n"})}),"\n",(0,l.jsx)(n.p,{children:"b\u3001Content-Encoding"}),"\n",(0,l.jsx)(n.p,{children:"\u8868\u793a\u6570\u636e\u538b\u7f29\u7684\u65b9\u5f0f\uff0cgzip\u3001compress\u3001deflate"}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9\u5e94\u5ba2\u6237\u7aef\u7684\u5b57\u6bb5\u4e3a Accept-Encoding\uff0c\u4ee3\u8868\u63a5\u6536\u54ea\u4e9b\u538b\u7f29\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"c\u3001\u7f3a\u70b9\u548c\u95ee\u9898"}),"\n",(0,l.jsx)(n.p,{children:"\u6bcf\u4e2a TCP \u8fde\u63a5\u53ea\u80fd\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u53d1\u9001\u5b8c\u6bd5\u8fde\u63a5\u5173\u95ed\uff0c\u4f7f\u7528\u6210\u672c\u5f88\u9ad8\uff0c\u6027\u80fd\u8f83\u5dee\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"Connection: keep-alive   - \u975e\u6807\u51c6\u5b57\u6bb5\n"})}),"\n",(0,l.jsx)(n.h4,{id:"3-11-\u7248\u672c",children:"3) 1.1 \u7248\u672c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'GET / HTTP/1.1\r\nUser-Agent: PostmanRuntime/7.24.1\r\nAccept: */*\r\nCache-Control: no-cache\r\nPostman-Token: 636ce8a6-7eab-451a-8638-4534a3578095\r\nHost: cn.bing.com\r\nAccept-Encoding: gzip, deflate, br\r\nConnection: keep-alive\r\n\r\nHTTP/1.1 200 OK\r\nCache-Control: private, max-age=0\r\nContent-Length: 45786\r\nContent-Type: text/html; charset=utf-8\r\nContent-Encoding: br\r\nVary: Accept-Encoding\r\nP3P: CP="NON UNI COM NAV STA LOC CURa DEVa PSAa PSDa OUR IND"\r\nSet-Cookie: SRCHD=AF=NOFORM; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/\r\nSet-Cookie: SRCHUID=V=2&GUID=5C28FF778A2C4A00B32F5408147038BF&dmnchg=1; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/\r\nSet-Cookie: SRCHUSR=DOB=20200622; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/\r\nSet-Cookie: _SS=SID=23AE726877396796143D7C99761766C7; domain=.bing.com; path=/\r\nSet-Cookie: _EDGE_S=F=1&SID=23AE726877396796143D7C99761766C7; path=/; httponly; domain=bing.com\r\nSet-Cookie: _EDGE_V=1; path=/; httponly; expires=Sat, 17-Jul-2021 07:03:23 GMT; domain=bing.com\r\nSet-Cookie: MUID=1CB3B15BCBD2637E2C01BFAACAFC6214; samesite=none; path=/; secure; expires=Sat, 17-Jul-2021 07:03:23 GMT; domain=bing.com\r\nSet-Cookie: MUIDB=1CB3B15BCBD2637E2C01BFAACAFC6214; path=/; httponly; expires=Sat, 17-Jul-2021 07:03:23 GMT\r\nX-MSEdge-Ref: Ref A: 71D6F4B3BA9C448EB453341AC182C7BC Ref B: BJ1EDGE0311 Ref C: 2020-06-22T07:03:23Z\r\nDate: Mon, 22 Jun 2020 07:03:23 GMT\n'})}),"\n",(0,l.jsx)(n.p,{children:"a\u3001\u6301\u4e45\u8fde\u63a5\uff0c\u542b\u4e49\u4e3a\u9ed8\u8ba4\u4e0d\u5173\u95ed tcp \u8fde\u63a5\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8bf7\u6c42\u590d\u7528\u3002\u5927\u591a\u65f6\u5019\uff0c\u6d4f\u89c8\u5668\u5bf9\u540c\u4e00\u4e2a\u57df\u540d\uff0c\u5141\u8bb8\u540c\u65f6\u5efa\u7acb 6 \u4e2a\u8fde\u63a5\u3002"}),"\n",(0,l.jsx)(n.p,{children:"b\u3001\u7ba1\u9053\u673a\u5236\uff0c\u652f\u6301\u5ba2\u6237\u7aef\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\uff0c\u7ba1\u7406\u8bf7\u6c42\u7684\u987a\u5e8f\u7684\u3002\u670d\u52a1\u5668\u8fd8\u662f\u6309\u7167\u63a5\u53d7\u8bf7\u6c42\u7684\u987a\u5e8f\uff0c\u8fd4\u56de\u5bf9\u5e94\u7684\u54cd\u5e94\u7ed3\u679c\u3002"}),"\n",(0,l.jsx)(n.p,{children:"c\u3001Content-Length, \u7528\u6765\u533a\u5206\u6570\u636e\u5305\u7684\u91cd\u8981\u5b57\u6bb5"}),"\n",(0,l.jsx)(n.p,{children:"d\u3001\u652f\u6301 PUT\u3001DELETE\u3001PATCH \u7b49\u547d\u4ee4"}),"\n",(0,l.jsx)(n.p,{children:"\u7f3a\u70b9\u548c\u95ee\u9898"}),"\n",(0,l.jsx)(n.p,{children:'\u5f53\u90e8\u5206\u8bf7\u6c42\u8017\u65f6\u8f83\u957f\u65f6\uff0c\u4ecd\u4f1a\u963b\u585e\u540e\u7eed\u8bf7\u6c42\u7684\u5904\u7406\u901f\u5ea6\uff0c\u8fd9\u79cd\u73b0\u8c61\u53eb\u505a\u201c\u961f\u5934\u963b\u585e\u201d/"\u7ebf\u5934\u963b\u585e"\u3002'}),"\n",(0,l.jsx)(n.h4,{id:"4-20-\u7248\u672c",children:"4) 2.0 \u7248\u672c"}),"\n",(0,l.jsx)(n.p,{children:"\u89e3\u51b3\u961f\u5934\u963b\u585e\u7684\u95ee\u9898\uff0c\u4f7f\u7528\u7684\u662f\u591a\u8def\u590d\u7528\u7684\u65b9\u5f0f\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"\u8bf4\u4e86\u8fd9\u4e48\u591a-\u4e0a\u4ee3\u7801\u6765\u64cd\u4f5c\u4e00\u4e0b\u5427",children:"\u8bf4\u4e86\u8fd9\u4e48\u591a \u4e0a\u4ee3\u7801\u6765\u64cd\u4f5c\u4e00\u4e0b\u5427\uff01\uff01"}),"\n",(0,l.jsx)(n.p,{children:"\u6211\u4eec\u7684\u7f16\u5199\u601d\u8def\u662f\u8fd9\u6837\u7684"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7f16\u5199\u521d\u59cb\u5316\u670d\u52a1\u7aef"}),"\n",(0,l.jsx)(n.li,{children:"\u7f16\u5199\u81ea\u5b9a\u4e49\u521d\u59cb\u5316\u5668 \u548c \u81ea\u5b9a\u4e49\u5904\u7406\u5668"}),"\n",(0,l.jsx)(n.li,{children:"\u542f\u52a8 postman \u67e5\u770b\u6211\u4eec\u8bbe\u7f6e\u7684 http \u7684\u54cd\u5e94\u7ed3\u679c"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u6211\u4eec\u8fd9\u91cc\u6709\u4e09\u4e2a\u7c7b"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"HttpServer \u521d\u59cb\u5316\u670d\u52a1\u7aef"}),"\n",(0,l.jsx)(n.li,{children:"MyHttpHandler \u81ea\u5b9a\u4e49\u5904\u7406\u5668"}),"\n",(0,l.jsx)(n.li,{children:"MyHttpInitializer \u81ea\u5b9a\u4e49\u521d\u59cb\u5316"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u9996\u5148\u662f server"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u6211\u4eec\u9700\u8981\u5728\u521d\u59cb\u5316\u670d\u52a1\u7aef\u7684\u65f6\u5019 \u8bbe\u7f6e\u4e3b\u4ece\u7ebf\u7a0b\u6a21\u578b\uff08Netty \u4e2d\u5e38\u7528\uff09\r\n\u8bbe\u7f6e \u542f\u52a8\u53c2\u6570 \u548c\u963b\u585e\u961f\u5217\u7684\u957f\u5ea6\u7b49\u8bbe\u7f6e\r\n\u8bbe\u7f6e \u521d\u59cb\u5316"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class HttpServer {\r\n    public static void main(String[] args) {\r\n        //\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7ebf\u7a0b\u7684\u6570\u91cf\r\n        EventLoopGroup bossGroup = new NioEventLoopGroup(1);\r\n        // \u9ed8\u8ba4\u521b\u5efa\u7684\u7ebf\u7a0b\u6570\u91cf = CPU \u5904\u7406\u5668\u6570\u91cf *2\r\n        EventLoopGroup workerGroup = new NioEventLoopGroup();\r\n        ServerBootstrap serverBootstrap = new ServerBootstrap();\r\n        serverBootstrap.group(bossGroup, workerGroup)\r\n                .channel(NioServerSocketChannel.class)\r\n                .handler(new LoggingHandler())\r\n                //\u5f53\u524d\u8fde\u63a5\u88ab\u963b\u585e\u7684\u65f6\u5019\uff0cBACKLOG\u4ee3\u8868\u7684\u4e8b \u963b\u585e\u961f\u5217\u7684\u957f\u5ea6\r\n                .option(ChannelOption.SO_BACKLOG, 128)\r\n                //\u8bbe\u7f6e\u8fde\u63a5\u4fdd\u6301\u4e3a\u6d3b\u52a8\u72b6\u6001\r\n                .childOption(ChannelOption.SO_KEEPALIVE, true)\r\n                .childHandler(new MyHttpInitializer());\r\n\r\n        try {\r\n        //\u8bbe\u7f6e\u4e3a\u5f02\u6b65\u542f\u52a8 \u5f02\u6b65 \u5173\u95ed\r\n            ChannelFuture future = serverBootstrap.bind(9988).sync();\r\n            future.channel().closeFuture().sync();\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n       \t\t//netty\u7684\u4f18\u96c5\u5173\u95ed \u6307 \u7b49\u4e00\u5207\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e \u6162\u6162\u7684\u5173\u95ed\r\n            bossGroup.shutdownGracefully();\r\n            workerGroup.shutdownGracefully();\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u7f16\u5199 \u521d\u59cb\u5316"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u7ee7\u627f ChannelInitializer \u6cdb\u578b\u4e3a Channel\uff0c\u7528\u6765\u8fdb\u884c\u8bbe\u7f6e\u51fa\u7ad9\u89e3\u7801\u5668\u548c\u5165\u7ad9\u7f16\u7801\u5668\r\n\u4f7f\u7528 codec netty \u5c01\u88c5\u597d\u7684\u89e3\u7801\u5668\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u4e0d\u7528\u6bcf\u6b21\u5b9a\u4e49 \u89e3\u7801\u548c\u7f16\u7801"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class MyHttpInitializer extends ChannelInitializer<Channel> {\r\n    @Override\r\n    protected void initChannel(Channel channel) throws Exception {\r\n        ChannelPipeline pipeline = channel.pipeline();\r\n        //\u5148\u5bf9\u5e94\u8bf7\u6c42\u89e3\u7801\uff0c\u540e\u5bf9\u54cd\u5e94\u89e3\u7801\r\n        //pipeline.addLast("decoder", new HttpRequestDecoder());\r\n        //pipeline.addLast("encoder", new HttpRequestEncoder());\r\n\r\n        //\u5f53\u7136\u6bcf\u6b21\u6211\u4eec\u90fd\u8981\u89e3\u7801\u7f16\u7801\u5f88\u9ebb\u70e6\uff0cnetty\u4e5f\u6709\u4e3a\u6211\u4eec\u63d0\u4f9b\u5bf9\u5e94\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5efa\u8bae\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a \u4e0d\u4f1a\u51fa\u9519\r\n        pipeline.addLast("codec", new HttpServerCodec());\r\n        //\u538b\u7f29\u6570\u636e\r\n        pipeline.addLast("compressor", new HttpContentCompressor());\r\n        //\u805a\u5408\u5b8c\u6574\u7684\u4fe1\u606f \u53c2\u6570\u4ee3\u8868\u53ef\u4ee5\u5904\u7406\u7684\u6700\u5927\u503c \u6b64\u65f6\u7684\u662f 512 kb\r\n        pipeline.addLast("aggregator", new HttpObjectAggregator(512 * 1024));\r\n        pipeline.addLast(new MyHttpHandler());\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6709\u4e86\u521d\u59cb\u5316\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e00\u4e2a\u505a\u4e8b\u7684 \u90a3\u5c31\u662f \u5904\u7406\u5668 Handler"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"netty \u5e2e\u6211\u4eec\u5c01\u88c5\u4e86\u8fd4\u56de\u5b8c\u6574 http \u54cd\u5e94\u7684\u7c7b DefaultFullHttpResponse\r\n\u6211\u4eec\u53ea\u9700\u8981\u5728\u8bfb\u53d6\u7684\u65f6\u5019 \u8bbe\u7f6e\u534f\u8bae\uff0c\u72b6\u6001\u7801\u548c\u54cd\u5e94\u4fe1\u606f\uff0c\r\n\u914d\u7f6e\u54cd\u5e94\u5934\u7684\u7c7b\u578b\u548c\u957f\u5ea6 \u5c31\u53ef\u4ee5\u5b8c\u6210\u5bf9\u8bf7\u6c42\u7684\u54cd\u5e94"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'/*\r\n * \u6cdb\u578b\u9700\u8981\u8bbe\u7f6e\u4e3a FullHttpRequest\r\n * \u7b5b\u9009 message \u4e3a\u6b64\u7c7b\u578b\u7684\u6d88\u606f\u624d\u5904\u7406\r\n * */\r\npublic class MyHttpHandler extends SimpleChannelInboundHandler<FullHttpRequest> {\r\n    @Override\r\n    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest fullHttpRequest) throws Exception {\r\n        //DefaultFullHttpResponse \u662f\u4e00\u4e2a\u9ed8\u8ba4\u7684\u5b8c\u6574\u7684http\u54cd\u5e94\r\n        DefaultFullHttpResponse response = new DefaultFullHttpResponse(\r\n                HttpVersion.HTTP_1_1, HttpResponseStatus.OK,\r\n                Unpooled.wrappedBuffer("hello http netty demo".getBytes())\r\n        );\r\n        //    \u6211\u4eec\u8fd8\u9700\u8981\u8bbe\u7f6e\u54cd\u5e94\u5934\r\n        // \u8bbe\u7f6e\u8bf7\u6c42 \u54cd\u5e94\u5934\u5b57\u6bb5 \u53ef\u4ee5\u4f7f\u7528 HttpHeaderNmaes\r\n        // \u8bbe\u7f6e\u5b57\u6bb5\u65f6 \u53ef\u4ee5\u4f7f\u7528\r\n        HttpHeaders headers = response.headers();\r\n        headers.add(HttpHeaderNames.CONTENT_TYPE, HttpHeaderValues.TEXT_PLAIN + ";charset=UTF-8");\r\n        headers.add(HttpHeaderNames.CONTENT_LENGTH, response.content().readableBytes());\r\n        ctx.write(response);\r\n    }\r\n\r\n    @Override\r\n    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {\r\n        ctx.flush();\r\n    }\r\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u542f\u52a8\u7ed3\u679c\r\n",(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/bc10e04520bbb6205e88e6f797bcfca3.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}),"\r\n",(0,l.jsx)(n.strong,{children:"postman"})," \u5dee\u770b\u5230\u7684\u8bf7\u6c42\u54cd\u5e94 \u53c2\u6570\r\n\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8bbe\u7f6e\u7684 http1.1 \u534f\u8bae\r\n\u7c7b\u578b text/plain \u957f\u5ea6 47\r\n\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\u7684 \u5185\u5bb9 ",(0,l.jsx)(n.code,{children:" hello http netty demo"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsx)(n.h3,{id:"\u5c0f\u7ed3",children:"\u5c0f\u7ed3"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e86\u89e3 http \u5404\u4e2a\u7248\u672c\u7684\u89e3\u51b3\u4e86\u4ec0\u4e48\u95ee\u9898\uff0c\u4f18\u7f3a\u70b9\uff0c\u4f18\u52a3\u6027"}),"\n",(0,l.jsx)(n.li,{children:"\u624b\u52a8\u7f16\u5199\u4e00\u4e2a\u670d\u52a1\u7aef\u7684\u54cd\u5e94\uff0c\u7528 postman \u67e5\u770b\u54cd\u5e94\u5934\u6211\u4eec\u8bbe\u7f6e\u7684\u5185\u5bb9"}),"\n",(0,l.jsx)(n.li,{children:"\u4f53\u9a8c\u5230 netty \u5f3a\u5927\u7684\u5c01\u88c5\u5e26\u7ed9\u6211\u4eec\u7684\u4fbf\u5229\u6027"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"2websocket",children:"2\u3001WebSocket"}),"\n",(0,l.jsx)(n.p,{children:"websocket \u662f\u7531\u6d4f\u89c8\u5668\u53d1\u8d77\u7684"}),"\n",(0,l.jsxs)(n.p,{children:["\u534f\u8bae\u6807\u8bc6\u7b26 ",(0,l.jsx)(n.a,{href:"http://127.0.0.1:8080",children:"http://127.0.0.1:8080"})," ws://127.0.0.1:7777"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"GET ws://127.0.0.1:7777 HTTP/1.1\r\nHost: 127.0.0.1\r\nUpgrade: websocket    # \u5347\u7ea7\u4e3aws\r\nConnection: Upgrade   # \u6b64\u94fe\u63a5\u9700\u8981\u5347\u7ea7\r\nSec-WebSocket-key: client-random-string ...  # \u6807\u8bc6\u52a0\u5bc6\u76f8\u5173\u4fe1\u606f\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"HTTP/1.1 101\r\nUpgrade: websocket\r\nConnection: Upgrade\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u54cd\u5e94\u7801 101 \u4ee3\u8868\u672c\u6b21\u534f\u8bae\u9700\u8981\u66f4\u6539\u4e3a websocket"}),"\n",(0,l.jsx)(n.p,{children:"\u8fde\u63a5\u5efa\u7acb\u540e\uff0c\u652f\u6301\u6587\u672c\u4fe1\u606f\u53ca\u4e8c\u8fdb\u5236\u4fe1\u606f\u3002"}),"\n",(0,l.jsx)(n.p,{children:"Websocket \u5b9e\u73b0\u7684\u539f\u7406\uff1a\r\n\u901a\u8fc7 http \u534f\u8bae\u8fdb\u884c\u8fde\u63a5\u7684\u5efa\u7acb\uff08\u63e1\u624b\u548c\u56de\u7b54\uff09\uff0c\u5efa\u7acb\u8fde\u63a5\u540e\u4e0d\u518d\u4f7f\u7528 http\uff0c\u800c tcp \u81ea\u8eab\u662f\u652f\u6301\u53cc\u5411\u901a\u4fe1\u7684\uff0c\u6240\u4ee5\u80fd\u8fbe\u5230\u201c\u5168\u53cc\u5de5\u201d\u7684\u6548\u679c\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u4fe1\u4f7f\u7528\u7684\u5355\u4f4d\u53eb\u5e27 frame\r\n\u5ba2\u6237\u7aef\uff1a\u53d1\u9001\u65f6\u5c06\u6d88\u606f\u5207\u5272\u6210\u591a\u4e2a\u5e27\r\n\u670d\u52a1\u7aef\uff1a\u63a5\u6536\u65f6\uff0c\u5c06\u5173\u8054\u7684\u5e27\u91cd\u65b0\u7ec4\u88c5"}),"\n",(0,l.jsx)(n.p,{children:"\u3010\u5ba2\u6237\u7aef\u3011"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'var ws = new WebSocket("ws://127.0.0.1:7777/hello");\r\nws.onopen = function(ev){\r\n     ws.send("hello"); //\u5efa\u7acb\u8fde\u63a5\u540e\u53d1\u9001\u6570\u636e\r\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u8bbe\u8ba1\u4e00\u4e2a\u6837\u5f0f\r\n\u5de6\u53f3\u4e24\u4e2a\u5404\u6709\u4e00\u4e2a\u6587\u672c\u6846\uff0c\u4e2d\u95f4\u653e\u4e00\u4e2a\u53d1\u9001\u6309\u94ae\u3002\r\n\u5de6\u4fa7\u6587\u672c\u6846\u7528\u6765\u53d1\u9001\u6570\u636e\uff0c\u53f3\u4fa7\u6587\u672c\u6846\u7528\u6765\u663e\u793a\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"websocket-\u5e94\u7528-demo",children:"Websocket \u5e94\u7528 demo"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u4ee3\u7801"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public class WebSocketServer {\r\n    public static void main(String[] args) {\r\n        //\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7ebf\u7a0b\u7684\u6570\u91cf\r\n        EventLoopGroup bossGroup = new NioEventLoopGroup(1);\r\n        // \u9ed8\u8ba4\u521b\u5efa\u7684\u7ebf\u7a0b\u6570\u91cf = CPU \u5904\u7406\u5668\u6570\u91cf *2\r\n        EventLoopGroup workerGroup = new NioEventLoopGroup();\r\n        ServerBootstrap serverBootstrap = new ServerBootstrap();\r\n        serverBootstrap.group(bossGroup, workerGroup)\r\n                .channel(NioServerSocketChannel.class)\r\n                .handler(new LoggingHandler())\r\n                //\u5f53\u524d\u8fde\u63a5\u88ab\u963b\u585e\u7684\u65f6\u5019\uff0cBACKLOG\u4ee3\u8868\u7684\u4e8b \u963b\u585e\u961f\u5217\u7684\u957f\u5ea6\r\n                .option(ChannelOption.SO_BACKLOG, 128)\r\n                //\u8bbe\u7f6e\u8fde\u63a5\u4fdd\u6301\u4e3a\u6d3b\u52a8\u72b6\u6001\r\n                .childOption(ChannelOption.SO_KEEPALIVE, true)\r\n                .childHandler(new WebSocketInitialzer());\r\n\r\n        try {\r\n            ChannelFuture future = serverBootstrap.bind(7777).sync();\r\n            future.channel().closeFuture().sync();\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            bossGroup.shutdownGracefully();\r\n            workerGroup.shutdownGracefully();\r\n        }\r\n    }\r\n\r\n}\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u521d\u59cb\u5316\u5668"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class WebSocketInitialzer extends ChannelInitializer<Channel> {\r\n    @Override\r\n    protected void initChannel(Channel ch) throws Exception {\r\n        ChannelPipeline pipeline = ch.pipeline();\r\n        //\u589e\u52a0\u7f16\u89e3\u7801\u5668 \u7684\u53e6\u4e00\u79cd\u65b9\u5f0f\r\n        pipeline.addLast(new HttpServerCodec());\r\n        //    \u5757\u65b9\u5f0f\u5199\u7684\u5904\u7406\u5668 \u9002\u5408\u5904\u7406\u5927\u6570\u636e\r\n        pipeline.addLast(new ChunkedWriteHandler());\r\n        //\u805a\u5408\r\n        pipeline.addLast(new HttpObjectAggregator(512 * 1024));\r\n        /*\r\n         * \u8fd9\u4e2a\u65f6\u5019 \u6211\u4eec\u9700\u8981\u58f0\u660e\u6211\u4eec\u4f7f\u7528\u7684\u662f websocket \u534f\u8bae\r\n         * netty\u4e3awebsocket\u4e5f\u51c6\u5907\u4e86\u5bf9\u5e94\u5904\u7406\u5668  \u8bbe\u7f6e\u7684\u662f\u8bbf\u95ee\u8def\u5f84\r\n         * \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ea\u9700\u8981\u8bbf\u95ee ws://127.0.0.1:7777/hello \u5c31\u53ef\u4ee5\u4e86\r\n         * \u8fd9\u4e2ahandler\u662f\u5c06http\u534f\u8bae\u5347\u7ea7\u4e3awebsocket  \u5e76\u4e14\u4f7f\u7528 101 \u4f5c\u4e3a\u54cd\u5e94\u7801\r\n         * */\r\n        pipeline.addLast(new WebSocketServerProtocolHandler("/hello"));\r\n        pipeline.addLast(new WebSocketHandler());\r\n    }\r\n}\r\n\n'})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u670d\u52a1\u7aef\u5904\u7406\u5668"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u4fe1\u4f7f\u7528\u7684\u5355\u4f4d\u53eb\u5e27 frame\r\n\u5ba2\u6237\u7aef\uff1a\u53d1\u9001\u65f6\u5c06\u6d88\u606f\u5207\u5272\u6210\u591a\u4e2a\u5e27\r\n\u670d\u52a1\u7aef\uff1a\u63a5\u6536\u65f6\uff0c\u5c06\u5173\u8054\u7684\u5e27\u91cd\u65b0\u7ec4\u88c5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'/*\r\n * \u6cdb\u578b \u4ee3\u8868\u7684\u662f\u5904\u7406\u6570\u636e\u7684\u5355\u4f4d\r\n * TextWebSocketFrame : \u6587\u672c\u4fe1\u606f\u5e27\r\n * */\r\npublic class WebSocketHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {\r\n\r\n    @Override\r\n    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame textWebSocketFrame) throws Exception {\r\n        //\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528text \u62ff\u5230\u6587\u672c\u4fe1\u606f\u5e27\u4e2d\u7684\u4fe1\u606f\r\n        System.out.println("msg:" + textWebSocketFrame.text());\r\n        Channel channel = ctx.channel();\r\n        //\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u65b0\u5efa\u4e00\u4e2a\u5bf9\u8c61 \u5c06\u670d\u52a1\u7aef\u9700\u8981\u8fd4\u56de\u7684\u4fe1\u606f\u653e\u5165\u5176\u4e2d \u8fd4\u56de\u5373\u53ef\r\n        TextWebSocketFrame resp = new TextWebSocketFrame("hello client from websocket server");\r\n        channel.writeAndFlush(resp);\r\n    }\r\n}\r\n\n'})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"websocket \u524d\u7aef\u7f16\u5199"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-html",children:'<!DOCTYPE html>\r\n<html lang="en">\r\n  <head>\r\n    <meta charset="UTF-8" />\r\n    <title>Title</title>\r\n  </head>\r\n  <body>\r\n    <script>\r\n      var socket;\r\n      //    \u5224\u65ad\u5f53\u524d\u6d4f\u89c8\u5668\u662f\u5426\u652f\u6301websocket\r\n      if (!window.WebSocket) {\r\n        alert("\u4e0d\u652f\u6301websocket");\r\n      } else {\r\n        \x3c!-- \u521b\u5efawebsocket \u8fde\u63a5\u5bf9\u8c61--\x3e\r\n        socket = new WebSocket("ws://127.0.0.1:7777/hello");\r\n        //\u8bbe\u7f6e\u5f00\u59cb\u8fde\u63a5\u7684\u65b9\u6cd5\r\n        socket.onopen = function (ev) {\r\n          var tmp = document.getElementById("respText");\r\n          tmp.value = "\u8fde\u63a5\u5df2\u7ecf\u5f00\u542f";\r\n        };\r\n        //\u8bbe\u7f6e\u5173\u95ed\u8fde\u63a5\u7684\u65b9\u6cd5\r\n        socket.onclose = function (ev) {\r\n          var tmp = document.getElementById("respText");\r\n          tmp.value = tmp.value + "\\n" + "\u8fde\u63a5\u5df2\u7ecf\u5173\u95ed";\r\n        };\r\n        //\u8bbe\u7f6e\u63a5\u6536\u6570\u636e\u7684\u65b9\u6cd5\r\n        socket.onmessage = function (ev) {\r\n          var tmp = document.getElementById("respText");\r\n          tmp.value = tmp.value + "\\n" + ev.data;\r\n        };\r\n      }\r\n\r\n      function send(message) {\r\n        if (!window.socket) {\r\n          return;\r\n        }\r\n        /*\r\n         * \u5224\u65adsocket\u7684\u72b6\u6001\r\n         * connecting \u6b63\u5728\u8fde\u63a5 closing \u6b63\u5728\u5173\u95ed\r\n         * closed \u5df2\u7ecf\u5173\u95ed\u6216\u6253\u5f00\u8fde\u63a5\u5931\u8d25\r\n         * open \u8fde\u63a5\u53ef\u4ee5 \u5df2\u7ecf\u6b63\u5e38\u901a\u4fe1\r\n         * */\r\n        if (socket.readyState == WebSocket.OPEN) {\r\n          socket.send(message);\r\n        } else {\r\n          alert("\u8fde\u63a5\u672a\u5f00\u542f");\r\n        }\r\n      }\r\n    <\/script>\r\n    \x3c!--\u9632\u6b62\u8868\u5355\u81ea\u52a8\u63d0\u4ea4--\x3e\r\n    <form onsubmit="return false">\r\n      <textarea name="message" style="height: 400px;width: 400px"></textarea>\r\n      <input\r\n        type="button"\r\n        value="\u53d1\u9001"\r\n        onclick="send(this.form.message.value)"\r\n      />\r\n      <textarea id="respText" style="height: 400px;width: 400px"></textarea>\r\n    </form>\r\n  </body>\r\n</html>\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u3010\u5ba2\u6237\u7aef\u3011"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'var ws = new WebSocket("ws://127.0.0.1:7777/hello");\r\nws.onopen = function(ev){\r\n     ws.send("hello"); //\u5efa\u7acb\u8fde\u63a5\u540e\u53d1\u9001\u6570\u636e\r\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u8bbe\u8ba1\u4e00\u4e2a\u6837\u5f0f\r\n\u5de6\u53f3\u4e24\u4e2a\u5404\u6709\u4e00\u4e2a\u6587\u672c\u6846\uff0c\u4e2d\u95f4\u653e\u4e00\u4e2a\u53d1\u9001\u6309\u94ae\u3002\r\n\u5de6\u4fa7\u6587\u672c\u6846\u7528\u6765\u53d1\u9001\u6570\u636e\uff0c\u53f3\u4fa7\u6587\u672c\u6846\u7528\u6765\u663e\u793a\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"\u6f14\u793a\u6548\u679c",children:"\u6f14\u793a\u6548\u679c"}),"\n",(0,l.jsx)(n.p,{children:"\u542f\u52a8\u670d\u52a1\u53d1\u9001\u6d88\u606f"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16-1680866877502991.png",alt:""})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/73697353609c4303b36088f42703246c.png",alt:""})}),"\n",(0,l.jsx)(n.h4,{id:"\u5c0f\u7ed3-1",children:"\u5c0f\u7ed3"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"websocket \u4e00\u822c\u7528\u4e8e\u505a\u53ef\u590d\u7528\u8fde\u63a5\uff0chttp \u4e00\u822c\u505a\u77ed\u94fe\u63a5"}),"\n",(0,l.jsx)(n.li,{children:"websocket \u89e3\u51b3\u4e86 http \u8fde\u63a5\u53ea\u80fd\u5ba2\u6237\u7aef\u53d1\u8d77\u7684"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u4e09\u539f\u7406\u7bc7",children:"\uff08\u4e09\uff09\u539f\u7406\u7bc7"}),"\n",(0,l.jsx)(n.h3,{id:"1bytebuf",children:"1\u3001ByteBuf"}),"\n",(0,l.jsx)(n.p,{children:"NIO \u4e2d ByteBuffer \u7684\u7f3a\u70b9\uff1a"}),"\n",(0,l.jsx)(n.p,{children:"A \u957f\u5ea6\u56fa\u5b9a\uff0c\u65e0\u6cd5\u52a8\u6001\u7684\u6269\u5bb9\u548c\u7f29\u5bb9\uff0c\u7f3a\u4e4f\u7075\u6d3b\u6027\r\nB \u4f7f\u7528\u4e00\u4e2a position \u8bb0\u5f55\u8bfb\u5199\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u5728\u8bfb\u5199\u6a21\u5f0f\u5207\u6362\u65f6\u9700\u624b\u52a8\u8c03\u7528 flip \u65b9\u6cd5\uff0c\u589e\u52a0\u4e86\u4f7f\u7528\u7684\u590d\u6742\u5ea6\u3002\r\nC \u529f\u80fd\u6709\u9650\uff0c\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u5f80\u5f80\u9700\u8981\u81ea\u884c\u5c01\u88c5"}),"\n",(0,l.jsx)(n.h4,{id:"1\u5206\u7c7b",children:"1\uff09\u5206\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"\u6309\u7167\u5185\u5b58\u7684\u4f4d\u7f6e\uff0c\u5206\u4e3a\u5806\u5185\u5b58\u7f13\u51b2\u533a heap buffer\u3001\u76f4\u63a5\u5185\u5b58\u7f13\u51b2\u533a direct buffer\u3001\u590d\u5408\u5185\u5b58\u7f13\u51b2\u533a composite buffer\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"a-heap-buffer",children:"A heap buffer"}),"\n",(0,l.jsx)(n.p,{children:"\u5c06\u6570\u636e\u5b58\u50a8\u5230 JVM \u7684\u5806\u7a7a\u95f4\u4e2d\uff0c\u5b9e\u9645\u4f7f\u7528\u5b57\u8282\u6570\u7ec4 byte[]\u6765\u5b58\u653e\u3002\r\n\u4f18\u70b9\uff1a\u6570\u636e\u53ef\u4ee5\u5feb\u901f\u7684\u521b\u5efa\u548c\u91ca\u653e\uff0c\u5e76\u4e14\u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u5185\u90e8\u6570\u7ec4\r\n\u7f3a\u70b9\uff1a\u5728\u8bfb\u5199\u6570\u636e\u65f6\uff0c\u9700\u8981\u5c06\u6570\u636e\u590d\u5236\u5230\u76f4\u63a5\u7f13\u51b2\u533a \u518d\u8fdb\u884c\u7f51\u7edc\u4f20\u8f93\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"b-direct-buffer",children:"B direct buffer"}),"\n",(0,l.jsx)(n.p,{children:"\u4e0d\u5728\u5806\u4e2d\uff0c\u800c\u662f\u4f7f\u7528\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u672c\u5730\u5185\u5b58\u3002\r\n\u4f18\u70b9\uff1a\u5728\u4f7f\u7528 Socket \u8fdb\u884c\u6570\u636e\u4f20\u8f93\u8fc7\u7a0b\u4e2d\uff0c\u51cf\u5c11\u4e00\u6b21\u62f7\u8d1d\uff0c\u6027\u80fd\u66f4\u9ad8\u3002\r\n\u7f3a\u70b9\uff1a\u91ca\u653e\u548c\u5206\u914d\u7684\u7a7a\u95f4\u66f4\u6602\u8d35\uff0c\u4f7f\u7528\u65f6\u9700\u8981\u66f4\u8c28\u614e\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"c-composite-buffer",children:"C composite buffer"}),"\n",(0,l.jsx)(n.p,{children:"\u5c06\u4e24\u4e2a\u6216\u591a\u4e2a\u4e0d\u540c\u5185\u5b58\u7684\u7f13\u51b2\u533a\u5408\u5e76\r\n\u4f18\u70b9\uff1a\u53ef\u4ee5\u7edf\u4e00\u8fdb\u884c\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.p,{children:"\u5e94\u7528\u573a\u666f\uff1a\u5728\u901a\u4fe1\u7ebf\u7a0b\u4f7f\u7528\u7f13\u51b2\u533a\u65f6\uff0c\u5f80\u5f80\u4f7f\u7528 direct buffer\uff0c\u800c\u4e1a\u52a1\u6d88\u606f\u4f7f\u7528\u7f13\u51b2\u533a\u65f6\uff0c\u5f80\u5f80\u4f7f\u7528 heap buffer\uff0c\u5728\u89e3\u51b3 http \u5305\uff0c\u8bf7\u6c42\u5934+\u8bf7\u6c42\u4f53\u7279\u6027\u4e0d\u540c\u800c\u9009\u62e9\u4e0d\u540c\u4f4d\u7f6e\u5b58\u50a8\u65f6\uff0c\u53ef\u4ee5\u5c06\u4e24\u8005\u62fc\u63a5\u4f7f\u7528"}),"\n",(0,l.jsx)(n.h5,{id:"d-\u6c60\u5316\u7684\u6982\u5ff5",children:"D \u6c60\u5316\u7684\u6982\u5ff5"}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9\u4e8e\u5185\u5b58\u7a7a\u95f4\u5206\u914d\u548c\u91ca\u653e\u7684\u590d\u6742\u5ea6\u548c\u6548\u7387\uff0cnetty \u901a\u8fc7\u5185\u5b58\u6c60\u7684\u65b9\u5f0f\u6765\u89e3\u51b3\u3002\r\n\u5185\u5b58\u6c60\uff0c\u53ef\u4ee5\u5faa\u73af\u5229\u7528 ByteBuf\uff0c\u63d0\u9ad8\u4f7f\u7528\u7387\u3002\u4f46\u662f\u7ba1\u7406\u548c\u7ef4\u62a4\u8f83\u590d\u6742\u3002"}),"\n",(0,l.jsx)(n.p,{children:"Unpooled \u6b63\u662f\u975e\u6c60\u5316\u7f13\u51b2\u533a\u7684\u5de5\u5177\u7c7b\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u4e3b\u8981\u533a\u522b\u5728\u4e8e\uff0c\u6c60\u5316\u7684\u5185\u5b58\u7531 netty \u7ba1\u7406\uff0c\u975e\u6c60\u5316\u7684\u5185\u5b58\u7531 GC \u56de\u6536\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"e-\u56de\u6536\u65b9\u5f0f",children:"E \u56de\u6536\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u56de\u6536\u65b9\u5f0f\u4e3a\u5f15\u7528\u8ba1\u6570\uff0c\u5177\u4f53\u89c4\u5219\u4e3a\uff0c\u901a\u8fc7\u8bb0\u5f55\u88ab\u5f15\u7528\u7684\u6b21\u6570\uff0c\u5224\u65ad\u5f53\u524d\u5bf9\u8c61\u662f\u5426\u8fd8\u4f1a\u88ab\u4f7f\u7528\u3002\r\n\u5f53\u5bf9\u8c61\u88ab\u8c03\u7528\u65f6\uff0c\u5f15\u7528\u8ba1\u4e3a+1\uff0c\u5f53\u5bf9\u8c61\u88ab\u91ca\u653e\u65f6\uff0c\u5f15\u7528\u8ba1\u4e3a-1\uff0c\u5f53\u5f15\u7528\u6b21\u6570\u4e3a 0 \u65f6\uff0c\u5bf9\u8c61\u53ef\u4ee5\u56de\u6536\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5f0a\u7aef\uff1a\u53ef\u80fd\u5f15\u53d1\u5185\u5b58\u6cc4\u6f0f\u3002\r\n\u5f53\u5bf9\u8c61\u4e0d\u53ef\u8fbe\uff0cJVM \u4f1a\u901a\u8fc7 GC \u56de\u6536\u6389\uff0c\u4f46\u6b64\u65f6\u5f15\u7528\u8ba1\u6570\u53ef\u80fd\u4e0d\u4e3a 0\uff0c\u5bf9\u8c61\u65e0\u6cd5\u5f52\u8fd8\u5185\u5b58\u6c60\uff0c\u4f1a\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\u3002netty \u53ea\u80fd\u901a\u8fc7\u5bf9\u5185\u5b58\u7f13\u51b2\u533a\u8fdb\u884c\u91c7\u6837\uff0c\u6765\u68c0\u67e5\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"2\u5de5\u4f5c\u539f\u7406",children:"2\uff09\u5de5\u4f5c\u539f\u7406"}),"\n",(0,l.jsx)(n.p,{children:"\u548c ByteBuffer \u4e0d\u540c\u5728\u4e8e\uff0c\u589e\u52a0\u4e86\u4e00\u4e2a\u6307\u9488\uff0c\u901a\u8fc7\u4e24\u4e2a\u6307\u9488\u8bb0\u5f55\u8bfb\u6a21\u5f0f\u548c\u5199\u6a21\u5f0f\u65f6\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u8bfb\u6307\u9488\u53eb\u505a readerIndex\uff0c\u5199\u6307\u9488\u53eb\u505a writerIndex\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"a-\u8bfb\u5199\u5206\u79bb",children:"A \u8bfb\u5199\u5206\u79bb"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/6147397fff9f9fc0425da347e70e1737.png",alt:"image-20220412193227329"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/ca02afab8b8f53a2aa107eb22e060b63.png",alt:"image-20220412193237587"})}),"\n",(0,l.jsx)(n.p,{children:"\u5f53\u6267\u884c clear()\u65b9\u6cd5\u65f6\uff0c\u7d22\u5f15\u4f4d\u7f6e\u6e05\u7a7a\u56de\u521d\u59cb\u4f4d\u7f6e\uff0c\u4f46\u6570\u636e\u4fdd\u6301\u4e0d\u53d8\u3002"}),"\n",(0,l.jsx)(n.p,{children:"mark \u548c reset \u65b9\u6cd5\u5728 ByteBuf \u4e2d\u540c\u6837\u9002\u7528\uff0c\u5982 markReaderIndex \u548c resetReaderIndex\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"b-\u6df1\u6d45\u62f7\u8d1d",children:"B \u6df1\u6d45\u62f7\u8d1d"}),"\n",(0,l.jsx)(n.p,{children:"\u6d45\u62f7\u8d1d\uff0c\u62f7\u8d1d\u7684\u662f\u5bf9\u5bf9\u8c61\u7684\u5f15\u7528\uff0c\u5e76\u6ca1\u6709\u521b\u5efa\u65b0\u5bf9\u8c61\uff0c\u65b0\u5bf9\u8c61\u548c\u539f\u5bf9\u8c61\u4e4b\u95f4\u4e92\u76f8\u5f71\u54cd\u3002\r\n\u6df1\u62f7\u8d1d\uff0c\u62f7\u8d1d\u7684\u662f\u6574\u4e2a\u5bf9\u8c61\uff0c\u548c\u539f\u5bf9\u8c61\u4e4b\u95f4\u5b8c\u5168\u72ec\u7acb\u3002"}),"\n",(0,l.jsx)(n.p,{children:"duplicate \u548c slice \u65b9\u6cd5\uff0c\u8fbe\u6210\u5168\u90e8\u6d45\u62f7\u8d1d\u548c\u90e8\u5206\u6d45\u62f7\u8d1d\u3002\r\ncopy\uff0c\u90e8\u5206\u6df1\u62f7\u8d1d\uff0c\u90e8\u5206\u4ee3\u8868\u7684\u662f\u53ef\u8bfb\u7a7a\u95f4\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"3\u6269\u5bb9\u673a\u5236",children:"3\uff09\u6269\u5bb9\u673a\u5236"}),"\n",(0,l.jsx)(n.h5,{id:"a-bytebuffer-\u7684\u5b58\u50a8",children:"A ByteBuffer \u7684\u5b58\u50a8"}),"\n",(0,l.jsx)(n.p,{children:"ByteBuffer \u5728 put \u6570\u636e\u65f6\uff0c\u4f1a\u6821\u9a8c\u5269\u4f59\u7a7a\u95f4\u662f\u5426\u4e0d\u8db3\uff0c\u5982\u679c\u4e0d\u8db3\uff0c\u4f1a\u629b\u51fa\u5f02\u5e38\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'ByteBuffer buffer = ByteBuffer.allocate(8);\r\nbuffer.put("yu".getBytes());\r\n\r\n----------------------------------------------------\r\n\r\n    public final ByteBuffer put(byte[] src) {\r\n        return put(src, 0, src.length);\r\n    }\r\n\r\n    // \u989d\u5916\u63a5\u6536\u504f\u79fb\u91cf\uff08\u5b58\u50a8\u6570\u636e\u7684\u8d77\u59cb\u4f4d\u7f6e\uff09  \u548c\u6570\u636e\u957f\u5ea6\r\n    public ByteBuffer put(byte[] src, int offset, int length) {\r\n        // \u6821\u9a8c\u53c2\u6570\u7684\u6709\u6548\u6027\r\n        checkBounds(offset, length, src.length);\r\n        // \u5982\u679c\u8981\u5b58\u50a8\u6570\u636e\u7684\u957f\u5ea6 > \u5269\u4f59\u53ef\u7528\u7a7a\u95f4  \u629b\u51fabuffer\u8d8a\u754c\u7684\u5f02\u5e38\r\n        if (length > remaining())\r\n            throw new BufferOverflowException();\r\n        // \u5982\u679c\u5269\u4f59\u7a7a\u95f4\u8db3\u591f  \u8ba1\u7b97\u5b58\u50a8\u7684\u7ed3\u675f\u4f4d\u7f6e = \u504f\u79fb\u91cf + \u6570\u636e\u957f\u5ea6\r\n        int end = offset + length;\r\n        for (int i = offset; i < end; i++)\r\n            this.put(src[i]);\r\n        return this;\r\n    }\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u8981\u624b\u52a8\u5bf9 ByteBuffer \u6269\u5bb9\uff0c\u53ef\u4ee5\u5728 put \u4e4b\u524d\uff0c\u5148\u6821\u9a8c\u5269\u4f59\u7a7a\u95f4\u662f\u5426\u8db3\u591f\uff0c\u5982\u679c\u4e0d\u8db3\u591f\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ByteBuffer\uff0c\u65b0\u7684\u5bb9\u91cf\u786e\u4fdd\u8db3\u591f\uff0c\u65e7\u7684 buffer \u6570\u636e\u62f7\u8d1d\u5230\u65b0\u7684 buffer \u4e2d\uff0c\u7136\u540e\u7ee7\u7eed\u5b58\u50a8\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h5,{id:"b-bytebuf-\u7684\u5b58\u50a8\u548c\u6269\u5bb9",children:"B ByteBuf \u7684\u5b58\u50a8\u548c\u6269\u5bb9"}),"\n",(0,l.jsx)(n.p,{children:'\u5f53\u5199\u6570\u636e\u65f6\uff0c\u5148\u5224\u65ad\u662f\u5426\u9700\u8981\u6269\u5bb9\uff0c\u5982\u679c\u5f53\u524d\u7a7a\u95f4\u8f83\u5c0f\uff08<4M\uff09\uff0c\u4ee5 64 \u4f5c\u4e3a\u57fa\u6570\u500d\u589e\uff0810 -> 64 -> 128 -> 256\uff09, \u5982\u679c\u5f53\u524d\u7a7a\u95f4\u8f83\u5927\uff08>4M\uff09, \u6bcf\u6b21\u6269\u5bb9\u90fd\u589e\u52a0 4M\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53eb\u505a"\u6b65\u8fdb\u5f0f"\u3002'}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'\u67e5\u770b\u6e90\u7801\uff0c\u4ee5AbstractByteBuf\u5b50\u7c7b\u4e3a\u4f9d\u636e\u67e5\u770b\uff0c\u6700\u91cd\u8981\u7684\u5b50\u7c7b\u4e4b\u4e00\uff0cByteBuf\u7684\u516c\u5171\u5c5e\u6027\u548c\u529f\u80fd\u90fd\u5728\u6b64\u4e2d\u5b9e\u73b0\u3002\r\n\r\nByteBuf buf = Unpooled.buffer(10);\r\nSystem.out.println("capacity: " + buf.capacity());\r\nfor (int i = 0; i < 11; i++) {\r\n    buf.writeByte(i);\r\n}\r\n----------------------------------------------------\r\n\r\n[ByteBuf\u7c7b]\r\npublic abstract ByteBuf writeByte(int value);\r\n\r\n\u6309\u4f4fCtrl+Alt\u5feb\u6377\u952e\r\n\r\n[AbstractByteBuf\u5b50\u7c7b]\r\n----------------------------------------------------\r\n    @Override\r\n    public ByteBuf writeByte(int value) {\r\n        // \u786e\u4fdd\u53ef\u5199\u7a7a\u95f4\u8db3\u591f\r\n        ensureWritable0(1);\r\n        // \u5199\u5165\u6570\u636e\r\n        _setByte(writerIndex++, value);\r\n        return this;\r\n    }\r\n\r\n    // \u53c2\u6570\u4e3a \u6700\u5c0f\u5199\u5165\u6570\u636e\u7684\u5927\u5c0f\r\n    final void ensureWritable0(int minWritableBytes) {\r\n        final int writerIndex = writerIndex();\r\n        // \u76ee\u6807\u5bb9\u91cf = \u5f53\u524d\u5199\u64cd\u4f5c\u7d22\u5f15 + \u6700\u5c0f\u5199\u5165\u6570\u636e\u5927\u5c0f\r\n        final int targetCapacity = writerIndex + minWritableBytes;\r\n        // \u5bb9\u91cf\u8db3\u591f  \u4e0d\u9700\u6269\u5bb9\r\n        if (targetCapacity <= capacity()) {\r\n            ensureAccessible();\r\n            return;\r\n        }\r\n        // \u5bb9\u91cf\u4e0d\u8db3\u65f6 \u5982\u679c\u76ee\u6807\u5bb9\u91cf \u8d85\u51fa\u6700\u5927\u5bb9\u91cf  \u629b\u51fa\u5f02\u5e38\r\n        if (checkBounds && targetCapacity > maxCapacity) {\r\n            ensureAccessible();\r\n            throw new IndexOutOfBoundsException(String.format(\r\n                    "writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s",\r\n                    writerIndex, minWritableBytes, maxCapacity, this));\r\n        }\r\n\r\n\t\t// \u6269\u5bb9\u903b\u8f91\r\n        // \u83b7\u53d6\u53ef\u5199\u7a7a\u95f4\u5927\u5c0f\r\n        final int fastWritable = maxFastWritableBytes();\r\n        // \u5982\u679c \u53ef\u5199\u7a7a\u95f4 >= \u6240\u9700\u7a7a\u95f4   \u65b0\u7684\u5bb9\u91cf=\u5199\u64cd\u4f5c\u7d22\u5f15+\u53ef\u5199\u7a7a\u95f4\u5927\u5c0f\r\n        // \u5982\u679c \u53ef\u5199\u7a7a\u95f4 < \u6240\u9700\u7a7a\u95f4   \u8ba1\u7b97\u8981\u6269\u5bb9\u7684\u65b0\u5bb9\u91cf\u5927\u5c0f calculateNewCapacity\u65b9\u6cd5\r\n        int newCapacity = fastWritable >= minWritableBytes ? writerIndex + fastWritable\r\n                : alloc().calculateNewCapacity(targetCapacity, maxCapacity);\r\n\r\n        // Adjust to the new capacity.\r\n\r\n        // \u8ba1\u7b97\u5b8c\u6210\u540e \u751f\u6210\u65b0\u7684ByteBuffer\r\n        capacity(newCapacity);\r\n    }\r\n\r\n    // \u83b7\u53d6\u53ef\u5199\u7a7a\u95f4\u5927\u5c0f\r\n    public int maxFastWritableBytes() {\r\n        return writableBytes();\r\n    }\r\n\r\n\r\n[AbstractByteBufAllocator\u5b50\u7c7b]\r\n----------------------------------------------------\r\n    // \u8ba1\u7b97\u8981\u6269\u5bb9\u7684\u65b0\u5bb9\u91cf\u5927\u5c0f\r\n    @Override\r\n    public int calculateNewCapacity(int minNewCapacity, int maxCapacity) {\r\n        // \u6821\u9a8c\u53c2\u6570\u6709\u6548\u6027\r\n        checkPositiveOrZero(minNewCapacity, "minNewCapacity");\r\n        if (minNewCapacity > maxCapacity) {\r\n            throw new IllegalArgumentException(String.format(\r\n                    "minNewCapacity: %d (expected: not greater than maxCapacity(%d)",\r\n                    minNewCapacity, maxCapacity));\r\n        }\r\n        // \u6269\u5bb9\u65b9\u5f0f\u7684\u5206\u754c\u70b9 \u4ee54M\u5927\u5c0f\u4e3a\u754c\r\n        final int threshold = CALCULATE_THRESHOLD; // 4 MiB page\r\n\r\n        if (minNewCapacity == threshold) {\r\n            return threshold;\r\n        }\r\n\r\n        // If over threshold, do not double but just increase by threshold.\u3001\r\n        // \u5982\u679c\u6240\u9700\u5bb9\u91cf\u5927\u4e8e4M  \u6309\u7167\u6b65\u8fdb\u7684\u65b9\u5f0f\u6269\u5bb9\r\n        //   \u4e3e\u4f8b\uff1a \u6bd4\u5982 minNewCapacity = 5M\r\n        if (minNewCapacity > threshold) {\r\n            // newCapacity = 5 / 4 * 4 = 4M  \u786e\u4fdd\u662f4\u7684\u500d\u6570\r\n            int newCapacity = minNewCapacity / threshold * threshold;\r\n            if (newCapacity > maxCapacity - threshold) {\r\n                newCapacity = maxCapacity;\r\n            } else {\r\n                // newCapacity = 4 + 4 = 8M;\r\n                newCapacity += threshold;\r\n            }\r\n            return newCapacity;\r\n        }\r\n\r\n        // Not over threshold. Double up to 4 MiB, starting from 64.\r\n        // \u5982\u679c\u6240\u9700\u5bb9\u91cf\u5927\u4e8e4M  \u6309\u716764\u7684\u500d\u6570\u6269\u5bb9  \u627e\u5230\u6700\u63a5\u8fd1\u6240\u9700\u5bb9\u91cf\u768464\u7684\u500d\u6570\r\n        int newCapacity = 64;\r\n        while (newCapacity < minNewCapacity) {\r\n            newCapacity <<= 1;\r\n        }\r\n\r\n        // \u4fdd\u969c\u5728\u6700\u5927\u53ef\u63a5\u53d7\u5bb9\u91cf\u8303\u56f4\u5185\r\n        return Math.min(newCapacity, maxCapacity);\r\n    }\r\n\n'})}),"\n",(0,l.jsx)(n.h4,{id:"4\u4f18\u52bf",children:"4\uff09\u4f18\u52bf"}),"\n",(0,l.jsx)(n.p,{children:"A \u6c60\u5316\u7684\u65b9\u5f0f\u63d0\u9ad8\u5185\u5b58\u4f7f\u7528\u7387"}),"\n",(0,l.jsx)(n.p,{children:"B \u63d0\u51fa\u4e86\u590d\u5408\u578b\u7f13\u51b2\u533a\u7684\u6574\u5408\u65b9\u6848"}),"\n",(0,l.jsx)(n.p,{children:"C \u589e\u52a0\u4e86\u7d22\u5f15\uff0c\u4f7f\u8bfb\u5199\u5206\u79bb\uff0c\u4f7f\u7528\u66f4\u4fbf\u6377"}),"\n",(0,l.jsx)(n.p,{children:"D \u89e3\u51b3\u4e86 ByteBuffer \u957f\u5ea6\u56fa\u5b9a\u7684\u95ee\u9898\uff0c\u589e\u52a0\u4e86\u6269\u5bb9\u673a\u5236"}),"\n",(0,l.jsx)(n.p,{children:"E \u7528\u5f15\u7528\u8ba1\u6570\u7684\u65b9\u5f0f\u8fdb\u884c\u5bf9\u8c61\u56de\u6536"}),"\n",(0,l.jsx)(n.h3,{id:"2channel",children:"2\u3001Channel"}),"\n",(0,l.jsx)(n.h4,{id:"1channel",children:"1\uff09Channel"}),"\n",(0,l.jsx)(n.p,{children:"channel \u662f\u901a\u8baf\u7684\u8f7d\u4f53\uff0c\u5bf9\u5e94\u901a\u8baf\u7684\u4e00\u7aef\uff0c\u5728 BIO \u4e2d\u5bf9\u5e94 Socket\uff0cNIO \u4e2d\u5bf9\u5e94 SocketChannel\uff0cNetty \u4e2d\u5bf9\u5e94 NioSocketChannel\uff0cServerSocket \u540c\u7406\u3002\r\nchannelhandler \u662f\u901a\u9053\u7684\u5904\u7406\u5668\uff0c\u4e00\u4e2a channel \u5f80\u5f80\u6709\u591a\u4e2a handler\r\nchannelpipeline \u662f handler \u7684\u5bb9\u5668\uff0c\u88c5\u8f7d\u5e76\u7ba1\u7406 handler \u7684\u987a\u5e8f\uff08\u672c\u8d28\u662f\u53cc\u5411\u94fe\u8868\uff09"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/90201ec5a9bf88239a9ade0522deae73.png",alt:"image-20220412193249568"})}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u56fe\uff0cchannel \u521b\u5efa\u65f6\uff0c\u4f1a\u5bf9\u5e94\u521b\u5efa\u4e00\u4e2a channelpipeline\uff0cpipeline \u9996\u5148\u4f1a\u8bb0\u5f55\u4e00\u4e2a\u5934\u90e8\u7684\u5904\u7406\u5668 handler\uff0c\u5f53 pipeline \u8fdb\u884c\u5206\u53d1\u65f6\uff0c\u5148\u5206\u53d1\u7ed9\u5934\u90e8\uff0c\u7136\u540e\u4f9d\u6b21\u6267\u884c\uff0c\u6267\u884c handler \u5168\u90e8\u6267\u884c\u5b8c\u6210\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u540c\u65f6\uff0cchannel \u521b\u5efa\u540e\uff0c\u4f1a\u6ce8\u518c\u8fdb EventLoop \u4e4b\u4e2d\uff0cEventLoop \u4f1a\u76d1\u542c\u4e8b\u4ef6\u7684\u53d1\u751f\u3002\u4e0d\u540c\u7684\u4e8b\u4ef6\u8c03\u7528 handler \u4e0d\u540c\u7684\u5904\u7406\u65b9\u6cd5\uff0c\u8ba9\u6d41\u7a0b\u8fd0\u8f6c\u8d77\u6765\u3002"}),"\n",(0,l.jsx)(n.p,{children:"channel \u751f\u547d\u5468\u671f\uff0c\u5bf9\u5e94\u56db\u79cd\u72b6\u6001\uff0c\u5206\u522b\u4e3a\uff1a\r\nA) ChannelUnregistered \u5df2\u521b\u5efa\u4f46\u8fd8\u672a\u88ab\u6ce8\u518c\u5230\u76d1\u542c\u5668\u4e2d\r\nB) ChannelRegistered \u5df2\u6ce8\u518c\u5230\u76d1\u542c\u5668 EventLoop \u4e2d\r\nC) ChannelActive \u8fde\u63a5\u5b8c\u6210\u5904\u4e8e\u6d3b\u8dc3\u72b6\u6001\uff0c\u6b64\u65f6\u53ef\u4ee5\u63a5\u6536\u548c\u53d1\u9001\u6570\u636e\r\nD) ChannelInactive \u975e\u6d3b\u8dc3\u72b6\u6001\uff0c\u4ee3\u8868\u8fde\u63a5\u672a\u5efa\u7acb\u6216\u8005\u5df2\u65ad\u5f00"}),"\n",(0,l.jsx)(n.p,{children:"channelhandler \u751f\u547d\u5468\u671f\uff0c\u5bf9\u5e94\u4e09\u79cd\u72b6\u6001\uff0c\u5206\u522b\u4e3a\uff1a\r\nA) handlerAdded \u628a handler \u6dfb\u52a0\u5230 pipeline \u4e4b\u4e2d\r\nB) handlerRemoved \u4ece pipeline \u4e2d\u79fb\u9664\r\nC) exceptionCaught \u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\u6709\u9519\u8bef\u4ea7\u751f"}),"\n",(0,l.jsx)(n.p,{children:"\u521b\u5efa channel \u6e90\u7801\u5206\u6790"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'\u4ee5\u670d\u52a1\u7aef\u542f\u52a8\u4e3a\u4f8b\r\nChannelFuture future = serverBootstrap.bind(8888).sync();\r\n\r\n\u53c2\u6570\u8bbe\u7f6e\r\nserverBootstrap.channel(NioServerSocketChannel.class)\r\n\r\n\u3010AbstractBootstrap\u3011 \u542f\u52a8\u5bf9\u8c61\u7684\u7236\u7c7b\r\n------------------------------------------------------------------\r\n    public ChannelFuture bind(int inetPort) {\r\n        return bind(new InetSocketAddress(inetPort));\r\n    }\r\n\r\n    public ChannelFuture bind(SocketAddress localAddress) {\r\n        validate();\r\n        return doBind(ObjectUtil.checkNotNull(localAddress, "localAddress"));\r\n    }\r\n\r\n    private ChannelFuture doBind(final SocketAddress localAddress) {\r\n        final ChannelFuture regFuture = initAndRegister();\r\n        final Channel channel = regFuture.channel();\r\n        .......\r\n    }\r\n\r\n\r\n    final ChannelFuture initAndRegister() {\r\n        Channel channel = null;\r\n        try {\r\n            channel = channelFactory.newChannel();\r\n            init(channel);\r\n        }\r\n        .......\r\n    }\r\n\r\n\r\n \u3010ReflectiveChannelFactory\u3011  \u5de5\u5382\u5b9e\u73b0\u7c7b\r\n ------------------------------------------------------------------\r\n    public T newChannel() {\r\n        try {\r\n            return constructor.newInstance();\r\n        } catch (Throwable t) {\r\n            throw new ChannelException("Unable to create Channel from class " + constructor.getDeclaringClass(), t);\r\n        }\r\n    }\r\n\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5728\u542f\u52a8\u5bf9\u8c61\u8c03\u7528 bind()\u6216 connect()\u65b9\u6cd5\u65f6\uff0c\u4f1a\u521b\u5efa channel\r\n\u672c\u8d28\u4e0a\u901a\u8fc7\u53cd\u5c04\uff0c\u4f7f\u7528\u5de5\u5382\u7684\u53cd\u5c04\u5b9e\u73b0\u7c7b\u521b\u5efa\u5bf9\u5e94\u7684\u5b9e\u4f8b\uff0c\u6b64\u65f6\u5b9e\u4f8b\u5bf9\u8c61\u7684\u7c7b\u578b\u662f\u901a\u8fc7 channel \u53c2\u6570\u6765\u8bbe\u7f6e\u7684"}),"\n",(0,l.jsx)(n.h4,{id:"2channelhandler",children:"2\uff09ChannelHandler"}),"\n",(0,l.jsx)(n.p,{children:"\u7c7b\u5c42\u6b21\u5173\u7cfb\u56fe"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/31189cba11962f972bfef0d5b7db285f.png",alt:"image-20220412193256540"})}),"\n",(0,l.jsx)(n.p,{children:"\u5165\u7ad9\u548c\u51fa\u7ad9\uff1a\r\n\u4ece\u670d\u52a1\u7aef\u7684\u89d2\u5ea6\uff0c\u6570\u636e\u4ece\u5ba2\u6237\u7aef\u53d1\u9001\u5230\u670d\u52a1\u7aef\uff0c\u79f0\u4e4b\u4e3a\u5165\u7ad9\uff0c\u5f53\u6570\u636e\u5904\u7406\u5b8c\u6210\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u79f0\u4e4b\u4e3a\u51fa\u7ad9\u3002\u662f\u76f8\u5bf9\u7684\u6982\u5ff5\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u4ece\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\uff0c\u6570\u636e\u4ece\u670d\u52a1\u7aef\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\uff0c\u79f0\u4e4b\u4e3a\u5165\u7ad9\uff0c\u5f53\u6570\u636e\u8fd4\u56de\u7ed9\u670d\u52a1\u7aef\uff0c\u79f0\u4e4b\u4e3a\u51fa\u7ad9\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u4e0d\u8bba\u662f\u5165\u7ad9\u8fd8\u662f\u51fa\u7ad9\uff0chandler \u4ece\u4e00\u7aef\u5f00\u59cb\uff0c\u5230\u53e6\u4e00\u7aef\u7ed3\u675f\uff0c\u4ee5\u8d23\u4efb\u94fe\u7684\u6a21\u5f0f\u4f9d\u6b21\u6267\u884c\u3002"}),"\n",(0,l.jsx)(n.p,{children:'\u8d23\u4efb\u94fe\u6a21\u5f0f\u2014\u2014"\u51fb\u9f13\u4f20\u82b1"\uff0c\u5f53\u8bf7\u6c42\u88ab\u4e0d\u540c\u7684\u63a5\u6536\u8005\u5904\u7406\u65f6\uff0c\u6bcf\u4e2a\u63a5\u6536\u8005\u90fd\u5305\u542b\u5bf9\u4e0b\u4e00\u4e2a\u63a5\u6536\u8005\u7684\u5f15\u7528\uff0c\u4e00\u4e2a\u63a5\u6536\u8005\u5904\u7406\u5b8c\u6210\u540e\uff0c\u5c06\u4f9d\u6b21\u5411\u4e0b\u4f20\u9012\u3002'}),"\n",(0,l.jsx)(n.p,{children:"\u9002\u914d\u5668\u6a21\u5f0f\u2014\u2014\u51fa\u56fd\u65f6\u8981\u4f7f\u7528\u7684\u7535\u6e90\u8f6c\u6362\u5668\uff08\u7f8e\u56fd/\u65e5\u672c 110V \u4e2d\u56fd 220V \u7535\u538b\uff09\uff0c\u4f5c\u4e3a\u4e24\u4e2a\u4e0d\u517c\u5bb9\u7684\u63a5\u53e3\u4e4b\u95f4\u7684\u6865\u6881\uff0c\u5c06\u7c7b\u7684\u63a5\u53e3\u8f6c\u6362\u4e3a\u9700\u8981\u7684\u53e6\u5916\u4e00\u79cd\u63a5\u53e3\u3002"}),"\n",(0,l.jsx)(n.p,{children:"ChannelDuplexHandler \u662f\u9664\u4e86\u5165\u7ad9\u548c\u51fa\u7ad9 handler \u4e4b\u5916\u7684\uff0c\u53e6\u4e00\u4e2a\u5e38\u7528\u5b50\u7c7b\u3002\r\n\u5b83\u540c\u65f6\u5b9e\u73b0\u4e86 ChannelInboundHandler \u548c ChannelOutboundHandler \u63a5\u53e3\uff0c\u5982\u679c\u9700\u8981\u65e2\u5904\u7406\u5165\u7ad9\u4e8b\u4ef6\u53c8\u5904\u7406\u51fa\u7ad9\u4e8b\u4ef6\uff0c\u53ef\u4ee5\u7ee7\u627f\u6b64\u7c7b\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" serverBootstrap.handler(new LoggingHandler(LogLevel.INFO))\r\n\r\n ------------------------------------------------------------------\r\n public class LoggingHandler extends ChannelDuplexHandler{}\r\n\r\n ------------------------------------------------------------------\r\n public class ChannelDuplexHandler extends ChannelInboundHandlerAdapter implements ChannelOutboundHandler {}\r\n\r\n  ------------------------------------------------------------------\r\n  public class ChannelInboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelInboundHandler {}\r\n\n"})}),"\n",(0,l.jsx)(n.p,{children:"ChannelHandlerAdapter\r\n\u63d0\u4f9b\u4e86\u989d\u5916\u7684 isSharable()\u65b9\u6cd5\uff0c\u7528\u6765\u5224\u65ad handler \u662f\u5426\u53ef\u4ee5\u88ab\u5171\u4eab\u5230\u591a\u4e2a pipeline \u4e4b\u4e2d\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0d\u5171\u4eab\uff0c\u5982\u679c\u9700\u8981\u5171\u4eab\uff0c\u5728\u7ee7\u627f\u4e86\u9002\u914d\u5668\u7684 handler \u4e0a\uff0c\u589e\u52a0\u6ce8\u89e3@Sharable"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"@Sharable\r\npublic class LoggingHandler extends ChannelDuplexHandler {}\n"})}),"\n",(0,l.jsx)(n.p,{children:"ChannelInboundHandler\r\n\u6700\u91cd\u8981\u7684\u65b9\u6cd5\u662f channelRead()\uff0c\u5728\u4f7f\u7528\u65f6\uff0c\u9700\u8981\u663e\u5f0f\u7684\u91ca\u653e ByteBuf \u76f8\u5173\u7684\u5185\u5b58\u3002\u4f7f\u7528 ReferenceCountUtil \u662f\u5f15\u7528\u8ba1\u6570\u7684\u5de5\u5177\u7c7b\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"    @Override\r\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\r\n        // netty\u4e2d\u7684\u7f13\u51b2\u533a  \u53eb\u505aByteBuf  -- \u5bf9ByteBuffer\u7684\u5c01\u88c5\r\n        ByteBuf buf = (ByteBuf) msg;\r\n        // \u91ca\u653eByteBuf\u5185\u5b58\r\n        ReferenceCountUtil.release(msg);\r\n    }\r\n\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u4e3a\u4e86\u51cf\u5c11\u5bf9\u8d44\u6e90\u5185\u5b58\u7684\u7ba1\u7406\uff0c\u4f7f\u7528 SimpleChannelInboundHandler\uff0c\u4f7f\u7528\u5176 channelRead0()\u65b9\u6cd5\uff0c\u53ef\u4ee5\u81ea\u52a8\u91ca\u653e\u8d44\u6e90\uff0c\u4f7f\u7528\u66f4\u4fbf\u5229\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'SimpleChannelInboundHandler\u6e90\u7801\r\n------------------------------------------------\r\n@Override\r\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\r\n        boolean release = true;\r\n        try {\r\n            if (acceptInboundMessage(msg)) {\r\n                @SuppressWarnings("unchecked")\r\n                I imsg = (I) msg;\r\n                channelRead0(ctx, imsg);\r\n            } else {\r\n                release = false;\r\n                ctx.fireChannelRead(msg);\r\n            }\r\n        } finally {\r\n            if (autoRelease && release) {\r\n                ReferenceCountUtil.release(msg);\r\n            }\r\n        }\r\n    }\n'})}),"\n",(0,l.jsx)(n.h4,{id:"3channelpipeline",children:"3\uff09ChannelPipeline"}),"\n",(0,l.jsx)(n.p,{children:"pipeline \u4e2d\u7ef4\u62a4\u5165\u7ad9\u548c\u51fa\u7ad9\u94fe\u8def\uff0c\u4e24\u6761\u94fe\u8def\u7684\u6267\u884c\u987a\u5e8f\u3002"}),"\n",(0,l.jsx)(n.p,{children:"handler \u53ea\u8d1f\u8d23\u5904\u7406\u81ea\u8eab\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u5bf9\u901a\u9053\u800c\u8a00\uff0c\u5b83\u662f\u65e0\u72b6\u6001\u7684\u3002\u901a\u9053\u7684\u4fe1\u606f\u4f1a\u4fdd\u5b58\u5230 handlerContext \u5904\u7406\u5668\u4e0a\u4e0b\u6587\u4e2d\uff0c\u5b83\u662f\u8fde\u63a5 pipeline \u548c handler \u4e4b\u95f4\u7684\u4e2d\u95f4\u89d2\u8272\u3002"}),"\n",(0,l.jsx)(n.p,{children:"pipeline \u7ba1\u7406\u7684\u662f\u7531 handlerContext \u5305\u88f9\u7684 handler\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6dfb\u52a0 handler \u65f6\uff0c\u5148\u5c06\u5176\u8f6c\u4e3a handlerContext\uff0c\u7136\u540e\u6dfb\u52a0\u5230 pipeline \u7684\u53cc\u5411\u94fe\u8868\u4e2d\u3002\u5934\u7ed3\u70b9\u53eb\u505a HeadContext\uff0c\u5c3e\u8282\u70b9\u53eb\u505a TailContext\u3002"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/c5fbb62a2262209d78cbad3329fdacef.png",alt:"image-20220412193303101"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:' ch.pipeline().addLast(new NettyServerHandler());\r\n\r\n [DefaultChannelPipeline]\r\n ----------------------------------------------------------------\r\n    public final ChannelPipeline addLast(ChannelHandler... handlers) {\r\n        return addLast(null, handlers);\r\n    }\r\n\r\n    public final ChannelPipeline addLast(EventExecutorGroup executor, ChannelHandler... handlers) {\r\n        ObjectUtil.checkNotNull(handlers, "handlers");\r\n\r\n        for (ChannelHandler h: handlers) {\r\n            if (h == null) {\r\n                break;\r\n            }\r\n            addLast(executor, null, h);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n\r\n    // \u5173\u952e\u903b\u8f91\r\n    public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {\r\n        final AbstractChannelHandlerContext newCtx;\r\n        synchronized (this) {\r\n            // \u68c0\u67e5\u5f53\u524dhandler\u662f\u5426\u652f\u6301\u5171\u4eab\uff0c\u5982\u679c\u4e0d\u652f\u6301\uff0c\u53c8\u88ab\u6dfb\u52a0\u5230\u5176\u4ed6pipeline\u4e2d\uff0c\u4f1a\u62a5\u9519\r\n            checkMultiplicity(handler);\r\n\t\t    // \u5c06handler\u5c01\u88c5\u4e3acontext\r\n            newCtx = newContext(group, filterName(name, handler), handler);\r\n            // \u5c06context\u6dfb\u52a0\u5230\u94fe\u8868\u5c3e\u90e8\r\n            addLast0(newCtx);\r\n\r\n            // If the registered is false it means that the channel was not registered on an eventLoop yet.\r\n            // In this case we add the context to the pipeline and add a task that will call\r\n            // ChannelHandler.handlerAdded(...) once the channel is registered.\r\n            // \u5224\u65ad\u5f53\u524d\u901a\u9053\u7684\u6ce8\u518c\u72b6\u6001\uff0c\u5982\u679c\u662f\u672a\u6ce8\u518c\uff0c\u6267\u884c\u6b64\u903b\u8f91\r\n            if (!registered) {\r\n                // \u6dfb\u52a0\u4e00\u4e2a\u4efb\u52a1\uff0c\u5f53\u901a\u9053\u88ab\u6ce8\u518c\u540e\uff0c\u80fd\u591f\u56de\u8c03handlerAdded\u65b9\u6cd5\r\n                newCtx.setAddPending();\r\n                callHandlerCallbackLater(newCtx, true);\r\n                return this;\r\n            }\r\n            // \u5982\u679c\u5df2\u88ab\u6ce8\u518c  \u6267\u884c\u8c03\u7528handlerAdded\u65b9\u6cd5\r\n            EventExecutor executor = newCtx.executor();\r\n            if (!executor.inEventLoop()) {\r\n                callHandlerAddedInEventLoop(newCtx, executor);\r\n                return this;\r\n            }\r\n        }\r\n        callHandlerAdded0(newCtx);\r\n        return this;\r\n    }\r\n\r\n\r\n\r\n    private static void checkMultiplicity(ChannelHandler handler) {\r\n        if (handler instanceof ChannelHandlerAdapter) {\r\n            ChannelHandlerAdapter h = (ChannelHandlerAdapter) handler;\r\n            if (!h.isSharable() && h.added) {\r\n                throw new ChannelPipelineException(\r\n                        h.getClass().getName() +\r\n                        " is not a @Sharable handler, so can\'t be added or removed multiple times.");\r\n            }\r\n            h.added = true;\r\n        }\r\n    }\r\n\r\n\r\n    private AbstractChannelHandlerContext newContext(EventExecutorGroup group, String name, ChannelHandler handler) {\r\n        return new DefaultChannelHandlerContext(this, childExecutor(group), name, handler);\r\n    }\r\n\r\n    // \u5c3e\u8282\u70b9\u4f1a\u63d0\u524d\u58f0\u660e\u5e76\u521b\u5efa\r\n    final AbstractChannelHandlerContext tail;\r\n\r\n    //  prev -> tail   \u5728\u5176\u4e2d\u63d2\u5165newctx\r\n    //  prev -> newctx -> tail   \u653e\u5230\u5012\u6570\u7b2c\u4e8c\u4e2a\u4f4d\u7f6e\u4e2d  tail\u8282\u70b9\u662f\u4fdd\u6301\u4e0d\u53d8\u7684\r\n    //  \u4f9d\u6b21\u66f4\u6539 \u65b0\u8282\u70b9\u7684\u524d\u540e\u6307\u9488   \u4ee5\u53caprev\u8282\u70b9\u7684\u540e\u7f6e\u6307\u9488\u548ctail\u8282\u70b9\u7684\u524d\u7f6e\u6307\u9488\r\n    private void addLast0(AbstractChannelHandlerContext newCtx) {\r\n        AbstractChannelHandlerContext prev = tail.prev;\r\n        newCtx.prev = prev;\r\n        newCtx.next = tail;\r\n        prev.next = newCtx;\r\n        tail.prev = newCtx;\r\n    }\r\n\r\n    // \u6784\u9020\u5668\u4e2d\u5df2\u7ecf\u63d0\u524d\u521b\u5efa\u4e86\u5934\u5c3e\u8282\u70b9\r\n    protected DefaultChannelPipeline(Channel channel) {\r\n        this.channel = ObjectUtil.checkNotNull(channel, "channel");\r\n        succeededFuture = new SucceededChannelFuture(channel, null);\r\n        voidPromise =  new VoidChannelPromise(channel, true);\r\n\r\n        tail = new TailContext(this);\r\n        head = new HeadContext(this);\r\n\r\n        head.next = tail;\r\n        tail.prev = head;\r\n    }\r\n\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528 pipeline \u6a21\u5f0f\u7684\u4f18\u70b9\uff1a\r\nA) \u89e3\u8026\uff0c\u8ba9\u5904\u7406\u5668\u903b\u8f91\u72ec\u7acb\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a channel \u5171\u4eab\r\nB) channel \u76f8\u5173\u4fe1\u606f\uff0c\u4ea4\u7ed9 context \u7ef4\u62a4\r\nC) \u5177\u6709\u6781\u5927\u7684\u7075\u6d3b\u6027\uff0c\u4f7f\u7528\u5904\u7406\u5668\u53ef\u4ee5\u65b9\u4fbf\u7684\u6dfb\u52a0\u6216\u5220\u9664\uff0c\u6216\u8005\u66f4\u6539\u5b83\u4eec\u7684\u987a\u5e8f"}),"\n",(0,l.jsx)(n.h3,{id:"3eventloop",children:"3\u3001EventLoop"}),"\n",(0,l.jsx)(n.p,{children:"EventLoop \u4e8b\u4ef6\u5faa\u73af\uff0c\u76d1\u542c IO \u4e8b\u4ef6\uff0c\u5185\u90e8\u5c01\u88c5\u4e86\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:"EventLoopGroup \u4e8b\u4ef6\u5faa\u73af\u7ec4\uff0c\u662f\u5bf9 EventLoop \u7684\u7ba1\u7406\uff0c\u5c01\u88c5\u4e86\u7ebf\u7a0b\u6c60\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5f53\u65b0\u5efa channel \u65f6\uff0cgroup \u4f1a\u4e3a\u5176\u5206\u914d\u4e00\u4e2a EventLoop\uff0c\u5c01\u88c5\u4e86 nio \u4e2d\u7684 Selector\uff0c\u76d1\u542c\u901a\u9053\u4e2d\u7684\u6240\u6709\u4e8b\u4ef6\uff0c\u4e00\u4e2a\u901a\u9053\u7684\u751f\u547d\u5468\u671f\u5185\uff0c\u6240\u6709\u64cd\u4f5c\u90fd\u7531\u76f8\u540c\u7684 EventLoop \u6240\u5c01\u88c5\u7684\u7ebf\u7a0b\u5904\u7406\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u540c\u65f6\uff0c\u591a\u4e2a\u901a\u9053\u53ef\u4ee5\u7531\u4e00\u4e2a EventLoop \u5904\u7406\uff0c\u662f\u591a\u5bf9\u4e00\u7684\u5173\u7cfb"}),"\n",(0,l.jsx)(n.h4,{id:"1eventloopgroup",children:"1\uff09EventLoopGroup"}),"\n",(0,l.jsx)(n.p,{children:"\u7c7b\u5c42\u7ea7\u7ed3\u6784\r\n\uff08\u901a\u8fc7\u9009\u4e2d NioEventLoopGroup \u6e90\u7801 - \u53f3\u952e - \u9009\u4e2d Diagrams - \u9009\u4e2d show diagram \u5c55\u793a\u51fa\u6765\uff09"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/f5d714566ee453cf273fba948d5c8376.png",alt:"image-20220412193309395"})}),"\n",(0,l.jsx)(n.h5,{id:"a-\u521d\u59cb\u5316\u6d41\u7a0b",children:"A \u521d\u59cb\u5316\u6d41\u7a0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'EventLoopGroup bossGroup = new NioEventLoopGroup();\r\nEventLoopGroup workerGroup = new NioEventLoopGroup();\r\n\r\n\r\n[NioEventLoopGroup]\r\n-------------------------------------------------------------------------\r\n    public NioEventLoopGroup() {\r\n        this(0);\r\n    }\r\n\r\n    public NioEventLoopGroup(int nThreads) {\r\n        this(nThreads, (Executor) null);\r\n    }\r\n\r\n    public NioEventLoopGroup(int nThreads, Executor executor) {\r\n        this(nThreads, executor, SelectorProvider.provider());\r\n    }\r\n\r\n    // \u9010\u6b65\u589e\u52a0\u53c2\u6570\r\n    public NioEventLoopGroup(\r\n            int nThreads, Executor executor, final SelectorProvider selectorProvider) {\r\n        this(nThreads, executor, selectorProvider, DefaultSelectStrategyFactory.INSTANCE);\r\n    }\r\n\r\n    // \u8c03\u7528\u7236\u7c7b\u7684\u6784\u9020\u5668\r\n    public NioEventLoopGroup(int nThreads, Executor executor, final SelectorProvider selectorProvider,\r\n                             final SelectStrategyFactory selectStrategyFactory) {\r\n        super(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());\r\n    }\r\n\r\n\r\n [MultithreadEventLoopGroup]\r\n-------------------------------------------------------------------------\r\n    protected MultithreadEventLoopGroup(int nThreads, Executor executor, Object... args) {\r\n        super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, executor, args);\r\n    }\r\n\r\n    // \u521d\u59cb\u5316\u7ebf\u7a0b\u6570\u91cf\u7684\u903b\u8f91     \u7ebf\u7a0b\u6570 = cpu\u6838\u6570 * 2\r\n    private static final int DEFAULT_EVENT_LOOP_THREADS;\r\n    static {\r\n        DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(\r\n                "io.netty.eventLoopThreads", NettyRuntime.availableProcessors() * 2));\r\n\r\n        if (logger.isDebugEnabled()) {\r\n            logger.debug("-Dio.netty.eventLoopThreads: {}", DEFAULT_EVENT_LOOP_THREADS);\r\n        }\r\n    }\r\n\r\n\r\n[MultithreadEventExecutorGroup]\r\n-------------------------------------------------------------------------\r\n    protected MultithreadEventExecutorGroup(int nThreads, Executor executor, Object... args) {\r\n        this(nThreads, executor, DefaultEventExecutorChooserFactory.INSTANCE, args);\r\n    }\r\n\r\n    // \u6838\u5fc3\u903b\u8f91\r\n    protected MultithreadEventExecutorGroup(int nThreads, Executor executor,\r\n                                            EventExecutorChooserFactory chooserFactory, Object... args) {\r\n        if (nThreads <= 0) {\r\n            throw new IllegalArgumentException(String.format("nThreads: %d (expected: > 0)", nThreads));\r\n        }\r\n\r\n        if (executor == null) {\r\n            executor = new ThreadPerTaskExecutor(newDefaultThreadFactory());\r\n        }\r\n\r\n        children = new EventExecutor[nThreads];\r\n\r\n        for (int i = 0; i < nThreads; i ++) {\r\n            boolean success = false;\r\n            try {\r\n                // \u6839\u636e\u7ebf\u7a0b\u6570\u91cf  \u521b\u5efaEventLoop\u7684\u903b\u8f91\r\n                // newChild\uff08\uff09\u7684\u5177\u4f53\u5b9e\u73b0\u5728NioEventLoopGroup\u7c7b\u4e2d\r\n                children[i] = newChild(executor, args);\r\n                success = true;\r\n            } catch (Exception e) {\r\n                // TODO: Think about if this is a good exception type\r\n                throw new IllegalStateException("failed to create a child event loop", e);\r\n            } finally {\r\n                if (!success) {\r\n                    for (int j = 0; j < i; j ++) {\r\n                        children[j].shutdownGracefully();\r\n                    }\r\n\r\n                    for (int j = 0; j < i; j ++) {\r\n                        EventExecutor e = children[j];\r\n                        try {\r\n                            while (!e.isTerminated()) {\r\n                                e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);\r\n                            }\r\n                        } catch (InterruptedException interrupted) {\r\n                            // Let the caller handle the interruption.\r\n                            Thread.currentThread().interrupt();\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        chooser = chooserFactory.newChooser(children);\r\n\r\n        final FutureListener<Object> terminationListener = new FutureListener<Object>() {\r\n            @Override\r\n            public void operationComplete(Future<Object> future) throws Exception {\r\n                if (terminatedChildren.incrementAndGet() == children.length) {\r\n                    terminationFuture.setSuccess(null);\r\n                }\r\n            }\r\n        };\r\n\r\n        for (EventExecutor e: children) {\r\n            e.terminationFuture().addListener(terminationListener);\r\n        }\r\n\r\n        Set<EventExecutor> childrenSet = new LinkedHashSet<EventExecutor>(children.length);\r\n        Collections.addAll(childrenSet, children);\r\n        readonlyChildren = Collections.unmodifiableSet(childrenSet);\r\n    }\r\n\r\n\r\n[NioEventLoopGroup]\r\n-------------------------------------------------------------------------\r\n     @Override\r\n    protected EventLoop newChild(Executor executor, Object... args) throws Exception {\r\n        EventLoopTaskQueueFactory queueFactory = args.length == 4 ? (EventLoopTaskQueueFactory) args[3] : null;\r\n        return new NioEventLoop(this, executor, (SelectorProvider) args[0],\r\n            ((SelectStrategyFactory) args[1]).newSelectStrategy(), (RejectedExecutionHandler) args[2], queueFactory);\r\n    }\r\n\r\n\n'})}),"\n",(0,l.jsx)(n.h4,{id:"2eventloop",children:"2\uff09EventLoop"}),"\n",(0,l.jsx)(n.p,{children:"\u91cd\u8981\u5c5e\u6027\u4e3a Selector \u53ca\u5176\u7236\u7c7b\u7684\u7236\u7c7b\u4e2d\u7684 Thread\r\nSelector \u7528\u4e8e\u5728 channel \u521b\u5efa\u4e4b\u540e\uff0c\u6ce8\u518c\u5176\u4e2d\u76d1\u542c\u540e\u7eed\u7684 I/O \u4e8b\u4ef6\r\nThread \u7528\u4e8e\u8fdb\u884c\u8f6e\u8be2\uff0c\u5728 channel \u6ce8\u518c\u4e4b\u540e\u542f\u52a8\u7ebf\u7a0b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/a9d3c52108af6a66c7470c6f8b2d2b00.png",alt:"image-20220412193320506"})}),"\n",(0,l.jsx)(n.h5,{id:"a-\u6ce8\u518c-channel",children:"A \u6ce8\u518c channel"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:' ChannelFuture future = serverBootstrap.bind(8888).sync();\r\n\r\n [AbstractBootstrap]\r\n --------------------------------------------------------------------------\r\n    public ChannelFuture bind(int inetPort) {\r\n        return bind(new InetSocketAddress(inetPort));\r\n    }\r\n\r\n\r\n    public ChannelFuture bind(SocketAddress localAddress) {\r\n        validate();\r\n        return doBind(ObjectUtil.checkNotNull(localAddress, "localAddress"));\r\n    }\r\n\r\n    private ChannelFuture doBind(final SocketAddress localAddress) {\r\n        final ChannelFuture regFuture = initAndRegister();\r\n        final Channel channel = regFuture.channel();\r\n        .....\r\n    }\r\n\r\n    final ChannelFuture initAndRegister() {\r\n        Channel channel = null;\r\n        try {\r\n            channel = channelFactory.newChannel();\r\n            init(channel);\r\n        } catch (Throwable t) {\r\n            if (channel != null) {\r\n                channel.unsafe().closeForcibly();\r\n                return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);\r\n            }\r\n            return new DefaultChannelPromise(new FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);\r\n        }\r\n\r\n        ChannelFuture regFuture = config().group().register(channel);\r\n        if (regFuture.cause() != null) {\r\n            if (channel.isRegistered()) {\r\n                channel.close();\r\n            } else {\r\n                channel.unsafe().closeForcibly();\r\n            }\r\n        }\r\n        return regFuture;\r\n    }\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6ce8\u518c\u7684\u6e90\u7801\u8c03\u7528\u94fe\u8def"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'ChannelFuture regFuture = config().group().register(channel);\r\n\r\n[MultithreadEventLoopGroup]\r\n------------------------------------------------------------------------------\r\n    public ChannelFuture register(Channel channel) {\r\n        return next().register(channel);\r\n    }\r\n\r\n[SingleThreadEventLoop]\r\n------------------------------------------------------------------------------\r\n    public ChannelFuture register(Channel channel) {\r\n        return register(new DefaultChannelPromise(channel, this));\r\n    }\r\n\r\n\r\n    public ChannelFuture register(final ChannelPromise promise) {\r\n        ObjectUtil.checkNotNull(promise, "promise");\r\n        promise.channel().unsafe().register(this, promise);\r\n        return promise;\r\n    }\r\n\r\n\r\n[AbstractChannel]\r\n------------------------------------------------------------------------------\r\n//  \u6838\u5fc3\u903b\u8f91\u662f \u8c03\u7528\u4e86 register0()\u65b9\u6cd5\r\n public final void register(EventLoop eventLoop, final ChannelPromise promise) {\r\n            ObjectUtil.checkNotNull(eventLoop, "eventLoop");\r\n            if (isRegistered()) {\r\n                promise.setFailure(new IllegalStateException("registered to an event loop already"));\r\n                return;\r\n            }\r\n            if (!isCompatible(eventLoop)) {\r\n                promise.setFailure(\r\n                        new IllegalStateException("incompatible event loop type: " + eventLoop.getClass().getName()));\r\n                return;\r\n            }\r\n\r\n\t\t\t// channel\u4e2d\u5b58\u5728EventLoop\u7c7b\u578b\u7684\u5c5e\u6027\r\n            // \u901a\u9053\u521d\u59cb\u5316\u65f6\uff0c\u4f1a\u5c06\u6307\u5b9a\u7684EventLoop\u4e0echannel\u8fdb\u884c\u5173\u8054\r\n            AbstractChannel.this.eventLoop = eventLoop;\r\n\r\n            if (eventLoop.inEventLoop()) {\r\n                register0(promise);\r\n            } else {\r\n                try {\r\n                    eventLoop.execute(new Runnable() {\r\n                        @Override\r\n                        public void run() {\r\n                            register0(promise);\r\n                        }\r\n                    });\r\n                } catch (Throwable t) {\r\n                    logger.warn(\r\n                            "Force-closing a channel whose registration task was not accepted by an event loop: {}",\r\n                            AbstractChannel.this, t);\r\n                    closeForcibly();\r\n                    closeFuture.setClosed();\r\n                    safeSetFailure(promise, t);\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n     // \u6838\u5fc3\u903b\u8f91\u662f\u8c03\u7528\u4e86doRegister()\u65b9\u6cd5\r\n     private void register0(ChannelPromise promise) {\r\n            try {\r\n                // check if the channel is still open as it could be closed in the mean time when the register\r\n                // call was outside of the eventLoop\r\n                if (!promise.setUncancellable() || !ensureOpen(promise)) {\r\n                    return;\r\n                }\r\n                boolean firstRegistration = neverRegistered;\r\n                doRegister();\r\n                neverRegistered = false;\r\n                registered = true;\r\n\r\n                // Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the\r\n                // user may already fire events through the pipeline in the ChannelFutureListener.\r\n                pipeline.invokeHandlerAddedIfNeeded();\r\n\r\n                safeSetSuccess(promise);\r\n                pipeline.fireChannelRegistered();\r\n                // Only fire a channelActive if the channel has never been registered. This prevents firing\r\n                // multiple channel actives if the channel is deregistered and re-registered.\r\n                if (isActive()) {\r\n                    if (firstRegistration) {\r\n                        pipeline.fireChannelActive();\r\n                    } else if (config().isAutoRead()) {\r\n                        // This channel was registered before and autoRead() is set. This means we need to begin read\r\n                        // again so that we process inbound data.\r\n                        //\r\n                        // See https://github.com/netty/netty/issues/4805\r\n                        beginRead();\r\n                    }\r\n                }\r\n            } catch (Throwable t) {\r\n                // Close the channel directly to avoid FD leak.\r\n                closeForcibly();\r\n                closeFuture.setClosed();\r\n                safeSetFailure(promise, t);\r\n            }\r\n        }\r\n\r\n\r\n[AbstractNioChannel]\r\n----------------------------------------------------------------------------\r\n// \u6838\u5fc3\u6ce8\u518c\u903b\u8f91\r\nprotected void doRegister() throws Exception {\r\n        boolean selected = false;\r\n        for (;;) {\r\n            try {\r\n                // \u5c06\u901a\u9053\u6ce8\u518c\u8fdbSelector\u4e2d \u6b64\u65f6\u611f\u5174\u8da3\u7684\u4e8b\u4ef6\u662f0\r\n                // \u5e76\u4e14\u5c06\u5f53\u524d\u5bf9\u8c61\u4f5c\u4e3a\u9644\u52a0\u5bf9\u8c61\u5b58\u5165\u5176\u4e2d  \u7b49\u4ef7selectionKey.attach()\u65b9\u6cd5\r\n                // \u4f7f\u7528\u5bf9\u8c61\u65f6   \u518d\u901a\u8fc7selectionkey.attachment()\u65b9\u6cd5\u53d6\u51fa\u5bf9\u8c61\r\n                selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this);\r\n                return;\r\n            } catch (CancelledKeyException e) {\r\n                if (!selected) {\r\n                    // Force the Selector to select now as the "canceled" SelectionKey may still be\r\n                    // cached and not removed because no Select.select(..) operation was called yet.\r\n                    eventLoop().selectNow();\r\n                    selected = true;\r\n                } else {\r\n                    // We forced a select operation on the selector before but the SelectionKey is still cached\r\n                    // for whatever reason. JDK bug ?\r\n                    throw e;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\n'})}),"\n",(0,l.jsx)(n.h5,{id:"b-\u8f6e\u8be2\u4e8b\u4ef6\u7684\u72b6\u6001",children:"B \u8f6e\u8be2\u4e8b\u4ef6\u7684\u72b6\u6001"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/c23f36d521261ca784b3e4e60dc508cb.png",alt:"image-20220412193329743"})}),"\n",(0,l.jsx)(n.p,{children:"\u8bfb\u53d6\u6e90\u7801\u7684\u601d\u8def\uff1a\u627e\u5230\u5165\u53e3\uff0c\u627e\u5230\u6838\u5fc3\u903b\u8f91\u3002"}),"\n",(0,l.jsx)(n.p,{children:"AbstractChannel \u4e2d register()\u65b9\u6cd5\uff0c\u5bf9 eventLoop.execute()\u7684\u8c03\u7528\uff0c\u5c31\u662f\u542f\u52a8\u7ebf\u7a0b\u8fdb\u884c\u8f6e\u8be2\u7684\u5165\u53e3\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'[SingleThreadEventExecutor]\r\n-----------------------------------------------------------------------------\r\n    public void execute(Runnable task) {\r\n        ObjectUtil.checkNotNull(task, "task");\r\n        execute(task, !(task instanceof LazyRunnable) && wakesUpForTask(task));\r\n    }\r\n\r\n    private final Queue<Runnable> taskQueue;\r\n    //  \u5f53\u524d\u7c7b\u7ef4\u62a4\u4e86\u4e00\u4e2a\u4efb\u52a1\u961f\u5217\r\n    private void execute(Runnable task, boolean immediate) {\r\n        boolean inEventLoop = inEventLoop();\r\n        addTask(task);\r\n        if (!inEventLoop) {\r\n            // \u542f\u52a8\u7ebf\u7a0b\r\n            startThread();\r\n            if (isShutdown()) {\r\n                boolean reject = false;\r\n                try {\r\n                    if (removeTask(task)) {\r\n                        reject = true;\r\n                    }\r\n                } catch (UnsupportedOperationException e) {\r\n                    // The task queue does not support removal so the best thing we can do is to just move on and\r\n                    // hope we will be able to pick-up the task before its completely terminated.\r\n                    // In worst case we will log on termination.\r\n                }\r\n                if (reject) {\r\n                    reject();\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!addTaskWakesUp && immediate) {\r\n            wakeup(inEventLoop);\r\n        }\r\n    }\r\n\r\n\r\n    private void startThread() {\r\n        if (state == ST_NOT_STARTED) {\r\n            if (STATE_UPDATER.compareAndSet(this, ST_NOT_STARTED, ST_STARTED)) {\r\n                boolean success = false;\r\n                try {\r\n                    doStartThread();\r\n                    success = true;\r\n                } finally {\r\n                    if (!success) {\r\n                        STATE_UPDATER.compareAndSet(this, ST_STARTED, ST_NOT_STARTED);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    private void doStartThread() {\r\n        assert thread == null;\r\n        executor.execute(new Runnable() {\r\n            @Override\r\n            public void run() {\r\n                thread = Thread.currentThread();\r\n                if (interrupted) {\r\n                    thread.interrupt();\r\n                }\r\n\r\n                boolean success = false;\r\n                updateLastExecutionTime();\r\n                try {\r\n                    // \u771f\u6b63\u7684\u8c03\u7528\u903b\u8f91\r\n                    SingleThreadEventExecutor.this.run();\r\n                    success = true;\r\n                }\r\n\r\n                ......\r\n            }\r\n         }\r\n     }\r\n\r\n[NioEventLoop]\r\n-----------------------------------------------------------------------------\r\nprotected void run() {\r\n        int selectCnt = 0;\r\n        for (;;) {\r\n            try {\r\n                int strategy;\r\n                try {\r\n                    strategy = selectStrategy.calculateStrategy(selectNowSupplier, hasTasks());\r\n                    switch (strategy) {\r\n                    case SelectStrategy.CONTINUE:\r\n                        continue;\r\n\r\n                    case SelectStrategy.BUSY_WAIT:\r\n                        // fall-through to SELECT since the busy-wait is not supported with NIO\r\n\r\n                    case SelectStrategy.SELECT:\r\n                        long curDeadlineNanos = nextScheduledTaskDeadlineNanos();\r\n                        if (curDeadlineNanos == -1L) {\r\n                            curDeadlineNanos = NONE; // nothing on the calendar\r\n                        }\r\n                        nextWakeupNanos.set(curDeadlineNanos);\r\n                        try {\r\n                            // \u5224\u65ad\u961f\u5217\u4e2d\u662f\u5426\u5b58\u5728\u4efb\u52a1\r\n                            if (!hasTasks()) {\r\n                                // \u5982\u679c\u4e0d\u5b58\u5728  \u8c03\u7528select()\u8fdb\u884c\u83b7\u53d6\r\n                                strategy = select(curDeadlineNanos);\r\n                            }\r\n                        } finally {\r\n                            // This update is just to help block unnecessary selector wakeups\r\n                            // so use of lazySet is ok (no race condition)\r\n                            nextWakeupNanos.lazySet(AWAKE);\r\n                        }\r\n                        // fall through\r\n                    default:\r\n                    }\r\n                } catch (IOException e) {\r\n                    // If we receive an IOException here its because the Selector is messed up. Let\'s rebuild\r\n                    // the selector and retry. https://github.com/netty/netty/issues/8566\r\n                    rebuildSelector0();\r\n                    selectCnt = 0;\r\n                    handleLoopException(e);\r\n                    continue;\r\n                }\r\n\r\n                selectCnt++;\r\n                cancelledKeys = 0;\r\n                needsToSelectAgain = false;\r\n                final int ioRatio = this.ioRatio;\r\n                boolean ranTasks;\r\n                if (ioRatio == 100) {\r\n                    try {\r\n                        if (strategy > 0) {\r\n                            // \u5904\u7406\u4efb\u52a1\u7684\u6838\u5fc3\u903b\u8f91\r\n                            processSelectedKeys();\r\n                        }\r\n                    } finally {\r\n                        // Ensure we always run tasks.\r\n                        ranTasks = runAllTasks();\r\n                    }\r\n                } else if (strategy > 0) {\r\n                    final long ioStartTime = System.nanoTime();\r\n                    try {\r\n                        processSelectedKeys();\r\n                    } finally {\r\n                        // Ensure we always run tasks.\r\n                        final long ioTime = System.nanoTime() - ioStartTime;\r\n                        ranTasks = runAllTasks(ioTime * (100 - ioRatio) / ioRatio);\r\n                    }\r\n                } else {\r\n                    ranTasks = runAllTasks(0); // This will run the minimum number of tasks\r\n                }\r\n\r\n                if (ranTasks || strategy > 0) {\r\n                    if (selectCnt > MIN_PREMATURE_SELECTOR_RETURNS && logger.isDebugEnabled()) {\r\n                        logger.debug("Selector.select() returned prematurely {} times in a row for Selector {}.",\r\n                                selectCnt - 1, selector);\r\n                    }\r\n                    selectCnt = 0;\r\n                } else if (unexpectedSelectorWakeup(selectCnt)) { // Unexpected wakeup (unusual case)\r\n                    selectCnt = 0;\r\n                }\r\n            } catch (CancelledKeyException e) {\r\n                // Harmless exception - log anyway\r\n                if (logger.isDebugEnabled()) {\r\n                    logger.debug(CancelledKeyException.class.getSimpleName() + " raised by a Selector {} - JDK bug?",\r\n                            selector, e);\r\n                }\r\n            } catch (Throwable t) {\r\n                handleLoopException(t);\r\n            }\r\n            // Always handle shutdown even if the loop processing threw an exception.\r\n            try {\r\n                if (isShuttingDown()) {\r\n                    closeAll();\r\n                    if (confirmShutdown()) {\r\n                        return;\r\n                    }\r\n                }\r\n            } catch (Throwable t) {\r\n                handleLoopException(t);\r\n            }\r\n        }\r\n    }\n'})}),"\n",(0,l.jsx)(n.p,{children:"processSelectedKeys()\u662f\u5904\u7406\u4efb\u52a1\u7684\u6838\u5fc3\u903b\u8f91\uff0c\u6765\u81ea\u4e8e NioEventLoop \u7684 run()\u65b9\u6cd5\u8c03\u7528"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'    // \u5904\u7406\u4e8b\u4ef6\u96c6\u5408\r\n    private void processSelectedKeys() {\r\n        // \u5982\u679cselectedKeys\uff08\u4e8b\u4ef6\u96c6\u5408\uff09\u6ca1\u6709\u503c\uff0c\u91cd\u65b0\u83b7\u53d6\uff0c\u5982\u679c\u6709\u503c\uff0c\u76f4\u63a5\u5904\u7406\r\n        if (selectedKeys != null) {\r\n            processSelectedKeysOptimized();\r\n        } else {\r\n            processSelectedKeysPlain(selector.selectedKeys());\r\n        }\r\n    }\r\n\r\n\r\n     private void processSelectedKeysPlain(Set<SelectionKey> selectedKeys) {\r\n        // check if the set is empty and if so just return to not create garbage by\r\n        // creating a new Iterator every time even if there is nothing to process.\r\n        // See https://github.com/netty/netty/issues/597\r\n        if (selectedKeys.isEmpty()) {\r\n            return;\r\n        }\r\n\r\n        Iterator<SelectionKey> i = selectedKeys.iterator();\r\n        for (;;) {\r\n            final SelectionKey k = i.next();\r\n            // \u8fd9\u662f\u6ce8\u518c\u65f6\uff0c\u5b58\u50a8\u7684\u9644\u52a0\u5bf9\u8c61\uff0c\u5373\u4e3a\u901a\u9053\u5bf9\u8c61channel\r\n            final Object a = k.attachment();\r\n            i.remove();\r\n\r\n            if (a instanceof AbstractNioChannel) {\r\n                // \u5904\u7406\u5177\u4f53\u4e8b\u4ef6\r\n                processSelectedKey(k, (AbstractNioChannel) a);\r\n            } else {\r\n                @SuppressWarnings("unchecked")\r\n                NioTask<SelectableChannel> task = (NioTask<SelectableChannel>) a;\r\n                processSelectedKey(k, task);\r\n            }\r\n\r\n            if (!i.hasNext()) {\r\n                break;\r\n            }\r\n\r\n            if (needsToSelectAgain) {\r\n                selectAgain();\r\n                selectedKeys = selector.selectedKeys();\r\n\r\n                // Create the iterator again to avoid ConcurrentModificationException\r\n                if (selectedKeys.isEmpty()) {\r\n                    break;\r\n                } else {\r\n                    i = selectedKeys.iterator();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // \u5904\u7406\u5177\u4f53\u4e8b\u4ef6\r\n    //  \u5224\u65ad\u4e8b\u4ef6\u7c7b\u578b\uff0c\u8c03\u7528\u5bf9\u5e94\u7684\u903b\u8f91\u5904\u7406\r\n    private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {\r\n        final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();\r\n        if (!k.isValid()) {\r\n            final EventLoop eventLoop;\r\n            try {\r\n                eventLoop = ch.eventLoop();\r\n            } catch (Throwable ignored) {\r\n                // If the channel implementation throws an exception because there is no event loop, we ignore this\r\n                // because we are only trying to determine if ch is registered to this event loop and thus has authority\r\n                // to close ch.\r\n                return;\r\n            }\r\n            // Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop\r\n            // and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is\r\n            // still healthy and should not be closed.\r\n            // See https://github.com/netty/netty/issues/5125\r\n            if (eventLoop == this) {\r\n                // close the channel if the key is not valid anymore\r\n                unsafe.close(unsafe.voidPromise());\r\n            }\r\n            return;\r\n        }\r\n\r\n        try {\r\n            int readyOps = k.readyOps();\r\n            // We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise\r\n            // the NIO JDK channel implementation may throw a NotYetConnectedException.\r\n            if ((readyOps & SelectionKey.OP_CONNECT) != 0) {\r\n                // remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking\r\n                // See https://github.com/netty/netty/issues/924\r\n                int ops = k.interestOps();\r\n                ops &= ~SelectionKey.OP_CONNECT;\r\n                k.interestOps(ops);\r\n\r\n                unsafe.finishConnect();\r\n            }\r\n\r\n            // Process OP_WRITE first as we may be able to write some queued buffers and so free memory.\r\n            if ((readyOps & SelectionKey.OP_WRITE) != 0) {\r\n                // Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write\r\n                ch.unsafe().forceFlush();\r\n            }\r\n\r\n            // Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead\r\n            // to a spin loop\r\n            if ((readyOps & (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {\r\n                unsafe.read();\r\n            }\r\n        } catch (CancelledKeyException ignored) {\r\n            unsafe.close(unsafe.voidPromise());\r\n        }\r\n    }\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u5176\u4e2d\u8bfb\u4e8b\u4ef6\u7684\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"unsafe.read();\r\n\r\n[AbstractNioByteChannel]\r\n----------------------------------------------------------------------------\r\npublic final void read() {\r\n            final ChannelConfig config = config();\r\n            if (shouldBreakReadReady(config)) {\r\n                clearReadPending();\r\n                return;\r\n            }\r\n            final ChannelPipeline pipeline = pipeline();\r\n            final ByteBufAllocator allocator = config.getAllocator();\r\n            final RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();\r\n            allocHandle.reset(config);\r\n\r\n            ByteBuf byteBuf = null;\r\n            boolean close = false;\r\n            try {\r\n                do {\r\n                    byteBuf = allocHandle.allocate(allocator);\r\n                    allocHandle.lastBytesRead(doReadBytes(byteBuf));\r\n                    if (allocHandle.lastBytesRead() <= 0) {\r\n                        // nothing was read. release the buffer.\r\n                        byteBuf.release();\r\n                        byteBuf = null;\r\n                        close = allocHandle.lastBytesRead() < 0;\r\n                        if (close) {\r\n                            // There is nothing left to read as we received an EOF.\r\n                            readPending = false;\r\n                        }\r\n                        break;\r\n                    }\r\n\r\n                    allocHandle.incMessagesRead(1);\r\n                    readPending = false;\r\n                    pipeline.fireChannelRead(byteBuf);\r\n                    byteBuf = null;\r\n                } while (allocHandle.continueReading());\r\n\r\n                allocHandle.readComplete();\r\n                pipeline.fireChannelReadComplete();\r\n\r\n                if (close) {\r\n                    closeOnRead(pipeline);\r\n                }\r\n            } catch (Throwable t) {\r\n                handleReadException(pipeline, byteBuf, t, close, allocHandle);\r\n            } finally {\r\n                // Check if there is a readPending which was not processed yet.\r\n                // This could be for two reasons:\r\n                // * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method\r\n                // * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method\r\n                //\r\n                // See https://github.com/netty/netty/issues/2254\r\n                if (!readPending && !config.isAutoRead()) {\r\n                    removeReadOp();\r\n                }\r\n            }\r\n        }\n"})}),"\n",(0,l.jsx)(n.h3,{id:"4bootstrap",children:"4\u3001Bootstrap"}),"\n",(0,l.jsx)(n.p,{children:"\u5f15\u5bfc\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u914d\u7f6e\uff0c\u5e76\u8ba9\u4ed6\u8fd0\u884c\u8d77\u6765\u7684\u8fc7\u7a0b\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"1\u914d\u7f6e",children:"1\uff09\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u5fc5\u9009\u53c2\u6570\uff1agroup \u3001 channel\u3001 handler\uff08\u670d\u52a1\u7aef -- childHandler\uff09"}),"\n",(0,l.jsx)(n.p,{children:"group()\uff1a \u6307\u5b9a\u4e00\u4e2a\u5230\u4e24\u4e2a reactor"}),"\n",(0,l.jsx)(n.p,{children:"channel()\uff1a\u6307\u5b9a channel \u5de5\u5382\uff0c\u53cd\u5c04\u7684\u65b9\u5f0f\u521b\u5efa channel \u4f7f\u7528"}),"\n",(0,l.jsx)(n.p,{children:"handler()\uff1a\u6307\u5b9a reactor \u7684\u5904\u7406\u5668\uff0c\u5176\u4e2d childHandler \u6307\u5b9a\u7684\u662f\uff0c\u670d\u52a1\u7aef\u6240\u63a5\u6536\u5230\u7684\u5ba2\u6237\u7aef channel \u4f7f\u7528\u7684\u5904\u7406\u5668\uff0c\u800c\u670d\u52a1\u7aef\u7684\u4e3b reactor\uff08bossGroup\uff09\uff0c\u5df2\u7ecf\u9ed8\u8ba4\u6dfb\u52a0\u4e86 acceptor \u5904\u7406\u5668\uff0c\u6240\u4ee5\u53ef\u4ee5\u4e0d\u6307\u5b9a\u3002"}),"\n",(0,l.jsx)(n.p,{children:"option()\uff1a\u6307\u5b9a TCP \u76f8\u5173\u7684\u53c2\u6570\uff0c\u4ee5\u53ca netty \u81ea\u5b9a\u4e49\u7684\u53c2\u6570"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u53c2\u6570\u7684\u8fc7\u7a0b\uff0c\u79f0\u4e4b\u4e3a\u521d\u59cb\u5316\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"2\u8fd0\u884c",children:"2\uff09\u8fd0\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"        // \u542f\u52a8\u5e76\u8bbe\u7f6e\u7aef\u53e3\u53f7  \u4f46\u9700\u8981\u4f7f\u7528sync\u5f02\u6b65\u542f\u52a8\r\n        try {\r\n            ChannelFuture future = serverBootstrap.bind(8888).sync();\r\n            // \u5c06\u5173\u95ed\u901a\u9053\u7684\u65b9\u5f0f \u4e5f\u8bbe\u7f6e\u4e3a\u5f02\u6b65\u7684\r\n            //    \u963b\u585efinally\u4e2d\u7684\u4ee3\u7801\u6267\u884c\r\n            future.channel().closeFuture().sync();\r\n\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            // \u4f18\u96c5\u5173\u95ed\r\n            bossGroup.shutdownGracefully();\r\n            workerGroup.shutdownGracefully();\r\n        }\n"})}),"\n",(0,l.jsx)(n.p,{children:"bind()\uff0c\u5c06\u670d\u52a1\u7aef\u7684 channel \u7ed1\u5b9a\u5230\u7aef\u53e3\u53f7\uff0c\u7136\u540e\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u8ba9\u6574\u4e2a netty \u8fd0\u884c\u8d77\u6765\u3002"}),"\n",(0,l.jsx)(n.p,{children:"sync()\uff0c\u56e0\u4e3a\u7ed1\u5b9a\u4e8b\u4ef6\u662f\u5f02\u6b65\u7684\uff0c\u6240\u4ee5\u4f7f\u7528 sync \u540c\u6b65\u7b49\u5f85\u7ed3\u679c\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0cbind \u53ea\u89e6\u53d1\u4e86\u7ed1\u5b9a\u7aef\u53e3\u7684\u4e8b\u4ef6\uff0c\u9700\u8981\u4f7f\u7528 sync \u7b49\u5f85\u4e8b\u4ef6\u6267\u884c\u7684\u7ed3\u679c\u3002"}),"\n",(0,l.jsx)(n.p,{children:"future.channel().closeFuture().sync()\uff0c\u542b\u4e49\u4e3a\uff0c\u5f53\u901a\u9053\u88ab\u5173\u95ed\u65f6\uff0c\u624d\u6267\u884c\u540e\u7eed\u7684\u64cd\u4f5c\uff0csync \u4f7f\u5f53\u524d\u7ebf\u7a0b\u6267\u884c\u5230\u6b64\u5904\u963b\u585e\uff0c\u4ee5\u786e\u4fdd\u4e0d\u6267\u884c\u540e\u7eed\u7684 shutdown \u65b9\u6cd5\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"3\u6e90\u7801\u89e3\u6790",children:"3\uff09\u6e90\u7801\u89e3\u6790"}),"\n",(0,l.jsx)(n.h5,{id:"a-\u7c7b\u58f0\u660e",children:"A \u7c7b\u58f0\u660e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"public abstract class AbstractBootstrap<B extends AbstractBootstrap<B, C>, C extends Channel> implements Cloneable {\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5d4c\u5957\u7684\u6cdb\u578b\u4f7f\u7528\uff0c\u53ef\u4ee5\u8fbe\u5230\uff0c\u5b50\u7c7b\u4e2d\u8fd4\u56de\u5b50\u7c7b\u672c\u8eab\u7684\u6548\u679c\uff0c\u5177\u4f53\u5982\u4e0b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"public class ServerBootstrap extends AbstractBootstrap<ServerBootstrap, ServerChannel> {\n"})}),"\n",(0,l.jsx)(n.h5,{id:"b-init-\u65b9\u6cd5",children:"B init \u65b9\u6cd5"}),"\n",(0,l.jsx)(n.p,{children:"\u5de5\u4f5c\u5185\u5bb9"}),"\n",(0,l.jsx)(n.p,{children:"a\u3001\u8bbe\u7f6e channel \u76f8\u5173\u7684\u9009\u9879\u53c2\u6570\r\nb\u3001\u8bbe\u7f6e channel \u7684\u5c5e\u6027\u952e\u503c\u5bf9\r\nc\u3001\u6dfb\u52a0\u5bf9 channel \u7684 IO \u4e8b\u4ef6\u5904\u7406\u5668 \uff08Acceptor \u89d2\u8272\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"void init(Channel channel) {\r\n        // \u8bbe\u7f6echannel\u76f8\u5173\u7684\u9009\u9879\u53c2\u6570\r\n        setChannelOptions(channel, newOptionsArray(), logger);\r\n        // \u8bbe\u7f6echannel\u7684\u5c5e\u6027\u952e\u503c\u5bf9\r\n        setAttributes(channel, attrs0().entrySet().toArray(EMPTY_ATTRIBUTE_ARRAY));\r\n\r\n        ChannelPipeline p = channel.pipeline();\r\n\r\n        final EventLoopGroup currentChildGroup = childGroup;\r\n        final ChannelHandler currentChildHandler = childHandler;\r\n        final Entry<ChannelOption<?>, Object>[] currentChildOptions;\r\n        synchronized (childOptions) {\r\n            currentChildOptions = childOptions.entrySet().toArray(EMPTY_OPTION_ARRAY);\r\n        }\r\n        final Entry<AttributeKey<?>, Object>[] currentChildAttrs = childAttrs.entrySet().toArray(EMPTY_ATTRIBUTE_ARRAY);\r\n\r\n        p.addLast(new ChannelInitializer<Channel>() {\r\n            @Override\r\n            public void initChannel(final Channel ch) {\r\n                final ChannelPipeline pipeline = ch.pipeline();\r\n                ChannelHandler handler = config.handler();\r\n                if (handler != null) {\r\n                    pipeline.addLast(handler);\r\n                }\r\n\r\n                // \u6dfb\u52a0\u5bf9channel\u7684IO\u4e8b\u4ef6\u5904\u7406\u5668 \uff08Acceptor\u89d2\u8272\uff09\r\n                ch.eventLoop().execute(new Runnable() {\r\n                    @Override\r\n                    public void run() {\r\n                        pipeline.addLast(new ServerBootstrapAcceptor(\r\n                                ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\n"})}),"\n",(0,l.jsx)(n.p,{children:"Acceptor \u5206\u6790"}),"\n",(0,l.jsx)(n.p,{children:"\u529f\u80fd\uff1a\u5c06\u4e3b reactor \u63a5\u6536\u5230\u7684\u5ba2\u6237\u7aef\u901a\u9053\uff0c\u4f20\u9012\u7ed9\u4ece reactor"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"// ServerBootstrapAcceptor\u662fServerBootstrap\u7684\u9759\u6001\u5185\u90e8\u7c7b\r\n// netty\u5c06acceptor\u770b\u4f5c\u4e00\u4e2a\u5904\u7406\u5668\uff0c\u5e76\u4e14\u662f\u5165\u7ad9\u5904\u7406\u5668\r\nprivate static class ServerBootstrapAcceptor extends ChannelInboundHandlerAdapter {\r\n\r\n// \u5177\u4f53\u7684\u903b\u8f91\u5c01\u88c5\u5230channelRead\uff08\uff09\u65b9\u6cd5\u4e2d\r\n// \u5bf9\u5ba2\u6237\u7aef\u901a\u9053\u8fdb\u884c\u914d\u7f6e \uff0c \u7136\u540e\u6ce8\u518c\u5230\u4eceReactor\u4e2d\r\npublic void channelRead(ChannelHandlerContext ctx, Object msg) {\r\n            // \u6b64\u65f6msg\u5bf9\u5e94 \u670d\u52a1\u7aef\u63a5\u6536\u5230\u7684\u5ba2\u6237\u7aef\u901a\u9053\r\n            final Channel child = (Channel) msg;\r\n\t\t    // \u8bbe\u7f6e\u5904\u7406\u94fe\u8def\r\n            child.pipeline().addLast(childHandler);\r\n\t\t\t// \u8bbe\u7f6e\u901a\u9053\u7684\u914d\u7f6e\u9879\u548c\u53c2\u6570\r\n            setChannelOptions(child, childOptions, logger);\r\n            setAttributes(child, childAttrs);\r\n\r\n            try {\r\n                // childGroup \u662f\u4ecereactor\u7684\u8d44\u6e90\u6c60 \u8c03\u7528\u6ce8\u518c\u65b9\u6cd5 \u6ce8\u518c\u5ba2\u6237\u7aef\u901a\u9053child\r\n                childGroup.register(child).addListener(new ChannelFutureListener() {\r\n                    @Override\r\n                    public void operationComplete(ChannelFuture future) throws Exception {\r\n                        // \u589e\u52a0\u76d1\u542c \u83b7\u53d6\u6ce8\u518c\u7684\u5f02\u6b65\u7ed3\u679c\r\n                        // \u5982\u679c\u6ce8\u518c\u5931\u8d25 \u6216\u8005\u629b\u51fa\u5f02\u5e38  \u90fd\u4f1a\u5173\u95edchannel\r\n                        if (!future.isSuccess()) {\r\n                            forceClose(child, future.cause());\r\n                        }\r\n                    }\r\n                });\r\n            } catch (Throwable t) {\r\n                forceClose(child, t);\r\n            }\r\n        }\r\n\r\n\r\n        // \u5982\u679c\u5904\u7406\u5ba2\u6237\u7aef\u8fde\u63a5\u5931\u8d25\u4e86\uff0c\u6682\u505c\u4e00\u79d2\uff0c\u7136\u540e\u7ee7\u7eed\u63a5\u53d7\r\n        // \u4e3a\u4fdd\u969c\u670d\u52a1\u7aef\u80fd\u591f\u5c3d\u53ef\u80fd\u591a\u7684\u5904\u7406\u5ba2\u6237\u7aef\u7684\u8fde\u63a5  \u4e0d\u53d7\u67d0\u4e00\u6b21\u5904\u7406\u5931\u8d25\u7684\u7ed3\u679c\u5f71\u54cd\r\n        public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\r\n            final ChannelConfig config = ctx.channel().config();\r\n            if (config.isAutoRead()) {\r\n                // stop accept new connections for 1 second to allow the channel to recover\r\n                // See https://github.com/netty/netty/issues/1328\r\n                config.setAutoRead(false);\r\n                ctx.channel().eventLoop().schedule(enableAutoReadTask, 1, TimeUnit.SECONDS);\r\n            }\r\n            // still let the exceptionCaught event flow through the pipeline to give the user\r\n            // a chance to do something with it\r\n            ctx.fireExceptionCaught(cause);\r\n        }\n"})}),"\n",(0,l.jsx)(n.h4,{id:"4-future-\u548c-promise",children:"4) Future \u548c Promise"}),"\n",(0,l.jsx)(n.p,{children:"Future \u4ee3\u8868\u7684\u662f\uff0c\u4e00\u4e2a\u8fd8\u672a\u5b8c\u6210\u7684\u5f02\u6b65\u4efb\u52a1\u7684\u6267\u884c\u7ed3\u679c\u3002\u53ef\u4ee5\u901a\u8fc7 addListener \u65b9\u6cd5\uff0c\u76d1\u542c\u6267\u884c\u7ed3\u679c\u540e\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\uff0c\u6b64\u65f6\u5b83\u7684\u72b6\u6001\u53ef\u4ee5\u5206\u4e3a\u672a\u5b8c\u6210\u3001\u5df2\u5b8c\u6210\uff08\u6210\u529f\u3001\u5931\u8d25\u3001\u4e3b\u52a8\u53d6\u6d88\uff09\u7b49\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5bf9 Future \u800c\u8a00\uff0c\u72b6\u6001\u53ea\u80fd\u8bfb\u53d6\uff0c\u65e0\u6cd5\u66f4\u6539\uff0c\u53c8\u51fa\u73b0\u4e86 Promise\uff0c\u4f46\u662f Promise \u53ea\u80fd\u66f4\u6539\u4e00\u6b21\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u53c2\u7167\u751f\u6d3b\u4e2d\u7684\u5b9a\u989d\u53d1\u7968\uff08Future\uff09\u548c\u673a\u6253\u53d1\u7968\uff08Promise\uff09\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"\u56db\u62d3\u5c55\u7bc7",children:"\uff08\u56db\uff09\u62d3\u5c55\u7bc7"}),"\n",(0,l.jsx)(n.h3,{id:"1\u5fc3\u8df3\u68c0\u6d4b",children:"1\u3001\u5fc3\u8df3\u68c0\u6d4b"}),"\n",(0,l.jsx)(n.p,{children:"\u68c0\u6d4b\u903b\u8f91\uff1a\r\n1\uff09 \u670d\u52a1\u7aef\u542f\u52a8\uff0c\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\uff0c\u8fde\u63a5\u7684\u76ee\u7684\u662f\u4e92\u76f8\u53d1\u9001\u6d88\u606f\u3002\r\n2\uff09 \u5982\u679c\u5ba2\u6237\u7aef\u5728\u5de5\u4f5c\uff0c\u670d\u52a1\u7aef\u4e00\u5b9a\u80fd\u6536\u5230\u6570\u636e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u7a7a\u95f2\uff0c\u670d\u52a1\u7aef\u4f1a\u51fa\u73b0\u8d44\u6e90\u6d6a\u8d39\u3002\r\n3\uff09 \u670d\u52a1\u7aef\u9700\u8981\u4e00\u79cd\u68c0\u6d4b\u673a\u5236\uff0c\u9a8c\u8bc1\u5ba2\u6237\u7aef\u7684\u6d3b\u8dc3\u72b6\u6001\uff0c\u4e0d\u6d3b\u8dc3\u5219\u5173\u95ed\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u9700\u6c42\u8bbe\u8ba1\uff1a\r\n1\uff09 \u5ba2\u6237\u7aef\u5411\u670d\u52a1\u7aef\u53d1\u9001 \u201cI am alive\u201d , sleep \u4e00\u4e2a\u968f\u673a\u65f6\u95f4\uff0c\u6a21\u62df\u7a7a\u95f2\u72b6\u6001\r\n2\uff09 \u670d\u52a1\u7aef\u6536\u5230\u6d88\u606f\u540e\uff0c\u8fd4\u56de\u201cover\u201d\uff0c \u5ba2\u6237\u7aef\u6709\u7a7a\u95f2\uff0c\u8bb0\u5f55\u7a7a\u95f2\u6b21\u6570\r\n3\uff09 \u8bbe\u5b9a\u9608\u503c\uff0c\u8fbe\u5230\u9608\u503c\u65f6\u4e3b\u52a8\u5173\u95ed\u8fde\u63a5"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/f45a5f504acec96234c73b119c5337e7.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})}),"\n",(0,l.jsx)(n.p,{children:"IdleStateHandler , \u662f netty \u63d0\u4f9b\u7684\u5904\u7406\u5668\r\n1\uff09\u8d85\u8fc7\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u8bfb readerIdleTime"}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsx)(n.li,{children:"\u8d85\u8fc7\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u5199 writerIdleTime"}),"\n",(0,l.jsx)(n.li,{children:"\u8d85\u8fc7\u591a\u957f\u65f6\u95f4\u6ca1\u6709\u8bfb\u548c\u5199 allIdleTime"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u5e95\u5c42\u5b9e\u73b0\u68c0\u6d4b\u7684\u662f IdleStateEvent \u4e8b\u4ef6\uff0c\u901a\u8fc7\u7ba1\u9053\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a handler \u5904\u7406\uff0c\u5904\u7406\u65b9\u6cd5\u662f userEventTriggered\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u5176\u4e2d IdleStateEvent \u4e8b\u4ef6\uff0c\u5206\u4e3a READER_IDLE\u3001WRITER_IDLE\u3001ALL_IDLE \u4e09\u5927\u7c7b"}),"\n",(0,l.jsx)(n.h3,{id:"2tcp-\u7c98\u5305\u62c6\u5305",children:"2\u3001TCP \u7c98\u5305\u62c6\u5305"}),"\n",(0,l.jsx)(n.p,{children:"TCP \u662f\u57fa\u4e8e\u6d41\u7684\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u4ea7\u751f\u7c98\u5305\u548c\u62c6\u5305\u95ee\u9898\u7684\u4e3b\u8981\u539f\u56e0\u662f\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5728\u53d1\u9001 TCP \u6570\u636e\u7684\u65f6\u5019\uff0c\u5e95\u5c42\u4f1a\u6709\u4e00\u4e2a\u7f13\u51b2\u533a\uff0c\u4f8b\u5982 1024 \u4e2a\u5b57\u8282\u5927\u5c0f\uff0c\u5982\u679c\u4e00\u6b21\u8bf7\u6c42\u53d1\u9001\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5c0f\uff0c\u6ca1\u8fbe\u5230\u7f13\u51b2\u533a\u5927\u5c0f\uff0cTCP \u5219\u4f1a\u5c06\u591a\u4e2a\u8bf7\u6c42\u5408\u5e76\u4e3a\u540c\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u884c\u53d1\u9001\uff0c\u8fd9\u5c31\u5f62\u6210\u4e86\u7c98\u5305\u95ee\u9898\uff1b\u5982\u679c\u4e00\u6b21\u8bf7\u6c42\u53d1\u9001\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u8d85\u8fc7\u4e86\u7f13\u51b2\u533a\u5927\u5c0f\uff0cTCP \u5c31\u4f1a\u5c06\u5176\u62c6\u5206\u4e3a\u591a\u6b21\u53d1\u9001\uff0c\u8fd9\u5c31\u662f\u62c6\u5305\uff0c\u4e5f\u5c31\u662f\u5c06\u4e00\u4e2a\u5927\u7684\u5305\u62c6\u5206\u4e3a\u591a\u4e2a\u5c0f\u5305\u8fdb\u884c\u53d1\u9001\u3002"}),"\n",(0,l.jsx)(n.p,{children:"UDP \u4f1a\u53d1\u751f\u62c6\u5305\u548c\u7c98\u5305\u5417\uff1f\r\n\u4e0d\u4f1a\uff0cUDP \u662f\u57fa\u4e8e\u62a5\u6587\u7684\uff0c\u5728 UDP \u7684\u9996\u90e8\u4f7f\u7528 16bit \u5b58\u50a8\u62a5\u6587\u7684\u957f\u5ea6\uff0c\u56e0\u6b64\u4e0d\u4f1a\u53d1\u751f\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["TCP \u53d1\u751f\u7c98\u5305\u548c\u62c6\u5305\u7684\u672c\u8d28\u539f\u56e0\uff1a\r\n\u8981\u53d1\u9001\u7684\u6570\u636e\u5148\u7ecf\u8fc7 TCP \u7684\u7f13\u51b2\u533a\uff0c\u8fd8\u9650\u5236\u4e86\u6700\u5927\u62a5\u6587\u957f\u5ea6\u3002\r\nA \u5982\u679c\u8981\u53d1\u9001\u7684\u6570\u636e > TCP \u5269\u4f59\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u53d1\u751f\u62c6\u5305\r\nB \u5982\u679c\u8981\u53d1\u9001\u7684\u6570\u636e > \u6700\u5927\u62a5\u6587\u957f\u5ea6\uff0c\u53d1\u751f\u62c6\u5305",(0,l.jsx)(n.br,{}),"\nC \u5982\u679c\u8981\u53d1\u9001\u7684\u6570\u636e << TCP \u5269\u4f59\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u53d1\u751f\u7c98\u5305\r\nD \u63a5\u6536\u6570\u636e\u7684\u5e94\u7528\u5c42\uff0c\u6ca1\u6709\u53ca\u65f6\u8bfb\u53d6\u7f13\u51b2\u533a\u6570\u636e\uff0c\u4e5f\u4f1a\u53d1\u751f\u7c98\u5305"]}),"\n",(0,l.jsx)(n.p,{children:"\u89e3\u51b3\u529e\u6cd5\uff1a\r\nA \u8bbe\u7f6e\u51fa\u6d88\u606f\u7684\u957f\u5ea6\r\nB \u8bbe\u7f6e\u51fa\u6d88\u606f\u7684\u8fb9\u754c\u2014\u2014\u5206\u9694\u7b26"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u63d0\u4f9b\u7684\u89e3\u7801\u5668\uff0c\u4e24\u7c7b"}),"\n",(0,l.jsx)(n.p,{children:"A \u57fa\u4e8e\u957f\u5ea6\u7684\u89e3\u7801\u5668\uff0c\u5728\u5305\u5934\u90e8\u8bbe\u7f6e\u51fa\u6570\u636e\u7684\u957f\u5ea6\u3002\uff08\u7c7b\u4f3c\u4e8e UDP \u7684\u5934\u90e8\u5904\u7406\uff09\r\nLengthFieldBasedFrameDecoder \u81ea\u5b9a\u4e49\u957f\u5ea6\u7684\u5904\u7406\u65b9\u5f0f\r\nFixedLengthFrameDecoder \u56fa\u5b9a\u957f\u5ea6\u7684\u5904\u7406\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:'B \u57fa\u4e8e\u5206\u9694\u7b26\u7684\u89e3\u7801\u5668\r\nDelimiterBasedFrameDecoder \u81ea\u5b9a\u4e49\u5206\u9694\u7b26\u7684\u5904\u7406\u65b9\u5f0f\r\nLineBasedFrameDecoder \u884c\u5c3e\uff08"\\n"\u6216"\\r\\n"\uff09\u5206\u9694\u7b26\u7684\u5904\u7406\u65b9\u5f0f'}),"\n",(0,l.jsx)(n.p,{children:"\u3010Demo \u903b\u8f91\u3011\r\n\u9700\u6c42\uff1a\u5ba2\u6237\u7aef\u5faa\u73af 100 \u6b21\u5411\u670d\u52a1\u7aef\u8bf7\u6c42\u65f6\u95f4"}),"\n",(0,l.jsx)(n.p,{children:"1\uff09\u7b2c\u4e00\u79cd\u65b9\u5f0f\uff0c\u4f20\u8f93\u7684\u8fc7\u7a0b\u6570\u636e\u5355\u4f4d\u662f\u5b57\u8282\u6d41 ByteBuf\uff0c\u9700\u8981\u81ea\u884c\u5904\u7406\u5206\u9694\u7b26\u4ee5\u53ca\u6570\u636e\u7684\u957f\u5ea6\uff0c\u6b64\u65f6\u4f1a\u51fa\u73b0\u7c98\u5305\u548c\u62c6\u5305\u7684\u95ee\u9898"}),"\n",(0,l.jsx)(n.p,{children:"2\uff09\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u4f7f\u7528 LineBasedFrameDecoder\uff0c\u914d\u5408 StringDecoder \u4f7f\u7528\uff0c\u4f20\u8f93\u7684\u6570\u636e\u5355\u4f4d\u53d8\u6210\u5b57\u7b26\u4e32\uff0c\u53ef\u4ee5\u76f4\u63a5\u5904\u7406\uff0c\u4fdd\u8bc1\u4e1a\u52a1\u903b\u8f91\u4e0a\u7684\u5305\u548c\u771f\u6b63\u4f20\u8f93\u7684\u5305\u662f\u4e00\u81f4\u7684"}),"\n",(0,l.jsx)(n.h3,{id:"3\u5e8f\u5217\u5316\u6846\u67b6protobuf",children:"3\u3001\u5e8f\u5217\u5316\u6846\u67b6\u2014\u2014protobuf"}),"\n",(0,l.jsx)(n.p,{children:"protobuf = protocol buffers\r\n\u7c7b\u4f3c\u4e8e xml \u7684\u751f\u6210\u548c\u89e3\u6790\uff0c\u4f46\u6548\u7387\u66f4\u9ad8\uff0c\u751f\u6210\u7684\u662f\u5b57\u8282\u7801\uff0c\u53ef\u8bfb\u6027\u7a0d\u5dee\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u3010Demo \u903b\u8f91\u3011"}),"\n",(0,l.jsx)(n.p,{children:"1\uff09\u5b89\u88c5 idea \u63d2\u4ef6\uff0cprotobuf support"}),"\n",(0,l.jsx)(n.p,{children:"\u200b \u5982\u679c\u5b89\u88c5\u4e4b\u540e\uff0c\u521b\u5efa*.proto \u6587\u4ef6\u6ca1\u6709\u4f7f\u7528\u63d2\u4ef6\uff0c\u624b\u52a8\u8bbe\u7f6e\u5173\u8054\u5173\u7cfb"}),"\n",(0,l.jsx)(n.p,{children:"\u200b settings -> file types -> \u627e\u5230 protobuf -> \u589e\u52a0\u6b63\u5219\u8868\u8fbe\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"2\uff09\u5f15\u5165 maven \u4f9d\u8d56\u548c\u63d2\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"<properties>\r\n    <os.detected.classifier>windows-x86_64</os.detected.classifier>\r\n</properties>\r\n\r\n<build>\r\n        <plugins>\r\n            <plugin>\r\n                <groupId>org.xolstice.maven.plugins</groupId>\r\n                <artifactId>protobuf-maven-plugin</artifactId>\r\n                <version>0.5.0</version>\r\n                <configuration>\r\n                    <protocArtifact>\r\n                        com.google.protobuf:protoc:3.1.0:exe:${os.detected.classifier}\r\n                    </protocArtifact>\r\n                    <pluginId>grpc-java</pluginId>\r\n                </configuration>\r\n                <executions>\r\n                    <execution>\r\n                        <goals>\r\n                            <goal>compile</goal>\r\n                            <goal>compile-custom</goal>\r\n                        </goals>\r\n                    </execution>\r\n                </executions>\r\n            </plugin>\r\n        </plugins>\r\n    </build>\n"})}),"\n",(0,l.jsxs)(n.p,{children:["3\uff09\u5728\u53f3\u4fa7 maven project \u4e2d\u53ef\u4ee5\u627e\u5230\u76f8\u5e94\u7684\u63d2\u4ef6 (\u6ca1\u6709\u7684\u8bdd\u5237\u65b0)\r\n",(0,l.jsx)(n.img,{src:"http://img.doomwatcher.cn/img/4406720e774876e94f7035d66f5d90f7.png",alt:"image-20220412193415944"})]}),"\n",(0,l.jsx)(n.p,{children:"4\uff09\u5728\u548c java \u5e73\u7ea7\u7684\u76ee\u5f55\u4e0b\uff0c\u521b\u5efa proto \u6587\u4ef6\u5939\uff0c\u7136\u540e\u521b\u5efa person.proto \u6587\u4ef6\r\n5\uff09person.proto"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'// \u58f0\u660e\u5305\u540d\u79f0\u7684\u7a7a\u95f4\r\nsyntax="proto3";\r\n// \u5177\u4f53\u7684\u7c7b\u751f\u6210\u76ee\u5f55\r\noption java_package="com.duing";\r\n// \u5177\u4f53\u7684\u7c7b\u540d\r\noption java_outer_classname="PersonModel";\r\n\r\n// \u7c7b\u7ed3\u6784\r\nmessage Person{\r\n    int32 id = 1;    // \u6b64\u5904\u76841\u4ee3\u8868\u987a\u5e8f\r\n    string name = 2;\r\n}\n'})}),"\n",(0,l.jsxs)(n.ol,{start:"6",children:["\n",(0,l.jsx)(n.li,{children:"\u4f7f\u7528\u63d2\u4ef6\u8fdb\u884c\u7f16\u8bd1\uff0c\u5c06\u7f16\u8bd1\u751f\u6210\u7684\u4ee3\u7801\u62f7\u8d1d\u5230\u9700\u8981\u7684\u76ee\u5f55\u4e0b\r\n7\uff09\u7f16\u5199\u6d4b\u4f8b\u8fdb\u884c\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var t=r(6540);const l={},i=t.createContext(l);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);
<!doctype html>
<html lang="cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Java/快速入门RabbitMQ并且加入项目实战" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">快速入门RabbitMQ并且加入项目实战 | 小冷の代码世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://doomwatcher2004.github.io/docs/Java/快速入门RabbitMQ并且加入项目实战"><meta data-rh="true" property="og:locale" content="cn"><meta data-rh="true" name="docusaurus_locale" content="cn"><meta data-rh="true" name="docsearch:language" content="cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="快速入门RabbitMQ并且加入项目实战 | 小冷の代码世界"><meta data-rh="true" name="description" content="📣 📣 📣 📢📢📢"><meta data-rh="true" property="og:description" content="📣 📣 📣 📢📢📢"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doomwatcher2004.github.io/docs/Java/快速入门RabbitMQ并且加入项目实战"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/Java/快速入门RabbitMQ并且加入项目实战" hreflang="cn"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/Java/快速入门RabbitMQ并且加入项目实战" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.15cbc4ab.css">
<script src="/assets/js/runtime~main.36e9e1ef.js" defer="defer"></script>
<script src="/assets/js/main.602a8fec.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">小冷の代码世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Java/Docker 快速入门">Java知识库</a><a class="navbar__item navbar__link" href="/docs/Web/JavaScript 高级">前端知识库</a><a class="navbar__item navbar__link" sidebarid="GodotSidebar" href="/docs/Godot">Godot游戏开发</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Doomwatcher2004" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Docker 快速入门">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java 8 更新的新特性 （函数式接口 lambda stream option）">Java8 新特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java后端进阶之路： JavaWeb">javaweb</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Mybatis">Mybatis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty+springboot实现IM即时通讯服务端">Netty+springboot实现IM即时通讯服务端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_HTTP文件列表服务器">Netty_HTTP文件列表服务器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_模拟Redis的客户端">Netty_模拟Redis的客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty网络框架">Netty 网络框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Nginx">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Redis 数据结构操作入门">Redis 数据结构操作入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring Aop 底层责任链思路实现">Spring Aop 底层责任链思路实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring5 Webflux 响应式编程">Spring5 Webflux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringBoot 解决企业级复杂性简化开发的神奇">微服务阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Alibaba">springCloudAlibaba</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Netflix">springcloud2020</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring内置MVC框架：SpringMVC">SpringMVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/mybatis plus">mybatis plus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/redis问题的常见解决方案">redis问题的常见解决方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/使用Netty+zookeeper开发一款高性能LRpc">RPC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/六道入门树题目带你走入树结构的世界">六道入门树题目带你走入树结构的世界</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）">分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/多线程进阶 JUC并发编程">多线程进阶 JUC 并发编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/大前端进阶（ES6）">ES6</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/Java/快速入门RabbitMQ并且加入项目实战">快速入门RabbitMQ并且加入项目实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/快速入门分布式系统与Dubbo+zookeeper">分布式系统简述：</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/掌握极简服务器开发的优秀框架 ：Spring">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/搜索引擎 _ Elasticsearch">Elasticsearch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/数据结构与算法">数据结构与算法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/理解IOC 手写springIOC">Spring 手撕 IOC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/线程池详解与异步任务编排使用案例">线程池详解与异步任务编排使用案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/通透百万数据秒级排序  快速排序">通透百万数据秒级排序  快速排序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/阿里淘系单点登录中心">阿里淘系单点登录中心</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/高并发秒杀系统">高并发秒杀系统</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">快速入门RabbitMQ并且加入项目实战</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><blockquote>
<p>📣 📣 📣 📢📢📢
☀️☀️ 你好啊！小伙伴，我是小冷。是一个兴趣驱动自学练习两年半的的 Java 工程师。
📒 一位十分喜欢将知识分享出来的 Java 博主 ⭐️⭐️⭐️，擅长使用 Java 技术开发 web 项目和工具
📒 文章内容丰富：覆盖大部分 java 必学技术栈，前端，计算机基础，容器等方面的文章
📒 如果你也对 Java 感兴趣，关注小冷吧，一起探索 Java 技术的生态与进步，一起讨论 Java 技术的使用与学习
✏️ 高质量技术专栏专栏链接: <a href="https://blog.csdn.net/doomwatcher/category_11306023.html" target="_blank" rel="noopener noreferrer"><strong>微服务</strong></a>，<a href="https://blog.csdn.net/doomwatcher/category_11542161.htm" target="_blank" rel="noopener noreferrer"><strong>数据结构</strong></a>，<a href="https://blog.csdn.net/doomwatcher/category_11475406.html" target="_blank" rel="noopener noreferrer"><strong>netty</strong></a>，<a href="https://blog.csdn.net/doomwatcher/category_11601911.html" target="_blank" rel="noopener noreferrer">单点登录</a>，<a href="https://blog.csdn.net/doomwatcher/category_11290129.html" target="_blank" rel="noopener noreferrer"><strong>SSM</strong></a> ，<a href="https://blog.csdn.net/doomwatcher/category_11451077.html" target="_blank" rel="noopener noreferrer"><strong>SpringCloudAlibaba</strong></a>等
<strong>😝 公众号 😝</strong> ： <strong>想全栈的小冷</strong>，分享一些技术上的文章，以及解决问题的经验
⏩<strong>当前专栏</strong>：<strong>RabbitMQ 系列</strong></p>
</blockquote>
<p>@[toc]</p>
<header><h1>一、MQ 概述</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="精短简介">精短简介<a href="#精短简介" class="hash-link" aria-label="Direct link to 精短简介" title="Direct link to 精短简介">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Java中有队列数据结构，但是是基于内存的，只有本JVM可以使用</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">MQ中间件是一个多客户端节点可以操作的队列结构</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简单案例">简单案例<a href="#简单案例" class="hash-link" aria-label="Direct link to 简单案例" title="Direct link to 简单案例">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异步消息处理注册">异步消息处理（注册）<a href="#异步消息处理注册" class="hash-link" aria-label="Direct link to 异步消息处理（注册）" title="Direct link to 异步消息处理（注册）">​</a></h3>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/202304071624982.png" alt="1639403611783" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">发送邮件、发送注册短信使用异步消息的模式，使得注册操作快速响应</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="应用解耦订单_库存">应用解耦（订单_库存）<a href="#应用解耦订单_库存" class="hash-link" aria-label="Direct link to 应用解耦（订单_库存）" title="Direct link to 应用解耦（订单_库存）">​</a></h3>
<p><img decoding="async" loading="lazy" alt="1639403799134" src="/assets/images/d4f001510ce9866f570599c0ff934375-76a0756415955b924cddacb94a1c429b.png" width="412" height="445" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">扣减库存接口可能会根据库存系统的升级而升级，而不得不导致订单系统也需要升级（重新部署）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">使用消息队列后，库存系统订阅队列即可，无需关心库存系统接口升级的问题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="流量控制">流量控制<a href="#流量控制" class="hash-link" aria-label="Direct link to 流量控制" title="Direct link to 流量控制">​</a></h3>
<p><img decoding="async" loading="lazy" alt="1639403877743" src="/assets/images/110e1e3bcbfa3bb1130c8e13483e83ba-bfefa19495e538febb217e189f7c05e4.png" width="564" height="253" class="img_ev3q">****</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">高并发场景下（秒杀），将请求存入mq，后台系统按照自己的处理能力来消费任务，达到削峰的目的</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1639404125733" src="/assets/images/202304071636672-8122685b7d7fb306c3ca7836793ee653.png" width="1138" height="486" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="消息代理message-broker">消息代理（message broker）<a href="#消息代理message-broker" class="hash-link" aria-label="Direct link to 消息代理（message broker）" title="Direct link to 消息代理（message broker）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">消息代理：指安装了消息中间件的服务器，用于接收消息和发送消息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="目的地destination">目的地（destination）<a href="#目的地destination" class="hash-link" aria-label="Direct link to 目的地（destination）" title="Direct link to 目的地（destination）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">通俗解释：消息代理接收到消息后会将消息继续发给目的地（生产者发送消息）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">目的地主要有两种形式：队列、主题</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="队列queue单播_点对点消息通信">队列（queue）【单播_点对点消息通信】<a href="#队列queue单播_点对点消息通信" class="hash-link" aria-label="Direct link to 队列（queue）【单播_点对点消息通信】" title="Direct link to 队列（queue）【单播_点对点消息通信】">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">点对点消息通信（point-to-point）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.消息发送者发送消息，消息代理将其放入一个队列中，消息接受者从队列中获取消息内容，消息读取后被移出队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.队列可以被多个消费者监听，但一条消息只会被一个消费者成功消费</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主题topic广播_发布订阅">主题（topic）【广播_发布/订阅】<a href="#主题topic广播_发布订阅" class="hash-link" aria-label="Direct link to 主题（topic）【广播_发布/订阅】" title="Direct link to 主题（topic）【广播_发布/订阅】">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">发布（publish）/订阅（subscribe）消息通信</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.发送者发送消息到主题，多个订阅者订阅该主题，多个消费者会同时收到消息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="两种规范">两种规范<a href="#两种规范" class="hash-link" aria-label="Direct link to 两种规范" title="Direct link to 两种规范">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jmsjava-消息服务">JMS（JAVA 消息服务）<a href="#jmsjava-消息服务" class="hash-link" aria-label="Direct link to JMS（JAVA 消息服务）" title="Direct link to JMS（JAVA 消息服务）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">JMS：（Java Message Service）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">JAVA消息服务，基于JVM信息代理的规范。ActiveMQ、HornetMQ是JMS实现</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqp高级消息队列协议">AMQP（高级消息队列协议）<a href="#amqp高级消息队列协议" class="hash-link" aria-label="Direct link to AMQP（高级消息队列协议）" title="Direct link to AMQP（高级消息队列协议）">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">AMQP：（Advanced Message Queuing Protocol）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">高级消息队列协议，也是一个消息代理的规范，兼容JMS</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">RabbitMQ是AMQP的实现</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于以上两种规范的分析">基于以上两种规范的分析<a href="#基于以上两种规范的分析" class="hash-link" aria-label="Direct link to 基于以上两种规范的分析" title="Direct link to 基于以上两种规范的分析">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">支持消息类型：byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain">=》只要能支持byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain">就可以传输，例如将对象转换为json，然后转二进制流传输即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">五种消息模型：重要，direct exchange其实就是队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            后四种就是主题的变种</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="1639405192579" src="/assets/images/2b4d40d5c1f411b9bd1134840264765f-8f6ac8318ae23d9facde6a86106325d6.png" width="1128" height="540" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-支持与-springboot-自动装配">Spring 支持与 SpringBoot 自动装配<a href="#spring-支持与-springboot-自动装配" class="hash-link" aria-label="Direct link to Spring 支持与 SpringBoot 自动装配" title="Direct link to Spring 支持与 SpringBoot 自动装配">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1639405624744" src="/assets/images/0251b27b49e32f06c3431a5b6708fc53-86b14846470e77acecd8c4f62ec0f86f.png" width="1096" height="519" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">使用@EnableRabbit开启自动配置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>二、RabbitMQ 安装与测试</h1>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">文档：https</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//www.rabbitmq.com/networking.html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="docker-安装">docker 安装<a href="#docker-安装" class="hash-link" aria-label="Direct link to docker 安装" title="Direct link to docker 安装">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">4369</span><span class="token punctuation" style="color:#475569">,</span><span class="token number" style="color:#B5CEA8">25672</span><span class="token plain">(Erlang发现&amp;集群端口)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">5672</span><span class="token punctuation" style="color:#475569">,</span><span class="token number" style="color:#B5CEA8">5671</span><span class="token plain">(AMQP端口)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">15672</span><span class="token plain">(web管理后台端口)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">61613</span><span class="token punctuation" style="color:#475569">,</span><span class="token number" style="color:#B5CEA8">61614</span><span class="token plain">(STOMP协议端口)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1883</span><span class="token punctuation" style="color:#475569">,</span><span class="token number" style="color:#B5CEA8">8883</span><span class="token plain">(MQTT协议端口)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">https</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//www.rabbitmq.com/networking.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.下载镜像并启动</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">docker run -d --name rabbitmq -p </span><span class="token number" style="color:#B5CEA8">5671</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">5671</span><span class="token plain"> -p </span><span class="token number" style="color:#B5CEA8">5672</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">5672</span><span class="token plain"> -p </span><span class="token number" style="color:#B5CEA8">4369</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">4369</span><span class="token plain"> -p </span><span class="token number" style="color:#B5CEA8">25672</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">25672</span><span class="token plain"> -p </span><span class="token number" style="color:#B5CEA8">15671</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">15671</span><span class="token plain"> -p </span><span class="token number" style="color:#B5CEA8">15672</span><span class="token operator" style="color:#475569">:</span><span class="token number" style="color:#B5CEA8">15672</span><span class="token plain"> rabbitmq</span><span class="token operator" style="color:#475569">:</span><span class="token plain">management</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.修改为自动重启</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">docker update rabbitmq --restart=always</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.登录管理页面</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">http</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//192.168.56.10:15672/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">guest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">guest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmq-运行机制">RabbitMQ 运行机制<a href="#rabbitmq-运行机制" class="hash-link" aria-label="Direct link to RabbitMQ 运行机制" title="Direct link to RabbitMQ 运行机制">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1639486954176" src="/assets/images/2ffc2c9a278948767c2cc4542f9d7737-3deb341e9467a86cb9d2497f6765bd53.png" width="1092" height="542" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="消息路由名词解释">消息路由名词解释<a href="#消息路由名词解释" class="hash-link" aria-label="Direct link to 消息路由名词解释" title="Direct link to 消息路由名词解释">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.新增了Exchange和Binding角色</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.消息路由：消息到达Exchange，并根据Binding关系发布到Queue队列中的过程，被称为消息路由</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exchange-类型">Exchange 类型<a href="#exchange-类型" class="hash-link" aria-label="Direct link to Exchange 类型" title="Direct link to Exchange 类型">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="direct">direct<a href="#direct" class="hash-link" aria-label="Direct link to direct" title="Direct link to direct">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fanout">fanout<a href="#fanout" class="hash-link" aria-label="Direct link to fanout" title="Direct link to fanout">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="topic">topic<a href="#topic" class="hash-link" aria-label="Direct link to topic" title="Direct link to topic">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.Exchange名词解释：是AMQP高级消息队列协议的划分</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.RabbitMQ有四种Exchange类型：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2.1</span><span class="token plain">.点对点通信</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2.1</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.direct</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			解析：直接交换机【单播模式，按照路由关系精确匹配】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			例：路由键是dog，direct Exchange绑定了两个队列，队列</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：dog、队列</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：dogTom</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			使用direct Exchange只会把消息发送给队列</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2.1</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.headers【性能比较低，不会用到，与direct几乎一致】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2.2</span><span class="token plain">.发布/订阅：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2.2</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.fanout</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			解析：扇形【广播模式，不关心路由键】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			例：消息会发送给fanout Exchange绑定的所有队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2.2</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.topic</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			解析：主题【部分广播，区分路由键】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			例：binding.key=usa.* ：*处必须有一个单词</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">               binding.key=#.news：#处有</span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain">个或多个单词</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			注：不能匹配字母，只能匹配单词</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>direct 案例：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639487844649" src="/assets/images/29ed91f914e959a49ac241d5879762a6-e3b320ebf7627caf05de544f0a22f759.png" width="1101" height="257" class="img_ev3q"></p>
<p><strong>fanout 案例：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639487913417" src="/assets/images/253599f9b5108f07c2dac69a39b9a558-aa081951bef766ec3be3e38f2cf2988d.png" width="978" height="275" class="img_ev3q"></p>
<p><strong>Topic 案例：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639487923953" src="/assets/images/5273e1eff0d106ac51d939ab36d90b44-2b22f6e0f9f5d0e40dd8e8f4f490c6c0.png" width="1041" height="275" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试案例">测试案例<a href="#测试案例" class="hash-link" aria-label="Direct link to 测试案例" title="Direct link to 测试案例">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试案例-1">测试案例 1<a href="#测试案例-1" class="hash-link" aria-label="Direct link to 测试案例 1" title="Direct link to 测试案例 1">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">http</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//192.168.56.10:15672/#/exchanges</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.新建交换机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Exchanges=》Add a new Exchange=》Add Exchange</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.新建队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Queues=》Add a new Queue=》Add Queue</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.在交换机表格中点击新建的交换机，绑定刚刚新建的队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Bindings=》Add binding from this exchange=》To queue=》Bind</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">4</span><span class="token plain">.发送消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">=》publishe Message</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">5</span><span class="token plain">.获取消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Nack message requeue </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Automatic ack</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Reject requeue </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Reject requeue </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">6</span><span class="token plain">.解除binding</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">=》unbind</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1新建交换机">1.新建交换机：<a href="#1新建交换机" class="hash-link" aria-label="Direct link to 1.新建交换机：" title="Direct link to 1.新建交换机：">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639488692329" src="/assets/images/eae9993fab62ca8260867edf3e2b6d97-2acf6d8f31f765a80741497b58e79704.png" width="656" height="884" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2新建队列">2.新建队列：<a href="#2新建队列" class="hash-link" aria-label="Direct link to 2.新建队列：" title="Direct link to 2.新建队列：">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639488927909" src="/assets/images/a19460b82de7d4e715f82f0913272d2c-8488eb9c6c86e26a8304c9697997c511.png" width="803" height="752" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3在交换机表格中点击新建的交换机">3.在交换机表格中点击新建的交换机：<a href="#3在交换机表格中点击新建的交换机" class="hash-link" aria-label="Direct link to 3.在交换机表格中点击新建的交换机：" title="Direct link to 3.在交换机表格中点击新建的交换机：">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639488787531" src="/assets/images/4c9785c3b3558551581db1f831a9aa0f-68e3b9e79f8a317f85bb4e721dae1dd7.png" width="562" height="260" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="1639489151587" src="/assets/images/f913b059709cdee646a05f6fb95fb4b8-52ab7d22b1d1ff3e5cf721ef6d7aa1b0.png" width="715" height="862" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4发送消息">4.发送消息<a href="#4发送消息" class="hash-link" aria-label="Direct link to 4.发送消息" title="Direct link to 4.发送消息">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639490481854" src="/assets/images/c779f5295bc1b43c6344fdaf7a3bba55-97679d4cd242b082854f4ad162b5a2b3.png" width="602" height="925" class="img_ev3q"></p>
<p><strong>消息发送成功：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639490629311" src="/assets/images/f3b896b8ac28406ec72a331a962a0047-bbca2d524f384401b60015c3319bdb88.png" width="818" height="266" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5获取消息">5.获取消息<a href="#5获取消息" class="hash-link" aria-label="Direct link to 5.获取消息" title="Direct link to 5.获取消息">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="nack-message-requeue-true">Nack message requeue true<a href="#nack-message-requeue-true" class="hash-link" aria-label="Direct link to Nack message requeue true" title="Direct link to Nack message requeue true">​</a></h5>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">不回复消息，并且消息重新入队</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-ack">Automatic ack<a href="#automatic-ack" class="hash-link" aria-label="Direct link to Automatic ack" title="Direct link to Automatic ack">​</a></h5>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">自动回复消息，消息不重新入队</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="reject-requeue-true">Reject requeue true<a href="#reject-requeue-true" class="hash-link" aria-label="Direct link to Reject requeue true" title="Direct link to Reject requeue true">​</a></h5>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"></code></pre>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="reject-requeue-false">Reject requeue false<a href="#reject-requeue-false" class="hash-link" aria-label="Direct link to Reject requeue false" title="Direct link to Reject requeue false">​</a></h5>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"></code></pre>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6解除-binding">6.解除 binding<a href="#6解除-binding" class="hash-link" aria-label="Direct link to 6.解除 binding" title="Direct link to 6.解除 binding">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639489487003" src="data:image/png;base64,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" width="538" height="212" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试案例-2">测试案例 2<a href="#测试案例-2" class="hash-link" aria-label="Direct link to 测试案例 2" title="Direct link to 测试案例 2">​</a></h3>
<p><img decoding="async" loading="lazy" alt="1639489298287" src="/assets/images/e356577f5c8fb9d72ed66f8c99863c11-d03682149fb8de47338246ad8f3ce5c8.png" width="1212" height="369" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">根据上表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.建立交换机：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.direct【点对点】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.fanout【广播，消息会发送给binding的多个队列中】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.topic【广播，会先找到存在binding关系的队列，然后按照binding关系的路由规则与路由键进行模糊匹配】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.建立队列：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	atguigu</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	atguigu.news</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	atguigu.emps</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	gulixueyuan.news</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.创建binding关系</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.direct绑定所有队列【绑定规则是根据路由键与路由精确绑定决定消息进入哪个队列】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.fanout绑定所有队列【消息会发送给每个队列】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	exchange.topic绑定所有队列【并设置不同的路由键atguigu.#、*.news】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">4</span><span class="token plain">.发送消息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>三、RabbitMQ 概念</h1>
<p><img decoding="async" loading="lazy" alt="1639407551973" src="/assets/images/f5b860ddebd28b33a7ea688354d668ef-0d49fabf8bad3bd91d1e8e3b979767fd.png" width="1192" height="670" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1简介">1.简介<a href="#1简介" class="hash-link" aria-label="Direct link to 1.简介" title="Direct link to 1.简介">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1639405993748" src="/assets/images/08747af99f739232ff0bf8525a262658-0fbd1a58239d23be9e3e9e7e55d9375b.png" width="1103" height="437" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="1639406310372" src="/assets/images/bad75c5e3593b2b3491fd53fe0f6dbe7-db53530beaab4d713a5819dc9ab32a3f.png" width="1094" height="516" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="1639406273053" src="/assets/images/041f3ab7baf22f87aacfd8c8ba2d6a42-14a93c3a993b8c252e2c0f729d2b5ff3.png" width="1095" height="537" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11message-消息">1.1.Message 消息<a href="#11message-消息" class="hash-link" aria-label="Direct link to 1.1.Message 消息" title="Direct link to 1.1.Message 消息">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">每条消息都需要在消息头中指定route-key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12publisher-生产者">1.2.publisher 生产者<a href="#12publisher-生产者" class="hash-link" aria-label="Direct link to 1.2.publisher 生产者" title="Direct link to 1.2.publisher 生产者">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13exchange-交换器">1.3.Exchange 交换器<a href="#13exchange-交换器" class="hash-link" aria-label="Direct link to 1.3.Exchange 交换器" title="Direct link to 1.3.Exchange 交换器">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Exchange：交换器，每一个交换器都连接一个队列（可以看作局域网中的交换机的端口，每一个端口都连接一台电脑）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14queue-队列">1.4.Queue 队列<a href="#14queue-队列" class="hash-link" aria-label="Direct link to 1.4.Queue 队列" title="Direct link to 1.4.Queue 队列">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Queue队列：用于存储生产者发送的消息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="15binding-绑定">1.5.Binding 绑定<a href="#15binding-绑定" class="hash-link" aria-label="Direct link to 1.5.Binding 绑定" title="Direct link to 1.5.Binding 绑定">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">交换器与Queue之间存在绑定关系，一个交换器可以绑定多个队列，存在多种绑定关系</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">根据消息头中的路由键指定的绑定关系发送到匹配的队列中</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="16connection-连接">1.6.Connection 连接<a href="#16connection-连接" class="hash-link" aria-label="Direct link to 1.6.Connection 连接" title="Direct link to 1.6.Connection 连接">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">网络连接</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	生产者与Broker、消费者与Broker通过连接传输消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	一个客户端只会建立一条连接</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="17channel-通道">1.7.Channel 通道<a href="#17channel-通道" class="hash-link" aria-label="Direct link to 1.7.Channel 通道" title="Direct link to 1.7.Channel 通道">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">一个客户端建立一条连接，一条连接内存储多个通道用于监听不同队列</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="18virtual-host-虚拟主机">1.8.Virtual Host 虚拟主机<a href="#18virtual-host-虚拟主机" class="hash-link" aria-label="Direct link to 1.8.Virtual Host 虚拟主机" title="Direct link to 1.8.Virtual Host 虚拟主机">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">只需要安装一个rabbitmq，但是可以分离出多个微主机，互相之间配置隔离，使用不同的url访问</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.例如dev、test可以使用不同VHost</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.不同的系统使用不同的VHost</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2消息确认可靠消息">2.消息确认（可靠消息）<a href="#2消息确认可靠消息" class="hash-link" aria-label="Direct link to 2.消息确认（可靠消息）" title="Direct link to 2.消息确认（可靠消息）">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1639582496156" src="/assets/images/6cbb41b3e2e706b5def406659c3e0749-544df596fd1af2855c250ba1a6e07242.png" width="1081" height="551" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21可靠抵达_发送端确认">2.1.可靠抵达_发送端确认<a href="#21可靠抵达_发送端确认" class="hash-link" aria-label="Direct link to 2.1.可靠抵达_发送端确认" title="Direct link to 2.1.可靠抵达_发送端确认">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.可靠抵达：消息可靠抵达MQ，消息可靠抵达消费者</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.事务消息：性能下降</span><span class="token number" style="color:#B5CEA8">250</span><span class="token plain">倍，所以采用确认机制代替</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">文档：https</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//www.rabbitmq.com/confirms.html#publisher-confirms</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Reliable Delivery=》Acknowledgements and Confirms=&gt;Publisher confirms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="confirmcallback-回调">confirmCallback 回调<a href="#confirmcallback-回调" class="hash-link" aria-label="Direct link to confirmCallback 回调" title="Direct link to confirmCallback 回调">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639583499327" src="/assets/images/a5d7fc23d39b86fcc4ef504dd1f796ec-72e7d8bac4011a2f22114bcd02bfcbad.png" width="1103" height="472" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.生产者发送消息到Queue会经过两个两个过程【确认机制看做一种协议】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">）消息从publisher到达Broker（到达后会回调confirmCallback，消费者被告知消息是否抵达服务器）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			【集群情况下必须所有的broker接收到才会调用confirmCallback】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">）消息从Exchange投递到Queue（失败后会回调returnCallback，消费者被告知消息是否抵达Queue）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"># 开启发送端确认：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.rabbitmq.publisher-returns=true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"># 消息在没有被队列接收时是否强行退回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.rabbitmq.template.mandatory=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// 测试步骤，调用单元测试中发送消息的方法，触发回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyRabbitConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public MessageConverter messageConverter() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 使用json序列化器来序列化消息，发送消息时，消息对象会被序列化成json格式</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Jackson2JsonMessageConverter();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 定制RabbitTemplate</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、服务收到消息就会回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、spring.rabbitmq.publisher-confirms: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、设置确认回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、消息正确抵达队列就会进行回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、spring.rabbitmq.publisher-returns: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * spring.rabbitmq.template.mandatory: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、设置确认回调ReturnCallback</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * &lt;p&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 3、消费端确认(保证每个消息都被正确消费，此时才可以broker删除这个消息)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @PostConstruct   // (MyRabbitConfig对象创建完成以后，执行这个方法)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void initRabbitTemplate() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * 发送消息触发confirmCallback回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param correlationData：当前消息的唯一关联数据（如果发送消息时未指定此值，则回调时返回null）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param ack：消息是否成功收到（ack=true，消息抵达Broker）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param cause：失败的原因</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            System.out.println(&quot;发送消息触发confirmCallback回调&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\ncorrelationData ===&gt; &quot; + correlationData +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nack ===&gt; &quot; + ack + &quot;&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\ncause ===&gt; &quot; + cause);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="returncallback-回调">returnCallback 回调<a href="#returncallback-回调" class="hash-link" aria-label="Direct link to returnCallback 回调" title="Direct link to returnCallback 回调">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.生产者发送消息到Queue会经过两个两个过程【确认机制看做一种协议】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">）消息从publisher到达Broker（到达后会回调confirmCallback，消费者被告知消息是否抵达服务器）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">）消息从Exchange投递到Queue（失败后会回调returnCallback，消费者被告知消息是否抵达Queue）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"># 开启发送端抵达队列确认</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.rabbitmq.publisher-returns=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyRabbitConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public MessageConverter messageConverter() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 使用json序列化器来序列化消息，发送消息时，消息对象会被序列化成json格式</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Jackson2JsonMessageConverter();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 定制RabbitTemplate</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、服务收到消息就会回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、spring.rabbitmq.publisher-confirms: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、设置确认回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、消息正确抵达队列就会进行回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、spring.rabbitmq.publisher-returns: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * spring.rabbitmq.template.mandatory: true</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、设置确认回调ReturnCallback</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * &lt;p&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 3、消费端确认(保证每个消息都被正确消费，此时才可以broker删除这个消息)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @PostConstruct   // (MyRabbitConfig对象创建完成以后，执行这个方法)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void initRabbitTemplate() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * 消息未到达队列触发returnCallback回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * 只要消息没有投递给指定的队列，就触发这个失败回调</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param message：投递失败的消息详细信息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param replyCode：回复的状态码</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param replyText：回复的文本内容</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param exchange：接收消息的交换机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * @param routingKey：接收消息的路由键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 需要修改数据库 消息的状态【后期定期重发消息】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            System.out.println(&quot;消息未到达队列触发returnCallback回调&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nmessage ===&gt; &quot; + message +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nreplyCode ===&gt; &quot; + replyCode +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nreplyText ===&gt; &quot; + replyText +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nexchange ===&gt; &quot; + exchange +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;\nroutingKey ===&gt; &quot; + routingKey);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22可靠接收_消费端确认">2.2.可靠接收_消费端确认<a href="#22可靠接收_消费端确认" class="hash-link" aria-label="Direct link to 2.2.可靠接收_消费端确认" title="Direct link to 2.2.可靠接收_消费端确认">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ack-机制">ack 机制<a href="#ack-机制" class="hash-link" aria-label="Direct link to ack 机制" title="Direct link to ack 机制">​</a></h4>
<p><img decoding="async" loading="lazy" alt="1639904298481" src="/assets/images/eab9a4b9dfc56ddfdc74664b549c5102-d0f7787d6e3633138ed5f14c8360d402.png" width="1120" height="560" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.消费者接收消息也会经过ack消息确认机制，只有消费者成功接收消息，broker才允许删除消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.默认情况下消息抵达客户端后自动确认，服务端消息自动删除</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.手动确认模式下，消费者接收消息后但是不执行ack/nack进行确认，服务端队列中的消息会从unacked状态变为ready状态等待下一次消费（即使consumer宕机消息也不会丢失）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">4</span><span class="token plain">.注意：消息到达消费端，消息会进入unacked状态，如果手动确认模式下，消费者因宕机而未执行ack/nack，消息会一直处于unacked状态不会被删除（持久化了）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">5</span><span class="token plain">.签收，ack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"># 消费者手动确认模式，关闭自动确认，否则会消息丢失</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@RabbitListener(queues = {&quot;hello-java-queue&quot;})</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Service(&quot;orderItemService&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class OrderItemServiceImpl extends ServiceImpl&lt;OrderItemDao, OrderItemEntity&gt; implements OrderItemService {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	@RabbitHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void revieveMessage(Message message, OrderEntity entity, Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求体，序列化存储（本例中已使用Jackson2JsonMessageConverter序列化器作JSON序列化存储）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byte[] body = message.getBody();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求头</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        MessageProperties properties = message.getMessageProperties();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // channel内按顺序自增的long类型消息标签</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        long deliveryTag = properties.getDeliveryTag();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // JSON反序列得到消息内容对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderEntity reason = JSONObject.parseObject(body, OrderEntity.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息对象&quot; + message);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + reason);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + entity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (deliveryTag == 2) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 手动确认，消息会从unacked中删除，total数量减1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // boolean multiple：是否批量签收</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel.basicAck(deliveryTag, false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 手动拒签</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // boolean multiple：是否批量拒签</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // boolean requeue：当前拒签消息是否发回服务器重新入队</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel.basicNack(deliveryTag, false, true);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 网络中断</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23本地事务表">2.3.本地事务表<a href="#23本地事务表" class="hash-link" aria-label="Direct link to 2.3.本地事务表" title="Direct link to 2.3.本地事务表">​</a></h3>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3延时队列柔性事务">3.延时队列（柔性事务）<a href="#3延时队列柔性事务" class="hash-link" aria-label="Direct link to 3.延时队列（柔性事务）" title="Direct link to 3.延时队列（柔性事务）">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31使用场景">3.1.使用场景<a href="#31使用场景" class="hash-link" aria-label="Direct link to 3.1.使用场景" title="Direct link to 3.1.使用场景">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">场景：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	未付款订单，超时后，系统自动取消订单并释放占有物品</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">常用解决方案：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	Spring的Schedule定时任务轮询数据库</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">缺点：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	消耗系统内存、增加数据库的压力、存在较大的时间误差</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	在保证可靠消息的前提下，使用延时队列+死信队列，达到最终一致性（柔性事务）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32ttl-和死信-exchange">3.2.TTL 和死信 Exchange<a href="#32ttl-和死信-exchange" class="hash-link" aria-label="Direct link to 3.2.TTL 和死信 Exchange" title="Direct link to 3.2.TTL 和死信 Exchange">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ttl">TTL<a href="#ttl" class="hash-link" aria-label="Direct link to TTL" title="Direct link to TTL">​</a></h4>
<p>TTL（Time To Live）</p>
<ul>
<li>消息的 TTL 就是消息的存活时间</li>
<li>RabbitMQ 中对队列、消息都可以设置 TTL
<ul>
<li>对队列设置 TTL，就是队列没有消费者连着的保留时间；对消息设置 TTL，超过了这个时间，消息就死了，称之为死信。</li>
<li>如果队列设置了，消息也设置了，那么会取小的。所以一个消息如果被路由到不同的队列中，这个消息死亡的时间有可能不一样(不同的队列设置)。这里单讲单个消息的 TTL，因为它才是实现延迟任务的关键。可以通过设置消息的 expiration 字段或者 x-message-ttl 属性来设置时间，两者是—样的效果。</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="死信-exchange">死信 Exchange<a href="#死信-exchange" class="hash-link" aria-label="Direct link to 死信 Exchange" title="Direct link to 死信 Exchange">​</a></h4>
<ul>
<li>可以进入死信路由的情况
<ul>
<li>被 consumer 拒收的消息，并且 reject 方法的参数里 requeue 是 false（不会重新入队）</li>
<li>TTL 过期的消息</li>
<li>队列消息满了，排在前面的消息会被丢弃或进入死信路由</li>
</ul>
</li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">死信Exchange其实就是普通的Exchange</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">队列设置好自己的Dead Letter Exchange，当此队列中的消息过期后会被转发到这个路由，被称为死信路由</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="延时队列">延时队列<a href="#延时队列" class="hash-link" aria-label="Direct link to 延时队列" title="Direct link to 延时队列">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">TTL消息 + 死信Exchange</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">使用一个队列接收死信Exchange中的TTL消息，这样的队列被称为延时队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">注意：存放TTL消息的队列不要让客户端监听（这个队列和延时队列不是同一个，延时队列是存储已经超时的TTL消息）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33延时队列实现方案">3.3.延时队列实现方案<a href="#33延时队列实现方案" class="hash-link" aria-label="Direct link to 3.3.延时队列实现方案" title="Direct link to 3.3.延时队列实现方案">​</a></h3>
<ul>
<li>
<p>实现 1：给队列设置 TTL</p>
<ul>
<li>采用方案 1，因为队列是先进先出的。如果存在一个消息已经超时但是队首的消息未超时，已超时的消息无法出队</li>
</ul>
</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">arguments.put(&quot;x-dead-letter-exchange&quot;, &quot;order-event-exchange&quot;);// 死信路由</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">arguments.put(&quot;x-dead-letter-routing-key&quot;, &quot;order.release.order&quot;);// 死信路由键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">arguments.put(&quot;x-message-ttl&quot;, 60000); // 消息过期时间 1分钟</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>实现 2：给消息设置 TTL
<img decoding="async" loading="lazy" alt="QQ图片20220102211522" src="/assets/images/86e05c17b083db3eaa5eb6bd005def59-d6158195e1080e2ab110c212ad1a7cb7.jpeg" width="701" height="433" class="img_ev3q">
<img decoding="async" loading="lazy" alt="QQ图片20220102213900" src="/assets/images/37060221bafe95ce025884862b2d1531-757f88635cbc4044eccb4b7e4bb9fc78.png" width="765" height="434" class="img_ev3q"></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4可靠消息柔性事务">4.可靠消息（柔性事务）<a href="#4可靠消息柔性事务" class="hash-link" aria-label="Direct link to 4.可靠消息（柔性事务）" title="Direct link to 4.可靠消息（柔性事务）">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">场景：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	配合延时队列+死信队列实现最终一致性（柔性事务）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-mq_message-表">创建 mq_message 表<a href="#创建-mq_message-表" class="hash-link" aria-label="Direct link to 创建 mq_message 表" title="Direct link to 创建 mq_message 表">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">mq_message</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">message_id</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">char</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">32</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">content</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> json</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">to_exchane</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">varchar</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">routing_key</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">varchar</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">class_type</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">varchar</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">message_status</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&#x27;0-新建 1-已发送 2-错误抵达 3-已抵达&#x27;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">create_time</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">datetime</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">update_time</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">datetime</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token keyword" style="color:#0c4a6e">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token identifier">message_id</span><span class="token identifier punctuation" style="color:#475569">`</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">ENGINE</span><span class="token operator" style="color:#475569">=</span><span class="token keyword" style="color:#0c4a6e">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">CHARSET</span><span class="token operator" style="color:#475569">=</span><span class="token plain">utf8mb4</span><span class="token punctuation" style="color:#475569">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41消息丢失">4.1.消息丢失<a href="#41消息丢失" class="hash-link" aria-label="Direct link to 4.1.消息丢失" title="Direct link to 4.1.消息丢失">​</a></h3>
<p><img decoding="async" loading="lazy" alt="QQ图片20220103220617.jpg" src="/assets/images/ecb305a2268a27fc5c973d5af1ea8357-c3fe9540140645e06b562953a4962077.jpeg" width="895" height="463" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">前提：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    使用定时器扫描mq_message定时重发</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：网络连接失败，消息未抵达Broker</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    解决：发送消息时同时将消息持久化到MQ中并设定状态为已抵达</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         当出现异常时在catch处修改消息状态为错误抵达</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：消息抵达Broker，但为抵达queue，消息会丢失（只有抵达了queue消息才会持久化）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	解决：开启生产者确认机制，将触发returnCallback的returnedMessage的消息状态修改为错误抵达</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">：消费者未ack时宕机，导致消息丢失</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	解决：开启消费者手动ack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42消息重复">4.2.消息重复<a href="#42消息重复" class="hash-link" aria-label="Direct link to 4.2.消息重复" title="Direct link to 4.2.消息重复">​</a></h3>
<p><img decoding="async" loading="lazy" alt="QQ图片20220103231446.png" src="/assets/images/90213e17aa0415194ef2a9baeb3b9d2a-999464efd6a437009b916853a2f9fb9b.png" width="922" height="422" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：业务逻辑已经执行，但是ack时宕机，消息由unack变为ready，消息重新入队</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  解决：将接口设计成幂等性，例如库存解锁时判断工作单的状态，已解锁则无操作</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  解决</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：防重表</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43消息积压">4.3.消息积压<a href="#43消息积压" class="hash-link" aria-label="Direct link to 4.3.消息积压" title="Direct link to 4.3.消息积压">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：生产者流量太大</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  解决：减慢发送消息速率（验证码、防刷、重定向、削峰）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">情况</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：消费者能力不足或宕机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  解决：上线更多消费者</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  解决</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：上线专门的队列消费服务，批量取出消息入库，离线处理业务慢慢处理</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="优化方案">优化方案<a href="#优化方案" class="hash-link" aria-label="Direct link to 优化方案" title="Direct link to 优化方案">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">可以添加一个消息服务，各模块调用发送消息API即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">实现消息存库+异常修改状态</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">思考：如果feign调用失败没有问题，做好本地事务，feign调用失败回滚即可</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5队列削峰高并发_秒杀">5.队列削峰（高并发_秒杀）<a href="#5队列削峰高并发_秒杀" class="hash-link" aria-label="Direct link to 5.队列削峰（高并发_秒杀）" title="Direct link to 5.队列削峰（高并发_秒杀）">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">场景：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	高并发秒杀模块，将秒杀成功创建订单的消息发送给MQ，订单模块按照自己的能力消费生成订单</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	这个过程就是队列削峰（不走购物车逻辑，否则秒杀的高并发流量会带给订单模块）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>四、Springboot 整合 RabbitMQ</h1>
<p><img decoding="async" loading="lazy" alt="1639491342358" src="/assets/images/45ff3b67b820b942c378050c5b785ab3-e63e1cdfc10d36ee6bc7eab344af02e3.png" width="414" height="201" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1引入-spring-boot-starter-amqp-依赖">1.引入 spring-boot-starter-amqp 依赖<a href="#1引入-spring-boot-starter-amqp-依赖" class="hash-link" aria-label="Direct link to 1.引入 spring-boot-starter-amqp 依赖" title="Direct link to 1.引入 spring-boot-starter-amqp 依赖">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.订单服务中引入依赖，场景启动器，引入后RabbitAutoConfiguration自动生效</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;!--rabbitmq--&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	&lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.RabbitAutoConfiguration生效后自动注入多个容器：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	CachingConnectionFactory：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	RabbitTemplate：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	AmqpAdmin：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	RabbitMessagingTemplate：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.RabbitProperties：配置类</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cachingconnectionfactory">CachingConnectionFactory<a href="#cachingconnectionfactory" class="hash-link" aria-label="Direct link to CachingConnectionFactory" title="Direct link to CachingConnectionFactory">​</a></h3>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"></code></pre>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rabbittemplate">RabbitTemplate<a href="#rabbittemplate" class="hash-link" aria-label="Direct link to RabbitTemplate" title="Direct link to RabbitTemplate">​</a></h3>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"></code></pre>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amqpadmin">AmqpAdmin<a href="#amqpadmin" class="hash-link" aria-label="Direct link to AmqpAdmin" title="Direct link to AmqpAdmin">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">用于创建Exchange、Queue、Binding</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitmessagingtemplate">RabbitMessagingTemplate<a href="#rabbitmessagingtemplate" class="hash-link" aria-label="Direct link to RabbitMessagingTemplate" title="Direct link to RabbitMessagingTemplate">​</a></h3>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"></code></pre>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2开启-rabbit">2.开启 Rabbit<a href="#2开启-rabbit" class="hash-link" aria-label="Direct link to 2.开启 Rabbit" title="Direct link to 2.开启 Rabbit">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">启动类标注：（只有需要用到监听消息时才需要该注解，开启后可以使用@RabbitListener）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@EnableRabbit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3配置属性">3.配置属性<a href="#3配置属性" class="hash-link" aria-label="Direct link to 3.配置属性" title="Direct link to 3.配置属性">​</a></h2>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token key atrule">spring</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token key atrule">rabbitmq</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 192.168.56.10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">5672</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">virtual-host</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 开启发送端抵达队列确认【发送端确认机制+本地事务表】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">publisher-returns</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 开启发送确认【发送端确认机制+本地事务表】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">publisher-confirm-type</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> correlated</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 只要抵达队列，优先回调return confirm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token key atrule">mandatory</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 使用手动确认模式，关闭自动确认【消息丢失】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">listener</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token key atrule">simple</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token key atrule">acknowledge-mode</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> manual</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4配置类">4.配置类<a href="#4配置类" class="hash-link" aria-label="Direct link to 4.配置类" title="Direct link to 4.配置类">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyRabbitConfig </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public MessageConverter messageConverter() </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 使用json序列化器来序列化消息，发送消息时，消息对象会被序列化成json格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Jackson2JsonMessageConverter();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5单元测试">5.单元测试<a href="#5单元测试" class="hash-link" aria-label="Direct link to 5.单元测试" title="Direct link to 5.单元测试">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-exchange">创建 Exchange<a href="#创建-exchange" class="hash-link" aria-label="Direct link to 创建 Exchange" title="Direct link to 创建 Exchange">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">AmqpAdmin amqpAdmin;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">void createExchange() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 创建交换机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String name, boolean durable, boolean autoDelete</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    DirectExchange exchange = new DirectExchange(&quot;hello-java-exchange&quot;, true, false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    amqpAdmin.declareExchange(exchange);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    log.info(&quot;Exchange创建[{}]成功&quot;, &quot;hello-java-exchange&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-queue">创建 Queue<a href="#创建-queue" class="hash-link" aria-label="Direct link to 创建 Queue" title="Direct link to 创建 Queue">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">AmqpAdmin amqpAdmin;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">void createQueue() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 创建队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String name, boolean durable, boolean exclusive, boolean autoDelete</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // exclusive：是否排他，true：只有一个连接可以使用此队列，其他连接无法连上此队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    Queue queue = new Queue(&quot;hello-java-queue&quot;, true, false, false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    amqpAdmin.declareQueue(queue);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    log.info(&quot;Queue创建[{}]成功&quot;, &quot;hello-java-queue&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-binding_交换机绑定">创建 Binding_交换机绑定<a href="#创建-binding_交换机绑定" class="hash-link" aria-label="Direct link to 创建 Binding_交换机绑定" title="Direct link to 创建 Binding_交换机绑定">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">AmqpAdmin amqpAdmin;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">void createBinding() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 创建绑定，交换机绑定目的地</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String destination：目的地name</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // DestinationType destinationType：目的地类型【queue或exchange（路由）】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String exchange：待绑定交换机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String routingKey：路由键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    Binding bind = new Binding(&quot;hello-java-queue&quot;, Binding.DestinationType.QUEUE,&quot;hello-java-exchange&quot;, &quot;hello.java&quot;, null)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    amqpAdmin.declareBinding(bind);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    log.info(&quot;Binding创建[{}]成功&quot;, &quot;hello-java-binding&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="发送消息-1639498067759">发送消息 <img decoding="async" loading="lazy" alt="1639498067759" src="/assets/images/65e23dd642166d3ce2f6ef751763c656-996caf7c0c7a9ca9ea58a87f8901524c.png" width="1071" height="598" class="img_ev3q"><a href="#发送消息-1639498067759" class="hash-link" aria-label="Direct link to 发送消息-1639498067759" title="Direct link to 发送消息-1639498067759">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">void sendMsg() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 如果发送的消息是个对象，会使用序列化机制，将对象写出去。对象类必须实现 serializable</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 如果使用JSON序列化器，则不需要类实现Serializable</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String exchange：交换机</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // String routingKey：路由键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // final Object object：消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // CorrelationData correlationData：可指定消息ID</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 消息对象，可以是任意类型，类必须实现serializable，消息会以序列化的方式写入流中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    OrderReturnReasonEntity message = new OrderReturnReasonEntity();// 退货原因</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    message.setId(1L);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    message.setCreateTime(new Date());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    message.setName(&quot;哈哈&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 消息ID</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    rabbitTemplate.convertAndSend(&quot;hello-java-exchange&quot;, &quot;hello.java&quot;, message, correlationData);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="接收消息">接收消息<a href="#接收消息" class="hash-link" aria-label="Direct link to 接收消息" title="Direct link to 接收消息">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitlistener">@RabbitListener<a href="#rabbitlistener" class="hash-link" aria-label="Direct link to @RabbitListener" title="Direct link to @RabbitListener">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.用于标注在监听类或监听方法上，接收消息，需要指定监听的队列（数组）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.使用该注解之前，需要在启动类加上该注解：@EnableRabbit</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.@RabbitListener即可以标注在方法上又可以标注在类上</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		标注在类上：表示该类是监听类，使得@RabbitHandler注解生效</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		标注在方法上：表示该方法时监听方法，会监听指定队列获得消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">4</span><span class="token plain">.一般只标注在方法上，并配合@RabbitHandler使用，重载的方式接收不同消息对象</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">import com.rabbitmq.client.Channel;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Service(&quot;orderItemService&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class OrderItemServiceImpl extends ServiceImpl&lt;OrderItemDao, OrderItemEntity&gt; implements OrderItemService {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * queues：声明需要监听的队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * channel：当前传输数据的通道</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 获取实际消息内容有两种方式：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     *  方式一：在方法参数列表中直接声明出来</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     *  方式二：从请求体中取出消息的二进制形式，然后通过JSON反序列化即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @RabbitListener(queues = {&quot;hello-java-queue&quot;})</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void revieveMessage(Message message, OrderReturnReasonEntity entity, Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求体，序列化存储（本例中已使用Jackson2JsonMessageConverter序列化器作JSON序列化存储）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byte[] body = message.getBody();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求头</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        MessageProperties messageProperties = message.getMessageProperties();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // JSON反序列得到消息内容对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderReturnReasonEntity reason = JSONObject.parseObject(body, OrderReturnReasonEntity.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息对象&quot; + message);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + reason);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + entity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="测试集群多客户端监听接收消息">测试集群多客户端监听接收消息<a href="#测试集群多客户端监听接收消息" class="hash-link" aria-label="Direct link to 测试集群多客户端监听接收消息" title="Direct link to 测试集群多客户端监听接收消息">​</a></h5>
<p><img decoding="async" loading="lazy" alt="1639580605368" src="/assets/images/7c03aa8e5c059d9f5d02bc1a6d659879-0c55ee34753315f4c2632d25ebdbee23.png" width="1031" height="870" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	复制一份订单配置</span><span class="token number" style="color:#B5CEA8">9011</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	-Xmx100m</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	--server.port=</span><span class="token number" style="color:#B5CEA8">9011</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	同时运行多个订单模块，然后测试发送多条消息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">结论：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.多个客户端可以共同监听同一队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.一条消息同时只能被一个客户端接收</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.同一个客户端接收消息是串行的，revieveMessage方法执行完后才会继续接收下一条消息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>9010 接收消息：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639580888252" src="/assets/images/202304071635352-a6ddf0ba813cd6439c99666f48444f5e.png" width="1015" height="157" class="img_ev3q"></p>
<p><strong>9011 接收消息：</strong></p>
<p><img decoding="async" loading="lazy" alt="1639580848532" src="/assets/images/202304071635297-c1c39b468944928e4c9a2f656c04215b.png" width="1045" height="171" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rabbithandler">@RabbitHandler<a href="#rabbithandler" class="hash-link" aria-label="Direct link to @RabbitHandler" title="Direct link to @RabbitHandler">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">作用：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	配合@RabbitListener，使用方法重载的方法接收不同的消息类型</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	1.用于标注在监听方法上，接收消息，不需要指定监听的队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	2.使用该注解之前，需要在启动类加上该注解：@EnableRabbit</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	3.@RabbitListener只可以标注在方法，重载的方式接收不同消息对象</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">class GulimallOrderApplicationTests {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    void sendMsg2() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 该测试案例向同一队列发送了两个不同类型的消息对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 消息一：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderReturnReasonEntity message1 = new OrderReturnReasonEntity();// 退货原因</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message1.setId(1L);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message1.setCreateTime(new Date());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message1.setName(&quot;哈哈&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CorrelationData correlationData1 = new CorrelationData(UUID.randomUUID().toString());// 消息ID</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        rabbitTemplate.convertAndSend(&quot;hello-java-exchange&quot;, &quot;hello.java&quot;, message1, correlationData1);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 消息二：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderEntity message2 = new OrderEntity();// 退货原因</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message2.setId(1L);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message2.setCreateTime(new Date());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        message2.setOrderSn(&quot;哈哈&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CorrelationData correlationData2 = new CorrelationData(UUID.randomUUID().toString());// 消息ID</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        rabbitTemplate.convertAndSend(&quot;hello-java-exchange&quot;, &quot;hello.java&quot;, message2, correlationData2);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@RabbitListener(queues = {&quot;hello-java-queue&quot;})</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Service(&quot;orderItemService&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class OrderItemServiceImpl extends ServiceImpl&lt;OrderItemDao, OrderItemEntity&gt; implements OrderItemService {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 方法重载1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @RabbitHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void revieveMessage(Message message, OrderReturnReasonEntity entity, Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求体，序列化存储（本例中已使用Jackson2JsonMessageConverter序列化器作JSON序列化存储）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byte[] body = message.getBody();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求头</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        MessageProperties messageProperties = message.getMessageProperties();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // JSON反序列得到消息内容对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderReturnReasonEntity reason = JSONObject.parseObject(body, OrderReturnReasonEntity.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息对象&quot; + message);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + reason);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + entity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 方法重载2</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @RabbitHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void revieveMessage(Message message, OrderEntity entity, Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求体，序列化存储（本例中已使用Jackson2JsonMessageConverter序列化器作JSON序列化存储）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byte[] body = message.getBody();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 请求头</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        MessageProperties messageProperties = message.getMessageProperties();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // JSON反序列得到消息内容对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        OrderEntity reason = JSONObject.parseObject(body, OrderEntity.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息对象&quot; + message);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + reason);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;接受到的消息内容&quot; + entity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6消息确认">6.消息确认<a href="#6消息确认" class="hash-link" aria-label="Direct link to 6.消息确认" title="Direct link to 6.消息确认">​</a></h2>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token key atrule">spring</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token key atrule">rabbitmq</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 192.168.56.10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">5672</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">virtual-host</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 开启发送端发送确认，无论是否到达broker都会触发回调【发送端确认机制+本地事务表】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">publisher-confirm-type</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> correlated</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 开启发送端抵达队列确认，消息未被队列接收时触发回调【发送端确认机制+本地事务表】</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">publisher-returns</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 消息在没有被队列接收时是否强行退回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token key atrule">mandatory</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955"># 消费者手动确认模式，关闭自动确认，否则会消息丢失</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">listener</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token key atrule">simple</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token key atrule">acknowledge-mode</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> manual</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7延时队列死信队列">7.延时队列、死信队列<a href="#7延时队列死信队列" class="hash-link" aria-label="Direct link to 7.延时队列、死信队列" title="Direct link to 7.延时队列、死信队列">​</a></h2>
<p><img decoding="async" loading="lazy" alt="QQ图片20220102220024.jpg" src="/assets/images/202304071634480-0dca5fbd14b84a6aa4f1ce498826ef0a.jpeg" width="962" height="431" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">描述：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	可以共用一个exchange，指定不同的路由分别绑定延时队列和死信队列</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 创建队列，交换机，延时队列，绑定关系 的configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 1.Broker中的Queue、Exchange、Binding不存在的情况下，会自动创建（在RabbitMQ），不会重复创建覆盖</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 2.懒加载，只有第一次使用的时候才会创建（例如监听队列）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyRabbitMQConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 延时队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Queue orderDelayQueue() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * Queue(String name,  队列名字</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         *       boolean durable,  是否持久化</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         *       boolean exclusive,  是否排他</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         *       boolean autoDelete, 是否自动删除</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         *       Map&lt;String, Object&gt; arguments) 属性【TTL、死信路由、死信路由键】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        HashMap&lt;String, Object&gt; arguments = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        arguments.put(&quot;x-dead-letter-exchange&quot;, &quot;order-event-exchange&quot;);// 死信路由</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        arguments.put(&quot;x-dead-letter-routing-key&quot;, &quot;order.release.order&quot;);// 死信路由键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        arguments.put(&quot;x-message-ttl&quot;, 60000); // 消息过期时间 1分钟</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Queue(&quot;order.delay.queue&quot;, true, false, false, arguments);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 交换机（死信路由）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Exchange orderEventExchange() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new TopicExchange(&quot;order-event-exchange&quot;, true, false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 死信队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Queue orderReleaseQueue() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Queue(&quot;order.release.order.queue&quot;, true, false, false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 绑定：交换机与订单解锁延迟队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Binding orderCreateBinding() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * String destination, 目的地（队列名或者交换机名字）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * DestinationType destinationType, 目的地类型（Queue、Exhcange）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * String exchange,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * String routingKey,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         * Map&lt;String, Object&gt; arguments</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         **/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Binding(&quot;order.delay.queue&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                Binding.DestinationType.QUEUE,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order-event-exchange&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order.create.order&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                null);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 绑定：交换机与订单解锁死信队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Binding orderReleaseBinding() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Binding(&quot;order.release.order.queue&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                Binding.DestinationType.QUEUE,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order-event-exchange&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order.release.order&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                null);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 绑定：交换机与库存解锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Binding orderReleaseOtherBinding() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new Binding(&quot;stock.release.stock.queue&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                Binding.DestinationType.QUEUE,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order-event-exchange&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;order.release.other.#&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Java/大前端进阶（ES6）"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ES6</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Java/快速入门分布式系统与Dubbo+zookeeper"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">分布式系统简述：</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#精短简介" class="table-of-contents__link toc-highlight">精短简介</a></li><li><a href="#简单案例" class="table-of-contents__link toc-highlight">简单案例</a><ul><li><a href="#异步消息处理注册" class="table-of-contents__link toc-highlight">异步消息处理（注册）</a></li><li><a href="#应用解耦订单_库存" class="table-of-contents__link toc-highlight">应用解耦（订单_库存）</a></li><li><a href="#流量控制" class="table-of-contents__link toc-highlight">流量控制</a></li></ul></li><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a><ul><li><a href="#消息代理message-broker" class="table-of-contents__link toc-highlight">消息代理（message broker）</a></li><li><a href="#目的地destination" class="table-of-contents__link toc-highlight">目的地（destination）</a></li></ul></li><li><a href="#两种规范" class="table-of-contents__link toc-highlight">两种规范</a><ul><li><a href="#jmsjava-消息服务" class="table-of-contents__link toc-highlight">JMS（JAVA 消息服务）</a></li><li><a href="#amqp高级消息队列协议" class="table-of-contents__link toc-highlight">AMQP（高级消息队列协议）</a></li><li><a href="#基于以上两种规范的分析" class="table-of-contents__link toc-highlight">基于以上两种规范的分析</a></li></ul></li><li><a href="#spring-支持与-springboot-自动装配" class="table-of-contents__link toc-highlight">Spring 支持与 SpringBoot 自动装配</a></li><li><a href="#docker-安装" class="table-of-contents__link toc-highlight">docker 安装</a></li><li><a href="#rabbitmq-运行机制" class="table-of-contents__link toc-highlight">RabbitMQ 运行机制</a><ul><li><a href="#消息路由名词解释" class="table-of-contents__link toc-highlight">消息路由名词解释</a></li><li><a href="#exchange-类型" class="table-of-contents__link toc-highlight">Exchange 类型</a></li></ul></li><li><a href="#测试案例" class="table-of-contents__link toc-highlight">测试案例</a><ul><li><a href="#测试案例-1" class="table-of-contents__link toc-highlight">测试案例 1</a></li><li><a href="#测试案例-2" class="table-of-contents__link toc-highlight">测试案例 2</a></li></ul></li><li><a href="#1简介" class="table-of-contents__link toc-highlight">1.简介</a><ul><li><a href="#11message-消息" class="table-of-contents__link toc-highlight">1.1.Message 消息</a></li><li><a href="#12publisher-生产者" class="table-of-contents__link toc-highlight">1.2.publisher 生产者</a></li><li><a href="#13exchange-交换器" class="table-of-contents__link toc-highlight">1.3.Exchange 交换器</a></li><li><a href="#14queue-队列" class="table-of-contents__link toc-highlight">1.4.Queue 队列</a></li><li><a href="#15binding-绑定" class="table-of-contents__link toc-highlight">1.5.Binding 绑定</a></li><li><a href="#16connection-连接" class="table-of-contents__link toc-highlight">1.6.Connection 连接</a></li><li><a href="#17channel-通道" class="table-of-contents__link toc-highlight">1.7.Channel 通道</a></li><li><a href="#18virtual-host-虚拟主机" class="table-of-contents__link toc-highlight">1.8.Virtual Host 虚拟主机</a></li></ul></li><li><a href="#2消息确认可靠消息" class="table-of-contents__link toc-highlight">2.消息确认（可靠消息）</a><ul><li><a href="#21可靠抵达_发送端确认" class="table-of-contents__link toc-highlight">2.1.可靠抵达_发送端确认</a></li><li><a href="#22可靠接收_消费端确认" class="table-of-contents__link toc-highlight">2.2.可靠接收_消费端确认</a></li><li><a href="#23本地事务表" class="table-of-contents__link toc-highlight">2.3.本地事务表</a></li></ul></li><li><a href="#3延时队列柔性事务" class="table-of-contents__link toc-highlight">3.延时队列（柔性事务）</a><ul><li><a href="#31使用场景" class="table-of-contents__link toc-highlight">3.1.使用场景</a></li><li><a href="#32ttl-和死信-exchange" class="table-of-contents__link toc-highlight">3.2.TTL 和死信 Exchange</a></li><li><a href="#33延时队列实现方案" class="table-of-contents__link toc-highlight">3.3.延时队列实现方案</a></li></ul></li><li><a href="#4可靠消息柔性事务" class="table-of-contents__link toc-highlight">4.可靠消息（柔性事务）</a><ul><li><a href="#创建-mq_message-表" class="table-of-contents__link toc-highlight">创建 mq_message 表</a></li><li><a href="#41消息丢失" class="table-of-contents__link toc-highlight">4.1.消息丢失</a></li><li><a href="#42消息重复" class="table-of-contents__link toc-highlight">4.2.消息重复</a></li><li><a href="#43消息积压" class="table-of-contents__link toc-highlight">4.3.消息积压</a></li><li><a href="#优化方案" class="table-of-contents__link toc-highlight">优化方案</a></li></ul></li><li><a href="#5队列削峰高并发_秒杀" class="table-of-contents__link toc-highlight">5.队列削峰（高并发_秒杀）</a></li><li><a href="#1引入-spring-boot-starter-amqp-依赖" class="table-of-contents__link toc-highlight">1.引入 spring-boot-starter-amqp 依赖</a><ul><li><a href="#cachingconnectionfactory" class="table-of-contents__link toc-highlight">CachingConnectionFactory</a></li><li><a href="#rabbittemplate" class="table-of-contents__link toc-highlight">RabbitTemplate</a></li><li><a href="#amqpadmin" class="table-of-contents__link toc-highlight">AmqpAdmin</a></li><li><a href="#rabbitmessagingtemplate" class="table-of-contents__link toc-highlight">RabbitMessagingTemplate</a></li></ul></li><li><a href="#2开启-rabbit" class="table-of-contents__link toc-highlight">2.开启 Rabbit</a></li><li><a href="#3配置属性" class="table-of-contents__link toc-highlight">3.配置属性</a></li><li><a href="#4配置类" class="table-of-contents__link toc-highlight">4.配置类</a></li><li><a href="#5单元测试" class="table-of-contents__link toc-highlight">5.单元测试</a><ul><li><a href="#创建-exchange" class="table-of-contents__link toc-highlight">创建 Exchange</a></li><li><a href="#创建-queue" class="table-of-contents__link toc-highlight">创建 Queue</a></li><li><a href="#创建-binding_交换机绑定" class="table-of-contents__link toc-highlight">创建 Binding_交换机绑定</a></li><li><a href="#发送消息-1639498067759" class="table-of-contents__link toc-highlight">发送消息 1639498067759</a></li><li><a href="#接收消息" class="table-of-contents__link toc-highlight">接收消息</a></li></ul></li><li><a href="#6消息确认" class="table-of-contents__link toc-highlight">6.消息确认</a></li><li><a href="#7延时队列死信队列" class="table-of-contents__link toc-highlight">7.延时队列、死信队列</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">  来自冷环渊的技术支持与文档创作 @2025</div></div></div></footer></div>
</body>
</html>
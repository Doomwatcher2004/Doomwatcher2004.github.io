<!doctype html>
<html lang="cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Java/Netty网络框架" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Netty 网络框架 | 小冷の代码世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://doomwatcher2004.github.io/docs/Java/Netty网络框架"><meta data-rh="true" property="og:locale" content="cn"><meta data-rh="true" name="docusaurus_locale" content="cn"><meta data-rh="true" name="docsearch:language" content="cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Netty 网络框架 | 小冷の代码世界"><meta data-rh="true" name="description" content="（一） 基础篇"><meta data-rh="true" property="og:description" content="（一） 基础篇"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doomwatcher2004.github.io/docs/Java/Netty网络框架"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/Java/Netty网络框架" hreflang="cn"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/Java/Netty网络框架" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.15cbc4ab.css">
<script src="/assets/js/runtime~main.d1486736.js" defer="defer"></script>
<script src="/assets/js/main.cae173d3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">小冷の代码世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Java/Docker 快速入门">Java知识库</a><a class="navbar__item navbar__link" href="/docs/Web/JavaScript 高级">前端知识库</a><a class="navbar__item navbar__link" href="/docs/Godot/">Godot游戏开发</a><a class="navbar__item navbar__link" href="/docs/finish/finishRpc">Finish系列手写中间件</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Doomwatcher2004" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Docker 快速入门">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java 8 更新的新特性 （函数式接口 lambda stream option）">Java8 新特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java后端进阶之路： JavaWeb">javaweb</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Mybatis">Mybatis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty+springboot实现IM即时通讯服务端">Netty+springboot实现IM即时通讯服务端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_HTTP文件列表服务器">Netty_HTTP文件列表服务器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_模拟Redis的客户端">Netty_模拟Redis的客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/Java/Netty网络框架">Netty 网络框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Nginx">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Redis 数据结构操作入门">Redis 数据结构操作入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring Aop 底层责任链思路实现">Spring Aop 底层责任链思路实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring5 Webflux 响应式编程">Spring5 Webflux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringBoot 解决企业级复杂性简化开发的神奇">微服务阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Alibaba">springCloudAlibaba</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Netflix">springcloud2020</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring内置MVC框架：SpringMVC">SpringMVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/mybatis plus">mybatis plus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/redis问题的常见解决方案">redis问题的常见解决方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/六道入门树题目带你走入树结构的世界">六道入门树题目带你走入树结构的世界</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）">分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/多线程进阶 JUC并发编程">多线程进阶 JUC 并发编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/大前端进阶（ES6）">ES6</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/快速入门RabbitMQ并且加入项目实战">快速入门RabbitMQ并且加入项目实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/快速入门分布式系统与Dubbo+zookeeper">分布式系统简述：</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/掌握极简服务器开发的优秀框架 ：Spring">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/搜索引擎 _ Elasticsearch">Elasticsearch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/数据结构与算法">数据结构与算法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/理解IOC 手写springIOC">Spring 手撕 IOC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/简易aiweb">Java入门Spring AI应用开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/线程池详解与异步任务编排使用案例">线程池详解与异步任务编排使用案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/通透百万数据秒级排序  快速排序">通透百万数据秒级排序  快速排序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/阿里淘系单点登录中心">阿里淘系单点登录中心</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/高并发秒杀系统">高并发秒杀系统</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Netty 网络框架</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Netty 网络框架</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一-基础篇">（一） 基础篇<a href="#一-基础篇" class="hash-link" aria-label="Direct link to （一） 基础篇" title="Direct link to （一） 基础篇">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1io-基础">1、I/O 基础<a href="#1io-基础" class="hash-link" aria-label="Direct link to 1、I/O 基础" title="Direct link to 1、I/O 基础">​</a></h3>
<p>输入流：InputStream 和 Reader
输出流：OutputStream 和 Writer</p>
<p>​ 字节流 字符流</p>
<p>计算机最小的二进制单位 bit 比特 代表 0 和 1
字节 1 byte = 8bit 计算机处理的最小单位
字符 1 char = 2byte = 16bit 人处理的最小单位</p>
<p>所以，字节流处理文件、图片、视频等二进制数据，而字符流处理文本数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2socket">2、Socket<a href="#2socket" class="hash-link" aria-label="Direct link to 2、Socket" title="Direct link to 2、Socket">​</a></h3>
<p>原意是“插座”，在计算机领域中，翻译为“套接字”。
本质上，是计算机之间进行通信的一种方式。</p>
<p>Linux，“一切皆文件”，给每个文件映射一个 ID，叫做&quot;文件描述符&quot;。
当处理网络连接时，也会看成一个文件，read/write 变成和远程计算机的交互。</p>
<p>OSI 七层模型 = Open System Interconnection 开放式系统互联
从下到上分别为：物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。</p>
<p>实际应用的是优化后的 TCP/IP 模型（四层）
网络接口层/链路层、网络层、传输层、应用层</p>
<p>应用层协议：HTTP、FTP、SMTP（邮件协议）
传输层协议：TCP、UDP</p>
<p>Socket 其实是应用层与传输层之间的抽象层，是一组接口。
在设计模式中，是门面模式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3nio">3、NIO<a href="#3nio" class="hash-link" aria-label="Direct link to 3、NIO" title="Direct link to 3、NIO">​</a></h3>
<p>BIO - BlockingIO 同步阻塞
NIO - New IO / Non-Blocking IO 同步非阻塞
AIO - Asynchronous IO 异步非阻塞</p>
<p>同步和异步，关注的是消息通知的机制
阻塞和非阻塞，关注的是等待消息过程中的状态</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/a9f7483239a5b5cc156b9ad28c1cbdc7.png" alt="image-20220412192629185" class="img_ev3q"></p>
<p>多路复用的模型</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/5f7d0e6f113c2501fa1c17a850a306dc.png" alt="image-20220412192637464" class="img_ev3q"></p>
<p>三大元素：Channel 、Buffer、Selector</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-channel">1) Channel<a href="#1-channel" class="hash-link" aria-label="Direct link to 1) Channel" title="Direct link to 1) Channel">​</a></h4>
<p>FileChannel 文件管道的数据
Pipe.SinkChannel
Pipe.SourceChannel 线程间通信的管道
ServerSocketChannel
SocketChannel 用于 TCP 网络通信的管道
DatagramChannel 用于 UDP 网络通信的管道</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-buffer">2) Buffer<a href="#2-buffer" class="hash-link" aria-label="Direct link to 2) Buffer" title="Direct link to 2) Buffer">​</a></h4>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/99d6a5a18cd285ba16eb20cba178a78a.png" alt="image-20220412192652620" class="img_ev3q"></p>
<p>capacity 总体容量大小
limit 存储容量的大小，是可读写和不可读写的界线
position 已读容量的大小，已读和未读区域的界线</p>
<p>【使用原理】
a) 初始化，给定总容量，position=0, limit=capacity
b) 当使用 put 方法存入数据是，通过 position 来记录存储的容量变化，position 不断后移，直到存储结束（写完成）
c）写完成需要调用 flip 方法刷新，limit=position，position=0
保障 limit 记录的是可读写区域的大小，position 已读部分重置为空
d) 读数据直到读完成，需要调用 clear 方法，position=0, limit=capacity</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-selector">3) Selector<a href="#3-selector" class="hash-link" aria-label="Direct link to 3) Selector" title="Direct link to 3) Selector">​</a></h4>
<p>三个元素： Selector 选择器、SelectableChannel 可选择的通道、SelectionKey 选择键</p>
<p>本质上，Selector 是监听器，监听的是通道是否有我们关心的操作产生，操作对应的是事件（连接、接收、读/写），使用 SelectionKey 代表具体的事件，在确保通道是可选择的情况下，将通道注册进选择器中，此时 Selector 维护的是，通道和事件之间的关联关系。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/eaa6ae4668a20fc0c2daec742f7a8f41.png" alt="image-20220412192659118" class="img_ev3q"></p>
<p>Selector，管理被注册的通道集合，以及他们的状态
SelectableChannel，是一个抽象类，提供了通道可被选择需要实现的 api。
FileChannel 就不是可选择的，Socket 相关的通道都是可选择的
一个通道可以被注册到多个选择器上吗？ 可以的
多个通道可以注册到一个选择器上，但一个通道只能在一个选择器中注册一次</p>
<p>SelectionKey，封装了要监听的事件，连接、接收、读、写。
一方面，Selector 关心通道要处理哪些事件
另一方面，当事件触发时，通道要处理哪些事件</p>
<p>【使用方式】</p>
<p>a、首先通过 open 方法，获取通道，将通道设置为非阻塞的
b、通过 open 方法，获取选择器，将通道注册进选择器中，伴随设置通道要处理的事件(OP_ACCEPT)
c、轮询选择器，当前是否有要处理的操作 select() &gt; 0?
如果有，要获取，待处理操作的集合 Set&lt;SelectionKey&gt; , 进行遍历
遍历到 SelectionKey 时，判断对应哪种操作，不同的操作设置不同的处理方式
如 OP_ACCEPT，接收客户端通道并进行注册，监听后续处理的事件，如 OP_WRITE
如 OP_WRITE，通过 key 的方法获取通道本身，读取数据并继续监听事件，如 OP_READ</p>
<p>​</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4零拷贝">4、零拷贝<a href="#4零拷贝" class="hash-link" aria-label="Direct link to 4、零拷贝" title="Direct link to 4、零拷贝">​</a></h3>
<p>需求：将磁盘中的文件读取出来，通过 socket 发送出去</p>
<p>传统的拷贝方式（4 次）
Socket 网络缓冲区，也属于操作系统的内核缓冲区。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/c4d403fd8d9721f7ae8103ec24ab582b.png" alt="image-20220412192706450" class="img_ev3q"></p>
<p>在操作系统中进行的拷贝（如第二次和第三次），叫做 CPU 拷贝。
连接磁盘或网卡等硬件的拷贝（如第一次和第四次），叫做 DMA 拷贝。</p>
<p>零拷贝的概念：减少 CPU 拷贝的次数。</p>
<p>零拷贝是基于操作系统层面的优化方式（以下基于 Linux 系统）</p>
<p>1） mmap = memory mapping 内存映射</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/47ab101c5b20875673171781b57abd27.png" alt="image-20220412192746768" class="img_ev3q"></p>
<p>2）sendfile (linux2.1 内核支持)</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/e4deb91ce6d01b26260a766d0d8f9b5e.png" alt="image-20220412192758187" class="img_ev3q"></p>
<ol start="3">
<li>sendfile with scatter/gather copy（批量 sendfile）
从单个文件的处理，上升到多个物理地址的处理，提高处理速度</li>
</ol>
<p>4）splice （拼接，在 linux2.6 内核支持）</p>
<p>​ 在操作系统内核缓冲区和 Socket 网络缓冲区之间建立管道，来减少拷贝次数。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/d346c3850ee5f27c4adf435a5a59184d.png" alt="image-20220412192804981" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="线程模型">线程模型<a href="#线程模型" class="hash-link" aria-label="Direct link to 线程模型" title="Direct link to 线程模型">​</a></h3>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/6f0d5f3f4a671dae4341a3dce89b3687.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1-单线程-reactor-模型">1） 单线程 Reactor 模型<a href="#1-单线程-reactor-模型" class="hash-link" aria-label="Direct link to 1） 单线程 Reactor 模型" title="Direct link to 1） 单线程 Reactor 模型">​</a></h5>
<p>顾名思义 就是使用一个线程来处理问题 线程中</p>
<ul>
<li>selector</li>
<li>事件处理 : 连接事件</li>
<li>处理事件：handler</li>
</ul>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<blockquote>
<p>单线程服务器</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ReactorServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerSocketChannel</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ReactorServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 初始化监听器 与 channel 通道</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            selector </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">open</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serverSocketChannel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">open</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 配置为非阻塞的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">configureBlocking</span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 配置通道连接地址 开放 9090 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SocketAddress</span><span class="token plain"> address </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">9090</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">socket</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">bind</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//将channel 注册到 selector监听通道事件  达到多路复用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//首个注册事件一般都是 accept 连接事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">register</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_ACCEPT</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    创建处理连接事件的 acceptor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 同时 创建处理器 接受后序的IO读写事件，不断的遍历 是否有事情发生</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token plain"> acceptor </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//附加一个对象 用来处理事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attach</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">acceptor</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//返回事件的个数 处理事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> num </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">select</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">num </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">continue</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//没有跳过就代表有事件需要处理，拿到事件集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Set</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectedKeys</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Iterator</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> iterator </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">iterator</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">hasNext</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> selectionKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">next</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//拿到事件的第一事情 移出事件 避免重复处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//根据事件类型 分发 给监听器处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//需要处理事情的时候 取出存储的对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//如有接收的时Accpet 事件 获取的就是Acceptor 事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//如果接受的时读写事件 获取的就是 Handler 事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> runnable </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attachment</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    runnable</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Accpetor 连接事件</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerSocketChannel</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerSocketChannel</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">selector </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serverSocketChannel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//接受客户端传入的连接时 Socket Channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> socketChannel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">accept</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//设置异步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            socketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">configureBlocking</span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> socketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">register</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_READ</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 创造处理器 处理连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//单线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//Handler handler = new Handler(key);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//多线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">MultHandler</span><span class="token plain"> handler </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MultHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            handler</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Handler 单线程处理</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Handler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token plain"> state</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Handler</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//处理 读写操作，判断读写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">READ</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/*轮流处理末尾添加事件达到循环处理*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//处理 读方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token plain"> buffer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">allocate</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//    通过通道获取KEY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//将传入的数据写入到buffer中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> num </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    转化成String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> msg </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">array</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    增加业务处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    继续处理注册写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interestOps</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_WRITE</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//处理 写方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token plain"> buffer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">wrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;hello&quot;</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    通过通道获取KEY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    继续处理注册写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interestOps</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_READ</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//记录状态 非读即写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">enum</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//读写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2多线程-reactor-模型">2）多线程 Reactor 模型<a href="#2多线程-reactor-模型" class="hash-link" aria-label="Direct link to 2）多线程 Reactor 模型" title="Direct link to 2）多线程 Reactor 模型">​</a></h5>
<p>提高 handler 的处理效率，首先 handler 不再负责具体的业务逻辑，当读取出数据后，分发给子线程处理，子线程处理完成后再将结果返回给 handler，handler 再将结果返回给客户端。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16-1680866877502990.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<blockquote>
<p>多线程处理 （handler 使用线程池）</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MultHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token plain"> state</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ExecutorService</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MultHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//处理 读写操作，判断读写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">READ</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//将最耗时的操作 放入线程池执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                pool</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">execute</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/*轮流处理末尾添加事件达到循环处理*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//处理 读方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token plain"> buffer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">allocate</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//    通过通道获取KEY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//将传入的数据写入到buffer中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> num </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">read</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    转化成String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> msg </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">array</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    增加业务处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    继续处理注册写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interestOps</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_WRITE</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//处理 写方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token plain"> buffer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuffer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">wrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;hello&quot;</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    通过通道获取KEY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    继续处理注册写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interestOps</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_READ</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">state </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//记录状态 非读即写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">enum</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">State</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//读写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token constant" style="color:#0f172a">READ</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">WRITE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3主从-reactor-模型">3）主从 Reactor 模型<a href="#3主从-reactor-模型" class="hash-link" aria-label="Direct link to 3）主从 Reactor 模型" title="Direct link to 3）主从 Reactor 模型">​</a></h5>
<p>mainReactor 用来接收连接事件，然后分发给 acceptor，acceptor 在处理过程中，直接将后续的读写事件，注册到 slaveReactor 之中，以此来达到分流。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/49645d17e759824fa2862d2c7b0778c2.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<blockquote>
<p>主从监听器</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">//主从模型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MultReactorServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> mainselector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> slaveselector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerSocketChannel</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MultReactorServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 主 reactor 处理连接事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            mainselector </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">open</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//从reactor 处理读写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            slaveselector </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">open</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 配置为非阻塞的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">configureBlocking</span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 配置通道连接地址 开放 9090 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SocketAddress</span><span class="token plain"> address </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">9090</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">socket</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">bind</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//将channel 注册到 selector监听通道事件  达到多路复用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//首个注册事件一般都是 accept 连接事件 （参数变化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">register</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">mainselector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OP_ACCEPT</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    创建处理连接事件的 acceptor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 同时 创建处理器 接受后序的IO读写事件，不断的遍历 是否有事情发生 （参数变化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token plain"> acceptor </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Acceptor</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">slaveselector</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serverSocketChannel</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//附加一个对象 用来处理事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attach</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">acceptor</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//主从监听逻辑分离</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HandlerLoop</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">slaveselector</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//返回事件的个数 处理事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> num </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> mainselector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">select</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">num </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">continue</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//没有跳过就代表有事件需要处理，拿到事件集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Set</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> mainselector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectedKeys</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Iterator</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> iterator </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">iterator</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">hasNext</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> selectionKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">next</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//拿到事件的第一事情 移出事件 避免重复处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//根据事件类型 分发 给监听器处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//需要处理事情的时候 取出存储的对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//只处理主Reactor 只处理连接事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> runnable </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> key</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attachment</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    runnable</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>主从事件处理读写分离</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">//用于处理从reactor事件监听</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HandlerLoop</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HandlerLoop</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Selector</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">selector </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//返回事件的个数 处理事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> num </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">select</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">num </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">continue</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//没有跳过就代表有事件需要处理，拿到事件集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Set</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectedKeys</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Iterator</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SelectionKey</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> iterator </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SKeyset</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">iterator</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">hasNext</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">SelectionKey</span><span class="token plain"> selectionKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">next</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//拿到事件的第一事情 移出事件 避免重复处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    iterator</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//根据事件类型 分发 给监听器处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//需要处理事情的时候 取出存储的对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//只处理从reactor 所以 接受的一定是读写事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token plain"> runnable </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Runnable</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> selectionKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attachment</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    runnable</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">run</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-应用篇">（二） 应用篇<a href="#二-应用篇" class="hash-link" aria-label="Direct link to （二） 应用篇" title="Direct link to （二） 应用篇">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1http">1、HTTP<a href="#1http" class="hash-link" aria-label="Direct link to 1、HTTP" title="Direct link to 1、HTTP">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-09-版本">1) 0.9 版本<a href="#1-09-版本" class="hash-link" aria-label="Direct link to 1) 0.9 版本" title="Direct link to 1) 0.9 版本">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">GET /index.html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>服务端只能返回 html 格式，传输过程只能处理文字。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-10-版本">2) 1.0 版本<a href="#2-10-版本" class="hash-link" aria-label="Direct link to 2) 1.0 版本" title="Direct link to 2) 1.0 版本">​</a></h4>
<p>支持任何格式的内容，包括图像、视频、二进制等等</p>
<p>引入了 POST 命令、HEAD 命令</p>
<p>增加了请求头、状态码，以及权限、缓存等</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">GET / HTTP/1.0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">User-Agent:Mozilla/1.0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Accept: */*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">HTTP/1.0 200 OK</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Type: text/plain</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Encoding: gzip</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  &lt;body&gt; hello world &lt;/body&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>a、 Content-Type</p>
<p>服务端通知客户端，当前数据的格式</p>
<p>示例： text/html 、 image/png 、 application/pdf 、 video/mp4</p>
<p>前面是一级类型，后面是二级类型，用斜杠分隔； 还可以增加其他参数，如编码格式。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Type: text/plain; charset=utf-8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>b、Content-Encoding</p>
<p>表示数据压缩的方式，gzip、compress、deflate</p>
<p>对应客户端的字段为 Accept-Encoding，代表接收哪些压缩方式</p>
<p>c、缺点和问题</p>
<p>每个 TCP 连接只能发送一个请求，发送完毕连接关闭，使用成本很高，性能较差。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">Connection: keep-alive   - 非标准字段</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-11-版本">3) 1.1 版本<a href="#3-11-版本" class="hash-link" aria-label="Direct link to 3) 1.1 版本" title="Direct link to 3) 1.1 版本">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">User-Agent: PostmanRuntime/7.24.1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Accept: */*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Cache-Control: no-cache</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Postman-Token: 636ce8a6-7eab-451a-8638-4534a3578095</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Host: cn.bing.com</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Accept-Encoding: gzip, deflate, br</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Connection: keep-alive</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Cache-Control: private, max-age=0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Length: 45786</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Type: text/html; charset=utf-8</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Content-Encoding: br</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Vary: Accept-Encoding</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">P3P: CP=&quot;NON UNI COM NAV STA LOC CURa DEVa PSAa PSDa OUR IND&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: SRCHD=AF=NOFORM; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: SRCHUID=V=2&amp;GUID=5C28FF778A2C4A00B32F5408147038BF&amp;dmnchg=1; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: SRCHUSR=DOB=20200622; domain=.bing.com; expires=Wed, 22-Jun-2022 07:03:23 GMT; path=/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: _SS=SID=23AE726877396796143D7C99761766C7; domain=.bing.com; path=/</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: _EDGE_S=F=1&amp;SID=23AE726877396796143D7C99761766C7; path=/; httponly; domain=bing.com</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: _EDGE_V=1; path=/; httponly; expires=Sat, 17-Jul-2021 07:03:23 GMT; domain=bing.com</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: MUID=1CB3B15BCBD2637E2C01BFAACAFC6214; samesite=none; path=/; secure; expires=Sat, 17-Jul-2021 07:03:23 GMT; domain=bing.com</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Set-Cookie: MUIDB=1CB3B15BCBD2637E2C01BFAACAFC6214; path=/; httponly; expires=Sat, 17-Jul-2021 07:03:23 GMT</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">X-MSEdge-Ref: Ref A: 71D6F4B3BA9C448EB453341AC182C7BC Ref B: BJ1EDGE0311 Ref C: 2020-06-22T07:03:23Z</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Date: Mon, 22 Jun 2020 07:03:23 GMT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>a、持久连接，含义为默认不关闭 tcp 连接，可以被多个请求复用。大多时候，浏览器对同一个域名，允许同时建立 6 个连接。</p>
<p>b、管道机制，支持客户端发送多个请求，管理请求的顺序的。服务器还是按照接受请求的顺序，返回对应的响应结果。</p>
<p>c、Content-Length, 用来区分数据包的重要字段</p>
<p>d、支持 PUT、DELETE、PATCH 等命令</p>
<p>缺点和问题</p>
<p>当部分请求耗时较长时，仍会阻塞后续请求的处理速度，这种现象叫做“队头阻塞”/&quot;线头阻塞&quot;。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-20-版本">4) 2.0 版本<a href="#4-20-版本" class="hash-link" aria-label="Direct link to 4) 2.0 版本" title="Direct link to 4) 2.0 版本">​</a></h4>
<p>解决队头阻塞的问题，使用的是多路复用的方式。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="说了这么多-上代码来操作一下吧">说了这么多 上代码来操作一下吧！！<a href="#说了这么多-上代码来操作一下吧" class="hash-link" aria-label="Direct link to 说了这么多 上代码来操作一下吧！！" title="Direct link to 说了这么多 上代码来操作一下吧！！">​</a></h2>
<p>我们的编写思路是这样的</p>
<ul>
<li>编写初始化服务端</li>
<li>编写自定义初始化器 和 自定义处理器</li>
<li>启动 postman 查看我们设置的 http 的响应结果</li>
</ul>
<p>我们这里有三个类</p>
<ul>
<li>HttpServer 初始化服务端</li>
<li>MyHttpHandler 自定义处理器</li>
<li>MyHttpInitializer 自定义初始化</li>
</ul>
<p>首先是 server</p>
<blockquote>
<p>我们需要在初始化服务端的时候 设置主从线程模型（Netty 中常用）
设置 启动参数 和阻塞队列的长度等设置
设置 初始化</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//可以自定义线程的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token plain"> bossGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 默认创建的线程数量 = CPU 处理器数量 *2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token plain"> workerGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token plain"> serverBootstrap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bossGroup</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> workerGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioServerSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">handler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoggingHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当前连接被阻塞的时候，BACKLOG代表的事 阻塞队列的长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">option</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelOption</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SO_BACKLOG</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">128</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//设置连接保持为活动状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">childOption</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelOption</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SO_KEEPALIVE</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">childHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyHttpInitializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//设置为异步启动 异步 关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">bind</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">9988</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">closeFuture</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">       		</span><span class="token comment" style="color:#6A9955">//netty的优雅关闭 指 等一切执行完毕之后 慢慢的关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            bossGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            workerGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编写 初始化</p>
<blockquote>
<p>继承 ChannelInitializer 泛型为 Channel，用来进行设置出站解码器和入站编码器
使用 codec netty 封装好的解码器，这样我们就不用每次定义 解码和编码</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyHttpInitializer</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Channel</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initChannel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token plain"> pipeline </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//先对应请求解码，后对响应解码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//pipeline.addLast(&quot;decoder&quot;, new HttpRequestDecoder());</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//pipeline.addLast(&quot;encoder&quot;, new HttpRequestEncoder());</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//当然每次我们都要解码编码很麻烦，netty也有为我们提供对应的解决方案，建议直接使用这个 不会出错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;codec&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpServerCodec</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//压缩数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;compressor&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpContentCompressor</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//聚合完整的信息 参数代表可以处理的最大值 此时的是 512 kb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;aggregator&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpObjectAggregator</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">512</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyHttpHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有了初始化，我们还需要一个做事的 那就是 处理器 Handler</p>
<blockquote>
<p>netty 帮我们封装了返回完整 http 响应的类 DefaultFullHttpResponse
我们只需要在读取的时候 设置协议，状态码和响应信息，
配置响应头的类型和长度 就可以完成对请求的响应</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 泛型需要设置为 FullHttpRequest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 筛选 message 为此类型的消息才处理</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyHttpHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">FullHttpRequest</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelRead0</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">FullHttpRequest</span><span class="token plain"> fullHttpRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//DefaultFullHttpResponse 是一个默认的完整的http响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">DefaultFullHttpResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">DefaultFullHttpResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">HttpVersion</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">HTTP_1_1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpResponseStatus</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">OK</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Unpooled</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">wrappedBuffer</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;hello http netty demo&quot;</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//    我们还需要设置响应头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 设置请求 响应头字段 可以使用 HttpHeaderNmaes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 设置字段时 可以使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">HttpHeaders</span><span class="token plain"> headers </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">headers</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        headers</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">HttpHeaderNames</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">CONTENT_TYPE</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpHeaderValues</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">TEXT_PLAIN</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;;charset=UTF-8&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        headers</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">HttpHeaderNames</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">CONTENT_LENGTH</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">content</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">readableBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">write</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelReadComplete</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">flush</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动结果
<img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/bc10e04520bbb6205e88e6f797bcfca3.png" alt="在这里插入图片描述" class="img_ev3q">
<strong>postman</strong> 差看到的请求响应 参数
可以看到我们设置的 http1.1 协议
类型 text/plain 长度 47
响应给客户端的 内容 <code> hello http netty demo</code></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结<a href="#小结" class="hash-link" aria-label="Direct link to 小结" title="Direct link to 小结">​</a></h3>
<ol>
<li>了解 http 各个版本的解决了什么问题，优缺点，优劣性</li>
<li>手动编写一个服务端的响应，用 postman 查看响应头我们设置的内容</li>
<li>体验到 netty 强大的封装带给我们的便利性</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2websocket">2、WebSocket<a href="#2websocket" class="hash-link" aria-label="Direct link to 2、WebSocket" title="Direct link to 2、WebSocket">​</a></h3>
<p>websocket 是由浏览器发起的</p>
<p>协议标识符 <a href="http://127.0.0.1:8080" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8080</a> ws://127.0.0.1:7777</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">GET ws://127.0.0.1:7777 HTTP/1.1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Host: 127.0.0.1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Upgrade: websocket    # 升级为ws</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Connection: Upgrade   # 此链接需要升级</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Sec-WebSocket-key: client-random-string ...  # 标识加密相关信息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">HTTP/1.1 101</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Upgrade: websocket</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">Connection: Upgrade</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>响应码 101 代表本次协议需要更改为 websocket</p>
<p>连接建立后，支持文本信息及二进制信息。</p>
<p>Websocket 实现的原理：
通过 http 协议进行连接的建立（握手和回答），建立连接后不再使用 http，而 tcp 自身是支持双向通信的，所以能达到“全双工”的效果。</p>
<p>通信使用的单位叫帧 frame
客户端：发送时将消息切割成多个帧
服务端：接收时，将关联的帧重新组装</p>
<p>【客户端】</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">var ws = new WebSocket(&quot;ws://127.0.0.1:7777/hello&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">ws.onopen = function(ev){</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     ws.send(&quot;hello&quot;); //建立连接后发送数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设计一个样式
左右两个各有一个文本框，中间放一个发送按钮。
左侧文本框用来发送数据，右侧文本框用来显示数据。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="websocket-应用-demo">Websocket 应用 demo<a href="#websocket-应用-demo" class="hash-link" aria-label="Direct link to Websocket 应用 demo" title="Direct link to Websocket 应用 demo">​</a></h4>
<blockquote>
<p>服务端代码</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//可以自定义线程的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token plain"> bossGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 默认创建的线程数量 = CPU 处理器数量 *2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token plain"> workerGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token plain"> serverBootstrap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bossGroup</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> workerGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioServerSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">handler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoggingHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当前连接被阻塞的时候，BACKLOG代表的事 阻塞队列的长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">option</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelOption</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SO_BACKLOG</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">128</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//设置连接保持为活动状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">childOption</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelOption</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SO_KEEPALIVE</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">childHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketInitialzer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">bind</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">7777</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">closeFuture</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            bossGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            workerGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>服务端初始化器</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketInitialzer</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Channel</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initChannel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token plain"> pipeline </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//增加编解码器 的另一种方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpServerCodec</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//    块方式写的处理器 适合处理大数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChunkedWriteHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//聚合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HttpObjectAggregator</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">512</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 这个时候 我们需要声明我们使用的是 websocket 协议</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * netty为websocket也准备了对应处理器  设置的是访问路径</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 这个时候我们只需要访问 ws://127.0.0.1:7777/hello 就可以了</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 这个handler是将http协议升级为websocket  并且使用 101 作为响应码</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketServerProtocolHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;/hello&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>服务端处理器</p>
</blockquote>
<p>通信使用的单位叫帧 frame
客户端：发送时将消息切割成多个帧
服务端：接收时，将关联的帧重新组装</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 泛型 代表的是处理数据的单位</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * TextWebSocketFrame : 文本信息帧</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">WebSocketHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">TextWebSocketFrame</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelRead0</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TextWebSocketFrame</span><span class="token plain"> textWebSocketFrame</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//可以直接调用text 拿到文本信息帧中的信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;msg:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> textWebSocketFrame</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">text</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//我们可以使用新建一个对象 将服务端需要返回的信息放入其中 返回即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">TextWebSocketFrame</span><span class="token plain"> resp </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TextWebSocketFrame</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;hello client from websocket server&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>websocket 前端编写</p>
</blockquote>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token doctype punctuation" style="color:#475569">&lt;!</span><span class="token doctype doctype-tag">DOCTYPE</span><span class="token doctype"> </span><span class="token doctype name">html</span><span class="token doctype punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">html</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag attr-name" style="color:#0c4a6e">lang</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">en</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">head</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">meta</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag attr-name" style="color:#0c4a6e">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">UTF-8</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag punctuation" style="color:#475569">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">title</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">Title</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">title</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">head</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">body</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">script</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#0c4a6e">var</span><span class="token script language-javascript"> socket</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript comment" style="color:#6A9955">//    判断当前浏览器是否支持websocket</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">if</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript operator" style="color:#475569">!</span><span class="token script language-javascript dom variable" style="color:#0c4a6e">window</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access maybe-class-name">WebSocket</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript function" style="color:#0e7490">alert</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;不支持websocket&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">else</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript operator" style="color:#475569">&lt;</span><span class="token script language-javascript operator" style="color:#475569">!</span><span class="token script language-javascript operator" style="color:#475569">--</span><span class="token script language-javascript"> 创建websocket 连接对象</span><span class="token script language-javascript operator" style="color:#475569">--</span><span class="token script language-javascript operator" style="color:#475569">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        socket </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#0c4a6e">new</span><span class="token script language-javascript"> </span><span class="token script language-javascript class-name" style="color:#0ea5e9">WebSocket</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;ws://127.0.0.1:7777/hello&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript comment" style="color:#6A9955">//设置开始连接的方法</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        socket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#0e7490">onopen</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#0c4a6e">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript parameter">ev</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          </span><span class="token script language-javascript keyword" style="color:#0c4a6e">var</span><span class="token script language-javascript"> tmp </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#0c4a6e">document</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method function property-access" style="color:#0e7490">getElementById</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;respText&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          tmp</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">value</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#64748b">&quot;连接已经开启&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript comment" style="color:#6A9955">//设置关闭连接的方法</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        socket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#0e7490">onclose</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#0c4a6e">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript parameter">ev</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          </span><span class="token script language-javascript keyword" style="color:#0c4a6e">var</span><span class="token script language-javascript"> tmp </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#0c4a6e">document</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method function property-access" style="color:#0e7490">getElementById</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;respText&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          tmp</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">value</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> tmp</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">value</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#64748b">&quot;\n&quot;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#64748b">&quot;连接已经关闭&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript comment" style="color:#6A9955">//设置接收数据的方法</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        socket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#0e7490">onmessage</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#0c4a6e">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript parameter">ev</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          </span><span class="token script language-javascript keyword" style="color:#0c4a6e">var</span><span class="token script language-javascript"> tmp </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#0c4a6e">document</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method function property-access" style="color:#0e7490">getElementById</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;respText&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          tmp</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">value</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">=</span><span class="token script language-javascript"> tmp</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">value</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#64748b">&quot;\n&quot;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">+</span><span class="token script language-javascript"> ev</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">data</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#0c4a6e">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#0e7490">send</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript parameter">message</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">if</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript operator" style="color:#475569">!</span><span class="token script language-javascript dom variable" style="color:#0c4a6e">window</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">socket</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">return</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript comment" style="color:#6A9955">         * 判断socket的状态</span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript comment" style="color:#6A9955">         * connecting 正在连接 closing 正在关闭</span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript comment" style="color:#6A9955">         * closed 已经关闭或打开连接失败</span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript comment" style="color:#6A9955">         * open 连接可以 已经正常通信</span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript comment" style="color:#6A9955">         * */</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">if</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript">socket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript property-access">readyState</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#475569">==</span><span class="token script language-javascript"> </span><span class="token script language-javascript maybe-class-name">WebSocket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript constant" style="color:#0f172a">OPEN</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          socket</span><span class="token script language-javascript punctuation" style="color:#475569">.</span><span class="token script language-javascript method function property-access" style="color:#0e7490">send</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript">message</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword control-flow" style="color:#0c4a6e">else</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#475569">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">          </span><span class="token script language-javascript function" style="color:#0e7490">alert</span><span class="token script language-javascript punctuation" style="color:#475569">(</span><span class="token script language-javascript string" style="color:#64748b">&quot;连接未开启&quot;</span><span class="token script language-javascript punctuation" style="color:#475569">)</span><span class="token script language-javascript punctuation" style="color:#475569">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:#475569">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">script</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">&lt;!--防止表单自动提交--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">form</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag special-attr attr-name" style="color:#0c4a6e">onsubmit</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript keyword control-flow" style="color:#0c4a6e">return</span><span class="token tag special-attr attr-value value javascript language-javascript" style="color:#64748b"> </span><span class="token tag special-attr attr-value value javascript language-javascript boolean" style="color:#64748b">false</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">textarea</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag attr-name" style="color:#0c4a6e">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">message</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag special-attr attr-name" style="color:#0c4a6e">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#64748b">height</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#64748b"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#B5CEA8">400</span><span class="token tag special-attr attr-value value css language-css unit" style="color:#64748b">px</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#64748b">width</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#64748b"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#B5CEA8">400</span><span class="token tag special-attr attr-value value css language-css unit" style="color:#64748b">px</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">textarea</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">input</span><span class="token tag" style="color:#0ea5e9"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token tag" style="color:#0ea5e9">        </span><span class="token tag attr-name" style="color:#0c4a6e">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">button</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token tag" style="color:#0ea5e9">        </span><span class="token tag attr-name" style="color:#0c4a6e">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">发送</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token tag" style="color:#0ea5e9">        </span><span class="token tag special-attr attr-name" style="color:#0c4a6e">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#0e7490">send</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#475569">(</span><span class="token tag special-attr attr-value value javascript language-javascript keyword" style="color:#0c4a6e">this</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#475569">.</span><span class="token tag special-attr attr-value value javascript language-javascript property-access" style="color:#64748b">form</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#475569">.</span><span class="token tag special-attr attr-value value javascript language-javascript property-access" style="color:#64748b">message</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#475569">.</span><span class="token tag special-attr attr-value value javascript language-javascript property-access" style="color:#64748b">value</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#475569">)</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token tag" style="color:#0ea5e9">      </span><span class="token tag punctuation" style="color:#475569">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">textarea</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag attr-name" style="color:#0c4a6e">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag attr-value" style="color:#64748b">respText</span><span class="token tag attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag" style="color:#0ea5e9"> </span><span class="token tag special-attr attr-name" style="color:#0c4a6e">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#475569">=</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#64748b">height</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#64748b"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#B5CEA8">400</span><span class="token tag special-attr attr-value value css language-css unit" style="color:#64748b">px</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#64748b">width</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#475569">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#64748b"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#B5CEA8">400</span><span class="token tag special-attr attr-value value css language-css unit" style="color:#64748b">px</span><span class="token tag special-attr attr-value punctuation" style="color:#475569">&quot;</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">textarea</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">form</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">body</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">html</span><span class="token tag punctuation" style="color:#475569">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>【客户端】</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">var ws = new WebSocket(&quot;ws://127.0.0.1:7777/hello&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">ws.onopen = function(ev){</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     ws.send(&quot;hello&quot;); //建立连接后发送数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设计一个样式
左右两个各有一个文本框，中间放一个发送按钮。
左侧文本框用来发送数据，右侧文本框用来显示数据。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="演示效果">演示效果<a href="#演示效果" class="hash-link" aria-label="Direct link to 演示效果" title="Direct link to 演示效果">​</a></h4>
<p>启动服务发送消息</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Ya3546v5riK,size_20,color_FFFFFF,t_70,g_se,x_16-1680866877502991.png" alt="" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/73697353609c4303b36088f42703246c.png" alt="" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="小结-1">小结<a href="#小结-1" class="hash-link" aria-label="Direct link to 小结" title="Direct link to 小结">​</a></h4>
<ol>
<li>websocket 一般用于做可复用连接，http 一般做短链接</li>
<li>websocket 解决了 http 连接只能客户端发起的</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三原理篇">（三）原理篇<a href="#三原理篇" class="hash-link" aria-label="Direct link to （三）原理篇" title="Direct link to （三）原理篇">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1bytebuf">1、ByteBuf<a href="#1bytebuf" class="hash-link" aria-label="Direct link to 1、ByteBuf" title="Direct link to 1、ByteBuf">​</a></h3>
<p>NIO 中 ByteBuffer 的缺点：</p>
<p>A 长度固定，无法动态的扩容和缩容，缺乏灵活性
B 使用一个 position 记录读写的索引位置，在读写模式切换时需手动调用 flip 方法，增加了使用的复杂度。
C 功能有限，使用过程中往往需要自行封装</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1分类">1）分类<a href="#1分类" class="hash-link" aria-label="Direct link to 1）分类" title="Direct link to 1）分类">​</a></h4>
<p>按照内存的位置，分为堆内存缓冲区 heap buffer、直接内存缓冲区 direct buffer、复合内存缓冲区 composite buffer。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-heap-buffer">A heap buffer<a href="#a-heap-buffer" class="hash-link" aria-label="Direct link to A heap buffer" title="Direct link to A heap buffer">​</a></h5>
<p>将数据存储到 JVM 的堆空间中，实际使用字节数组 byte[]来存放。
优点：数据可以快速的创建和释放，并且能够直接访问内部数组
缺点：在读写数据时，需要将数据复制到直接缓冲区 再进行网络传输。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="b-direct-buffer">B direct buffer<a href="#b-direct-buffer" class="hash-link" aria-label="Direct link to B direct buffer" title="Direct link to B direct buffer">​</a></h5>
<p>不在堆中，而是使用了操作系统的本地内存。
优点：在使用 Socket 进行数据传输过程中，减少一次拷贝，性能更高。
缺点：释放和分配的空间更昂贵，使用时需要更谨慎。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="c-composite-buffer">C composite buffer<a href="#c-composite-buffer" class="hash-link" aria-label="Direct link to C composite buffer" title="Direct link to C composite buffer">​</a></h5>
<p>将两个或多个不同内存的缓冲区合并
优点：可以统一进行操作</p>
<p>应用场景：在通信线程使用缓冲区时，往往使用 direct buffer，而业务消息使用缓冲区时，往往使用 heap buffer，在解决 http 包，请求头+请求体特性不同而选择不同位置存储时，可以将两者拼接使用</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="d-池化的概念">D 池化的概念<a href="#d-池化的概念" class="hash-link" aria-label="Direct link to D 池化的概念" title="Direct link to D 池化的概念">​</a></h5>
<p>对于内存空间分配和释放的复杂度和效率，netty 通过内存池的方式来解决。
内存池，可以循环利用 ByteBuf，提高使用率。但是管理和维护较复杂。</p>
<p>Unpooled 正是非池化缓冲区的工具类。</p>
<p>主要区别在于，池化的内存由 netty 管理，非池化的内存由 GC 回收。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="e-回收方式">E 回收方式<a href="#e-回收方式" class="hash-link" aria-label="Direct link to E 回收方式" title="Direct link to E 回收方式">​</a></h5>
<p>回收方式为引用计数，具体规则为，通过记录被引用的次数，判断当前对象是否还会被使用。
当对象被调用时，引用计为+1，当对象被释放时，引用计为-1，当引用次数为 0 时，对象可以回收。</p>
<p>弊端：可能引发内存泄漏。
当对象不可达，JVM 会通过 GC 回收掉，但此时引用计数可能不为 0，对象无法归还内存池，会导致内存泄漏。netty 只能通过对内存缓冲区进行采样，来检查。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2工作原理">2）工作原理<a href="#2工作原理" class="hash-link" aria-label="Direct link to 2）工作原理" title="Direct link to 2）工作原理">​</a></h4>
<p>和 ByteBuffer 不同在于，增加了一个指针，通过两个指针记录读模式和写模式时的索引位置，读指针叫做 readerIndex，写指针叫做 writerIndex。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-读写分离">A 读写分离<a href="#a-读写分离" class="hash-link" aria-label="Direct link to A 读写分离" title="Direct link to A 读写分离">​</a></h5>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/6147397fff9f9fc0425da347e70e1737.png" alt="image-20220412193227329" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/ca02afab8b8f53a2aa107eb22e060b63.png" alt="image-20220412193237587" class="img_ev3q"></p>
<p>当执行 clear()方法时，索引位置清空回初始位置，但数据保持不变。</p>
<p>mark 和 reset 方法在 ByteBuf 中同样适用，如 markReaderIndex 和 resetReaderIndex。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="b-深浅拷贝">B 深浅拷贝<a href="#b-深浅拷贝" class="hash-link" aria-label="Direct link to B 深浅拷贝" title="Direct link to B 深浅拷贝">​</a></h5>
<p>浅拷贝，拷贝的是对对象的引用，并没有创建新对象，新对象和原对象之间互相影响。
深拷贝，拷贝的是整个对象，和原对象之间完全独立。</p>
<p>duplicate 和 slice 方法，达成全部浅拷贝和部分浅拷贝。
copy，部分深拷贝，部分代表的是可读空间。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3扩容机制">3）扩容机制<a href="#3扩容机制" class="hash-link" aria-label="Direct link to 3）扩容机制" title="Direct link to 3）扩容机制">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-bytebuffer-的存储">A ByteBuffer 的存储<a href="#a-bytebuffer-的存储" class="hash-link" aria-label="Direct link to A ByteBuffer 的存储" title="Direct link to A ByteBuffer 的存储">​</a></h5>
<p>ByteBuffer 在 put 数据时，会校验剩余空间是否不足，如果不足，会抛出异常。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">ByteBuffer buffer = ByteBuffer.allocate(8);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">buffer.put(&quot;yu&quot;.getBytes());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public final ByteBuffer put(byte[] src) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return put(src, 0, src.length);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 额外接收偏移量（存储数据的起始位置）  和数据长度</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ByteBuffer put(byte[] src, int offset, int length) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 校验参数的有效性</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        checkBounds(offset, length, src.length);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果要存储数据的长度 &gt; 剩余可用空间  抛出buffer越界的异常</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (length &gt; remaining())</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            throw new BufferOverflowException();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果剩余空间足够  计算存储的结束位置 = 偏移量 + 数据长度</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        int end = offset + length;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (int i = offset; i &lt; end; i++)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            this.put(src[i]);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果要手动对 ByteBuffer 扩容，可以在 put 之前，先校验剩余空间是否足够，如果不足够，创建一个新的 ByteBuffer，新的容量确保足够，旧的 buffer 数据拷贝到新的 buffer 中，然后继续存储数据。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="b-bytebuf-的存储和扩容">B ByteBuf 的存储和扩容<a href="#b-bytebuf-的存储和扩容" class="hash-link" aria-label="Direct link to B ByteBuf 的存储和扩容" title="Direct link to B ByteBuf 的存储和扩容">​</a></h5>
<p>当写数据时，先判断是否需要扩容，如果当前空间较小（&lt;4M），以 64 作为基数倍增（10 -&gt; 64 -&gt; 128 -&gt; 256）, 如果当前空间较大（&gt;4M）, 每次扩容都增加 4M，这种方式叫做&quot;步进式&quot;。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">查看源码，以AbstractByteBuf子类为依据查看，最重要的子类之一，ByteBuf的公共属性和功能都在此中实现。</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">ByteBuf buf = Unpooled.buffer(10);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">System.out.println(&quot;capacity: &quot; + buf.capacity());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">for (int i = 0; i &lt; 11; i++) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    buf.writeByte(i);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[ByteBuf类]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public abstract ByteBuf writeByte(int value);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">按住Ctrl+Alt快捷键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[AbstractByteBuf子类]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ByteBuf writeByte(int value) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 确保可写空间足够</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ensureWritable0(1);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 写入数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        _setByte(writerIndex++, value);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 参数为 最小写入数据的大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    final void ensureWritable0(int minWritableBytes) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final int writerIndex = writerIndex();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 目标容量 = 当前写操作索引 + 最小写入数据大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final int targetCapacity = writerIndex + minWritableBytes;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 容量足够  不需扩容</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (targetCapacity &lt;= capacity()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ensureAccessible();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 容量不足时 如果目标容量 超出最大容量  抛出异常</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (checkBounds &amp;&amp; targetCapacity &gt; maxCapacity) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ensureAccessible();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            throw new IndexOutOfBoundsException(String.format(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    writerIndex, minWritableBytes, maxCapacity, this));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		// 扩容逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 获取可写空间大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final int fastWritable = maxFastWritableBytes();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果 可写空间 &gt;= 所需空间   新的容量=写操作索引+可写空间大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果 可写空间 &lt; 所需空间   计算要扩容的新容量大小 calculateNewCapacity方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        int newCapacity = fastWritable &gt;= minWritableBytes ? writerIndex + fastWritable</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                : alloc().calculateNewCapacity(targetCapacity, maxCapacity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // Adjust to the new capacity.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 计算完成后 生成新的ByteBuffer</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        capacity(newCapacity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 获取可写空间大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public int maxFastWritableBytes() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return writableBytes();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[AbstractByteBufAllocator子类]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 计算要扩容的新容量大小</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public int calculateNewCapacity(int minNewCapacity, int maxCapacity) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 校验参数有效性</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        checkPositiveOrZero(minNewCapacity, &quot;minNewCapacity&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (minNewCapacity &gt; maxCapacity) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            throw new IllegalArgumentException(String.format(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;minNewCapacity: %d (expected: not greater than maxCapacity(%d)&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    minNewCapacity, maxCapacity));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 扩容方式的分界点 以4M大小为界</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final int threshold = CALCULATE_THRESHOLD; // 4 MiB page</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (minNewCapacity == threshold) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return threshold;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // If over threshold, do not double but just increase by threshold.、</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果所需容量大于4M  按照步进的方式扩容</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        //   举例： 比如 minNewCapacity = 5M</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (minNewCapacity &gt; threshold) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // newCapacity = 5 / 4 * 4 = 4M  确保是4的倍数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            int newCapacity = minNewCapacity / threshold * threshold;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (newCapacity &gt; maxCapacity - threshold) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                newCapacity = maxCapacity;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // newCapacity = 4 + 4 = 8M;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                newCapacity += threshold;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return newCapacity;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // Not over threshold. Double up to 4 MiB, starting from 64.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果所需容量大于4M  按照64的倍数扩容  找到最接近所需容量的64的倍数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        int newCapacity = 64;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        while (newCapacity &lt; minNewCapacity) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            newCapacity &lt;&lt;= 1;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 保障在最大可接受容量范围内</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return Math.min(newCapacity, maxCapacity);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4优势">4）优势<a href="#4优势" class="hash-link" aria-label="Direct link to 4）优势" title="Direct link to 4）优势">​</a></h4>
<p>A 池化的方式提高内存使用率</p>
<p>B 提出了复合型缓冲区的整合方案</p>
<p>C 增加了索引，使读写分离，使用更便捷</p>
<p>D 解决了 ByteBuffer 长度固定的问题，增加了扩容机制</p>
<p>E 用引用计数的方式进行对象回收</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2channel">2、Channel<a href="#2channel" class="hash-link" aria-label="Direct link to 2、Channel" title="Direct link to 2、Channel">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1channel">1）Channel<a href="#1channel" class="hash-link" aria-label="Direct link to 1）Channel" title="Direct link to 1）Channel">​</a></h4>
<p>channel 是通讯的载体，对应通讯的一端，在 BIO 中对应 Socket，NIO 中对应 SocketChannel，Netty 中对应 NioSocketChannel，ServerSocket 同理。
channelhandler 是通道的处理器，一个 channel 往往有多个 handler
channelpipeline 是 handler 的容器，装载并管理 handler 的顺序（本质是双向链表）</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/90201ec5a9bf88239a9ade0522deae73.png" alt="image-20220412193249568" class="img_ev3q"></p>
<p>如图，channel 创建时，会对应创建一个 channelpipeline，pipeline 首先会记录一个头部的处理器 handler，当 pipeline 进行分发时，先分发给头部，然后依次执行，执行 handler 全部执行完成。</p>
<p>同时，channel 创建后，会注册进 EventLoop 之中，EventLoop 会监听事件的发生。不同的事件调用 handler 不同的处理方法，让流程运转起来。</p>
<p>channel 生命周期，对应四种状态，分别为：
A) ChannelUnregistered 已创建但还未被注册到监听器中
B) ChannelRegistered 已注册到监听器 EventLoop 中
C) ChannelActive 连接完成处于活跃状态，此时可以接收和发送数据
D) ChannelInactive 非活跃状态，代表连接未建立或者已断开</p>
<p>channelhandler 生命周期，对应三种状态，分别为：
A) handlerAdded 把 handler 添加到 pipeline 之中
B) handlerRemoved 从 pipeline 中移除
C) exceptionCaught 在处理过程中有错误产生</p>
<p>创建 channel 源码分析</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">以服务端启动为例</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">ChannelFuture future = serverBootstrap.bind(8888).sync();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">参数设置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">serverBootstrap.channel(NioServerSocketChannel.class)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">【AbstractBootstrap】 启动对象的父类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture bind(int inetPort) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return bind(new InetSocketAddress(inetPort));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture bind(SocketAddress localAddress) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        validate();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return doBind(ObjectUtil.checkNotNull(localAddress, &quot;localAddress&quot;));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private ChannelFuture doBind(final SocketAddress localAddress) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final ChannelFuture regFuture = initAndRegister();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final Channel channel = regFuture.channel();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        .......</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    final ChannelFuture initAndRegister() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Channel channel = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channel = channelFactory.newChannel();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            init(channel);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        .......</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> 【ReflectiveChannelFactory】  工厂实现类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> ------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public T newChannel() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return constructor.newInstance();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            throw new ChannelException(&quot;Unable to create Channel from class &quot; + constructor.getDeclaringClass(), t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在启动对象调用 bind()或 connect()方法时，会创建 channel
本质上通过反射，使用工厂的反射实现类创建对应的实例，此时实例对象的类型是通过 channel 参数来设置的</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2channelhandler">2）ChannelHandler<a href="#2channelhandler" class="hash-link" aria-label="Direct link to 2）ChannelHandler" title="Direct link to 2）ChannelHandler">​</a></h4>
<p>类层次关系图</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/31189cba11962f972bfef0d5b7db285f.png" alt="image-20220412193256540" class="img_ev3q"></p>
<p>入站和出站：
从服务端的角度，数据从客户端发送到服务端，称之为入站，当数据处理完成返回给客户端，称之为出站。是相对的概念。</p>
<p>从客户端的角度，数据从服务端发送给客户端，称之为入站，当数据返回给服务端，称之为出站。</p>
<p>不论是入站还是出站，handler 从一端开始，到另一端结束，以责任链的模式依次执行。</p>
<p>责任链模式——&quot;击鼓传花&quot;，当请求被不同的接收者处理时，每个接收者都包含对下一个接收者的引用，一个接收者处理完成后，将依次向下传递。</p>
<p>适配器模式——出国时要使用的电源转换器（美国/日本 110V 中国 220V 电压），作为两个不兼容的接口之间的桥梁，将类的接口转换为需要的另外一种接口。</p>
<p>ChannelDuplexHandler 是除了入站和出站 handler 之外的，另一个常用子类。
它同时实现了 ChannelInboundHandler 和 ChannelOutboundHandler 接口，如果需要既处理入站事件又处理出站事件，可以继承此类。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"> serverBootstrap.handler(new LoggingHandler(LogLevel.INFO))</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> ------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> public class LoggingHandler extends ChannelDuplexHandler{}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> ------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> public class ChannelDuplexHandler extends ChannelInboundHandlerAdapter implements ChannelOutboundHandler {}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  ------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  public class ChannelInboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelInboundHandler {}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ChannelHandlerAdapter
提供了额外的 isSharable()方法，用来判断 handler 是否可以被共享到多个 pipeline 之中。默认情况不共享，如果需要共享，在继承了适配器的 handler 上，增加注解@Sharable</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@Sharable</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class LoggingHandler extends ChannelDuplexHandler {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ChannelInboundHandler
最重要的方法是 channelRead()，在使用时，需要显式的释放 ByteBuf 相关的内存。使用 ReferenceCountUtil 是引用计数的工具类。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // netty中的缓冲区  叫做ByteBuf  -- 对ByteBuffer的封装</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 释放ByteBuf内存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ReferenceCountUtil.release(msg);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了减少对资源内存的管理，使用 SimpleChannelInboundHandler，使用其 channelRead0()方法，可以自动释放资源，使用更便利。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">SimpleChannelInboundHandler源码</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        boolean release = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (acceptInboundMessage(msg)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                @SuppressWarnings(&quot;unchecked&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                I imsg = (I) msg;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channelRead0(ctx, imsg);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                release = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ctx.fireChannelRead(msg);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (autoRelease &amp;&amp; release) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ReferenceCountUtil.release(msg);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3channelpipeline">3）ChannelPipeline<a href="#3channelpipeline" class="hash-link" aria-label="Direct link to 3）ChannelPipeline" title="Direct link to 3）ChannelPipeline">​</a></h4>
<p>pipeline 中维护入站和出站链路，两条链路的执行顺序。</p>
<p>handler 只负责处理自身的业务逻辑，对通道而言，它是无状态的。通道的信息会保存到 handlerContext 处理器上下文中，它是连接 pipeline 和 handler 之间的中间角色。</p>
<p>pipeline 管理的是由 handlerContext 包裹的 handler，也就是说，当添加 handler 时，先将其转为 handlerContext，然后添加到 pipeline 的双向链表中。头结点叫做 HeadContext，尾节点叫做 TailContext。</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/c5fbb62a2262209d78cbad3329fdacef.png" alt="image-20220412193303101" class="img_ev3q"></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"> ch.pipeline().addLast(new NettyServerHandler());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> [DefaultChannelPipeline]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> ----------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public final ChannelPipeline addLast(ChannelHandler... handlers) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return addLast(null, handlers);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public final ChannelPipeline addLast(EventExecutorGroup executor, ChannelHandler... handlers) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ObjectUtil.checkNotNull(handlers, &quot;handlers&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (ChannelHandler h: handlers) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (h == null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            addLast(executor, null, h);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 关键逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final AbstractChannelHandlerContext newCtx;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        synchronized (this) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 检查当前handler是否支持共享，如果不支持，又被添加到其他pipeline中，会报错</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            checkMultiplicity(handler);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		    // 将handler封装为context</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            newCtx = newContext(group, filterName(name, handler), handler);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 将context添加到链表尾部</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            addLast0(newCtx);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // If the registered is false it means that the channel was not registered on an eventLoop yet.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // In this case we add the context to the pipeline and add a task that will call</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // ChannelHandler.handlerAdded(...) once the channel is registered.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 判断当前通道的注册状态，如果是未注册，执行此逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (!registered) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 添加一个任务，当通道被注册后，能够回调handlerAdded方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                newCtx.setAddPending();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                callHandlerCallbackLater(newCtx, true);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 如果已被注册  执行调用handlerAdded方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            EventExecutor executor = newCtx.executor();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (!executor.inEventLoop()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                callHandlerAddedInEventLoop(newCtx, executor);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        callHandlerAdded0(newCtx);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return this;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private static void checkMultiplicity(ChannelHandler handler) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (handler instanceof ChannelHandlerAdapter) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ChannelHandlerAdapter h = (ChannelHandlerAdapter) handler;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (!h.isSharable() &amp;&amp; h.added) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                throw new ChannelPipelineException(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        h.getClass().getName() +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        &quot; is not a @Sharable handler, so can&#x27;t be added or removed multiple times.&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            h.added = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private AbstractChannelHandlerContext newContext(EventExecutorGroup group, String name, ChannelHandler handler) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new DefaultChannelHandlerContext(this, childExecutor(group), name, handler);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 尾节点会提前声明并创建</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    final AbstractChannelHandlerContext tail;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    //  prev -&gt; tail   在其中插入newctx</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    //  prev -&gt; newctx -&gt; tail   放到倒数第二个位置中  tail节点是保持不变的</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    //  依次更改 新节点的前后指针   以及prev节点的后置指针和tail节点的前置指针</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void addLast0(AbstractChannelHandlerContext newCtx) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        AbstractChannelHandlerContext prev = tail.prev;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        newCtx.prev = prev;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        newCtx.next = tail;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        prev.next = newCtx;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        tail.prev = newCtx;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 构造器中已经提前创建了头尾节点</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    protected DefaultChannelPipeline(Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this.channel = ObjectUtil.checkNotNull(channel, &quot;channel&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        succeededFuture = new SucceededChannelFuture(channel, null);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        voidPromise =  new VoidChannelPromise(channel, true);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        tail = new TailContext(this);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        head = new HeadContext(this);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        head.next = tail;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        tail.prev = head;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 pipeline 模式的优点：
A) 解耦，让处理器逻辑独立，可以被多个 channel 共享
B) channel 相关信息，交给 context 维护
C) 具有极大的灵活性，使用处理器可以方便的添加或删除，或者更改它们的顺序</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3eventloop">3、EventLoop<a href="#3eventloop" class="hash-link" aria-label="Direct link to 3、EventLoop" title="Direct link to 3、EventLoop">​</a></h3>
<p>EventLoop 事件循环，监听 IO 事件，内部封装了线程</p>
<p>EventLoopGroup 事件循环组，是对 EventLoop 的管理，封装了线程池。</p>
<p>当新建 channel 时，group 会为其分配一个 EventLoop，封装了 nio 中的 Selector，监听通道中的所有事件，一个通道的生命周期内，所有操作都由相同的 EventLoop 所封装的线程处理。</p>
<p>同时，多个通道可以由一个 EventLoop 处理，是多对一的关系</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1eventloopgroup">1）EventLoopGroup<a href="#1eventloopgroup" class="hash-link" aria-label="Direct link to 1）EventLoopGroup" title="Direct link to 1）EventLoopGroup">​</a></h4>
<p>类层级结构
（通过选中 NioEventLoopGroup 源码 - 右键 - 选中 Diagrams - 选中 show diagram 展示出来）</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/f5d714566ee453cf273fba948d5c8376.png" alt="image-20220412193309395" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-初始化流程">A 初始化流程<a href="#a-初始化流程" class="hash-link" aria-label="Direct link to A 初始化流程" title="Direct link to A 初始化流程">​</a></h5>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">EventLoopGroup bossGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">EventLoopGroup workerGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[NioEventLoopGroup]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public NioEventLoopGroup() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this(0);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public NioEventLoopGroup(int nThreads) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this(nThreads, (Executor) null);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public NioEventLoopGroup(int nThreads, Executor executor) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this(nThreads, executor, SelectorProvider.provider());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 逐步增加参数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public NioEventLoopGroup(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            int nThreads, Executor executor, final SelectorProvider selectorProvider) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this(nThreads, executor, selectorProvider, DefaultSelectStrategyFactory.INSTANCE);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 调用父类的构造器</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public NioEventLoopGroup(int nThreads, Executor executor, final SelectorProvider selectorProvider,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                             final SelectStrategyFactory selectStrategyFactory) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        super(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> [MultithreadEventLoopGroup]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    protected MultithreadEventLoopGroup(int nThreads, Executor executor, Object... args) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, executor, args);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 初始化线程数量的逻辑     线程数 = cpu核数 * 2</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private static final int DEFAULT_EVENT_LOOP_THREADS;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors() * 2));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (logger.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            logger.debug(&quot;-Dio.netty.eventLoopThreads: {}&quot;, DEFAULT_EVENT_LOOP_THREADS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[MultithreadEventExecutorGroup]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    protected MultithreadEventExecutorGroup(int nThreads, Executor executor, Object... args) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        this(nThreads, executor, DefaultEventExecutorChooserFactory.INSTANCE, args);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 核心逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    protected MultithreadEventExecutorGroup(int nThreads, Executor executor,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                            EventExecutorChooserFactory chooserFactory, Object... args) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (nThreads &lt;= 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            throw new IllegalArgumentException(String.format(&quot;nThreads: %d (expected: &gt; 0)&quot;, nThreads));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (executor == null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            executor = new ThreadPerTaskExecutor(newDefaultThreadFactory());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        children = new EventExecutor[nThreads];</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (int i = 0; i &lt; nThreads; i ++) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            boolean success = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 根据线程数量  创建EventLoop的逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // newChild（）的具体实现在NioEventLoopGroup类中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                children[i] = newChild(executor, args);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                success = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // TODO: Think about if this is a good exception type</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                throw new IllegalStateException(&quot;failed to create a child event loop&quot;, e);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (!success) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    for (int j = 0; j &lt; i; j ++) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        children[j].shutdownGracefully();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    for (int j = 0; j &lt; i; j ++) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        EventExecutor e = children[j];</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            while (!e.isTerminated()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        } catch (InterruptedException interrupted) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // Let the caller handle the interruption.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            Thread.currentThread().interrupt();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        chooser = chooserFactory.newChooser(children);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final FutureListener&lt;Object&gt; terminationListener = new FutureListener&lt;Object&gt;() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            public void operationComplete(Future&lt;Object&gt; future) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (terminatedChildren.incrementAndGet() == children.length) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    terminationFuture.setSuccess(null);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (EventExecutor e: children) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e.terminationFuture().addListener(terminationListener);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Set&lt;EventExecutor&gt; childrenSet = new LinkedHashSet&lt;EventExecutor&gt;(children.length);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Collections.addAll(childrenSet, children);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        readonlyChildren = Collections.unmodifiableSet(childrenSet);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[NioEventLoopGroup]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    protected EventLoop newChild(Executor executor, Object... args) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        EventLoopTaskQueueFactory queueFactory = args.length == 4 ? (EventLoopTaskQueueFactory) args[3] : null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new NioEventLoop(this, executor, (SelectorProvider) args[0],</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ((SelectStrategyFactory) args[1]).newSelectStrategy(), (RejectedExecutionHandler) args[2], queueFactory);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2eventloop">2）EventLoop<a href="#2eventloop" class="hash-link" aria-label="Direct link to 2）EventLoop" title="Direct link to 2）EventLoop">​</a></h4>
<p>重要属性为 Selector 及其父类的父类中的 Thread
Selector 用于在 channel 创建之后，注册其中监听后续的 I/O 事件
Thread 用于进行轮询，在 channel 注册之后启动线程</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/a9d3c52108af6a66c7470c6f8b2d2b00.png" alt="image-20220412193320506" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-注册-channel">A 注册 channel<a href="#a-注册-channel" class="hash-link" aria-label="Direct link to A 注册 channel" title="Direct link to A 注册 channel">​</a></h5>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"> ChannelFuture future = serverBootstrap.bind(8888).sync();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> [AbstractBootstrap]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> --------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture bind(int inetPort) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return bind(new InetSocketAddress(inetPort));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture bind(SocketAddress localAddress) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        validate();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return doBind(ObjectUtil.checkNotNull(localAddress, &quot;localAddress&quot;));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private ChannelFuture doBind(final SocketAddress localAddress) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final ChannelFuture regFuture = initAndRegister();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final Channel channel = regFuture.channel();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        .....</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    final ChannelFuture initAndRegister() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Channel channel = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channel = channelFactory.newChannel();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            init(channel);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (channel != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel.unsafe().closeForcibly();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return new DefaultChannelPromise(new FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ChannelFuture regFuture = config().group().register(channel);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (regFuture.cause() != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (channel.isRegistered()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel.close();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel.unsafe().closeForcibly();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return regFuture;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注册的源码调用链路</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">ChannelFuture regFuture = config().group().register(channel);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[MultithreadEventLoopGroup]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture register(Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return next().register(channel);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[SingleThreadEventLoop]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture register(Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return register(new DefaultChannelPromise(channel, this));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public ChannelFuture register(final ChannelPromise promise) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ObjectUtil.checkNotNull(promise, &quot;promise&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        promise.channel().unsafe().register(this, promise);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return promise;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[AbstractChannel]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">//  核心逻辑是 调用了 register0()方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> public final void register(EventLoop eventLoop, final ChannelPromise promise) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ObjectUtil.checkNotNull(eventLoop, &quot;eventLoop&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (isRegistered()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                promise.setFailure(new IllegalStateException(&quot;registered to an event loop already&quot;));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (!isCompatible(eventLoop)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                promise.setFailure(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        new IllegalStateException(&quot;incompatible event loop type: &quot; + eventLoop.getClass().getName()));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			// channel中存在EventLoop类型的属性</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 通道初始化时，会将指定的EventLoop与channel进行关联</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            AbstractChannel.this.eventLoop = eventLoop;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (eventLoop.inEventLoop()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                register0(promise);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    eventLoop.execute(new Runnable() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        public void run() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            register0(promise);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    logger.warn(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            &quot;Force-closing a channel whose registration task was not accepted by an event loop: {}&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            AbstractChannel.this, t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    closeForcibly();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    closeFuture.setClosed();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    safeSetFailure(promise, t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     // 核心逻辑是调用了doRegister()方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     private void register0(ChannelPromise promise) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // check if the channel is still open as it could be closed in the mean time when the register</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // call was outside of the eventLoop</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (!promise.setUncancellable() || !ensureOpen(promise)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                boolean firstRegistration = neverRegistered;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                doRegister();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                neverRegistered = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                registered = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // user may already fire events through the pipeline in the ChannelFutureListener.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                pipeline.invokeHandlerAddedIfNeeded();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                safeSetSuccess(promise);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                pipeline.fireChannelRegistered();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Only fire a channelActive if the channel has never been registered. This prevents firing</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // multiple channel actives if the channel is deregistered and re-registered.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (isActive()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (firstRegistration) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        pipeline.fireChannelActive();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    } else if (config().isAutoRead()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // This channel was registered before and autoRead() is set. This means we need to begin read</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // again so that we process inbound data.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        //</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // See https://github.com/netty/netty/issues/4805</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        beginRead();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Close the channel directly to avoid FD leak.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                closeForcibly();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                closeFuture.setClosed();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                safeSetFailure(promise, t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[AbstractNioChannel]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 核心注册逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">protected void doRegister() throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        boolean selected = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (;;) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 将通道注册进Selector中 此时感兴趣的事件是0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 并且将当前对象作为附加对象存入其中  等价selectionKey.attach()方法</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 使用对象时   再通过selectionkey.attachment()方法取出对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (CancelledKeyException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (!selected) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // Force the Selector to select now as the &quot;canceled&quot; SelectionKey may still be</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // cached and not removed because no Select.select(..) operation was called yet.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    eventLoop().selectNow();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    selected = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // We forced a select operation on the selector before but the SelectionKey is still cached</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // for whatever reason. JDK bug ?</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    throw e;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="b-轮询事件的状态">B 轮询事件的状态<a href="#b-轮询事件的状态" class="hash-link" aria-label="Direct link to B 轮询事件的状态" title="Direct link to B 轮询事件的状态">​</a></h5>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/c23f36d521261ca784b3e4e60dc508cb.png" alt="image-20220412193329743" class="img_ev3q"></p>
<p>读取源码的思路：找到入口，找到核心逻辑。</p>
<p>AbstractChannel 中 register()方法，对 eventLoop.execute()的调用，就是启动线程进行轮询的入口。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">[SingleThreadEventExecutor]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public void execute(Runnable task) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ObjectUtil.checkNotNull(task, &quot;task&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        execute(task, !(task instanceof LazyRunnable) &amp;&amp; wakesUpForTask(task));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private final Queue&lt;Runnable&gt; taskQueue;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    //  当前类维护了一个任务队列</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void execute(Runnable task, boolean immediate) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        boolean inEventLoop = inEventLoop();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        addTask(task);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!inEventLoop) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 启动线程</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            startThread();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (isShutdown()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                boolean reject = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (removeTask(task)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        reject = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } catch (UnsupportedOperationException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // The task queue does not support removal so the best thing we can do is to just move on and</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // hope we will be able to pick-up the task before its completely terminated.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // In worst case we will log on termination.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (reject) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    reject();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!addTaskWakesUp &amp;&amp; immediate) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            wakeup(inEventLoop);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void startThread() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (state == ST_NOT_STARTED) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (STATE_UPDATER.compareAndSet(this, ST_NOT_STARTED, ST_STARTED)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                boolean success = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    doStartThread();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    success = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (!success) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        STATE_UPDATER.compareAndSet(this, ST_STARTED, ST_NOT_STARTED);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void doStartThread() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        assert thread == null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        executor.execute(new Runnable() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            public void run() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                thread = Thread.currentThread();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (interrupted) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    thread.interrupt();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                boolean success = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                updateLastExecutionTime();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // 真正的调用逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    SingleThreadEventExecutor.this.run();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    success = true;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ......</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[NioEventLoop]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">-----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">protected void run() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        int selectCnt = 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (;;) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                int strategy;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    strategy = selectStrategy.calculateStrategy(selectNowSupplier, hasTasks());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    switch (strategy) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    case SelectStrategy.CONTINUE:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        continue;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    case SelectStrategy.BUSY_WAIT:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // fall-through to SELECT since the busy-wait is not supported with NIO</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    case SelectStrategy.SELECT:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        long curDeadlineNanos = nextScheduledTaskDeadlineNanos();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        if (curDeadlineNanos == -1L) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            curDeadlineNanos = NONE; // nothing on the calendar</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        nextWakeupNanos.set(curDeadlineNanos);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // 判断队列中是否存在任务</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            if (!hasTasks()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                // 如果不存在  调用select()进行获取</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                strategy = select(curDeadlineNanos);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // This update is just to help block unnecessary selector wakeups</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // so use of lazySet is ok (no race condition)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            nextWakeupNanos.lazySet(AWAKE);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // fall through</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    default:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } catch (IOException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // If we receive an IOException here its because the Selector is messed up. Let&#x27;s rebuild</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // the selector and retry. https://github.com/netty/netty/issues/8566</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    rebuildSelector0();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    selectCnt = 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    handleLoopException(e);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    continue;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                selectCnt++;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                cancelledKeys = 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                needsToSelectAgain = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                final int ioRatio = this.ioRatio;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                boolean ranTasks;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (ioRatio == 100) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        if (strategy &gt; 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // 处理任务的核心逻辑</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            processSelectedKeys();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // Ensure we always run tasks.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        ranTasks = runAllTasks();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } else if (strategy &gt; 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    final long ioStartTime = System.nanoTime();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        processSelectedKeys();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // Ensure we always run tasks.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        final long ioTime = System.nanoTime() - ioStartTime;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        ranTasks = runAllTasks(ioTime * (100 - ioRatio) / ioRatio);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    ranTasks = runAllTasks(0); // This will run the minimum number of tasks</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (ranTasks || strategy &gt; 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS &amp;&amp; logger.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        logger.debug(&quot;Selector.select() returned prematurely {} times in a row for Selector {}.&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                selectCnt - 1, selector);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    selectCnt = 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } else if (unexpectedSelectorWakeup(selectCnt)) { // Unexpected wakeup (unusual case)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    selectCnt = 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (CancelledKeyException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Harmless exception - log anyway</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (logger.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    logger.debug(CancelledKeyException.class.getSimpleName() + &quot; raised by a Selector {} - JDK bug?&quot;,</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            selector, e);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                handleLoopException(t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // Always handle shutdown even if the loop processing threw an exception.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (isShuttingDown()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    closeAll();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (confirmShutdown()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                handleLoopException(t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>processSelectedKeys()是处理任务的核心逻辑，来自于 NioEventLoop 的 run()方法调用</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">    // 处理事件集合</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void processSelectedKeys() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果selectedKeys（事件集合）没有值，重新获取，如果有值，直接处理</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (selectedKeys != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            processSelectedKeysOptimized();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            processSelectedKeysPlain(selector.selectedKeys());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     private void processSelectedKeysPlain(Set&lt;SelectionKey&gt; selectedKeys) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // check if the set is empty and if so just return to not create garbage by</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // creating a new Iterator every time even if there is nothing to process.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // See https://github.com/netty/netty/issues/597</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (selectedKeys.isEmpty()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        for (;;) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final SelectionKey k = i.next();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 这是注册时，存储的附加对象，即为通道对象channel</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final Object a = k.attachment();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            i.remove();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (a instanceof AbstractNioChannel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 处理具体事件</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                processSelectedKey(k, (AbstractNioChannel) a);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                @SuppressWarnings(&quot;unchecked&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                processSelectedKey(k, task);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (!i.hasNext()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (needsToSelectAgain) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                selectAgain();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                selectedKeys = selector.selectedKeys();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Create the iterator again to avoid ConcurrentModificationException</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (selectedKeys.isEmpty()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    i = selectedKeys.iterator();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 处理具体事件</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    //  判断事件类型，调用对应的逻辑处理</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!k.isValid()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final EventLoop eventLoop;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                eventLoop = ch.eventLoop();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable ignored) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // If the channel implementation throws an exception because there is no event loop, we ignore this</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // because we are only trying to determine if ch is registered to this event loop and thus has authority</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // to close ch.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // still healthy and should not be closed.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // See https://github.com/netty/netty/issues/5125</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (eventLoop == this) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // close the channel if the key is not valid anymore</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                unsafe.close(unsafe.voidPromise());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            int readyOps = k.readyOps();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // the NIO JDK channel implementation may throw a NotYetConnectedException.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // See https://github.com/netty/netty/issues/924</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                int ops = k.interestOps();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ops &amp;= ~SelectionKey.OP_CONNECT;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                k.interestOps(ops);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                unsafe.finishConnect();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ch.unsafe().forceFlush();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // to a spin loop</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                unsafe.read();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (CancelledKeyException ignored) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            unsafe.close(unsafe.voidPromise());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中读事件的处理</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">unsafe.read();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">[AbstractNioByteChannel]</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public final void read() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final ChannelConfig config = config();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (shouldBreakReadReady(config)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                clearReadPending();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final ChannelPipeline pipeline = pipeline();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final ByteBufAllocator allocator = config.getAllocator();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            allocHandle.reset(config);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ByteBuf byteBuf = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            boolean close = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                do {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    byteBuf = allocHandle.allocate(allocator);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    allocHandle.lastBytesRead(doReadBytes(byteBuf));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    if (allocHandle.lastBytesRead() &lt;= 0) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // nothing was read. release the buffer.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        byteBuf.release();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        byteBuf = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        close = allocHandle.lastBytesRead() &lt; 0;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        if (close) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            // There is nothing left to read as we received an EOF.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            readPending = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    allocHandle.incMessagesRead(1);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    readPending = false;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    pipeline.fireChannelRead(byteBuf);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    byteBuf = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                } while (allocHandle.continueReading());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                allocHandle.readComplete();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                pipeline.fireChannelReadComplete();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (close) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    closeOnRead(pipeline);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                handleReadException(pipeline, byteBuf, t, close, allocHandle);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // Check if there is a readPending which was not processed yet.</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // This could be for two reasons:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                //</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // See https://github.com/netty/netty/issues/2254</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (!readPending &amp;&amp; !config.isAutoRead()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    removeReadOp();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4bootstrap">4、Bootstrap<a href="#4bootstrap" class="hash-link" aria-label="Direct link to 4、Bootstrap" title="Direct link to 4、Bootstrap">​</a></h3>
<p>引导，对应用程序进行配置，并让他运行起来的过程。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1配置">1）配置<a href="#1配置" class="hash-link" aria-label="Direct link to 1）配置" title="Direct link to 1）配置">​</a></h4>
<p>必选参数：group 、 channel、 handler（服务端 -- childHandler）</p>
<p>group()： 指定一个到两个 reactor</p>
<p>channel()：指定 channel 工厂，反射的方式创建 channel 使用</p>
<p>handler()：指定 reactor 的处理器，其中 childHandler 指定的是，服务端所接收到的客户端 channel 使用的处理器，而服务端的主 reactor（bossGroup），已经默认添加了 acceptor 处理器，所以可以不指定。</p>
<p>option()：指定 TCP 相关的参数，以及 netty 自定义的参数</p>
<p>配置参数的过程，称之为初始化。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2运行">2）运行<a href="#2运行" class="hash-link" aria-label="Direct link to 2）运行" title="Direct link to 2）运行">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">        // 启动并设置端口号  但需要使用sync异步启动</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ChannelFuture future = serverBootstrap.bind(8888).sync();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 将关闭通道的方式 也设置为异步的</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            //    阻塞finally中的代码执行</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            future.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 优雅关闭</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            bossGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            workerGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>bind()，将服务端的 channel 绑定到端口号，然后接收客户端的连接，让整个 netty 运行起来。</p>
<p>sync()，因为绑定事件是异步的，所以使用 sync 同步等待结果，换句话说，bind 只触发了绑定端口的事件，需要使用 sync 等待事件执行的结果。</p>
<p>future.channel().closeFuture().sync()，含义为，当通道被关闭时，才执行后续的操作，sync 使当前线程执行到此处阻塞，以确保不执行后续的 shutdown 方法。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3源码解析">3）源码解析<a href="#3源码解析" class="hash-link" aria-label="Direct link to 3）源码解析" title="Direct link to 3）源码解析">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="a-类声明">A 类声明<a href="#a-类声明" class="hash-link" aria-label="Direct link to A 类声明" title="Direct link to A 类声明">​</a></h5>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">public abstract class AbstractBootstrap&lt;B extends AbstractBootstrap&lt;B, C&gt;, C extends Channel&gt; implements Cloneable {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>嵌套的泛型使用，可以达到，子类中返回子类本身的效果，具体如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">public class ServerBootstrap extends AbstractBootstrap&lt;ServerBootstrap, ServerChannel&gt; {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="b-init-方法">B init 方法<a href="#b-init-方法" class="hash-link" aria-label="Direct link to B init 方法" title="Direct link to B init 方法">​</a></h5>
<p>工作内容</p>
<p>a、设置 channel 相关的选项参数
b、设置 channel 的属性键值对
c、添加对 channel 的 IO 事件处理器 （Acceptor 角色）</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">void init(Channel channel) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 设置channel相关的选项参数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        setChannelOptions(channel, newOptionsArray(), logger);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 设置channel的属性键值对</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        setAttributes(channel, attrs0().entrySet().toArray(EMPTY_ATTRIBUTE_ARRAY));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ChannelPipeline p = channel.pipeline();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final EventLoopGroup currentChildGroup = childGroup;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final ChannelHandler currentChildHandler = childHandler;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        synchronized (childOptions) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            currentChildOptions = childOptions.entrySet().toArray(EMPTY_OPTION_ARRAY);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs = childAttrs.entrySet().toArray(EMPTY_ATTRIBUTE_ARRAY);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        p.addLast(new ChannelInitializer&lt;Channel&gt;() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            public void initChannel(final Channel ch) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                final ChannelPipeline pipeline = ch.pipeline();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ChannelHandler handler = config.handler();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                if (handler != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    pipeline.addLast(handler);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // 添加对channel的IO事件处理器 （Acceptor角色）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ch.eventLoop().execute(new Runnable() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    public void run() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        pipeline.addLast(new ServerBootstrapAcceptor(</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Acceptor 分析</p>
<p>功能：将主 reactor 接收到的客户端通道，传递给从 reactor</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// ServerBootstrapAcceptor是ServerBootstrap的静态内部类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// netty将acceptor看作一个处理器，并且是入站处理器</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">private static class ServerBootstrapAcceptor extends ChannelInboundHandlerAdapter {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 具体的逻辑封装到channelRead（）方法中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 对客户端通道进行配置 ， 然后注册到从Reactor中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public void channelRead(ChannelHandlerContext ctx, Object msg) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 此时msg对应 服务端接收到的客户端通道</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final Channel child = (Channel) msg;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		    // 设置处理链路</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            child.pipeline().addLast(childHandler);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">			// 设置通道的配置项和参数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            setChannelOptions(child, childOptions, logger);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            setAttributes(child, childAttrs);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // childGroup 是从reactor的资源池 调用注册方法 注册客户端通道child</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                childGroup.register(child).addListener(new ChannelFutureListener() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    @Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // 增加监听 获取注册的异步结果</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // 如果注册失败 或者抛出异常  都会关闭channel</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        if (!future.isSuccess()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            forceClose(child, future.cause());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                forceClose(child, t);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 如果处理客户端连接失败了，暂停一秒，然后继续接受</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 为保障服务端能够尽可能多的处理客户端的连接  不受某一次处理失败的结果影响</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            final ChannelConfig config = ctx.channel().config();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            if (config.isAutoRead()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // stop accept new connections for 1 second to allow the channel to recover</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                // See https://github.com/netty/netty/issues/1328</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                config.setAutoRead(false);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ctx.channel().eventLoop().schedule(enableAutoReadTask, 1, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // still let the exceptionCaught event flow through the pipeline to give the user</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // a chance to do something with it</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ctx.fireExceptionCaught(cause);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-future-和-promise">4) Future 和 Promise<a href="#4-future-和-promise" class="hash-link" aria-label="Direct link to 4) Future 和 Promise" title="Direct link to 4) Future 和 Promise">​</a></h4>
<p>Future 代表的是，一个还未完成的异步任务的执行结果。可以通过 addListener 方法，监听执行结果后进行相应的处理，此时它的状态可以分为未完成、已完成（成功、失败、主动取消）等。</p>
<p>对 Future 而言，状态只能读取，无法更改，又出现了 Promise，但是 Promise 只能更改一次。</p>
<p>参照生活中的定额发票（Future）和机打发票（Promise）。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四拓展篇">（四）拓展篇<a href="#四拓展篇" class="hash-link" aria-label="Direct link to （四）拓展篇" title="Direct link to （四）拓展篇">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1心跳检测">1、心跳检测<a href="#1心跳检测" class="hash-link" aria-label="Direct link to 1、心跳检测" title="Direct link to 1、心跳检测">​</a></h3>
<p>检测逻辑：
1） 服务端启动，客户端建立连接，连接的目的是互相发送消息。
2） 如果客户端在工作，服务端一定能收到数据，如果客户端空闲，服务端会出现资源浪费。
3） 服务端需要一种检测机制，验证客户端的活跃状态，不活跃则关闭。</p>
<p>需求设计：
1） 客户端向服务端发送 “I am alive” , sleep 一个随机时间，模拟空闲状态
2） 服务端收到消息后，返回“over”， 客户端有空闲，记录空闲次数
3） 设定阈值，达到阈值时主动关闭连接</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/f45a5f504acec96234c73b119c5337e7.png" alt="在这里插入图片描述" class="img_ev3q"></p>
<p>IdleStateHandler , 是 netty 提供的处理器
1）超过多长时间没有读 readerIdleTime</p>
<ol start="2">
<li>超过多长时间没有写 writerIdleTime</li>
<li>超过多长时间没有读和写 allIdleTime</li>
</ol>
<p>底层实现检测的是 IdleStateEvent 事件，通过管道传递给下一个 handler 处理，处理方法是 userEventTriggered。</p>
<p>其中 IdleStateEvent 事件，分为 READER_IDLE、WRITER_IDLE、ALL_IDLE 三大类</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2tcp-粘包拆包">2、TCP 粘包拆包<a href="#2tcp-粘包拆包" class="hash-link" aria-label="Direct link to 2、TCP 粘包拆包" title="Direct link to 2、TCP 粘包拆包">​</a></h3>
<p>TCP 是基于流的。</p>
<p>产生粘包和拆包问题的主要原因是，操作系统在发送 TCP 数据的时候，底层会有一个缓冲区，例如 1024 个字节大小，如果一次请求发送的数据量比较小，没达到缓冲区大小，TCP 则会将多个请求合并为同一个请求进行发送，这就形成了粘包问题；如果一次请求发送的数据量比较大，超过了缓冲区大小，TCP 就会将其拆分为多次发送，这就是拆包，也就是将一个大的包拆分为多个小包进行发送。</p>
<p>UDP 会发生拆包和粘包吗？
不会，UDP 是基于报文的，在 UDP 的首部使用 16bit 存储报文的长度，因此不会发生。</p>
<p>TCP 发生粘包和拆包的本质原因：
要发送的数据先经过 TCP 的缓冲区，还限制了最大报文长度。
A 如果要发送的数据 &gt; TCP 剩余的缓冲区大小，发生拆包
B 如果要发送的数据 &gt; 最大报文长度，发生拆包<br>
C 如果要发送的数据 &lt;&lt; TCP 剩余的缓冲区大小，发生粘包
D 接收数据的应用层，没有及时读取缓冲区数据，也会发生粘包</p>
<p>解决办法：
A 设置出消息的长度
B 设置出消息的边界——分隔符</p>
<p>Netty 提供的解码器，两类</p>
<p>A 基于长度的解码器，在包头部设置出数据的长度。（类似于 UDP 的头部处理）
LengthFieldBasedFrameDecoder 自定义长度的处理方式
FixedLengthFrameDecoder 固定长度的处理方式</p>
<p>B 基于分隔符的解码器
DelimiterBasedFrameDecoder 自定义分隔符的处理方式
LineBasedFrameDecoder 行尾（&quot;\n&quot;或&quot;\r\n&quot;）分隔符的处理方式</p>
<p>【Demo 逻辑】
需求：客户端循环 100 次向服务端请求时间</p>
<p>1）第一种方式，传输的过程数据单位是字节流 ByteBuf，需要自行处理分隔符以及数据的长度，此时会出现粘包和拆包的问题</p>
<p>2）第二种方式，使用 LineBasedFrameDecoder，配合 StringDecoder 使用，传输的数据单位变成字符串，可以直接处理，保证业务逻辑上的包和真正传输的包是一致的</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3序列化框架protobuf">3、序列化框架——protobuf<a href="#3序列化框架protobuf" class="hash-link" aria-label="Direct link to 3、序列化框架——protobuf" title="Direct link to 3、序列化框架——protobuf">​</a></h3>
<p>protobuf = protocol buffers
类似于 xml 的生成和解析，但效率更高，生成的是字节码，可读性稍差。</p>
<p>【Demo 逻辑】</p>
<p>1）安装 idea 插件，protobuf support</p>
<p>​ 如果安装之后，创建*.proto 文件没有使用插件，手动设置关联关系</p>
<p>​ settings -&gt; file types -&gt; 找到 protobuf -&gt; 增加正则表达式</p>
<p>2）引入 maven 依赖和插件</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;properties&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;os.detected.classifier&gt;windows-x86_64&lt;/os.detected.classifier&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/properties&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;build&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        &lt;plugins&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;version&gt;0.5.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;configuration&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &lt;protocArtifact&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        com.google.protobuf:protoc:3.1.0:exe:${os.detected.classifier}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &lt;/protocArtifact&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &lt;pluginId&gt;grpc-java&lt;/pluginId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;/configuration&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;executions&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &lt;execution&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        &lt;goals&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            &lt;goal&gt;compile&lt;/goal&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            &lt;goal&gt;compile-custom&lt;/goal&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        &lt;/goals&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &lt;/execution&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                &lt;/executions&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        &lt;/plugins&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;/build&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）在右侧 maven project 中可以找到相应的插件 (没有的话刷新)
<img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/4406720e774876e94f7035d66f5d90f7.png" alt="image-20220412193415944" class="img_ev3q"></p>
<p>4）在和 java 平级的目录下，创建 proto 文件夹，然后创建 person.proto 文件
5）person.proto</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// 声明包名称的空间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">syntax=&quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 具体的类生成目录</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">option java_package=&quot;com.duing&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 具体的类名</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">option java_outer_classname=&quot;PersonModel&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 类结构</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">message Person{</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    int32 id = 1;    // 此处的1代表顺序</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    string name = 2;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>使用插件进行编译，将编译生成的代码拷贝到需要的目录下
7）编写测例进行序列化和反序列化操作</li>
</ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Java/Netty_模拟Redis的客户端"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Netty_模拟Redis的客户端</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Java/Nginx"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Nginx</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一-基础篇" class="table-of-contents__link toc-highlight">（一） 基础篇</a><ul><li><a href="#1io-基础" class="table-of-contents__link toc-highlight">1、I/O 基础</a></li><li><a href="#2socket" class="table-of-contents__link toc-highlight">2、Socket</a></li><li><a href="#3nio" class="table-of-contents__link toc-highlight">3、NIO</a><ul><li><a href="#1-channel" class="table-of-contents__link toc-highlight">1) Channel</a></li><li><a href="#2-buffer" class="table-of-contents__link toc-highlight">2) Buffer</a></li><li><a href="#3-selector" class="table-of-contents__link toc-highlight">3) Selector</a></li></ul></li><li><a href="#4零拷贝" class="table-of-contents__link toc-highlight">4、零拷贝</a></li><li><a href="#线程模型" class="table-of-contents__link toc-highlight">线程模型</a><ul><li><a href="#1-单线程-reactor-模型" class="table-of-contents__link toc-highlight">1） 单线程 Reactor 模型</a></li><li><a href="#2多线程-reactor-模型" class="table-of-contents__link toc-highlight">2）多线程 Reactor 模型</a></li><li><a href="#3主从-reactor-模型" class="table-of-contents__link toc-highlight">3）主从 Reactor 模型</a></li></ul></li></ul></li><li><a href="#二-应用篇" class="table-of-contents__link toc-highlight">（二） 应用篇</a><ul><li><a href="#1http" class="table-of-contents__link toc-highlight">1、HTTP</a><ul><li><a href="#1-09-版本" class="table-of-contents__link toc-highlight">1) 0.9 版本</a></li><li><a href="#2-10-版本" class="table-of-contents__link toc-highlight">2) 1.0 版本</a></li><li><a href="#3-11-版本" class="table-of-contents__link toc-highlight">3) 1.1 版本</a></li><li><a href="#4-20-版本" class="table-of-contents__link toc-highlight">4) 2.0 版本</a></li></ul></li></ul></li><li><a href="#说了这么多-上代码来操作一下吧" class="table-of-contents__link toc-highlight">说了这么多 上代码来操作一下吧！！</a><ul><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li><li><a href="#2websocket" class="table-of-contents__link toc-highlight">2、WebSocket</a><ul><li><a href="#websocket-应用-demo" class="table-of-contents__link toc-highlight">Websocket 应用 demo</a></li><li><a href="#演示效果" class="table-of-contents__link toc-highlight">演示效果</a></li><li><a href="#小结-1" class="table-of-contents__link toc-highlight">小结</a></li></ul></li></ul></li><li><a href="#三原理篇" class="table-of-contents__link toc-highlight">（三）原理篇</a><ul><li><a href="#1bytebuf" class="table-of-contents__link toc-highlight">1、ByteBuf</a><ul><li><a href="#1分类" class="table-of-contents__link toc-highlight">1）分类</a><ul><li><a href="#a-heap-buffer" class="table-of-contents__link toc-highlight">A heap buffer</a></li><li><a href="#b-direct-buffer" class="table-of-contents__link toc-highlight">B direct buffer</a></li><li><a href="#c-composite-buffer" class="table-of-contents__link toc-highlight">C composite buffer</a></li><li><a href="#d-池化的概念" class="table-of-contents__link toc-highlight">D 池化的概念</a></li><li><a href="#e-回收方式" class="table-of-contents__link toc-highlight">E 回收方式</a></li></ul></li><li><a href="#2工作原理" class="table-of-contents__link toc-highlight">2）工作原理</a><ul><li><a href="#a-读写分离" class="table-of-contents__link toc-highlight">A 读写分离</a></li><li><a href="#b-深浅拷贝" class="table-of-contents__link toc-highlight">B 深浅拷贝</a></li></ul></li><li><a href="#3扩容机制" class="table-of-contents__link toc-highlight">3）扩容机制</a><ul><li><a href="#a-bytebuffer-的存储" class="table-of-contents__link toc-highlight">A ByteBuffer 的存储</a></li><li><a href="#b-bytebuf-的存储和扩容" class="table-of-contents__link toc-highlight">B ByteBuf 的存储和扩容</a></li></ul></li><li><a href="#4优势" class="table-of-contents__link toc-highlight">4）优势</a></li></ul></li><li><a href="#2channel" class="table-of-contents__link toc-highlight">2、Channel</a><ul><li><a href="#1channel" class="table-of-contents__link toc-highlight">1）Channel</a></li><li><a href="#2channelhandler" class="table-of-contents__link toc-highlight">2）ChannelHandler</a></li><li><a href="#3channelpipeline" class="table-of-contents__link toc-highlight">3）ChannelPipeline</a></li></ul></li><li><a href="#3eventloop" class="table-of-contents__link toc-highlight">3、EventLoop</a><ul><li><a href="#1eventloopgroup" class="table-of-contents__link toc-highlight">1）EventLoopGroup</a><ul><li><a href="#a-初始化流程" class="table-of-contents__link toc-highlight">A 初始化流程</a></li></ul></li><li><a href="#2eventloop" class="table-of-contents__link toc-highlight">2）EventLoop</a><ul><li><a href="#a-注册-channel" class="table-of-contents__link toc-highlight">A 注册 channel</a></li><li><a href="#b-轮询事件的状态" class="table-of-contents__link toc-highlight">B 轮询事件的状态</a></li></ul></li></ul></li><li><a href="#4bootstrap" class="table-of-contents__link toc-highlight">4、Bootstrap</a><ul><li><a href="#1配置" class="table-of-contents__link toc-highlight">1）配置</a></li><li><a href="#2运行" class="table-of-contents__link toc-highlight">2）运行</a></li><li><a href="#3源码解析" class="table-of-contents__link toc-highlight">3）源码解析</a><ul><li><a href="#a-类声明" class="table-of-contents__link toc-highlight">A 类声明</a></li><li><a href="#b-init-方法" class="table-of-contents__link toc-highlight">B init 方法</a></li></ul></li><li><a href="#4-future-和-promise" class="table-of-contents__link toc-highlight">4) Future 和 Promise</a></li></ul></li></ul></li><li><a href="#四拓展篇" class="table-of-contents__link toc-highlight">（四）拓展篇</a><ul><li><a href="#1心跳检测" class="table-of-contents__link toc-highlight">1、心跳检测</a></li><li><a href="#2tcp-粘包拆包" class="table-of-contents__link toc-highlight">2、TCP 粘包拆包</a></li><li><a href="#3序列化框架protobuf" class="table-of-contents__link toc-highlight">3、序列化框架——protobuf</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">  来自冷环渊的技术支持与文档创作 @2025</div></div></div></footer></div>
</body>
</html>
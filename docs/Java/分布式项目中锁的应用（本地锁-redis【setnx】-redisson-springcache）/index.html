<!doctype html>
<html lang="cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache） | 小冷の代码世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）"><meta data-rh="true" property="og:locale" content="cn"><meta data-rh="true" name="docusaurus_locale" content="cn"><meta data-rh="true" name="docsearch:language" content="cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache） | 小冷の代码世界"><meta data-rh="true" name="description" content="[toc]"><meta data-rh="true" property="og:description" content="[toc]"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）" hreflang="cn"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.15cbc4ab.css">
<script src="/assets/js/runtime~main.41489e3b.js" defer="defer"></script>
<script src="/assets/js/main.53b12e53.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">小冷の代码世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Java/Docker 快速入门">Java知识库</a><a class="navbar__item navbar__link" href="/docs/Web/JavaScript 高级">前端知识库</a><a class="navbar__item navbar__link" sidebarid="GodotSidebar" href="/docs/Godot">Godot游戏开发</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Doomwatcher2004" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Docker 快速入门">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java 8 更新的新特性 （函数式接口 lambda stream option）">Java8 新特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Java后端进阶之路： JavaWeb">javaweb</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Mybatis">Mybatis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty+springboot实现IM即时通讯服务端">Netty+springboot实现IM即时通讯服务端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_HTTP文件列表服务器">Netty_HTTP文件列表服务器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty_模拟Redis的客户端">Netty_模拟Redis的客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Netty网络框架">Netty 网络框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Nginx">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Redis 数据结构操作入门">Redis 数据结构操作入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring Aop 底层责任链思路实现">Spring Aop 底层责任链思路实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring5 Webflux 响应式编程">Spring5 Webflux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringBoot 解决企业级复杂性简化开发的神奇">微服务阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Alibaba">springCloudAlibaba</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/SpringCloud Netflix">springcloud2020</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/Spring内置MVC框架：SpringMVC">SpringMVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/mybatis plus">mybatis plus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/redis问题的常见解决方案">redis问题的常见解决方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/使用Netty+zookeeper开发一款高性能LRpc">RPC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/六道入门树题目带你走入树结构的世界">六道入门树题目带你走入树结构的世界</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）">分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/多线程进阶 JUC并发编程">多线程进阶 JUC 并发编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/大前端进阶（ES6）">ES6</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/快速入门RabbitMQ并且加入项目实战">快速入门RabbitMQ并且加入项目实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/快速入门分布式系统与Dubbo+zookeeper">分布式系统简述：</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/掌握极简服务器开发的优秀框架 ：Spring">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/搜索引擎 _ Elasticsearch">Elasticsearch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/数据结构与算法">数据结构与算法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/理解IOC 手写springIOC">Spring 手撕 IOC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/线程池详解与异步任务编排使用案例">线程池详解与异步任务编排使用案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/通透百万数据秒级排序  快速排序">通透百万数据秒级排序  快速排序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/阿里淘系单点登录中心">阿里淘系单点登录中心</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Java/高并发秒杀系统">高并发秒杀系统</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>[toc]</p>
<header><h1>概述</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1适合放入缓存的数据">1.适合放入缓存的数据<a href="#1适合放入缓存的数据" class="hash-link" aria-label="Direct link to 1.适合放入缓存的数据" title="Direct link to 1.适合放入缓存的数据">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.即时性、数据一致性要求不高的</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.访问量大且更新频率不高的数据（读多，写少）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">举例：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.电商类应用，商品分类，商品列表等适合缓存并加一个失效时间（根据数据更新频率来定）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.后台如果发布一个商品，买家需要</span><span class="token number" style="color:#B5CEA8">5</span><span class="token plain">分钟才能看到新的商品一般还是可以接受的</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.物流信息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2读模式缓存使用流程">2.读模式缓存使用流程<a href="#2读模式缓存使用流程" class="hash-link" aria-label="Direct link to 2.读模式缓存使用流程" title="Direct link to 2.读模式缓存使用流程">​</a></h2>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/2de2f4a095d7c644d46d9444d83b0a23.png" alt="1635512623631" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/0f5a29c819eaa6aebc0bd68377ecb2d9.png" alt="1635512538828" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3本地缓存与局限性">3.本地缓存与局限性<a href="#3本地缓存与局限性" class="hash-link" aria-label="Direct link to 3.本地缓存与局限性" title="Direct link to 3.本地缓存与局限性">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.集群情况下，每个节点的本地缓存可能会不一致（数据一致性）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/41ed81f2ad154fcc65470c13a49f0663.png" alt="1635513182709" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4分布式缓存">4.分布式缓存<a href="#4分布式缓存" class="hash-link" aria-label="Direct link to 4.分布式缓存" title="Direct link to 4.分布式缓存">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">使用缓存中间件：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	redis（集群、分片）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/44721c36c7d789fd677a5888b78e82e4.png" alt="1635513259851" class="img_ev3q"></p>
<h1>整合 redis</h1>
<p><strong>把 redis 看做 Map</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1使用-springboot-整合-redis">1.使用 springboot 整合 redis<a href="#1使用-springboot-整合-redis" class="hash-link" aria-label="Direct link to 1.使用 springboot 整合 redis" title="Direct link to 1.使用 springboot 整合 redis">​</a></h2>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">1.在需要使用redis的模块导入依赖，启动器</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        &lt;</span><span class="token tag" style="color:#0ea5e9">!--redis</span><span class="token plain">启动器</span><span class="token punctuation" style="color:#475569">-</span><span class="token punctuation" style="color:#475569">-</span><span class="token punctuation" style="color:#475569">&gt;</span><span class="token scalar string" style="color:#64748b"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token scalar string" style="color:#64748b">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token scalar string" style="color:#64748b">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token scalar string" style="color:#64748b">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token scalar string" style="color:#64748b">        &lt;/dependency&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">2.RedisAutoConfiguration查看自动配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">在.yml增加以下配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token key atrule">spring</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> 192.168.56.10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:#475569">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">6379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">3.使用SpringBoot自动配置好的RedisTemplate或者StringRedisTemplate即可操作redis</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">【一般使用StringRedisTemplate】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2测试用例">2.测试用例<a href="#2测试用例" class="hash-link" aria-label="Direct link to 2.测试用例" title="Direct link to 2.测试用例">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    StringRedisTemplate stringRedisTemplate;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 测试redis</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    void testRedis() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 获取操作对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 存储</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ops.set(&quot;hello&quot;, &quot;world&quot; + UUID.randomUUID());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 获取</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(ops.get(&quot;hello&quot;));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/e6ec18b8b7caf07fd7ff360d4d636159.png" alt="1635514358072" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3lettuce-堆外内存溢出springboot232-已解决">3.lettuce 堆外内存溢出（springboot2.3.2 已解决）<a href="#3lettuce-堆外内存溢出springboot232-已解决" class="hash-link" aria-label="Direct link to 3.lettuce 堆外内存溢出（springboot2.3.2 已解决）" title="Direct link to 3.lettuce 堆外内存溢出（springboot2.3.2 已解决）">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31lettucejedisredistemplate">3.1.lettuce、jedis、redistemplate<a href="#31lettucejedisredistemplate" class="hash-link" aria-label="Direct link to 3.1.lettuce、jedis、redistemplate" title="Direct link to 3.1.lettuce、jedis、redistemplate">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">三者分别是什么？</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	lettuce：redis的客户端，对redis操作进行封装，内部使用netty进行网络通信，性能很强</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	jedis：redis的客户端，对redis操作进行封装，停止更新了</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	redistemplate：是springboot对redis客户端的再封装</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32原因">3.2.原因<a href="#32原因" class="hash-link" aria-label="Direct link to 3.2.原因" title="Direct link to 3.2.原因">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">异常描述：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	当进行压力测试时后期出现堆外内存溢出OutOfDirectMemoryError（压力测试指查询缓存数据）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">原因：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">）springboot2.</span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain">以后默认使用lettuce作为操作redis的客户端，它使用netty进行网络通信，使用netty创建连接时未及时释放连接</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">）如果没有为netty指定对外内存，默认使用Xms的值（使用-Dio.netty.maxDirectMemory设置值）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">解决：（只是调大堆外内存治标不治本）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：升级lettuce客户端（</span><span class="token number" style="color:#B5CEA8">2.3</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">已解决）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：切换使用jedis</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33解决方法切换-jedis">3.3.解决方法：切换 jedis<a href="#33解决方法切换-jedis" class="hash-link" aria-label="Direct link to 3.3.解决方法：切换 jedis" title="Direct link to 3.3.解决方法：切换 jedis">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">步骤：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">排除lettuce依赖，导入jedis</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">&lt;!--redis启动器--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">spring-boot-starter-data-redis</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">exclusions</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">&lt;!--排除springboot默认的redis客户端lettus--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">exclusion</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">io.lettuce</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">lettuce-core</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">exclusion</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">exclusions</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">&lt;!--jedis，操作redis的客户端--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">redis.clients</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">jedis</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4缓存失效问题">4.缓存失效问题<a href="#4缓存失效问题" class="hash-link" aria-label="Direct link to 4.缓存失效问题" title="Direct link to 4.缓存失效问题">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">读模式，会存在缓存失效问题：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	缓存穿透、雪崩、击穿</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41缓存穿透不存在的数据">4.1.缓存穿透（不存在的数据）<a href="#41缓存穿透不存在的数据" class="hash-link" aria-label="Direct link to 4.1.缓存穿透（不存在的数据）" title="Direct link to 4.1.缓存穿透（不存在的数据）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">缓存穿透</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	查询一个一定不存在的数据，导致一定会查询缓存+查询DB，缓存失去意义（大并发过来时任然会查询db）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">风险：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	利用不存在的数据进行攻击，数据库顺时压力增大，最终导致崩溃</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：将</span><span class="token null keyword" style="color:#0c4a6e">null</span><span class="token plain">结果缓存，并加入短暂过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	弊端：查询条件使用UUID生成，仍然出现缓存穿透问题，并且redis存满了</span><span class="token null keyword" style="color:#0c4a6e">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：布隆过滤器，不放行不存在的查询</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    在redis维护id的hash表过滤掉id不存在的查询（不到达DB层查询）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42缓存雪崩大面积失效">4.2.缓存雪崩（大面积失效）<a href="#42缓存雪崩大面积失效" class="hash-link" aria-label="Direct link to 4.2.缓存雪崩（大面积失效）" title="Direct link to 4.2.缓存雪崩（大面积失效）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">缓存雪崩：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	高并发状态下，大面积redis数据失效，导致所有查询到达DB，DB瞬时压力过重雪崩</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：规避雪崩，设置随机的有效时间（实际上无需设置随机时间，因为每个缓存放入库中的时间本身就不固定）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		让每一个缓存过期时间重复率降低，</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：永不失效</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		事前：尽量保证整个 redis 集群的高可用性，发现机器宕机尽快补上。选择合适的内存淘汰策略。</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		事中：本地ehcache缓存 + hystrix限流&amp;降级，避免MySQL崩掉</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		事后：利用 redis 持久化机制保存的数据尽快恢复缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">问题：如果已经出现了缓存雪崩，如何解决？</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：熔断、降级</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43缓存击穿一条失效">4.3.缓存击穿（一条失效）<a href="#43缓存击穿一条失效" class="hash-link" aria-label="Direct link to 4.3.缓存击穿（一条失效）" title="Direct link to 4.3.缓存击穿（一条失效）">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">缓存击穿：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	高并发状态下，一条数据过期，所有请求到达DB</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：加分布式锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	例原子操作（Redis的SETNX或者Memcache的ADD）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	流程：查询cache失败，竞争锁，竞争成功查询cache，查询成功返回释放锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		查询失败则查询DB，并set缓存，并释放锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	方法</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：永不失效</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44锁时效问题">4.4.锁时效问题<a href="#44锁时效问题" class="hash-link" aria-label="Direct link to 4.4.锁时效问题" title="Direct link to 4.4.锁时效问题">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">结果放入缓存的操作，应该放在同步代码块内，否则会造成重复查询DB的情况</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/be95534b068f7f8be7e8d5c4377b2aa4.png" alt="1635663356474" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="45模拟分布式本地锁失效">4.5.模拟分布式本地锁失效<a href="#45模拟分布式本地锁失效" class="hash-link" aria-label="Direct link to 4.5.模拟分布式本地锁失效" title="Direct link to 4.5.模拟分布式本地锁失效">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.启动多份配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.修改压测配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	gulimall.com	</span><span class="token number" style="color:#B5CEA8">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /index/catalog.json</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.开始压测</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">100</span><span class="token plain">个线程  循环</span><span class="token number" style="color:#B5CEA8">5</span><span class="token plain">次</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">4</span><span class="token plain">.本地锁失效，多次查询数据库</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/3d46f1e3482acf3f6f0875f4bab56c39.png" alt="1635663592317" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5分布式锁">5.分布式锁<a href="#5分布式锁" class="hash-link" aria-label="Direct link to 5.分布式锁" title="Direct link to 5.分布式锁">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">文档</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">：http</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//redisdoc.com/string/set.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">文档</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">：http</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//www.redis.cn/commands/set.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/ea0581f01b74a64a5778f334088d374d.png" alt="1635664198425" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51演示分布式锁-setnx">5.1.演示分布式锁 SETNX<a href="#51演示分布式锁-setnx" class="hash-link" aria-label="Direct link to 5.1.演示分布式锁 SETNX" title="Direct link to 5.1.演示分布式锁 SETNX">​</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">1.打开多个sh框</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">2.打开xshell撰写栏（查看-&gt;撰写-&gt;撰写栏）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">3.编辑命令，发送给多个窗口，同时连接redis客户端</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">docker exec -it redis redis-cli</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">4.编辑命令，发送给多个窗口，同时占锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">set key value NX</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">返回OK表示占锁成功，返回nill占锁失败</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">5.设置锁过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">set key value EX 300 NX</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">6.查看锁过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">ttl lock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>发送命令至全部会话：</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/248e4e439b6d2ae713eeb21837acc0c2.png" alt="1635669533421" class="img_ev3q"></p>
<p>锁值：</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/b864eb8a242754d33025528974ed69b1.png" alt="1635670061333" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52问题合集">5.2.问题合集<a href="#52问题合集" class="hash-link" aria-label="Direct link to 5.2.问题合集" title="Direct link to 5.2.问题合集">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">问题1：（删除锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	未执行删除锁逻辑，会导致其他线程无法获得锁，出现死锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">问题2：（设置过期时间）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    锁释放操作可能失败（服务宕机），所以需要设置过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">问题3：（设置过期时间的原子性）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    设置过期时间的代码必须在setnx抢占锁的同时设置，保证原子性</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">问题4：（仅可以删除当前线程占用的锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    删除锁时，可能锁已过期删除了其他线程的锁，占锁时设置值为uuid，删除时判断当前uuid是否相等</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    并且需要使用lua脚本执行原子删除操作</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/a28c0b0a90e35fc592f9991a1461c9e5.png" alt="1635670158689" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/af2562bcefc63a2489cb7d4bbf323a74.png" alt="1635673350495" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53redis-分布式锁版本">5.3.redis 分布式锁版本<a href="#53redis-分布式锁版本" class="hash-link" aria-label="Direct link to 5.3.redis 分布式锁版本" title="Direct link to 5.3.redis 分布式锁版本">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查询三级分类（原生版redis分布式锁版本）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public Map&lt;String, List&lt;Catalog2VO&gt;&gt; getCatalogJsonFromDBWithRedisLock() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1.抢占分布式锁，同时设置过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    String uuid = UUID.randomUUID().toString();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 使用setnx占锁（setIfAbsent）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    Boolean isLock = redisTemplate.opsForValue().setIfAbsent(CategoryConstant.LOCK_KEY_CATALOG_JSON, uuid, 300, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (isLock) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 2.抢占成功</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = null;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 查询DB</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return getCatalogJsonFromDB();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 3.查询UUID是否是自己，是自己的lock就删除</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 封装lua脚本（原子操作解锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 查询+删除（当前值与目标值是否相等，相等执行删除，不等返回0）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            String luaScript = &quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1]\n&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;then\n&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;    return redis.call(&#x27;del&#x27;,KEYS[1])\n&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;else\n&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;    return 0\n&quot; +</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    &quot;end&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 删除锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            redisTemplate.execute(new DefaultRedisScript&lt;Long&gt;(luaScript, Long.class), Arrays.asList(CategoryConstant.LOCK_KEY_CATALOG_JSON), uuid);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 4.加锁失败，自旋重试</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            Thread.sleep(200);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return getCatalogJsonFromDBWithRedisLock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Redisson</h1>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">文档：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">https</span><span class="token operator" style="color:#475569">:</span><span class="token comment" style="color:#6A9955">//github.com/redisson/redisson/wiki/Table-of-Content</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1概述">1.概述<a href="#1概述" class="hash-link" aria-label="Direct link to 1.概述" title="Direct link to 1.概述">​</a></h2>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.不推荐直接使用SETNX实现分布式锁，应该使用Redisson</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">因为根据锁的实现会分为</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	读写锁、可重入锁、闭锁、信号量、</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.封装了分布式Map、List等类型</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.Redisson与lettuce、jedis一样都是redis的客户端，代替了redisTemplate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2使用原生-redisson看门狗">2.使用原生 redisson(看门狗)<a href="#2使用原生-redisson看门狗" class="hash-link" aria-label="Direct link to 2.使用原生 redisson(看门狗)" title="Direct link to 2.使用原生 redisson(看门狗)">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">步骤：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">1.引入依赖</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;!--redisson，redis客户端，封装了分布式锁实现，也可以使用springboot的方式，不需要自己配置--&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;artifactId&gt;redisson&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;version&gt;3.13.3&lt;/version&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">2.配置类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.redisson.Redisson;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.redisson.api.RedissonClient;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.redisson.config.Config;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyRedissonConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 注入客户端实例对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean(destroyMethod=&quot;shutdown&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public RedissonClient redisson(@Value(&quot;${spring.redis.host}&quot;) String host, @Value(&quot;${spring.redis.port}&quot;)String port) throws IOException {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 1.创建配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Config config = new Config();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        config.useSingleServer().setAddress(&quot;redis://&quot; + host + &quot;:&quot; + port);// 单节点模式</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">//        config.useSingleServer().setAddress(&quot;rediss://&quot; + host + &quot;:&quot; + port);// 使用安全连接</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">//        config.useClusterServers().addNodeAddress(&quot;127.0.0.1:7004&quot;, &quot;127.0.0.1:7001&quot;);// 集群模式</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 2.创建redisson客户端实例</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        RedissonClient redissonClient = Redisson.create(config);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return redissonClient;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21可重入锁">2.1.可重入锁<a href="#21可重入锁" class="hash-link" aria-label="Direct link to 2.1.可重入锁" title="Direct link to 2.1.可重入锁">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">redisson实现了JUC包下的可重入锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">RLock lock = redissonClient.getLock(&quot;redisson_lock&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22过期时间自动续期手动释放lua-原子操作">2.2.过期时间、自动续期、手动释放（lua 原子操作）<a href="#22过期时间自动续期手动释放lua-原子操作" class="hash-link" aria-label="Direct link to 2.2.过期时间、自动续期、手动释放（lua 原子操作）" title="Direct link to 2.2.过期时间、自动续期、手动释放（lua 原子操作）">​</a></h3>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">原理：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	// 1）默认过期时间30S</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 2）锁自动续期+30S，业务超长情况下（看门狗）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 3）如果线程宕机，看门狗不会自动续期，锁会自动过期</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 4）unlock使用lua脚本释放锁，不会出现误删锁</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">代码案例：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 测试redisson实现分布式锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@ResponseBody</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@GetMapping(&quot;/testRedisson&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public String test() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1.获取锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RLock lock = redissonClient.getLock(&quot;redisson_lock&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 2.加锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1）锁自动续期+30S，业务超长情况下（看门狗）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 2）如果线程宕机，看门狗不会自动续期，锁会自动过期</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 3）unlock使用lua脚本释放锁，不会出现误删锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    lock.lock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 加锁成功，执行业务</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;加锁成功，执行业务...&quot; + Thread.currentThread().getId());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Thread.sleep(30000);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 3.解锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(&quot;解锁...&quot; + Thread.currentThread().getId());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        lock.unlock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return &quot;testRedisson&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23指定超时不自动续期">2.3.指定超时不自动续期<a href="#23指定超时不自动续期" class="hash-link" aria-label="Direct link to 2.3.指定超时不自动续期" title="Direct link to 2.3.指定超时不自动续期">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.查看源码</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">）当不指定超时时间时，默认30S过期，且启动一个定时任务【自动续期任务】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		续期时间点=默认过期时间/</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">，没隔10S执行一次续期</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">）当指定超时时间时，不会自动续期</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.推荐设置过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">）可以省略自动续期操作</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">）若真的超时未完成，则很有可能是数据库宕机，即使续期也无法完成，不应该无限续期下去</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 测试redisson实现分布式锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@ResponseBody</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@GetMapping(</span><span class="token string" style="color:#64748b">&quot;/testRedisson&quot;</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public String test() </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 1.获取锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RLock lock = redissonClient.getLock(</span><span class="token string" style="color:#64748b">&quot;redisson_lock&quot;</span><span class="token plain">);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 2.加锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 1）锁自动续期+30S，业务超长情况下（看门狗）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 2）如果线程宕机，看门狗不会自动续期，锁会自动过期</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 3）unlock使用lua脚本释放锁，不会出现误删锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    lock.lock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    try </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 加锁成功，执行业务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(</span><span class="token string" style="color:#64748b">&quot;加锁成功，执行业务...&quot;</span><span class="token plain"> + Thread.currentThread().getId());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Thread.sleep(</span><span class="token number" style="color:#B5CEA8">30000</span><span class="token plain">);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> catch (Exception e) </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> finally </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 3.解锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        System.out.println(</span><span class="token string" style="color:#64748b">&quot;解锁...&quot;</span><span class="token plain"> + Thread.currentThread().getId());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        lock.unlock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return </span><span class="token string" style="color:#64748b">&quot;testRedisson&quot;</span><span class="token plain">;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24trylock">2.4.tryLock<a href="#24trylock" class="hash-link" aria-label="Direct link to 2.4.tryLock" title="Direct link to 2.4.tryLock">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// 尝试加锁，最多等待100秒</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 超时时间30秒</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">lock.tryLock(100, 30, TimeUnit.SECONDS);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="25公平锁">2.5.公平锁<a href="#25公平锁" class="hash-link" aria-label="Direct link to 2.5.公平锁" title="Direct link to 2.5.公平锁">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// 有顺序进行加锁操作，按照请求的顺序</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">RLock lock = redisson.getFairLock(&quot;fair-lock&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="26读写锁">2.6.读写锁<a href="#26读写锁" class="hash-link" aria-label="Direct link to 2.6.读写锁" title="Direct link to 2.6.读写锁">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">写+读：读阻塞</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">写+写：阻塞</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">读+写：写阻塞</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">RReadWriteLock rwlock = redisson.getReadWriteLock(&quot;lock&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 读锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">rwlock.readLock().lock(10, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">// 写锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">rwlock.writeLock().lock(10, TimeUnit.SECONDS);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>写锁：</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/1f9d99b814f28b20ee7a1ca08c3085d9.png" alt="1597734236213" class="img_ev3q"></p>
<p>读锁：</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/fdbd1ec9ca37c46557970301e56735b0.png" alt="1597734296729" class="img_ev3q"></p>
<p>读锁同时存入多个：</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/4a47fd299603171ca6126e91410698c6.png" alt="1597735057026" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="27信号量-semphore">2.7.信号量 Semphore<a href="#27信号量-semphore" class="hash-link" aria-label="Direct link to 2.7.信号量 Semphore" title="Direct link to 2.7.信号量 Semphore">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">先设置一个值</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token string" style="color:#64748b">&quot;park&quot;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">acquire：获取一个信号量，为</span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain">阻塞</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">release：释放一个信号量，+</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">tryacquire：尝试获取一个信号量，不阻塞</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">作用：【限流】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	所有服务上来了去获取一个信号量，一个一个放行（最多只能n个线程同时执行）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/9eda4760d793430502cc2a7e61f78be2.png" alt="1635689277138" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="28闭锁-countdownlatch">2.8.闭锁 CountDownLatch<a href="#28闭锁-countdownlatch" class="hash-link" aria-label="Direct link to 2.8.闭锁 CountDownLatch" title="Direct link to 2.8.闭锁 CountDownLatch">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">// 等待一组操作执行完毕，统一执行</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/1b58fc947f819eab3b7d1faed1f2e0aa.png" alt="1635689625640" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="29锁的粒度">2.9.锁的粒度<a href="#29锁的粒度" class="hash-link" aria-label="Direct link to 2.9.锁的粒度" title="Direct link to 2.9.锁的粒度">​</a></h3>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">锁的粒度一定要小，例如不应该锁整个商品操作，应该带上商品ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="210redisson-分布式锁版本">2.10.redisson 分布式锁版本<a href="#210redisson-分布式锁版本" class="hash-link" aria-label="Direct link to 2.10.redisson 分布式锁版本" title="Direct link to 2.10.redisson 分布式锁版本">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查询三级分类（redisson分布式锁版本）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public Map&lt;String, List&lt;Catalog2VO&gt;&gt; getCatalogJsonFromDBWithRedissonLock() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1.抢占分布式锁，同时设置过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RLock lock = redisson.getLock(CategoryConstant.LOCK_KEY_CATALOG_JSON);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    lock.lock(30, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 2.查询DB</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = getCatalogJsonFromDB();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 3.释放锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        lock.unlock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>数据一致性</h1>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">写模式，会存在数据一致性问题：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain">.加读写锁实现（所以对一致性高的数据不要放在缓存里）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain">.引入canal，感知mysql更新去更新缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	</span><span class="token number" style="color:#B5CEA8">3</span><span class="token plain">.读多写多，直接查数据库</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1双写模式和失效模式与最终一致性指修改数据方案">1.双写模式和失效模式与最终一致性（指修改数据方案）<a href="#1双写模式和失效模式与最终一致性指修改数据方案" class="hash-link" aria-label="Direct link to 1.双写模式和失效模式与最终一致性（指修改数据方案）" title="Direct link to 1.双写模式和失效模式与最终一致性（指修改数据方案）">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">注：双写模式和失效模式都会导致数据一致性问题（写和读操作并发时导致，解决，读与写操作加读写锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">双写模式：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	描述：同时写</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	漏洞：缓存有脏数据。操作1写缓存慢于操作2写缓存，导致缓存与DB数据不一致</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		方案1：写数据库+写缓存整个加锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		方案2：业务是否允许暂时性数据不一致问题，若允许则给数据设置一个过期时间即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">失效模式：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	描述：DB写完，删除缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	注：下图有错误，用户3先读db-1，然后用户2再写db-2，用户2删缓存，用户3写缓存【写入脏数据1】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	漏洞：缓存有脏数据。用户3将db-1写入了缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	解决：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		方案1：写数据库+写缓存整个加锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		方案2：业务是否允许暂时性数据不一致问题，若允许则给数据设置一个过期时间即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">二者都有脏数据的可能性</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/3bc73ac0016d1ed91c347245baea2116.png" alt="1635691115207" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/44b77e5f585e1a0e1008fb76469a1a37.png" alt="1635692249946" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2解决方案选用失效模式">2.解决方案（选用失效模式）<a href="#2解决方案选用失效模式" class="hash-link" aria-label="Direct link to 2.解决方案（选用失效模式）" title="Direct link to 2.解决方案（选用失效模式）">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">三种方案：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	1.仅加过期时间即可（首先考虑业务造成脏数据的概率，例如用户维度数据（订单数据、用户数据）并发几率很小，每过一段时间触发读的主动更新）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	2.canal订阅binlog的方式（菜单、商品介绍等基础数据）【完美解决】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	3.加读写锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	4.实时性、一致性要求高的数据，应该直接查数据库</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">最终方案：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    1.所有数据加上过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    2.读写数据加分布式读写锁（经常写的数据不要放在缓存里）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21canal">2.1.canal<a href="#21canal" class="hash-link" aria-label="Direct link to 2.1.canal" title="Direct link to 2.1.canal">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">canal：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    阿里开源的中间件，可以作为数据库的从服务器，订阅数据库的binlog日志，数据更新canal也同步更新redis</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">另一作用：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    解析不同的表日志分析计算生成一张新的表记录</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    案例：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    	根据用户访问的商品记录、订单记录 + 商品记录表共同生成一张用户推荐表，展示首页的数据（每个用户的首页推荐数据是不一样的）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/27cfae800161100cbfa0cde09b7f5dd4.png" alt="1635863295094" class="img_ev3q"></p>
<h1>SpringCache</h1>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">简介：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    通过注解实现缓存；属于spring内容不是springboot</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">文档：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#spring-integration</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/d703a0d4ffa78a0ca6487f6b70e350b8.png" alt="1597740655126" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1整合">1.整合<a href="#1整合" class="hash-link" aria-label="Direct link to 1.整合" title="Direct link to 1.整合">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">注：name::key，缓存区域化指name，key是键</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">1.引入SpringCache依赖</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;!--Spring Cache，使用注解简化开发--&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">2.引入redis依赖</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;!--redis启动器--&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">&lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">3.这一步只是查看一下自动配置类+属性类，没有实际编码动作</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    1）自动配置以下内容：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    属性类：CacheProperties.java【属性以spring.cache开头】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    自动配置类：CacheAutoConfiguration.java【会导入RedisCacheConfiguration配置】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    redis自动配置类：RedisCacheConfiguration.java【往IOC注入了redis缓存管理器】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    redis缓存管理器：RedisCacheManager【会初始化所有缓存（决定每个缓存使用什么配置）】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    	【如果RedisCacheConfiguration有就使用，没有就使用默认的（导致缓存使用默认配置，默认配置值来自于this.cacheProperties.getRedis()）】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    注：缓存区域化只是springcache的内容，在redis里数据存放没有区域化的概念，体现为 name::key</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">4.注解解释：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		@Cacheable：更新缓存【读操作：如果当前缓存存在方法不被执行，不存在则执行get方法并更新缓存】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		@CacheEvict：删除缓存【写操作：失效模式，方法执行完删除缓存】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		@CachePut：更新缓存【写操作：双写模式，方法执行完更新缓存】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		@Caching：组合以上多个缓存操作</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">		@CacheConfig：在类级别共享缓存的相同配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">5.属性</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  redis:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    host: 192.168.56.10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    port: 6379</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">  cache:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    type: redis # 使用redis作为缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    redis:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      time-to-live: 3600s # 过期时间</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      # key-prefix: CACHE_ # 会导致自己在@Cacheable里设置的名字失效，所以这里不指定</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      use-key-prefix: true # key值加前缀</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">      cache-null-values: true # 缓存控制</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">6.默认行为：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	key自动生成：缓存名字::key值</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    默认过期时间：-1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    value值默认序列化方式：jdk序列化【值使用jdk序列化后存放到redis】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">7.自定义行为</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    缓存名字：value = {&quot;category&quot;}【区域划分】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	key值：key = &quot;&#x27;levelCategorys&#x27;&quot;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        【接收一个SpEl表达式，可以获取当前方法名，参数列表，单引号表字符串】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        【使用方法名作为key：&quot;#root.method.name&quot;】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    过期时间：在application.yml中指定</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    修改序列化方式要在配置类中修改</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">8.配置类【添加@EnableCache使用springcache】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@EnableConfigurationProperties(CacheProperties.class)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@EnableCaching</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class MyCacheConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">//    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">//    CacheProperties cacheProperties;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 需要将配置文件中的配置设置上</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1、使配置类生效</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 1）开启配置类与属性绑定功能EnableConfigurationProperties</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @ConfigurationProperties(prefix = &quot;spring.cache&quot;)  public class CacheProperties</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2）注入就可以使用了</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @Autowired CacheProperties cacheProperties;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 3）直接在方法参数上加入属性参数redisCacheConfiguration(CacheProperties redisProperties)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 自动从IOC容器中找</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * &lt;p&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * 2、给config设置上</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RedisCacheConfiguration redisCacheConfiguration(CacheProperties cacheProperties) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 当自己往IOC注入了RedisCacheConfiguration配置类时，以下参数全都失效，需要手动设置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CacheProperties.Redis redisProperties = cacheProperties.getRedis();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (redisProperties.getTimeToLive() != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (redisProperties.getKeyPrefix() != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            config = config.prefixCacheNameWith(redisProperties.getKeyPrefix());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!redisProperties.isCacheNullValues()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            config = config.disableCachingNullValues();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!redisProperties.isUseKeyPrefix()) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            config = config.disableKeyPrefix();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return config;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">9.使用案例：在service层代码上添加注解</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查出所有1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public List&lt;CategoryEntity&gt; getLevel1Categorys() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    System.out.println(&quot;调用了getLevel1Categorys...&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 查询父id=0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_cid&quot;, 0));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>redis 缓存管理器源码，会初始化过期时间、key 前缀、空数据是否缓存、是否使用缓存前缀<img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/205896a194286a529fa05b2ab6edcec1.png" alt="1636030148580" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2读模式与写模式">2.读模式与写模式<a href="#2读模式与写模式" class="hash-link" aria-label="Direct link to 2.读模式与写模式" title="Direct link to 2.读模式与写模式">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21读模式">2.1.读模式<a href="#21读模式" class="hash-link" aria-label="Direct link to 2.1.读模式" title="Direct link to 2.1.读模式">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">直接在get方法上添加@Cacheable即可</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查出所有1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public List&lt;CategoryEntity&gt; getLevel1Categorys() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    System.out.println(&quot;调用了getLevel1Categorys...&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 查询父id=0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_cid&quot;, 0));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22写模式">2.2.写模式<a href="#22写模式" class="hash-link" aria-label="Direct link to 2.2.写模式" title="Direct link to 2.2.写模式">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="失效模式">失效模式<a href="#失效模式" class="hash-link" aria-label="Direct link to 失效模式" title="Direct link to 失效模式">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 级联更新</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 缓存策略：失效模式，方法执行完删除缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public void updateCascade(CategoryEntity category) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    this.updateById(category);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (!StringUtils.isEmpty(category.getName())) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 更新冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // TODO 更新其他冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="双写模式">双写模式<a href="#双写模式" class="hash-link" aria-label="Direct link to 双写模式" title="Direct link to 双写模式">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 级联更新</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 缓存策略：双写模式，方法执行完更新缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@CachePut(value = &quot;category&quot;, key = &quot;&#x27;level1Categorys&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public void updateCascade(CategoryEntity category) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    this.updateById(category);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (!StringUtils.isEmpty(category.getName())) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 更新冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // TODO 更新其他冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23caching失效模式解决击穿雪崩穿透分布式锁">2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）<a href="#23caching失效模式解决击穿雪崩穿透分布式锁" class="hash-link" aria-label="Direct link to 2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）" title="Direct link to 2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">失效模式，级联更新类型时，删除与类型相关的所有缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">两种方式：</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    方式1：指定每个key</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Caching(evict = {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        @CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;),</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        @CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    方式2：直接删除区域化内所有缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @CacheEvict(value = {&quot;category&quot;}, allEntries = true)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 级联更新所有关联表的冗余数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 缓存策略：失效模式，方法执行完删除缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@CacheEvict(value = {&quot;category&quot;}, allEntries = true)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public void updateCascade(CategoryEntity category) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    this.updateById(category);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (!StringUtils.isEmpty(category.getName())) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 更新冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // TODO 更新其他冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查出所有1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public List&lt;CategoryEntity&gt; getLevel1Categorys() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    System.out.println(&quot;调用了getLevel1Categorys...&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 查询父id=0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_cid&quot;, 0));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查询三级分类并封装成Map返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 使用SpringCache注解方式简化缓存设置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public Map&lt;String, List&lt;Catalog2VO&gt;&gt; getCatalogJsonWithSpringCache() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 未命中缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1.抢占分布式锁，同时设置过期时间【不使用读写锁，因为就是为了防止缓存击穿】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    RLock lock = redisson.getLock(CategoryConstant.LOCK_KEY_CATALOG_JSON);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    lock.lock(30, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 2.double check，占锁成功需要再次检查缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 查询非空即返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        String catlogJSON = redisTemplate.opsForValue().get(&quot;getCatalogJson&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        if (!StringUtils.isEmpty(catlogJSON)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 查询成功直接返回不需要查询DB</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = JSON.parseObject(catlogJSON, new TypeReference&lt;Map&lt;String, List&lt;Catalog2VO&gt;&gt;&gt;() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 3.查询所有分类，按照parentCid分组</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;Long, List&lt;CategoryEntity&gt;&gt; categoryMap = baseMapper.selectList(null).stream()</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                .collect(Collectors.groupingBy(key -&gt; key.getParentCid()));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 4.获取1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        List&lt;CategoryEntity&gt; level1Categorys = categoryMap.get(0L);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 5.封装数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = level1Categorys.stream().collect(Collectors.toMap(key -&gt; key.getCatId().toString(), l1Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 6.查询2级分类，并封装成List&lt;Catalog2VO&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            List&lt;Catalog2VO&gt; catalog2VOS = categoryMap.get(l1Category.getCatId())</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    .stream().map(l2Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // 7.查询3级分类，并封装成List&lt;Catalog3VO&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        List&lt;Catalog2VO.Catalog3Vo&gt; catalog3Vos = categoryMap.get(l2Category.getCatId())</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                .stream().map(l3Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                    // 封装3级分类VO</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                    Catalog2VO.Catalog3Vo catalog3Vo = new Catalog2VO.Catalog3Vo(l2Category.getCatId().toString(), l3Category.getCatId().toString(), l3Category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                    return catalog3Vo;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                }).collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        // 封装2级分类VO返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        Catalog2VO catalog2VO = new Catalog2VO(l1Category.getCatId().toString(), catalog3Vos, l2Category.getCatId().toString(), l2Category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        return catalog2VO;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    }).collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            return catalog2VOS;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 8.释放锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        lock.unlock();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4细节">4.细节<a href="#4细节" class="hash-link" aria-label="Direct link to 4.细节" title="Direct link to 4.细节">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21configurationproperties-标注方法上使用">2.1.@ConfigurationProperties 标注方法上使用<a href="#21configurationproperties-标注方法上使用" class="hash-link" aria-label="Direct link to 2.1.@ConfigurationProperties 标注方法上使用" title="Direct link to 2.1.@ConfigurationProperties 标注方法上使用">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">使用@ConfigurationProperties标注在方法上使用时必须配合@Bean + @Configuration使用</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class DruidDataSourceConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * DataSource 配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @ConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean(name = &quot;readDruidDataSource&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public DataSource readDruidDataSource() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new DruidDataSource();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * DataSource 配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @ConfigurationProperties(prefix = &quot;spring.datasource.druid.write&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean(name = &quot;writeDruidDataSource&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Primary</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public DataSource writeDruidDataSource() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new DruidDataSource();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.write.username=root</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.write.password=1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.write.driver-class-name=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.read.url=jdbc:mysql://localhost:3306/jpa</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.read.username=root</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.read.password=1</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.druid.read.driver-class-name=com.mysql.jdbc.Driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22configurationproperties-标注类上使用">2.2.@ConfigurationProperties 标注类上使用<a href="#22configurationproperties-标注类上使用" class="hash-link" aria-label="Direct link to 2.2.@ConfigurationProperties 标注类上使用" title="Direct link to 2.2.@ConfigurationProperties 标注类上使用">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Setter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class DatasourcePro {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private String url;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private String password;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 配置文件中是driver-class-name, 转驼峰命名便可以绑定成</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private String driverClassName;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private String type;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Controller</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@RequestMapping(value = &quot;/config&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class ConfigurationPropertiesController {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    private DatasourcePro datasourcePro;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @RequestMapping(&quot;/test&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @ResponseBody</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public Map&lt;String, Object&gt; test(){</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        map.put(&quot;url&quot;, datasourcePro.getUrl());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        map.put(&quot;userName&quot;, datasourcePro.getUsername());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        map.put(&quot;password&quot;, datasourcePro.getPassword());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        map.put(&quot;className&quot;, datasourcePro.getDriverClassName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        map.put(&quot;type&quot;, datasourcePro.getType());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return map;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.url=jdbc:mysql://127.0.0.1:8888/test?useUnicode=false&amp;autoReconnect=true&amp;characterEncoding=utf-8</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.username=root</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.password=root</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">spring.datasource.type=com.alibaba.druid.pool.DruidDataSource</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-enableconfigurationproperties-标注在类上使用">2.3. @EnableConfigurationProperties 标注在类上使用<a href="#23-enableconfigurationproperties-标注在类上使用" class="hash-link" aria-label="Direct link to 2.3. @EnableConfigurationProperties 标注在类上使用" title="Direct link to 2.3. @EnableConfigurationProperties 标注在类上使用">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">@EnableConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public class DruidDataSourceConfig {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * DataSource 配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @ConfigurationProperties(prefix = &quot;spring.datasource.druid.read&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean(name = &quot;readDruidDataSource&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public DataSource readDruidDataSource(JDBCProperties properties) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        DruidDataSource dataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // dataSource.setUrl(properties.getXX)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return dataSource;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * DataSource 配置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @ConfigurationProperties(prefix = &quot;spring.datasource.druid.write&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Bean(name = &quot;writeDruidDataSource&quot;)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    @Primary</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    public DataSource writeDruidDataSource() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return new DruidDataSource();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5spring-cache-不足">5.spring-cache 不足<a href="#5spring-cache-不足" class="hash-link" aria-label="Direct link to 5.spring-cache 不足" title="Direct link to 5.spring-cache 不足">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">1、读模式:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	缓存穿透:查询一个DB不存在的数据。解决:缓存空数据;ache-null-values=true【布隆过滤器】</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	缓存击穿:大量并发进来同时查询一个正好过期的数据。解决:加锁; 默认未加锁【sync = true】只是本地锁</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	缓存雪崩:大量的key同时过期。解决:加上过期时间。: spring.cache.redis.time-to-live= 360000s</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">2、写模式:（缓存与数据库一致)（没有解决）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	1)、手动读写加锁。</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	2)、引入canal，感知mysql的更新去更新缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	3)、读多写多，直接去查询数据库就行</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">总结:</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	常规数据（读多写少，即时性，一致性要求不高的数据）﹔完全可以使用Spring-Cache，写模式(只要缓存的数据有过期时间就可以）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">	特殊数据:特殊设计（canal、读写锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">在RedisCache里面打断点查看get同步方法</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="最终版失效模式解决击穿雪崩穿透本地锁">最终版：失效模式+解决击穿、雪崩、穿透（本地锁）<a href="#最终版失效模式解决击穿雪崩穿透本地锁" class="hash-link" aria-label="Direct link to 最终版：失效模式+解决击穿、雪崩、穿透（本地锁）" title="Direct link to 最终版：失效模式+解决击穿、雪崩、穿透（本地锁）">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 级联更新所有关联表的冗余数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 缓存策略：失效模式，方法执行完删除缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@CacheEvict(value = {&quot;category&quot;}, allEntries = true)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public void updateCascade(CategoryEntity category) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    this.updateById(category);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (!StringUtils.isEmpty(category.getName())) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 更新冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // TODO 更新其他冗余表</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查出所有1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;getLevel1Categorys&#x27;&quot;, sync = true)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public List&lt;CategoryEntity&gt; getLevel1Categorys() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    System.out.println(&quot;调用了getLevel1Categorys...&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 查询父id=0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_cid&quot;, 0));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 查询三级分类并封装成Map返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 使用SpringCache注解方式简化缓存设置</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Cacheable(value = {&quot;category&quot;}, key = &quot;&#x27;getCatalogJson&#x27;&quot;, sync = true)</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public Map&lt;String, List&lt;Catalog2VO&gt;&gt; getCatalogJsonWithSpringCache() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 未命中缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 1.double check，占锁成功需要再次检查缓存（springcache使用本地锁）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 查询非空即返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    String catlogJSON = redisTemplate.opsForValue().get(&quot;getCatalogJson&quot;);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (!StringUtils.isEmpty(catlogJSON)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 查询成功直接返回不需要查询DB</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = JSON.parseObject(catlogJSON, new TypeReference&lt;Map&lt;String, List&lt;Catalog2VO&gt;&gt;&gt;() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 2.查询所有分类，按照parentCid分组</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    Map&lt;Long, List&lt;CategoryEntity&gt;&gt; categoryMap = baseMapper.selectList(null).stream()</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            .collect(Collectors.groupingBy(key -&gt; key.getParentCid()));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 3.获取1级分类</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    List&lt;CategoryEntity&gt; level1Categorys = categoryMap.get(0L);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 4.封装数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    Map&lt;String, List&lt;Catalog2VO&gt;&gt; result = level1Categorys.stream().collect(Collectors.toMap(key -&gt; key.getCatId().toString(), l1Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 5.查询2级分类，并封装成List&lt;Catalog2VO&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        List&lt;Catalog2VO&gt; catalog2VOS = categoryMap.get(l1Category.getCatId())</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                .stream().map(l2Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // 7.查询3级分类，并封装成List&lt;Catalog3VO&gt;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    List&lt;Catalog2VO.Catalog3Vo&gt; catalog3Vos = categoryMap.get(l2Category.getCatId())</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            .stream().map(l3Category -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                // 封装3级分类VO</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                Catalog2VO.Catalog3Vo catalog3Vo = new Catalog2VO.Catalog3Vo(l2Category.getCatId().toString(), l3Category.getCatId().toString(), l3Category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                                return catalog3Vo;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            }).collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    // 封装2级分类VO返回</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    Catalog2VO catalog2VO = new Catalog2VO(l1Category.getCatId().toString(), catalog3Vos, l2Category.getCatId().toString(), l2Category.getName());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    return catalog2VO;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                }).collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return catalog2VOS;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>StringRedisTemplate</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1一些使用案例">1.一些使用案例<a href="#1一些使用案例" class="hash-link" aria-label="Direct link to 1.一些使用案例" title="Direct link to 1.一些使用案例">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11boundhashoperations">1.1.BoundHashOperations<a href="#11boundhashoperations" class="hash-link" aria-label="Direct link to 1.1.BoundHashOperations" title="Direct link to 1.1.BoundHashOperations">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 根据用户信息获取购物车redis操作对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">private BoundHashOperations&lt;String, Object, Object&gt; getCartOps() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 获取用户登录信息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    UserInfoTO userInfo = CartInterceptor.threadLocal.get();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    String cartKey = &quot;&quot;;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (userInfo.getUserId() != null) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 登录态，使用用户购物车</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        cartKey = CartConstant.CART_PREFIX + userInfo.getUserId();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 非登录态，使用游客购物车</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        cartKey = CartConstant.CART_PREFIX + userInfo.getUserKey();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 绑定购物车的key操作Redis</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    BoundHashOperations&lt;String, Object, Object&gt; operations = redisTemplate.boundHashOps(cartKey);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return operations;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>get 方法：</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 根据skuId获取购物车商品信息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public CartItemVO getCartItem(Long skuId) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 获取购物车redis操作对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    String cartItemJSONString = (String) cartOps.get(skuId.toString());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    CartItemVO cartItemVo = JSON.parseObject(cartItemJSONString, CartItemVO.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    return cartItemVo;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>put 方法：</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> * 添加sku商品到购物车</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">public CartItemVO addToCart(Long skuId, Integer num) throws ExecutionException, InterruptedException {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 获取购物车redis操作对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    BoundHashOperations&lt;String, Object, Object&gt; operations = getCartOps();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    // 获取商品</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    String cartItemJSONString = (String) operations.get(skuId.toString());</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    if (StringUtils.isEmpty(cartItemJSONString)) {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 购物车不存在此商品，需要将当前商品添加到购物车中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CartItemVO cartItem = new CartItemVO();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CompletableFuture&lt;Void&gt; getSkuInfoFuture = CompletableFuture.runAsync(() -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 远程查询当前商品信息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            R r = productFeignService.getInfo(skuId);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            SkuInfoVO skuInfo = r.getData(&quot;skuInfo&quot;, new TypeReference&lt;SkuInfoVO&gt;() {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setSkuId(skuInfo.getSkuId());// 商品ID</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setTitle(skuInfo.getSkuTitle());// 商品标题</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setImage(skuInfo.getSkuDefaultImg());// 商品默认图片</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setPrice(skuInfo.getPrice());// 商品单价</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setCount(num);// 商品件数</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setCheck(true);// 是否选中</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }, executor);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CompletableFuture&lt;Void&gt; getSkuAttrValuesFuture = CompletableFuture.runAsync(() -&gt; {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            // 远程查询attrName:attrValue信息</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            List&lt;String&gt; skuSaleAttrValues = productFeignService.getSkuSaleAttrValues(skuId);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cartItem.setSkuAttrValues(skuSaleAttrValues);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        }, executor);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CompletableFuture.allOf(getSkuInfoFuture, getSkuAttrValuesFuture).get();</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        operations.put(skuId.toString(), JSON.toJSONString(cartItem));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return cartItem;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        // 当前购物车已存在此商品，修改当前商品数量</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        CartItemVO cartItem = JSON.parseObject(cartItemJSONString, CartItemVO.class);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        cartItem.setCount(cartItem.getCount() + num);</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        operations.put(skuId.toString(), JSON.toJSONString(cartItem));</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        return cartItem;</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Java/分布式项目中锁的应用（本地锁-redis【setnx】-redisson-springcache）.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Java/六道入门树题目带你走入树结构的世界"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">六道入门树题目带你走入树结构的世界</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Java/多线程进阶 JUC并发编程"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">多线程进阶 JUC 并发编程</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1适合放入缓存的数据" class="table-of-contents__link toc-highlight">1.适合放入缓存的数据</a></li><li><a href="#2读模式缓存使用流程" class="table-of-contents__link toc-highlight">2.读模式缓存使用流程</a></li><li><a href="#3本地缓存与局限性" class="table-of-contents__link toc-highlight">3.本地缓存与局限性</a></li><li><a href="#4分布式缓存" class="table-of-contents__link toc-highlight">4.分布式缓存</a></li><li><a href="#1使用-springboot-整合-redis" class="table-of-contents__link toc-highlight">1.使用 springboot 整合 redis</a></li><li><a href="#2测试用例" class="table-of-contents__link toc-highlight">2.测试用例</a></li><li><a href="#3lettuce-堆外内存溢出springboot232-已解决" class="table-of-contents__link toc-highlight">3.lettuce 堆外内存溢出（springboot2.3.2 已解决）</a><ul><li><a href="#31lettucejedisredistemplate" class="table-of-contents__link toc-highlight">3.1.lettuce、jedis、redistemplate</a></li><li><a href="#32原因" class="table-of-contents__link toc-highlight">3.2.原因</a></li><li><a href="#33解决方法切换-jedis" class="table-of-contents__link toc-highlight">3.3.解决方法：切换 jedis</a></li></ul></li><li><a href="#4缓存失效问题" class="table-of-contents__link toc-highlight">4.缓存失效问题</a><ul><li><a href="#41缓存穿透不存在的数据" class="table-of-contents__link toc-highlight">4.1.缓存穿透（不存在的数据）</a></li><li><a href="#42缓存雪崩大面积失效" class="table-of-contents__link toc-highlight">4.2.缓存雪崩（大面积失效）</a></li><li><a href="#43缓存击穿一条失效" class="table-of-contents__link toc-highlight">4.3.缓存击穿（一条失效）</a></li><li><a href="#44锁时效问题" class="table-of-contents__link toc-highlight">4.4.锁时效问题</a></li><li><a href="#45模拟分布式本地锁失效" class="table-of-contents__link toc-highlight">4.5.模拟分布式本地锁失效</a></li></ul></li><li><a href="#5分布式锁" class="table-of-contents__link toc-highlight">5.分布式锁</a><ul><li><a href="#51演示分布式锁-setnx" class="table-of-contents__link toc-highlight">5.1.演示分布式锁 SETNX</a></li><li><a href="#52问题合集" class="table-of-contents__link toc-highlight">5.2.问题合集</a></li><li><a href="#53redis-分布式锁版本" class="table-of-contents__link toc-highlight">5.3.redis 分布式锁版本</a></li></ul></li><li><a href="#1概述" class="table-of-contents__link toc-highlight">1.概述</a></li><li><a href="#2使用原生-redisson看门狗" class="table-of-contents__link toc-highlight">2.使用原生 redisson(看门狗)</a><ul><li><a href="#21可重入锁" class="table-of-contents__link toc-highlight">2.1.可重入锁</a></li><li><a href="#22过期时间自动续期手动释放lua-原子操作" class="table-of-contents__link toc-highlight">2.2.过期时间、自动续期、手动释放（lua 原子操作）</a></li><li><a href="#23指定超时不自动续期" class="table-of-contents__link toc-highlight">2.3.指定超时不自动续期</a></li><li><a href="#24trylock" class="table-of-contents__link toc-highlight">2.4.tryLock</a></li><li><a href="#25公平锁" class="table-of-contents__link toc-highlight">2.5.公平锁</a></li><li><a href="#26读写锁" class="table-of-contents__link toc-highlight">2.6.读写锁</a></li><li><a href="#27信号量-semphore" class="table-of-contents__link toc-highlight">2.7.信号量 Semphore</a></li><li><a href="#28闭锁-countdownlatch" class="table-of-contents__link toc-highlight">2.8.闭锁 CountDownLatch</a></li><li><a href="#29锁的粒度" class="table-of-contents__link toc-highlight">2.9.锁的粒度</a></li><li><a href="#210redisson-分布式锁版本" class="table-of-contents__link toc-highlight">2.10.redisson 分布式锁版本</a></li></ul></li><li><a href="#1双写模式和失效模式与最终一致性指修改数据方案" class="table-of-contents__link toc-highlight">1.双写模式和失效模式与最终一致性（指修改数据方案）</a></li><li><a href="#2解决方案选用失效模式" class="table-of-contents__link toc-highlight">2.解决方案（选用失效模式）</a><ul><li><a href="#21canal" class="table-of-contents__link toc-highlight">2.1.canal</a></li></ul></li><li><a href="#1整合" class="table-of-contents__link toc-highlight">1.整合</a></li><li><a href="#2读模式与写模式" class="table-of-contents__link toc-highlight">2.读模式与写模式</a><ul><li><a href="#21读模式" class="table-of-contents__link toc-highlight">2.1.读模式</a></li><li><a href="#22写模式" class="table-of-contents__link toc-highlight">2.2.写模式</a></li><li><a href="#23caching失效模式解决击穿雪崩穿透分布式锁" class="table-of-contents__link toc-highlight">2.3.@Caching+失效模式+解决击穿、雪崩、穿透（分布式锁）</a></li></ul></li><li><a href="#4细节" class="table-of-contents__link toc-highlight">4.细节</a><ul><li><a href="#21configurationproperties-标注方法上使用" class="table-of-contents__link toc-highlight">2.1.@ConfigurationProperties 标注方法上使用</a></li><li><a href="#22configurationproperties-标注类上使用" class="table-of-contents__link toc-highlight">2.2.@ConfigurationProperties 标注类上使用</a></li><li><a href="#23-enableconfigurationproperties-标注在类上使用" class="table-of-contents__link toc-highlight">2.3. @EnableConfigurationProperties 标注在类上使用</a></li></ul></li><li><a href="#5spring-cache-不足" class="table-of-contents__link toc-highlight">5.spring-cache 不足</a><ul><li><a href="#最终版失效模式解决击穿雪崩穿透本地锁" class="table-of-contents__link toc-highlight">最终版：失效模式+解决击穿、雪崩、穿透（本地锁）</a></li></ul></li><li><a href="#1一些使用案例" class="table-of-contents__link toc-highlight">1.一些使用案例</a><ul><li><a href="#11boundhashoperations" class="table-of-contents__link toc-highlight">1.1.BoundHashOperations</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">  来自冷环渊的技术支持与文档创作 @2025</div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-finish/finishRpc" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">finishRpc | 小冷の代码世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://doomwatcher2004.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://doomwatcher2004.github.io/docs/finish/finishRpc"><meta data-rh="true" property="og:locale" content="cn"><meta data-rh="true" name="docusaurus_locale" content="cn"><meta data-rh="true" name="docsearch:language" content="cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="finishRpc | 小冷の代码世界"><meta data-rh="true" name="description" content="简介"><meta data-rh="true" property="og:description" content="简介"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doomwatcher2004.github.io/docs/finish/finishRpc"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/finish/finishRpc" hreflang="cn"><link data-rh="true" rel="alternate" href="https://doomwatcher2004.github.io/docs/finish/finishRpc" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.15cbc4ab.css">
<script src="/assets/js/runtime~main.3e566960.js" defer="defer"></script>
<script src="/assets/js/main.cae173d3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="小冷の代码世界" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">小冷の代码世界</b></a><a class="navbar__item navbar__link" href="/docs/Java/Docker 快速入门">Java知识库</a><a class="navbar__item navbar__link" href="/docs/Web/JavaScript 高级">前端知识库</a><a class="navbar__item navbar__link" href="/docs/Godot/">Godot游戏开发</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/finish/finishRpc">Finish系列手写中间件</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Doomwatcher2004" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/finish/finishRpc">finishRpc</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">finishRpc</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>finishRpc</h1></header>
<blockquote>
<p>简介</p>
<p>​		纯个人兴趣设计的项目:</p>
<p>因为失业在家摆烂 所以没事就想写点代码 本身也比较喜欢自己写一些好玩的demo</p>
<p>这个项目的设计完全是取悦自己又菜又有一个创造框架的梦想</p>
<p>可以用于提升框架设计思路以及实践一些常用技术的练习</p>
<p>可以用于校园中的练习 , 如果能对你有所帮助 那最好</p>
<p>最终的目标是能够在小环境的微服务中成为一种简单. 好用 性能尚可的框架</p>
<p>后续可能在b站出教学视频</p>
<p>finishRpc 也可以理解成一种思路 它也是在我学习了数个rpc文章 视频以后 按照各个教学中我个人认为的优点加上自己寻思的东西设计出一个利好我开发思想的rpc 千人千面  你可以将自己先实践的技术加入其中 让它成为你的finish 共勉</p>
<p>**ps: 如果你想要跟着文章编写finishRpc 并且文档可能有些细节无法完全展现,有一定的技术门槛 需要了解微服务和网路通信知识 如果有问题还请多一些些包容 遇到不合理的地方可以尝试自己设计 **</p>
<p>文档不可能做到尽善尽美 建议搭配源码一起了解</p>
<p>gitee地址 :<a href="https://gitee.com/cold-abyss_admin/pinghaoRpc" target="_blank" rel="noopener noreferrer">https://gitee.com/cold-abyss_admin/pinghaoRpc</a></p>
<p>B站教学地址(已完结) :<a href="https://www.bilibili.com/video/BV1127BzjEaU" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1127BzjEaU</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境">环境<a href="#环境" class="hash-link" aria-label="Direct link to 环境" title="Direct link to 环境">​</a></h3>
<ul>
<li>jdk 8 -17 都可以</li>
<li>nacos2.5.x</li>
<li>netty 4.1.51</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="需要实现功能">需要实现功能<a href="#需要实现功能" class="hash-link" aria-label="Direct link to 需要实现功能" title="Direct link to 需要实现功能">​</a></h3>
<ol>
<li>基于netty的网络通信
<ol>
<li>以心跳的方式维护一个不长不短刚好够用的连接</li>
<li>自定义编码器</li>
<li>使用future的方式异步的执行远程调用</li>
</ol>
</li>
<li>以nacos作为服务中心 更加贴合常用的微服务环境 便于组合
<ol>
<li>基于nacos完成动态的服务注册与获取 以及未来的配置获取</li>
<li>基于nacos的任务状态实现以事件驱动的缓存</li>
</ol>
</li>
<li>使用调用端令牌桶+客户端熔断+重试的方式来确保可靠性</li>
<li>提供轮询和哈希一致性的方式实现最基础的负载均衡</li>
</ol>
<p>可能要做的:</p>
<ul>
<li>链路追踪定位 基于skywalking</li>
<li>实现多个自定义注解来更好的springboot环境 提升使用效率</li>
</ul>
<h1>纯原生版本</h1>
<p>我们在base版本 要做的时间其实很简单 :</p>
<ul>
<li>实现基础的rpc 就是固定地址+ip 然后动态代理直接类对象的方法</li>
<li>加入nacos 基于nacos来完成服务的注册获取和调用</li>
</ul>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413141600161.png" alt="image-20250413141600161" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结构与依赖">结构与依赖<a href="#结构与依赖" class="hash-link" aria-label="Direct link to 结构与依赖" title="Direct link to 结构与依赖">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="结构">结构<a href="#结构" class="hash-link" aria-label="Direct link to 结构" title="Direct link to 结构">​</a></h3>
<p>父项目: idea纯maven项目 创建三个模块</p>
<ul>
<li>
<p>finishRpc-core 核心库作为rpc核心 这里会暂时作为简单的客户端和调用端来作为测试</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413144933491.png" alt="image-20250413144933491" class="img_ev3q"></p>
</li>
<li>
<p>finishRpc-api:模拟的微服务 需要远程调用的接口</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413142126126.png" alt="image-20250413142126126" class="img_ev3q"></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="依赖">依赖<a href="#依赖" class="hash-link" aria-label="Direct link to 依赖" title="Direct link to 依赖">​</a></h3>
<p><code>finishRPC-core</code>的依赖库</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"> </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependencies</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">org.reflections</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">reflections</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">0.10.2</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">&lt;!-- 请检查是否有更新版本 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">cn.hutool</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">hutool-all</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">5.8.10</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">org.slf4j</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">slf4j-log4j12</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.7.25</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">&lt;!--        nacos--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">com.alibaba.nacos</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">nacos-client</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">2.5.1</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">&lt;!--       java轻量级高可用框架--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">io.github.resilience4j</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">resilience4j-circuitbreaker</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.7.1</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">io.github.resilience4j</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">resilience4j-retry</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.7.1</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">io.netty</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">netty-all</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">4.1.51.Final</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">scope</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">compile</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">scope</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">org.slf4j</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">slf4j-log4j12</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.7.25</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">fastjson</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.2.83</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">com.hyc</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">groupId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">finishRpc-api</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">artifactId</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token tag punctuation" style="color:#475569">&lt;</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain">1.0-SNAPSHOT</span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">version</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependency</span><span class="token tag punctuation" style="color:#475569">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token tag punctuation" style="color:#475569">&lt;/</span><span class="token tag" style="color:#0ea5e9">dependencies</span><span class="token tag punctuation" style="color:#475569">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="接口提供">接口提供<a href="#接口提供" class="hash-link" aria-label="Direct link to 接口提供" title="Direct link to 接口提供">​</a></h2>
<p>当前包结构:</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413142329958.png" alt="image-20250413142329958" class="img_ev3q"></p>
<blockquote>
<p>实体类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">pojo</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Builder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Data</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NoArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializable</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@NoArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 客户端和服务端共有的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> id</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TaskName</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> complete</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>接口</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">service</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Task</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getTaskById</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> id</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">insertTaskId</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>实现类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">service</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Task</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Random</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">UUID</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> taskServiceImpl </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getTaskById</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> id</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;客户端查询了&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> id </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;的用户&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 模拟从数据库中取用户的行为</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Random</span><span class="token plain"> random </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Random</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> user </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">TaskName</span><span class="token punctuation" style="color:#475569">(</span><span class="token constant" style="color:#0f172a">UUID</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">randomUUID</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">id</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">complete</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">random</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">nextBoolean</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">insertTaskId</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> task</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;插入数据成功&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> task</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getTaskName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> task</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心库">核心库<a href="#核心库" class="hash-link" aria-label="Direct link to 核心库" title="Direct link to 核心库">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="常量">常量<a href="#常量" class="hash-link" aria-label="Direct link to 常量" title="Direct link to 常量">​</a></h3>
<p><code>RPCConstant</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">constant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/15 15:49</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RPCConstant</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;RPC&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">CONFIG_FILE_PREFIX</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;FinishRPC&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">NACOS_USERNAME</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;nacos&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">NACOS_PASSWORD</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;nacos&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">SERVER_ADDR</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;127.0.0.1:8848&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求响应规范">请求响应规范<a href="#请求响应规范" class="hash-link" aria-label="Direct link to 请求响应规范" title="Direct link to 请求响应规范">​</a></h3>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413145110201.png" alt="image-20250413145110201" class="img_ev3q"></p>
<blockquote>
<p>请求类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Message</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Builder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Data</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NoArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializable</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@NoArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token plain"> type</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//服务类名，客户端只知道接口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//调用的方法名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//参数列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> params</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//参数类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> paramsType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">heartBeat</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">type</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">HEARTBEAT</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>响应类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">message</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Builder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Data</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NoArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializable</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@NoArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//状态信息 http</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> code</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token plain"> type</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> message</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//具体数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//更新：加入传输数据的类型，以便在自定义序列化器中解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> dataType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//构造成功信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">success</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">code</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">200</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">nettySuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> data</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> dataType</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">requestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">requestId</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">type</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RESPONSE</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">code</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">200</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">data</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">dataType</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">dataType</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">fail</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">requestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">requestId</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">type</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RESPONSE</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">code</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">500</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">message</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>消息类型</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Message</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于对消息读取机制拓展</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/23 22:18</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">enum</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token function" style="color:#0e7490">REQUEST</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">RESPONSE</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">HEARTBEAT</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> code</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> code</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="编解码器">编解码器<a href="#编解码器" class="hash-link" aria-label="Direct link to 编解码器" title="Direct link to 编解码器">​</a></h3>
<p>这里这么设计的原因是 想提供多种序列化器的 目前暂时用json和最原始的序列化方式 之后可能会拓展 更好的序列化格式</p>
<p>没有那么复杂的编解码需求 开发中希望能在编解码时多一些自定义校验 所以自己编写相对简单的编解码器</p>
<p>当前包位置:</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250413145134740.png" alt="image-20250413145134740" class="img_ev3q"></p>
<blockquote>
<p>序列化接口</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HashMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *  用于提供对象的序列化功能</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 通过静态工厂方法根据类型返回具体的序列化器实例</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/23 22:21</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//    把对象序列化成字节数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">*  将一个字节数组反序列化为一个Java对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">* 如果用Java自带的类型 不用设置也可以得到对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">* 如果有指定消息格式 就根据messageType转化为消息对象</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">* */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">deserializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> messageType</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 定义静态常量 serializerMap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Integer</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">Serializer</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> serializerMap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getSerializerByCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> code</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 静态映射，保证只初始化一次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serializerMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serializerMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ObjectSerializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serializerMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> serializerMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">code</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 如果不存在，则返回 null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Json序列化</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">fastjson</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">JSON</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">fastjson</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/4 11:17</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description JsonSerializer</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> bytes </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toJSONBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">deserializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> messageType</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> obj </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">messageType</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">JSON</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseObject</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">HEARTBEAT</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    obj </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> objects </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> objects</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> paramsType </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParamsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token comment" style="color:#6A9955">//判断每个方法参数类型是否和 getParamsType 一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">paramsType</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isAssignableFrom</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        objects</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toJavaObject</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParamsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token comment" style="color:#6A9955">//没问题就直接加入到数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        objects</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">objects</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                obj </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">JSON</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseObject</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//用于序列化限流以及异常等响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    obj </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> dataType </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getDataType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">dataType</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isAssignableFrom</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setData</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toJavaObject</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">JSONObject</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> dataType</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                obj </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;暂时不支持这个类型的序列化&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;Json&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>编码器</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">buffer</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ByteBuf</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageToByteEncoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/23 22:42</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description MyEncoder</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyEncoder</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageToByteEncoder</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    netty写出数据的时候使用该编码器将Java对象转换为二进制数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">encode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> channelHandlerContext</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> o</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuf</span><span class="token plain"> byteBuf</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//       日志输出对象类名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">o</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        判断消息是否是请求或者响应类型 根据类型写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">o </span><span class="token keyword" style="color:#0c4a6e">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeShort</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">REQUEST</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">o </span><span class="token keyword" style="color:#0c4a6e">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeShort</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RESPONSE</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        写入当前序列化器的表示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeShort</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serializer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        将消息转化为字符数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> serialize </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">serialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">o</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeInt</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>解码器</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">buffer</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ByteBuf</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ByteToMessageDecoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/23 22:47</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description MyDecoder</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyDecoder</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteToMessageDecoder</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//    这个类负责传入字节流解码为业务对象然后将解码后的对象添加到输出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">decode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> channelHandlerContext</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ByteBuf</span><span class="token plain"> byteBuf</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> list</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//         读取消息类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">short</span><span class="token plain"> messageType </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">readShort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">messageType</span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">REQUEST</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain">messageType</span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RESPONSE</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">           log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;暂时不支持这个类型的数据&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//      读取序列化类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">short</span><span class="token plain"> serializerType </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">readShort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        根据类型返回适当的序列化器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token plain"> serializer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getSerializerByCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serializerType</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serializer</span><span class="token operator" style="color:#475569">==</span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;不存在对应的序列化器&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        将反序列化对象放到out列表中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> length </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">readInt</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> bytes</span><span class="token operator" style="color:#475569">=</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">byte</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">length</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        读取出对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        byteBuf</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">readBytes</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        反序列出对象加入到加入到输出列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> deserialize</span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">deserializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> messageType</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">deserialize</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="提供端">提供端<a href="#提供端" class="hash-link" aria-label="Direct link to 提供端" title="Direct link to 提供端">​</a></h3>
<blockquote>
<p>这是整个提供端与客户端的包结构</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417105608296.png" alt="image-20250417105608296" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="服务本地注册">服务本地注册<a href="#服务本地注册" class="hash-link" aria-label="Direct link to 服务本地注册" title="Direct link to 服务本地注册">​</a></h4>
<p>提供端口的整个流程如下 :</p>
<p>服务端入口类 -&gt; 初始化服务 -&gt; 加入provider-&gt;netty收到客户端信息从处理器调用provider的获取服务 -&gt; 提取服务执行方法-&gt; 返回结果</p>
<p>我们最原始的rpc 需要一个收集所有服务然后提供服务的出口,将服务节点先注册到本地</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">provider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceRegister</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HashMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//本地服务存放器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//集合中存放服务的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> interfaceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">host </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">port </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">interfaceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">interfaceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//本地注册服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">provideServiceInterface</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> canRetry</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> interfaceName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaces</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> clazz </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//            本机映射表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            interfaceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//获取服务实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getService</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> interfaceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="netty服务端">netty服务端<a href="#netty服务端" class="hash-link" aria-label="Direct link to netty服务端" title="Direct link to netty服务端">​</a></h4>
<p>目前我们netty服务端需要做的事情 将标记的服务注册到本地(map) 来作为服务提供列表返回给客户端,并且维持链接, 用心跳包的方式来控制链接的关闭,所以我需要准备两个handler 我喜欢分开写 如果你懂得netty知识 一个handler也是可以的</p>
<blockquote>
<p>简单的阐述一下netty在非Spring 环境下的 固定使用流程</p>
<ul>
<li>你可以直接在nettyserver或nettyclient里全部以表达式的形式去创建循环组的设置 这样会显得比较臃肿 耦合度也很高</li>
<li>这里我们采用最常见的 处理器-&gt; 初始化 -&gt; 启动类的方式 来实现netty的交互
<ul>
<li>处理器用于处理netty信息的消费和收发 以及事件的处理</li>
<li>初始化 用于我们定义netty的通道的配置 比如组件的初始化顺序 处理器的初始化 编解码器设置 拆包粘包处理器等</li>
</ul>
</li>
</ul>
</blockquote>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="处理器">处理器<a href="#处理器" class="hash-link" aria-label="Direct link to 处理器" title="Direct link to 处理器">​</a></h5>
<ul>
<li>HeartbeatHandler 用于处理心跳事件</li>
<li>NettyRPCServerHandler 用于日常的收发请求</li>
</ul>
<blockquote>
<p>HeartbeatHandler</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">server</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">handler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleState</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于处理服务器的心跳数据</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/9 22:32</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description HeartbeatHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    用于处理客户端的心跳包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">userEventTriggered</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token plain"> event </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;触发事件:{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//               如果是触发读空闲 说明很久没有收到客户端的心跳包了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">IdleState</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">READER_IDLE</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">equals</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">state</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;超过10s没有收到客户端心跳 channel:{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">close</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">IdleState</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">WRITER_IDLE</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">equals</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">state</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;超过25s没有写数据 channel:{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">close</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;处理事件发生异常,{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMessage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelInactive</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;连接已关闭: {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>NettyRPCServerHandler</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">server</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">handler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InvocationTargetException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Method</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 因为是服务器端，我们知道接受到请求格式是RPCRequest</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/22 23:21</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRPCServerHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcRequest</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelRead0</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RpcRequest is null&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">HEARTBEAT</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;接收到心跳包&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//接收request，读取并调用服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">exceptionCaught</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Throwable</span><span class="token plain"> cause</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        cause</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">close</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//得到服务名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//得到服务端相应服务实现类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> service </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//反射调用方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Method</span><span class="token plain"> method </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            method </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMethod</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMethodName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParamsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> invoke </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">invoke</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">service</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> rpcResponse </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">nettySuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> invoke</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getReturnType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NoSuchMethodException</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IllegalAccessException</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InvocationTargetException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;方法执行错误&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">fail</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="初始化">初始化<a href="#初始化" class="hash-link" aria-label="Direct link to 初始化" title="Direct link to 初始化">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">server</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MyDecoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MyEncoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">server</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">server</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyRPCServerHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">socket</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">LengthFieldBasedFrameDecoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">LengthFieldPrepender</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleStateHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于服务器的channel初始化</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/22 23:20</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyServerInitializer</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SocketChannel</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initChannel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token plain"> pipeline </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LengthFieldBasedFrameDecoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">MAX_VALUE</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//计算当前待发送消息的长度，写入到前4个字节中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LengthFieldPrepender</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//使用自己的编码逻辑 默认使用json来进行序列化编码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyEncoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//使用自己的解码逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyDecoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//        服务器持续的关注客户端的读写事件 如果一定时间没有收到消息 触发idle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IdleStateHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">15</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">25</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRPCServerHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceProvider</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="启动类">启动类<a href="#启动类" class="hash-link" aria-label="Direct link to 启动类" title="Direct link to 启动类">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">server</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">bootstrap</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">socket</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioServerSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/22 16:54</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NettyRpcServer</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvide</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serviceProvide </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceProvide</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvide</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token plain"> channelFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token plain"> serverBootstrap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServerBootstrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token plain"> workerGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token plain"> bossGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bossGroup</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> workerGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioServerSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">childHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyServerInitializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceProvide</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Netty服务端启动了&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channelFuture </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serverBootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">bind</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">port</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Netty服务端已绑定端口：{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 将关闭通道的方式 也设置为异步的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//    阻塞finally中的代码执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            channelFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">closeFuture</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Thread</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">currentThread</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interrupt</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Netty服务端启动中断：{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMessage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">stop</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">channelFuture </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channelFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">close</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sync</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Netty服务端主通道已关闭&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Thread</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">currentThread</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interrupt</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;关闭Netty服务端主通道时中断：{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMessage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">warn</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;Netty服务端主通道尚未启动，无法关闭&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">shutdown</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token plain"> bossGroup</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token plain"> workGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">bossGroup </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            bossGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">syncUninterruptibly</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">workGroup </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            workGroup</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">shutdownGracefully</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">syncUninterruptibly</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="客户端">客户端<a href="#客户端" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h3>
<p>在客户端的使用中 核心的其实就是基于反射的代理 我们需要代理出所使用的对象 并且组合rpc请求到提供端获取执行结果</p>
<blockquote>
<p>执行流程</p>
</blockquote>
<p>客户端启动类-&gt; 获取需要执行服务的代理-&gt;在代理类中初始化nettyclient-&gt;构建rpcrequest并且发送到提供端-&gt;异步执行-&gt; 返回结果</p>
<p>为什么异步的执行呢 因为同步的方式 心跳包的发送会占用优先级 导致只有链接断开的时候才能拿到结果</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="netty客户端">netty客户端<a href="#netty客户端" class="hash-link" aria-label="Direct link to netty客户端" title="Direct link to netty客户端">​</a></h4>
<p>netty客户端的入口代码和服务端就很相似了 一样的处理器 初始化和启动类</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="处理器-1">处理器<a href="#处理器-1" class="hash-link" aria-label="Direct link to 处理器" title="Direct link to 处理器">​</a></h5>
<blockquote>
<p>HeartbeatHandler</p>
</blockquote>
<p>这里我的设置是单项心跳, 如果你想 按照这个项目的配置你完全可以实现双向心跳</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">client</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">handler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleState</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于处理客户端心跳发送</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/9 22:32</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description HeartbeatHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">userEventTriggered</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token plain"> event </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">IdleStateEvent</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;触发事件:{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">IdleState</span><span class="token plain"> idleState </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">state</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//            每一段时间都需要发送一个心跳包给服务器用于维护通道</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">IdleState</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">WRITER_IDLE</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">equals</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">idleState</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;超过8s没有写数据 发送心跳包维持链接&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">heartBeat</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>NettyClientHandler</p>
</blockquote>
<p>这里的使用的future在处理器的read按需执行,之后在代理类中get结果</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">client</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">handler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Channel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/6 19:01</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NettyRpcClientHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClientHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SimpleChannelInboundHandler</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelRead0</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> responseKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">valueOf</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;rpcResponse&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attr</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">responseKey</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">future </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">complete</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="初始化-1">初始化<a href="#初始化-1" class="hash-link" aria-label="Direct link to 初始化" title="Direct link to 初始化">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">client</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MyDecoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MyEncoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">client</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">client</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyClientHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">socket</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">SocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">LengthFieldBasedFrameDecoder</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">codec</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">LengthFieldPrepender</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">handler</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">timeout</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">IdleStateHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * netty 初始化</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/22 16:22</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyClientInitializer</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInitializer</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">SocketChannel</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initChannel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">SocketChannel</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelPipeline</span><span class="token plain"> pipeline </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">pipeline</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">/*</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 为了避免拆包/粘包 使用netty提供的基于自定义长度的解码器 参数设置为</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 1 设置长度字节为int类型 一般使用最大值</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 2 长度字段在发送的字节数组中的下标位置 从0开始</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 3 长度字段大小 因为我们用的是int 所以是4字节</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * 4 我们希望服务端只接受消息体就行所以设置跳过消息长度存储的字节数也就是 4字节</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">         * */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LengthFieldBasedFrameDecoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">MAX_VALUE</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//计算当前待发送消息的长度，写入到前4个字节中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LengthFieldPrepender</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//使用自己的编码逻辑 默认使用json来进行序列化编码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyEncoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">JsonSerializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//使用自己的解码逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">MyDecoder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyClientHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IdleStateHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        pipeline</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addLast</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HeartbeatHandler</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="启动类-1">启动类<a href="#启动类-1" class="hash-link" aria-label="Direct link to 启动类" title="Direct link to 启动类">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">client</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">serviceCenter</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">bootstrap</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Bootstrap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Channel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">socket</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Getter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/6 19:03</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NettyRpcClient</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Bootstrap</span><span class="token plain"> bootStrap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token plain"> eventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Getter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> nacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosServiceCenter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        bootStrap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Bootstrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        eventLoopGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        bootStrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">eventLoopGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">handler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyClientInitializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">sendRpcRequest</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//连接服务器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token plain"> channelFuture </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> bootStrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nacosServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">serviceDiscovery</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">connectFuture </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">connectFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isSuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">completeExceptionally</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">connectFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">cause</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">syncUninterruptibly</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channelFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//future 存储到 channel中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> responseKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">valueOf</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;rpcResponse&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attr</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">responseKey</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">future</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//发送数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> future</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="服务代理">服务代理<a href="#服务代理" class="hash-link" aria-label="Direct link to 服务代理" title="Direct link to 服务代理">​</a></h4>
<p>在这个类获取到future get结果然后返回</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">proxy</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">client</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Resilience4jRetry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcCircuitBreaker</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">circuitbreaker</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Retry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InvocationHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Method</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Proxy</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">UUID</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">function</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Function</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">function</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Supplier</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于创建需要本地执行的任务代理实例</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/10 14:18</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description ServiceProxy</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InvocationHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> nacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">rpcClient </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> clazz</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> o </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Proxy</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">newProxyInstance</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClassLoader</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> o</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">invoke</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//构建request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">requestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token constant" style="color:#0f172a">UUID</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">randomUUID</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">type</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">REQUEST</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getDeclaringClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">methodName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">params</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">paramsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParameterTypes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sendRequest</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> rpcResponse </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">whenComplete</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">ex </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                ex</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试和小结">测试和小结<a href="#测试和小结" class="hash-link" aria-label="Direct link to 测试和小结" title="Direct link to 测试和小结">​</a></h3>
<p>到这里最基础的netty实现rpc就结束了 ,我们这个rpc是之后搭建的基础,远程调用的核心已经完成了 之后都是不断优化</p>
<ul>
<li>加入注册中心 集中的管理服务地址 并且基于注册中心来实现缓存等一系列操作</li>
<li>加入服务端限流 客户端熔断重试等保证可靠性的优化</li>
<li>加入客户端负载均衡来提升系统的稳定性</li>
<li>抽象配置,集成到nacos中或者读取配置文件</li>
<li>注解化 将启动, 服务注册(之后可能还会更加的优化为按照方法注解 类似 openfeign),重试熔断抽象为注解 可以快速的加入到项目中</li>
</ul>
<blockquote>
<p>testClient</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Task</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">proxy</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">service</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">TaskService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/10 21:18</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description testClient</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> testClient </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token plain"> proxy </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token plain"> taskService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TaskByUserId</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> taskService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getTaskById</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;获取到任务: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> userByUserId</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>testServer</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">server</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">service</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">TaskService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">service</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">taskServiceImpl</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/10 21:14</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description testServer</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> testServer </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 创建 UserService 实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token plain"> taskService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">taskServiceImpl</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">9999</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 发布服务接口到 ServiceProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">provideServiceInterface</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">taskService</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955">// 可以设置是否支持重试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 启动 RPC 服务器并监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token plain"> server </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceProvider</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        server</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">9999</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955">// 启动 Netty RPC 服务，监听 port 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RPC 服务端启动，监听端口&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">9999</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>测试结果</p>
<p>这是调用端</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417111606387.png" alt="image-20250417111606387" class="img_ev3q"></p>
<p>服务端</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417111638907.png" alt="image-20250417111638907" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="注册中心-nacos">注册中心 NACOS<a href="#注册中心-nacos" class="hash-link" aria-label="Direct link to 注册中心 NACOS" title="Direct link to 注册中心 NACOS">​</a></h2>
<p>我们使用nacos的意义是 集中的管理服务节点并且基于注册中心来实现缓存等一系列操作</p>
<p>在这一次的拓展中 我们将实现:</p>
<ul>
<li>以nacos作为中心获取服务连接</li>
<li>基于nacos事件动态缓存节点地址</li>
<li>服务器限流</li>
<li>客户端负载均衡</li>
</ul>
<p>我使用的nacos 是 2.5.1版本, 可以去官网下载</p>
<p><a href="https://nacos.io/" target="_blank" rel="noopener noreferrer">https://nacos.io/</a></p>
<p>解压完以后,我们需要先配置nacos , 新版的nacos需要开启权限和单机启动 , 可以去官方文档或者搜索如何配置</p>
<p>这是我的配置, 请忽略和这个key哈哈随便写一下就行</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417112755332.png" alt="image-20250417112755332" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417112640668.png" alt="image-20250417112640668" class="img_ev3q"></p>
<p>修改为 单机启动</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417112816446.png" alt="image-20250417112816446" class="img_ev3q"></p>
<p>复制一份 改名为 startupSingle</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417112845398.png" alt="image-20250417112845398" class="img_ev3q"></p>
<p>修改这个属性 默认是集群模式 改为单机启动</p>
<p>当前的包结构</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417115027591.png" alt="image-20250417115027591" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务端">服务端<a href="#服务端" class="hash-link" aria-label="Direct link to 服务端" title="Direct link to 服务端">​</a></h3>
<p>我们还是先服务端再客户端, 有了nacos以后,我们需要设置一些使用nacos需要的常量,这些之后都会优化成配置文件读取</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417113002177.png" alt="image-20250417113002177" class="img_ev3q"></p>
<p>我们的思路是将rpc服务和注册节点的服务分开来 , 所有的rpc节点都在rpc分组下</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="服务注册nacos">服务注册nacos<a href="#服务注册nacos" class="hash-link" aria-label="Direct link to 服务注册nacos" title="Direct link to 服务注册nacos">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceRegister</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">exception</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/1 21:32</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NacosServiceRegister</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingService</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;username&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_USERNAME</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;password&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_PASSWORD</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;serverAddr&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SERVER_ADDR</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">!</span><span class="token plain">nameSpace</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;nameSpace&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">createNamingService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;连接nacos失败&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 注册服务 负责将需要发现的服务注册到nacos管理</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * date: 2025/4/1 21:40</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">register</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> clusterName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token plain"> instance </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        instance</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setIp</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceAddress</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getHostName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        instance</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setPort</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceAddress</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getPort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        instance</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setServiceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clusterName </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">!</span><span class="token plain">clusterName</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            instance</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setClusterName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clusterName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">metadata </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">!</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">keySet</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            instance</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setMetadata</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">registerInstance</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务注册成功&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> serviceName </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;-&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getHostName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务注册失败&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有了这个方法 我们就可以将服务以服务名+ip的形式 注册到nacos里</p>
<p>之后我们在provider中作为注册的起点 , 这里的canRetry是用于之后的是否开启重试服务的flag 存储在nacos服务节点的meta数据中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">provider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceRegister</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HashMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//本地服务存放器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//集合中存放服务的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> interfaceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token plain"> nacosServiceRegister</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    nacos的元数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> nacosMeta</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">host </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">port </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">interfaceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosServiceRegister </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosMeta </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">interfaceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//本地注册服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">provideServiceInterface</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> canRetry</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> interfaceName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaces</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> clazz </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//            本机映射表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            interfaceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            nacosMeta</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">valueOf</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">canRetry</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            nacosServiceRegister</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">register</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> nacosMeta</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//获取服务实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getService</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> interfaceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>到这里 nacos加入到服务端就结束了 ,之后我们就可以在nacos中获取的对应的服务地址,然后发起请求了</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="基于令牌桶限流">基于令牌桶限流<a href="#基于令牌桶限流" class="hash-link" aria-label="Direct link to 基于令牌桶限流" title="Direct link to 基于令牌桶限流">​</a></h4>
<p>包结构</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417132127072.png" alt="image-20250417132127072" class="img_ev3q"></p>
<p>开闭限流是服务器保证自己服务稳定性的一种手段 ,我们简单的实现一个令牌桶来对服务器进行限制,</p>
<p>我们的思路有两种 一种是以服务名为基础的限流,一种是以ip为基础的限流, 这里我们以服务名作为限流标识</p>
<p>后面想要更多的限流方式只需要不断实现接口 就可以达到效果</p>
<blockquote>
<p>限流服务构建</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/10 14:22</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RateLimitProvider</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimitProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//用于存储每个节点和限流器的映射关系</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">RateLimit</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> rateLimitMap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConcurrentHashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimit</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getRateLimitByInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rateLimitMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">computeIfAbsent</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interfaceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> k </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TokenBucketRateLimit</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">100</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">5</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>令牌桶算法实现</p>
</blockquote>
<p>基于原子操作 实现令牌桶</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Server</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">rateLimit</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *  用于自定义限流机制 这里我们采用令牌桶的方式</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * date: 2025/3/30 13:58</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimit</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getToken</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">rateLimit</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">atomic</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AtomicInteger</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">atomic</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AtomicLong</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用原子请求来限制异步</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/13 13:22</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description AsyncTokenBucketRateLimiter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AsyncTokenBucketRateLimiter</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimit</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 令牌生成速率 (毫秒/个)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">long</span><span class="token plain"> requestPerSecond</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 桶容量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> maxToken</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 当前令牌数 (原子类型)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AtomicInteger</span><span class="token plain"> tokens</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 最后填充时间 (原子类型)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AtomicLong</span><span class="token plain"> lastRefillTime</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AsyncTokenBucketRateLimiter</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> requestPerSecond</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> maxToken</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">requestPerSecond </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1000L</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> requestPerSecond</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">maxToken </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> maxToken</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">tokens </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AtomicInteger</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">maxToken</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">lastRefillTime </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AtomicLong</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">currentTimeMillis</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//这个方法用于获取是否能够执行请求 并且是否能够获取令牌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getToken</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> n</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//当前时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">long</span><span class="token plain"> now </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">currentTimeMillis</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//获取到当前时间的间隔并且替换当前时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">long</span><span class="token plain"> timePassed </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> now </span><span class="token operator" style="color:#475569">-</span><span class="token plain"> lastRefillTime</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getAndSet</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//计算出需要增加的 token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> tokensToAdd </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">timePassed </span><span class="token operator" style="color:#475569">/</span><span class="token plain"> requestPerSecond</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//用当前时间能生成的token和桶中还能放做少token取小 来以防溢出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        tokens</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addAndGet</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Math</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">min</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">tokensToAdd</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> maxToken </span><span class="token operator" style="color:#475569">-</span><span class="token plain"> tokens</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> tokens</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getAndAdd</span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">-</span><span class="token plain">n</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&gt;=</span><span class="token plain"> n</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getToken</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getToken</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>限流运用</p>
</blockquote>
<p>将限流服务加入到serviceprovider中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token annotation punctuation" style="color:#475569">@Getter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimitProvider</span><span class="token plain"> rateLimitProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">host </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> host</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">port </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> port</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">interfaceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosServiceRegister </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosMeta </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">rateLimitProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimitProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们的服务提供入口是在 NettyRPCServerHandler的getResponse方法 , 修改如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">server</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">handler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AllArgsConstructor</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InvocationTargetException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Method</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/5 14:03</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NettyRpcServerHandler</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServerHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ChannelInboundHandlerAdapter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">channelRead</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">obj </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;没有请求对象&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> rpcRequest </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        System.out.println(&quot;请求的参数为&quot; + rpcRequest);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> token </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRateLimitProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRateLimitByInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getToken</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> fail </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">fail</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;请求被限流&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务限流:        &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> fail</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            ctx</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">fail</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getResponse</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interfaceName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> service </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interfaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> methodName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMethodName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Method</span><span class="token plain"> method </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            method </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMethod</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">methodName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParamsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//方法结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> invoke </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">invoke</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">service</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParams</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">nettySuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> invoke</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getReturnType</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NoSuchMethodException</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IllegalAccessException</span><span class="token plain"> </span><span class="token operator" style="color:#475569">|</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InvocationTargetException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">fail</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRequestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;调用远程方法出错&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="客户端-1">客户端<a href="#客户端-1" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h3>
<p>这里的服务发现,返回多个列表, 先获取第一个,之后会使用负载均衡的方式 经可能按照需求分散到各个节点</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">exception</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">impl</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">cache</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">serviceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">stream</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于发现nacos上所需要的服务</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/1 22:11</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NacosServiceCenter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingService</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> checkRetry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;username&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_USERNAME</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;password&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_PASSWORD</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;serverAddr&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SERVER_ADDR</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">!</span><span class="token plain">nameSpace</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;nameSpace&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">createNamingService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;连接nacos失败&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceDiscovery</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">           </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> instances</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> instances</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMetadata</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            checkRetry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Boolean</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseBoolean</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">checkRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> checkRetry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    将字符串解析成为地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> split </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">split</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;:&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseInt</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有了服务发现的方法之后, 我们客户端就可以以注册中心作为连接点,直接获取到对应服务名的连接从而开始调用</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">netty</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">client</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Message</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">bootstrap</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Bootstrap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Channel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ChannelFutureListener</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">channel</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">socket</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nio</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NioSocketChannel</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/10 14:20</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NettyRpcClient</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> nacosServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Bootstrap</span><span class="token plain"> bootstrap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">EventLoopGroup</span><span class="token plain"> eventLoopGroup</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nacosServiceCenter </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//netty客户端初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        eventLoopGroup </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NioEventLoopGroup</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        bootstrap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Bootstrap</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        bootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">group</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">eventLoopGroup</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NioSocketChannel</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//NettyClientInitializer这里 配置netty对消息的处理机制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">handler</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyClientInitializer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">sendRequest</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 连接到远程服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ChannelFuture</span><span class="token plain"> channelFuture </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channelFuture </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> bootstrap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">connect</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nacosServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">serviceDiscovery</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getInterfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelFutureListener</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> connectFuture </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">connectFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isSuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">completeExceptionally</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">connectFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">cause</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">syncUninterruptibly</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Channel</span><span class="token plain"> channel </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> channelFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">channel</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 存储 future 到 Channel 属性中，供后续获取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">CompletableFuture</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> responseFutureKey </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">AttributeKey</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">valueOf</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RpcResponseFuture&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">attr</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">responseFutureKey</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">set</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">future</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 发送数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">writeAndFlush</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ChannelFutureListener</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> writeFuture </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">writeFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isSuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                future</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">completeExceptionally</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">writeFuture</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">cause</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                channel</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">close</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> future</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="节点缓存">节点缓存<a href="#节点缓存" class="hash-link" aria-label="Direct link to 节点缓存" title="Direct link to 节点缓存">​</a></h3>
<p>我们客户端其实是需要缓存的, 它可以提升请求的性能 节省不必要的连接开销, 比如我需要多次获取task 每次都要去注册中心请求地址, 本地才是最快的, 所以我们可以在本地以监听器+容器的方式 根据nacos的事件创造一个动态的本地缓存</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">cache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Collections</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ConcurrentHashMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于存储从nacos 获取的节点实例缓存</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/11 14:37</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description ServiceCache</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceCache</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//存储服务名+节点地址列表的映射缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> cacheMap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConcurrentHashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//添加服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">addServiceToCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">containsKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> list </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addAll</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;添加服务地址 {} 到本地节点缓存：{}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;创建新的节点缓存: {},当前地址列表: {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//获取已有的节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getServiceFromCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">containsKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Collections</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">emptyList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> res </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;成功使用缓存节点: {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">deleteCacheNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> list </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">list </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">removeAll</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;删除服务节点 {} 的地址 {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAddress</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务地址清空,删除节点: {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务节点 {} 不存在&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">updateCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> oldIps</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> modifiedIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">containsKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> list </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> cacheMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">removeAll</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">oldIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            list</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addAll</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">modifiedIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;更新服务节点 {} 的地址 {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> modifiedIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务节点 {} 不存在&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="nacos监听器">nacos监听器<a href="#nacos监听器" class="hash-link" aria-label="Direct link to nacos监听器" title="Direct link to nacos监听器">​</a></h4>
<p>思路就是监听rpc分组下的节点状态信息 以节点健康问基准动态的删除或新增至缓存</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">serviceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">listener</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Event</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">listener</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">EventListener</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">client</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">listener</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingChangeEvent</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">cache</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">stream</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于监听 nacos提供的节点event 来对缓存状态做同步处理</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/11 14:47</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description ServiceChangeListener</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">EventListener</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceCache</span><span class="token plain"> serviceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serviceCache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceCache</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">onEvent</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Event</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event </span><span class="token keyword" style="color:#0c4a6e">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingChangeEvent</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">NamingChangeEvent</span><span class="token plain"> namingEvent </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NamingChangeEvent</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getServiceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">equals</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getGroupName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//处理添加的节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isAdded</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> healthyIps </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getAddedInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">filter</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">isHealthy</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">addServiceToCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> healthyIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//处理节点更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isModified</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> oldIps </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getServiceFromCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> modifiedIps </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getModifiedInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">filter</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">isHealthy</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">updateCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> oldIps</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> modifiedIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//处理删除的节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isRemoved</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> removeIps </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingEvent</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRemovedInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">filter</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">isHealthy</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">deleteCacheNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> removeIps</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="应用监听器-和缓存">应用监听器 和缓存<a href="#应用监听器-和缓存" class="hash-link" aria-label="Direct link to 应用监听器 和缓存" title="Direct link to 应用监听器 和缓存">​</a></h4>
<p>在<code>NacosServiceCenter</code>中 创建监听器实例 并且加入到nacos连接中 , 并且将获取节点地址的方式改为缓存优先</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">serviceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">cn</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hutool</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">core</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">collection</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ConcurrentHashSet</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">exception</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingFactory</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">cache</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">stream</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/10 14:30</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NacosServiceCenter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingService</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceCache</span><span class="token plain"> serviceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token plain"> serviceChangeListener</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConcurrentHashSet</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> subscribedServices</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameScope</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serviceCache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceCache</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;username&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_USERNAME</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;password&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_PASSWORD</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;serverAddr&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SERVER_ADDR</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nameScope </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;namespace&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> nameScope</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingFactory</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">createNamingService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serviceChangeListener </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            subscribedServices </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConcurrentHashSet</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceDiscovery</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Instance</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> instances </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 确保只注册一次监听器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">subscribedServices</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">contains</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">subscribe</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceChangeListener</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                subscribedServices</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getServiceFromCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//使用缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                addressList </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> instances</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> split </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">split</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;:&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseInt</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="客户端负载均衡">客户端负载均衡<a href="#客户端负载均衡" class="hash-link" aria-label="Direct link to 客户端负载均衡" title="Direct link to 客户端负载均衡">​</a></h3>
<p>负载均衡其实是一个很有意思的东西 ,这里我暂时先提供 两种负载均衡的方式,</p>
<ul>
<li>一种是最简单和普遍的轮训法</li>
<li>第二种是基于节点hash来负载均衡</li>
</ul>
<blockquote>
<p>接口</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/26 15:09</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description LoadBalance</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoadBalance</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    负责实现具体算法 返回分配地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">balance</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    添加节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">addNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    删除节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">delNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>轮询法</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">impl</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">LoadBalance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 基于轮询算法的负载均衡</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/26 15:10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RoundLoadBalance</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RoundLoadBalance</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoadBalance</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    初始化轮询索引</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> flag </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">balance</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        flag</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        flag </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> flag </span><span class="token operator" style="color:#475569">%</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">size</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;轮询至 {} 服务器&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">addNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">delNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>hash一致性</p>
</blockquote>
<p>这个方法借鉴于一个rpc教学思路  . 这里的负载均衡思路 将节点映射在哈希环中, 通过哈希值来找到环中最近的节点, 通过虚拟节点来增加哈希命中的概率.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">impl</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">LoadBalance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">org</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Logger</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">org</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">LoggerFactory</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">SortedMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">TreeMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">UUID</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">concurrent</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CopyOnWriteArrayList</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 基于一致性hash负载均衡</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 虚拟节点解决hash偏移问题的</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/26 15:10</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description ConsistencyHashBalance</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConsistencyHashBalance</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoadBalance</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    每个真实节点所需要的虚拟节点数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_NUM</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">5</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   虚拟节点标识</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_STR</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&amp;&amp;VIRTUAL_NODE&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Logger</span><span class="token plain"> log </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">LoggerFactory</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getLogger</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   保存虚拟节点的hash值以及对应的虚拟节点 key为hash值 value为虚拟节点名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">SortedMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Integer</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> shards </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TreeMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Integer</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    考虑线程安全问题 并发读的时候无需上锁 并且新增不会直接往容器写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> realNodes </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CopyOnWriteArrayList</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> server </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token function" style="color:#0e7490">addNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">server</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 基于fnv1_32</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getHash</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> str</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">FNV_PRIME</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">16777619</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        fnv初始哈希值 截断为int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2166136261L</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> str</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">length</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash </span><span class="token operator" style="color:#475569">^</span><span class="token plain"> str</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">charAt</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">FNV_PRIME</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 增强步骤：增加位移和异或操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash </span><span class="token operator" style="color:#475569">^</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash </span><span class="token operator" style="color:#475569">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">16</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0x85ebca6b</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 混合高低位</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            hash </span><span class="token operator" style="color:#475569">^=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash </span><span class="token operator" style="color:#475569">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">13</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">                       </span><span class="token comment" style="color:#6A9955">// 二次扩散</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Math</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">abs</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> node</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> serviceList</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//      初始化真实节点和虚拟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceList</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getHash</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;这次请求所分析的地址hash {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//      获取hash值大于等于请求哈希值的所有虚拟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">SortedMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Integer</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> nodeMap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">tailMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//      如果没有找到对应的节点集合 那么久选择最大的节点 否则选择第一个虚拟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nodeMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">lastKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            key </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> nodeMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">firstKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//      返回真实节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> virtualNode </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;这次请求所前往的虚拟节点 {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">substring</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">indexOf</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;&amp;&amp;&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">balance</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">||</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">IllegalArgumentException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;服务列表地址为空&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> requestPath </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">UUID</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">randomUUID</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;发起请求的地址 {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> requestPath</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">requestPath</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">addNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">realNodes</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">contains</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            realNodes</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;真实节点 {} 被添加&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_NUM</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//                虚拟节点命名规则为server&amp;&amp;VIRTUAL_STR+i i是虚拟节点的编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> virtualNode </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_STR</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getHash</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">virtualNode</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//               根据hash值对节点排序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;虚拟节点 {} 被添加,hash为 {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">delNode</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">realNodes</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">contains</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            realNodes</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;真实节点 {} 以下线&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_NUM</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//                虚拟节点命名规则为server&amp;&amp;VIRTUAL_STR+i i是虚拟节点的编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> virtualNode </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Node</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">VIRTUAL_STR</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> hash </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getHash</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">virtualNode</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//               根据hash值对节点排序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                shards</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">remove</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">hash</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;虚拟节点 {} 被下线,hash {} 被移除&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> virtualNode</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>将负载均衡和缓存加入到netty的请求入口</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">exception</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosException</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NamingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">alibaba</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">nacos</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">api</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">naming</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">pojo</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Instance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">impl</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">cache</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">serviceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">net</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">stream</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于发现nacos上所需要的服务</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/1 22:11</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description NacosServiceCenter</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NamingService</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> serviceCache serviceCache</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token plain"> serviceChangeListener</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serviceCache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceCache</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">serviceCache </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceCache</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">init</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Properties</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;username&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_USERNAME</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;password&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">NACOS_PASSWORD</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;serverAddr&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">SERVER_ADDR</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">nameSpace </span><span class="token operator" style="color:#475569">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token plain"> </span><span class="token operator" style="color:#475569">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">!</span><span class="token plain">nameSpace</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">setProperty</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;nameSpace&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> nameSpace</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosFactory</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">createNamingService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            serviceChangeListener </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceChangeListener</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;连接nacos失败&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceDiscovery</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Instance</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> instances </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">subscribe</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceChangeListener</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> addressList </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> serviceCache</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getServiceFromCacheMap</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                addressList </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> instances</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">stream</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">map</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Instance</span><span class="token operator" style="color:#475569">::</span><span class="token function" style="color:#0e7490">toInetAddr</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">collect</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Collectors</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toList</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> balance </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">balance</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">addressList</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">checkRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Instance</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> instances </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            instances </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> namingService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">selectInstances</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RPC_GROUP_NAME</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NacosException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> s </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> instances</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getMetadata</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Boolean</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseBoolean</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//    将字符串解析成为地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">parseAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> split </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> address</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">split</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;:&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InetSocketAddress</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">parseInt</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#475569">[</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a href="#测试" class="hash-link" aria-label="Direct link to 测试" title="Direct link to 测试">​</a></h3>
<blockquote>
<p>服务端日志</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417130913608.png" alt="image-20250417130913608" class="img_ev3q"></p>
<blockquote>
<p>客户端日志</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417130939793.png" alt="image-20250417130939793" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250417131013060.png" alt="image-20250417131013060" class="img_ev3q"></p>
<p>可以看到 缓存和负载均衡均已生效</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="重试与熔断">重试与熔断<a href="#重试与熔断" class="hash-link" aria-label="Direct link to 重试与熔断" title="Direct link to 重试与熔断">​</a></h2>
<p>我们基于==resilience4j== 来实现重试与熔断</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="重试配置">重试配置<a href="#重试配置" class="hash-link" aria-label="Direct link to 重试配置" title="Direct link to 重试配置">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">config</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Retry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RetryConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RetryRegistry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">time</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Duration</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 重试</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/12 18:52</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RetryConfig</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Resilience4jRetryConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Retry</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">GetRetryTemplate</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RetryConfig</span><span class="token plain"> retryConfig </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RetryConfig</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">custom</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//最大重试次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">maxAttempts</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//时间间隔</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">waitDuration</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Duration</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">ofSeconds</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当 RPC 响应的状态码为 500 时，记录为失败。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">retryOnResult</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">500</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">retryExceptions</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//                .failAfterMaxAttempts(true)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">//放入注册表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RetryRegistry</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">of</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">retryConfig</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">retry</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;pinhaoRpcRetry&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="熔断配置">熔断配置<a href="#熔断配置" class="hash-link" aria-label="Direct link to 熔断配置" title="Direct link to 熔断配置">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">config</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">circuitbreaker</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">circuitbreaker</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CircuitBreakerConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">circuitbreaker</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CircuitBreakerRegistry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">time</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Duration</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * rpc 接口可靠性保障之 熔断器</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/12 18:52</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description BreakerConfig</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">BreakerConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getCircuitBreaker</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CircuitBreakerConfig</span><span class="token plain"> config </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CircuitBreakerConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">custom</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当 RPC 响应的状态码为 500 时，记录为失败。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">recordResult</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">response </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">500</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当失败率达到 50% 时，熔断器会打开。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">failureRateThreshold</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">50</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//当慢调用比例达到 50% 时，熔断器会打开。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">slowCallRateThreshold</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">50</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//调用耗时超过 2 秒视为慢调用。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">slowCallDurationThreshold</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Duration</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">ofSeconds</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//熔断器打开后，10 秒后自动切换到半开状态。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">waitDurationInOpenState</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Duration</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">ofSeconds</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">10</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">automaticTransitionFromOpenToHalfOpenEnabled</span><span class="token punctuation" style="color:#475569">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//在半开状态下允许 5 次调用，用于测试服务是否恢复。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">5</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">minimumNumberOfCalls</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token comment" style="color:#6A9955">//使用基于计数的滑动窗口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">slidingWindowType</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">CircuitBreakerConfig</span><span class="token class-name punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">SlidingWindowType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">COUNT_BASED</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">slidingWindowSize</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">15</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">recordExceptions</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">CircuitBreakerRegistry</span><span class="token plain"> breakerRegistry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CircuitBreakerRegistry</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">of</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> breakerRegistry</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">circuitBreaker</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;pinhaoRpcCircuitBreaker&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务代理-1">服务代理<a href="#服务代理-1" class="hash-link" aria-label="Direct link to 服务代理" title="Direct link to 服务代理">​</a></h3>
<p>我们更新服务代理类的代码 用于监控和编写重试熔断逻辑</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">proxy</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">config</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">BreakerConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">config</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Resilience4jRetryConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">message</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RpcResponse</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">client</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">circuitbreaker</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">io</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">github</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">resilience4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">retry</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Retry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">InvocationHandler</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Method</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Proxy</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">UUID</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">function</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Supplier</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/6/6 19:18</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description ServiceProxy</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">implements</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InvocationHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token plain"> circuitBreaker</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Retry</span><span class="token plain"> retry</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">retry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Resilience4jRetryConfig</span><span class="token class-name punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">GetRetryTemplate</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">rpcClient </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">circuitBreaker </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">BreakerConfig</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getCircuitBreaker</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">setupEventListeners</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">NettyRpcClient</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#475569">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">invoke</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//        System.out.println(&quot;进入方法的类名:&quot; + method.getDeclaringClass().getName());</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcRequest</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">builder</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">requestId</span><span class="token punctuation" style="color:#475569">(</span><span class="token constant" style="color:#0f172a">UUID</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">randomUUID</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">type</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">MessageType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">REQUEST</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">interfaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getDeclaringClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">methodName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">params</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">paramsType</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getParameterTypes</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">build</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> checkRetry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getNacosServiceCenter</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">checkRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">checkRetry</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Supplier</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">RpcResponse</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> rpcCall </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sendRpcRequest</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;请求失败&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">//先熔断再请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">CircuitBreaker</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">decorateSupplier</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">circuitBreaker</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Retry</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">decorateSupplier</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">retry</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcCall</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        response </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> rpcClient</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sendRpcRequest</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getData</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">setupEventListeners</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        retry</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getEventPublisher</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">onRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;重试次数:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> event</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getNumberOfRetryAttempts</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">onError</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;重试失败&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">onSuccess</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;重试成功&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        circuitBreaker</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getEventPublisher</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">onStateTransition</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getStateTransition</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">CLOSED_TO_OPEN</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;熔断器已打开&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">OPEN_TO_HALF_OPEN</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;熔断器已半开&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">HALF_OPEN_TO_CLOSED</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;熔断器已关闭&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token keyword" style="color:#0c4a6e">break</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token keyword" style="color:#0c4a6e">case</span><span class="token plain"> </span><span class="token constant" style="color:#0f172a">HALF_OPEN_TO_OPEN</span><span class="token operator" style="color:#475569">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;熔断器半开失败&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> clazz</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Proxy</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">newProxyInstance</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClassLoader</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">{</span><span class="token plain">clazz</span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">this</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试-1">测试<a href="#测试-1" class="hash-link" aria-label="Direct link to 测试" title="Direct link to 测试">​</a></h3>
<p>熔断测试客户端请求案例</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">throws</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token plain"> clientProxy </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token plain"> proxy </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> clientProxy</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getProxy</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">TaskService</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">int</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i </span><span class="token operator" style="color:#475569">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">90</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> i</span><span class="token operator" style="color:#475569">++</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> i1 </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">i </span><span class="token operator" style="color:#475569">%</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">30</span><span class="token plain"> </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token class-name" style="color:#0ea5e9">Thread</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">sleep</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">10000</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Thread</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token operator" style="color:#475569">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">Task</span><span class="token plain"> user </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getTaskById</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">i1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;获取到任务=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> user</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">NullPointerException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;task为空&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    e</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">printStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>测试结果</p>
</blockquote>
<p>我们将服务端的限流控制在初始只有一个令牌 也就是请求百分之99都错误的情况</p>
<p>客户端此时默认是开启重试与熔断的</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">Server</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">provider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">rateLimit</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RateLimit</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">rateLimit</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">TokenBucketRateLimit</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">HashMap</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Map</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 基于令牌桶限制的服务提供</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/3/30 14:22</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RateLimitProvider</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimitProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//   用于存储每隔接口和对应速率显示器的映射关系</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Map</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">String</span><span class="token generics punctuation" style="color:#475569">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">RateLimit</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> rateLimitsMap </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">HashMap</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 根据结构名称获取对应的限制器实例 如不存在将创建</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * date: 2025/3/30 14:24</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RateLimit</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getRateLimitByInterFaceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> interFaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">rateLimitsMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">containsKey</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interFaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//              todo  这里先默认的使用固定值创建新的限流器 之后会修改成从配置文件中读取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">RateLimit</span><span class="token plain"> rateLimit </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">TokenBucketRateLimit</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">100</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            rateLimitsMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">put</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interFaceName</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rateLimit</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rateLimit</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rateLimitsMap</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">get</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">interFaceName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// todo  这里采用的是服务名限流 之后会拓展基于IP限流 思路大致一致 改变的只会是粗细度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//           public RateLimit getRateLimitByInterFaceName()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动服务和客户端</p>
<blockquote>
<p>触发批量请求的重试</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428145838237.png" alt="image-20250428145838237" class="img_ev3q"></p>
<p>抢到令牌</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428145909631.png" alt="image-20250428145909631" class="img_ev3q"></p>
<p>失败过多 判断为服务器挂了  开启熔断</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428145932806.png" alt="image-20250428145932806" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="读取配置">读取配置<a href="#读取配置" class="hash-link" aria-label="Direct link to 读取配置" title="Direct link to 读取配置">​</a></h2>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150406731.png" alt="image-20250428150406731" class="img_ev3q"></p>
<p>这个类用于存放默认配置</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">config</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token class-name" style="color:#0ea5e9">ServiceCenter</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">impl</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceRegister</span><span class="token import punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import operator" style="color:#475569">*</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/20 19:48</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RpcConfigTemplate</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@AllArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@NoArgsConstructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@ToString</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">final</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> name </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;FinishRpc&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Integer</span><span class="token plain"> port </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">9999</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//主机名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> host </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;localhost&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//版本号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> version </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;1.0.0&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//注册中心 暂时只支持nacos 之后如果有时间会多拓展几个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> registry </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NacosServiceRegister</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//序列化器 之后回去支持 proto</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> serializer </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Serializer</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getSerializerByCode</span><span class="token punctuation" style="color:#475569">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//负载均衡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> loadBalance </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConsistencyHashBalance</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>工具类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">util</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">cn</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hutool</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">core</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">StrUtil</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">cn</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hutool</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">setting</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">dialect</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Props</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConfigUtil</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 加载配置文件，使用默认环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">loadConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">loadConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">targetClass</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">// 加载配置文件，支持指定环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">T</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">loadConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">T</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">StringBuilder</span><span class="token plain"> configFileNameBuilder </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">StringBuilder</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;application&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">StrUtil</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isNotBlank</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">environment</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            configFileNameBuilder</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">append</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;-&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">append</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">environment</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        configFileNameBuilder</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">append</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;.properties&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 加载配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Props</span><span class="token plain"> properties </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Props</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">configFileNameBuilder</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">warn</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;配置文件 &#x27;{}&#x27; 为空或加载失败！&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> configFileNameBuilder</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;加载配置文件: &#x27;{}&#x27;&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> configFileNameBuilder</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toString</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 返回转化后的配置对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">toBean</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">targetClass</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">error</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;配置转换失败，目标类: {}&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> targetClass</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;配置加载失败&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建测试项目">创建测试项目<a href="#创建测试项目" class="hash-link" aria-label="Direct link to 创建测试项目" title="Direct link to 创建测试项目">​</a></h3>
<ul>
<li>servera 是客户端</li>
<li>server b 是服务提供</li>
</ul>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150525157.png" alt="image-20250428150525157" class="img_ev3q"></p>
<p>客户端没什么说的 ,这里展示服务器的配置类</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.version=1.0.0</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.port=9999</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.serializer=Json</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.host=localhost</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.registry=Nacos</span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">FinishRpc.loadBalance=ConsistencyHash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>到这里我们的基础设置就结束了 之后会在自动配置中使用此小节代码</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="注解启动与服务注册">注解启动与服务注册<a href="#注解启动与服务注册" class="hash-link" aria-label="Direct link to 注解启动与服务注册" title="Direct link to 注解启动与服务注册">​</a></h2>
<p>我们使用<code>reflections</code>来作为反射工具 为什么不用spring呢 因为基础版本我想作为原生的版本 他依旧可以在spring项目中使用  如果通过spring实现rpc 那么只需要将resttemplate封装并且适配一下rpc就实现了 有空可能去实现一下</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150201511.png" alt="image-20250428150201511" class="img_ev3q"></p>
<blockquote>
<p>启动注解</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">annotation</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">annotation</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import operator" style="color:#475569">*</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Target</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ElementType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">TYPE</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Retention</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RetentionPolicy</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RUNTIME</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Documented</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#475569">@interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpcServer</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 是否强制使用默认配置（覆盖配置文件）</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">useDefaultConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>注册注解</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">annotation</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">annotation</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import operator" style="color:#475569">*</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Target</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ElementType</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">TYPE</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Retention</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RetentionPolicy</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">RUNTIME</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Documented</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#475569">@interface</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">FinishService</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">serviceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">boolean</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">canRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">default</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="autoconfig">autoconfig<a href="#autoconfig" class="hash-link" aria-label="Direct link to autoconfig" title="Direct link to autoconfig">​</a></h3>
<p>新建一个autoconfig类</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150241601.png" alt="image-20250428150241601" class="img_ev3q"></p>
<p>思路就是 :</p>
<ul>
<li>启动类带有启动注解 自动配置服务端 并且扫描带有注册注解的类基于启动类的目录</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token keyword" style="color:#0c4a6e">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">hyc</span><span class="token namespace punctuation" style="color:#475569">.</span><span class="token namespace">config</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">annotation</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">EnableFinishRpcServer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">annotation</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">FinishService</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">constant</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">netty</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">server</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">provider</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">com</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">hyc</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ConfigUtil</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">lombok</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">extern</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">slf4j</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Slf4j</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">org</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">reflections</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Reflections</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">lang</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">annotation</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Annotation</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">ArrayList</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">List</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">import</span><span class="token plain"> </span><span class="token import namespace">java</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import namespace">util</span><span class="token import namespace punctuation" style="color:#475569">.</span><span class="token import class-name" style="color:#0ea5e9">Set</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * 用于读取配置并且初始化rpc 并且支持启动注解</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @date 2025/4/20 20:40</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> * @description RpcAutoConfiguration</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcAutoConfiguration</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">volatile</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token plain"> rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">//通过注解初始化 扫描类路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">scanAndInitializeServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 扫描类路径，检查是否有 @EnableFinishRpcServer 注解</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">private</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">scanAndInitializeServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> callerPackage </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getCallerPackage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;包名&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> callerPackage</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 检查是否标记了 @EnableFinishRpcServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">FinishServiceClass</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">scanServices</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">callerPackage</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">FinishService</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpcServer</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpc</span><span class="token plain"> </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">scanService</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">callerPackage</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpcServer</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getAnnotation</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpcServer</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">EnableFinishRpc</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">useDefaultConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 强制使用默认配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 正常加载配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">info</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RPC 框架通过 @EnableFinishRpcServer 注解初始化完成&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token class-name" style="color:#0ea5e9">FinishServiceClass</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Object</span><span class="token plain"> scanService </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">FinishServiceClass</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;拿到的类&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> scanService</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">FinishService</span><span class="token plain"> serviceAnnotation </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> scanService</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClass</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getAnnotation</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">FinishService</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token plain"> serviceProvider </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ServiceProvider</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getHost</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getPort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token operator" style="color:#475569">!</span><span class="token plain">serviceAnnotation</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">serviceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">isEmpty</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token comment" style="color:#6A9955">// 发布服务接口到 ServiceProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">provideServiceInterface</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">scanService</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAnnotation</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">serviceName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAnnotation</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">canRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955">// 可以设置是否支持重试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token comment" style="color:#6A9955">// 启动 RPC 服务器并监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token plain"> server </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceProvider</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        server</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getPort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token comment" style="color:#6A9955">// 发布服务接口到 ServiceProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        serviceProvider</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">provideServiceInterface</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">scanService</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> serviceAnnotation</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">canRetry</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955">// 可以设置是否支持重试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token comment" style="color:#6A9955">// 启动 RPC 服务器并监听端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token plain"> server </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">NettyRpcServer</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">serviceProvider</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                        server</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">start</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getPort</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">warn</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;未找到 @EnableFinishRpcServer 注解，RPC 框架未自动初始化&quot;</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 扫描主类包 用于默认的服务扫描</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * date: 2025/4/20 21:32</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getCallerPackage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 获取调用栈，找到入口类（通常是用户的主类）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">StackTraceElement</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> stackTrace </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Thread</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">currentThread</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getStackTrace</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> mainClassName </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> stackTrace</span><span class="token punctuation" style="color:#475569">[</span><span class="token plain">stackTrace</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">length </span><span class="token operator" style="color:#475569">-</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:#475569">]</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getClassName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> mainClass </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">forName</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">mainClassName</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> mainClass</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getPackage</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getName</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 返回主类所在包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">ClassNotFoundException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> </span><span class="token string" style="color:#64748b">&quot;&quot;</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"> </span><span class="token comment" style="color:#6A9955">// 如果无法获取，则默认全扫描（需过滤 JDK 类）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token plain"> customRpcConfig</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        rpcConfigTemplate </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> customRpcConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RPC 框架初始化，配置 = &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> customRpcConfig</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token plain"> customRpcConfig</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            customRpcConfig </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ConfigUtil</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">loadConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RPCConstant</span><span class="token punctuation" style="color:#475569">.</span><span class="token constant" style="color:#0f172a">CONFIG_FILE_PREFIX</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token comment" style="color:#6A9955">// 配置加载失败，使用默认配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            log</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">warn</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;配置加载失败，使用默认配置&quot;</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            customRpcConfig </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">customRpcConfig</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">getRpcConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">rpcConfigTemplate </span><span class="token operator" style="color:#475569">==</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">RpcConfigTemplate</span><span class="token punctuation" style="color:#475569">.</span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token function" style="color:#0e7490">initialize</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain">  </span><span class="token comment" style="color:#6A9955">// 确保在第一次调用时初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> rpcConfigTemplate</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token comment" style="color:#6A9955">/**</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * 获取带有注解实现类的接口</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     *</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * @author 冷环渊</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     * date: 2025/4/21 14:03</span><br></span><span class="token-line" style="color:#0f172a"><span class="token comment" style="color:#6A9955">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">List</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">scanServices</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> basePackage</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#0c4a6e">extends</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">Annotation</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotationClass</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 创建Reflections实例，指定要扫描的基础包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Reflections</span><span class="token plain"> reflections </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Reflections</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">basePackage</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">ArrayList</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Object</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> objects </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">ArrayList</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 使用getTypesAnnotatedWith方法获取带有指定注解的所有类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Set</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotatedClasses </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> reflections</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getTypesAnnotatedWith</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">annotationClass</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotatedClass </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> annotatedClasses</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token keyword" style="color:#0c4a6e">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                objects</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">add</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">annotatedClass</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">newInstance</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">                </span><span class="token keyword" style="color:#0c4a6e">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RuntimeException</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 将Set转换为List并返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> objects</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">scanService</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token plain"> basePackage</span><span class="token punctuation" style="color:#475569">,</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#0c4a6e">extends</span><span class="token generics"> </span><span class="token generics class-name" style="color:#0ea5e9">Annotation</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotationClass</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 创建Reflections实例，指定要扫描的基础包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Reflections</span><span class="token plain"> reflections </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">new</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">Reflections</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">basePackage</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> res </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">null</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token comment" style="color:#6A9955">// 使用getTypesAnnotatedWith方法获取带有指定注解的所有类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">Set</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotatedClasses </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> reflections</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getTypesAnnotatedWith</span><span class="token punctuation" style="color:#475569">(</span><span class="token plain">annotationClass</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">Class</span><span class="token generics punctuation" style="color:#475569">&lt;</span><span class="token generics operator" style="color:#475569">?</span><span class="token generics punctuation" style="color:#475569">&gt;</span><span class="token plain"> annotatedClass </span><span class="token operator" style="color:#475569">:</span><span class="token plain"> annotatedClasses</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">            res </span><span class="token operator" style="color:#475569">=</span><span class="token plain"> annotatedClass</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token keyword" style="color:#0c4a6e">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token punctuation" style="color:#475569">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试-2">测试<a href="#测试-2" class="hash-link" aria-label="Direct link to 测试" title="Direct link to 测试">​</a></h3>
<p>将api项目中的实现类直接诺到我们的<code>serverB</code>中</p>
<p>加入注解</p>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150804395.png" alt="image-20250428150804395" class="img_ev3q"></p>
<blockquote>
<p>启动类</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#0f172a;--prism-background-color:#f1f5f9"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#0f172a;background-color:#f1f5f9"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#0f172a"><span class="token annotation punctuation" style="color:#475569">@Slf4j</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token annotation punctuation" style="color:#475569">@EnableFinishRpcServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">class</span><span class="token plain"> testServer </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token keyword" style="color:#0c4a6e">public</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">static</span><span class="token plain"> </span><span class="token keyword" style="color:#0c4a6e">void</span><span class="token plain"> </span><span class="token function" style="color:#0e7490">main</span><span class="token punctuation" style="color:#475569">(</span><span class="token class-name" style="color:#0ea5e9">String</span><span class="token punctuation" style="color:#475569">[</span><span class="token punctuation" style="color:#475569">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#475569">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#475569">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain"></span><span class="token comment" style="color:#6A9955">//         框架已在静态代码块中初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">        </span><span class="token class-name" style="color:#0ea5e9">System</span><span class="token punctuation" style="color:#475569">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">println</span><span class="token punctuation" style="color:#475569">(</span><span class="token string" style="color:#64748b">&quot;RPC 配置: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#475569">+</span><span class="token plain"> </span><span class="token class-name" style="color:#0ea5e9">RpcAutoConfiguration</span><span class="token punctuation" style="color:#475569">.</span><span class="token function" style="color:#0e7490">getRpcConfig</span><span class="token punctuation" style="color:#475569">(</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">)</span><span class="token punctuation" style="color:#475569">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#0f172a"><span class="token plain">    </span><span class="token punctuation" style="color:#475569">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>直接启动测试项目</p>
<blockquote>
<p>serverB打印</p>
<p>自动配置完成</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="http://img.doomwatcher.cn/img/image-20250428150902665.png" alt="image-20250428150902665" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>​	目前来看整个的 finishRpc已经具备了最基础的rpc以及可靠性和提升效率的功能 , 初次设计可能编写的很青涩 此项目也会作为博主提升的里程碑 ,之后考虑去基于finish的思路 实现一个网关 , 注册中心等一系列生态 , 然后目前的思路也可能去实现适配spring的rpc ,  本篇结束 ==你的提升来自于你的热爱和想法== 我们下一篇见</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#环境" class="table-of-contents__link toc-highlight">环境</a></li><li><a href="#需要实现功能" class="table-of-contents__link toc-highlight">需要实现功能</a></li><li><a href="#结构与依赖" class="table-of-contents__link toc-highlight">结构与依赖</a><ul><li><a href="#结构" class="table-of-contents__link toc-highlight">结构</a></li><li><a href="#依赖" class="table-of-contents__link toc-highlight">依赖</a></li></ul></li><li><a href="#接口提供" class="table-of-contents__link toc-highlight">接口提供</a></li><li><a href="#核心库" class="table-of-contents__link toc-highlight">核心库</a><ul><li><a href="#常量" class="table-of-contents__link toc-highlight">常量</a></li><li><a href="#请求响应规范" class="table-of-contents__link toc-highlight">请求响应规范</a></li><li><a href="#编解码器" class="table-of-contents__link toc-highlight">编解码器</a></li><li><a href="#提供端" class="table-of-contents__link toc-highlight">提供端</a><ul><li><a href="#服务本地注册" class="table-of-contents__link toc-highlight">服务本地注册</a></li><li><a href="#netty服务端" class="table-of-contents__link toc-highlight">netty服务端</a><ul><li><a href="#处理器" class="table-of-contents__link toc-highlight">处理器</a></li><li><a href="#初始化" class="table-of-contents__link toc-highlight">初始化</a></li><li><a href="#启动类" class="table-of-contents__link toc-highlight">启动类</a></li></ul></li></ul></li><li><a href="#客户端" class="table-of-contents__link toc-highlight">客户端</a><ul><li><a href="#netty客户端" class="table-of-contents__link toc-highlight">netty客户端</a><ul><li><a href="#处理器-1" class="table-of-contents__link toc-highlight">处理器</a></li><li><a href="#初始化-1" class="table-of-contents__link toc-highlight">初始化</a></li><li><a href="#启动类-1" class="table-of-contents__link toc-highlight">启动类</a></li></ul></li><li><a href="#服务代理" class="table-of-contents__link toc-highlight">服务代理</a></li></ul></li><li><a href="#测试和小结" class="table-of-contents__link toc-highlight">测试和小结</a></li></ul></li><li><a href="#注册中心-nacos" class="table-of-contents__link toc-highlight">注册中心 NACOS</a><ul><li><a href="#服务端" class="table-of-contents__link toc-highlight">服务端</a><ul><li><a href="#服务注册nacos" class="table-of-contents__link toc-highlight">服务注册nacos</a></li><li><a href="#基于令牌桶限流" class="table-of-contents__link toc-highlight">基于令牌桶限流</a></li></ul></li><li><a href="#客户端-1" class="table-of-contents__link toc-highlight">客户端</a></li><li><a href="#节点缓存" class="table-of-contents__link toc-highlight">节点缓存</a><ul><li><a href="#nacos监听器" class="table-of-contents__link toc-highlight">nacos监听器</a></li><li><a href="#应用监听器-和缓存" class="table-of-contents__link toc-highlight">应用监听器 和缓存</a></li></ul></li><li><a href="#客户端负载均衡" class="table-of-contents__link toc-highlight">客户端负载均衡</a></li><li><a href="#测试" class="table-of-contents__link toc-highlight">测试</a></li></ul></li><li><a href="#重试与熔断" class="table-of-contents__link toc-highlight">重试与熔断</a><ul><li><a href="#重试配置" class="table-of-contents__link toc-highlight">重试配置</a></li><li><a href="#熔断配置" class="table-of-contents__link toc-highlight">熔断配置</a></li><li><a href="#服务代理-1" class="table-of-contents__link toc-highlight">服务代理</a></li><li><a href="#测试-1" class="table-of-contents__link toc-highlight">测试</a></li></ul></li><li><a href="#读取配置" class="table-of-contents__link toc-highlight">读取配置</a><ul><li><a href="#创建测试项目" class="table-of-contents__link toc-highlight">创建测试项目</a></li></ul></li><li><a href="#注解启动与服务注册" class="table-of-contents__link toc-highlight">注解启动与服务注册</a><ul><li><a href="#autoconfig" class="table-of-contents__link toc-highlight">autoconfig</a></li><li><a href="#测试-2" class="table-of-contents__link toc-highlight">测试</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">  来自冷环渊的技术支持与文档创作 @2025</div></div></div></footer></div>
</body>
</html>